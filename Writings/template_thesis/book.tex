\include{preamble}
\include{macros}



%%%%%%%%%%% BEGIN OF THE DOCUMENT
\begin{document}
\renewcommand{\nomname}{Abbreviations}

\begin{titlepage}
\KOMAoptions{twoside = false, BCOR=0mm}
\pagenumbering{roman}
\begin{center}
\linespread{1.5}
\vspace*{2cm}

{\huge \textbf{Development of New Multistate Multireference Perturbation Theory Methods and their Application}}

\vspace{2cm}

\large
Dissertation

zur

Erlangung des Doktorgrades (Dr. rer. nat.)

der

Mathematisch-Naturwissenschaftlichen Fakultät

der

Rheinischen Friedrich-Wilhelms-Universität Bonn

\vspace{1cm}

vorgelegt von

Lucas Lang

aus

Würzburg

\vspace{2cm}

Dezember 2019




\end{center}
\end{titlepage}



\thispagestyle{empty}

\begin{flushleft}
\linespread{3}
\vspace*{10cm}

\begin{center}
Angefertigt mit Genehmigung der Mathematisch-Naturwissenschaftlichen Fakultät der 

\vspace{0.5cm}

Rheinischen Friedrich-Wilhelms-Universität Bonn
\end{center}


\vspace{6cm}

Erstgutachter: Prof. Dr. Frank Neese

\vspace{0.5cm}

Zweitgutachter: Prof. Dr. Stefan Grimme

\vspace{0.5cm}

Tag der Promotion:

\vspace{0.5cm}

Erscheinungsjahr:
\end{flushleft}

\KOMAoptions{twoside = true, BCOR=15mm}
\clearpage


\chapter*{Summary}
The present work is concerned with the development and application of two new multistate multireference perturbation theory methods. In contrast to state-specific perturbation theory methods, multistate methods can simultaneously provide several states that are allowed to mix under the influence of dynamic correlation.
The first new method is the 2nd order dynamic correlation dressed complete active space me\-thod (DCD-CAS(2)), which is formulated in terms of an effective Hamiltonian that is based on the theory of intermediate effective Hamiltonians. It simultaneously provides the ground state and a few low-lying excited states. The method is orbitally invariant and preserves orbital degeneracies of the underlying complete active space self-consistent field solutions. In cases where model space components become nearly degenerate after the inclusion of dynamic correlation, DCD-CAS(2) is shown to be superior to state-specific 2nd order dynamic correlation methods like the N-electron valence state perturbation theory (NEVPT2).

It was found that DCD-CAS(2) fails in simultaneously describing ligand field and charge transfer states in a balanced
way because of the state-averaged 0th order Hamiltonian used in its construction. The multi-partitioning idea allows the use of
state-specific 0th order Hamiltonians in a multistate framework and could therefore
alleviate the mentioned problem. However, the effective Hamiltonian is non-Hermitian
in the traditional formulation of multi-partitioning, which can lead to unphysical
behavior especially for nearly degenerate states. In order to achieve a more balanced
treatment of states with a different physical character and at the same time have a
Hermitian effective Hamiltonian, we combine for the first time multi-partitioning with
canonical Van Vleck perturbation theory. At the 2nd order, the result is a Hermitian
variant of multi-partitioning quasi-degenerate NEVPT2 (QD-NEVPT2). It is given the acronym HQD-NEVPT2. The effect of model space non-invariance of the method is discussed and the benefit of a Hermitian formulation is highlighted with numerical
examples.

Both DCD-CAS(2) and HQD-NEVPT2 are also extended to incorporate spin-dependent relativistic effects into the
Hamiltonian.
This results in effective Hamiltonians that simultaneously contain the effects of static
correlation, dynamic correlation and relativity. All important
contributions necessary for the description of magnetic phenomena and electron
paramagnetic resonance spectroscopy, namely spin-orbit coupling, magnetic
hyperfine coupling, Zeeman interaction, and direct electronic spin-spin coupling, are incorporated.
We also suggest a novel analysis of Kramers doublet g-matrices and A-matrices
based on the singular value decomposition. I provides not only the magnitude but
also the sign of the principal components and allows for a transparent decomposition into
different physical contributions.

Tests are performed for excitation energies of
first-row transition metal ions, as well as D-tensors and g-shifts of first-row transition
metal complexes using minimal active spaces. It is observed that state-mixing effects
are usually small in these cases and that the results are comparable to nondegenerate NEVPT2 in conjunction with quasidegenerate perturbation theory (QDPT). Results on
EPR parameters of pseudo-square-planar copper(II) complexes show that state mixing with
a ligand-to-metal charge transfer configuration greatly improves the results
compared with NEVPT2/QDPT. HQD-NEVPT2 turns out to be more reliable than DCD-CAS(2) for this kind of problem because of its better 0th order description of the involved states.
HQD-NEVPT2 is also shown to give good results for the calculation of electronic
transitions of the tetrachlorocuprate(II) complex, which is an example where the balance between ligand-field
and charge transfer configurations is of utmost importance.

The last part of this work is concerned with the connection of the newly developed multistate methods with the \textit{ab initio} ligand field theory (AILFT), which has evolved into an
important tool for the extraction of ligand field models from \textit{ab initio} calculations over the last few years. The
incorporation of dynamic correlation was previously realized
at the level of NEVPT2. The two new versions of AILFT are tested for a diverse set of transition metal
complexes. It is found that the multistate methods have, compared to NEVPT2, an
AILFT fit with smaller root-mean-square deviations (RMSDs) between \textit{ab initio} and
AILFT energies. Comparison of AILFT excitation energies with the experiment shows
that for some systems the agreement gets better at the multistate level because of the
smaller RMSDs. However, for some systems the agreement gets worse, which can be
attributed to a cancellation of errors at the NEVPT2 level that is partly removed at the
multistate level. An investigation of trends in the extracted li\-gand field parameters shows
that at the multistate level the ligand field splitting Δ gets larger, while the Racah
parameters \textit{B} and \textit{C} get smaller and larger, respectively. An investigation of the reasons
for the observed improvement for octahedral chromium(III) halide complexes shows that the
possibility of state mixing relaxes constraints that are present at the NEVPT2 level and that
keep Δ and \textit{B} from following their individual preferences.

\cleardoublepage
\hrule
\vspace*{0.5cm}
{\LARGE\textsc{List of Publications}}
\vspace{1cm}
\hrule
\vspace{0.5cm}
{\large\textsc{Publications related to this work}}

\begin{itemize}
\item \textbf{L. Lang}, M. Atanasov, and F. Neese, An Improvement of Ab Initio Ligand Field Theory by Means of Multistate Perturbation Theory, submitted to \textit{J. Phys. Chem. A}.

I contributed the implementation of the new \textit{ab initio} effective Hamiltonians in AILFT and performed all calculations together with their analysis.

\item \textbf{L. Lang}, K. Sivalingam, and F. Neese, The Combination of Multi-Partitioning of the Hamiltonian with Canonical Van Vleck Perturbation Theory Leads to a Hermitian Variant of Quasi-Degenerate N-Electron Valence Perturbation Theory, accepted for publication at \textit{J. Chem. Phys.}

I developed the idea of combining multi-partitioning theory with canonical Van Vleck perturbation theory, worked out the theory, did the implementation, and performed all calculations and their analysis.

\item \textbf{L. Lang} and F. Neese, Spin-dependent properties in the framework of the dynamic correlation dressed complete active space method, \textit{J. Chem. Phys.} \textbf{150}, 104104 (2019).

I worked out the theory of spin-dependent DCD-CAS(2), did the implementation, performed the calculations, and analyzed the results.

\item S. Pathak, \textbf{L. Lang}, and F. Neese, A dynamic correlation dressed complete active space method: Theory, implementation, and preliminary applications, \textit{J. Chem. Phys} \textbf{147}, 234109 (2017).

I contributed the majority of the theory and implementation. In particular, I developed an efficient implementation using protyping techniques, an efficient treatment of the largest perturber class, the difference-dedicated DCD-CAS(2), the bias correction, and performed the theoretical investigation of orbital invariance and size consistency. I furthermore obtained the numerical results on the free ions and on \textit{ab initio} ligand field theory. The calculations originally done by S. Pathak (size consistency, avoided crossing, magnetic exchange) were repeated for this thesis and partly extended with new data.
\end{itemize}

\hrule
\vspace{0.5cm}
{\large\textsc{Further publications}}

\begin{itemize}
\item P. Gütlein, \textbf{L. Lang}, K. Reuter, J. Blumberger, and H. Oberhofer, Toward First-Principles-Level Polarization Energies in Force Fields: A Gaussian Basis for the Atom-Condensed Kohn–Sham Method, \textit{J. Chem. Theory Comput.} \textbf{15}, 4516 (2019).

\item C.-M. Suomivuori, \textbf{L. Lang}, D. Sundholm, A. P. Gamiz-Hernandez, and V. R. I. Kaila, Tuning the Protein-Induced Absorption Shifts of Retinal in Engineered Rho\-dop\-sin Mimics, \textit{Chem. Eur. J.} \textbf{22}, 8254 (2016).
\end{itemize}


\newpage
\chapter*{Acknowledgments}

First and foremost, I would like to express my gratitude to my supervisor Prof. Dr. Frank Neese for providing me with an exciting and challenging project that allowed me to get familiar with diverse areas of quantum chemistry. Furthermore, I want to thank Prof. Dr. Stefan Grimme for agreeing to be my second supervisor and for the pleasant stay in his research group in Bonn in the context of the Bonn-Mülheim exchange seminar. I also gratefully acknowledge the support by the Verband der Chemischen Industrie, which endowed me with a Kekulé fellowship.

I am indebted to many people who influenced this work with their knowledge and insight, in particular Kanthen Sivalingam, Mihail Atanasov, and Róbert Izsák. I also want to thank Frank Wennmohs and Mihail Atanasov as representatives of the ORCA developer team and the molecular magnetism group. Ute Becker did an amazing job in  parallelizing my code and Marvin Lechner, Róbert Izsák, Van Anh Tran, Anneke Dittmer and Christine Schulz read parts of this thesis and considerably contributed to its readability. I also want to thank all other members of the Neese and DeBeer groups that I did not mention explicitly. 

I am grateful for the many interesting discussions I shared over the years with my previous office mates Liza Suturina, Yang Guo, and Willem van den Heuvel, and last but not least Shubhrodeep Pathak, who accompanied me during the beginning of my Ph.D. work.

I also want to thank my parents, who have always supported me in following my dreams, and my brother Leon who shares my passion for the exact sciences.

I am also indebted to all my friends who have always encouraged me in what I was doing and for spending amazing times with me. In particular I am grateful to Ola and Róbert for all the many Thursday evenings we spent together over the last few years. Last but not least I want to thank Stephi for her love and support without which all this would not have been possible.

\tableofcontents

\cleardoublepage
\addcontentsline{toc}{chapter}{List of Tables}
\listoftables

\cleardoublepage
\addcontentsline{toc}{chapter}{List of Figures}
\listoffigures

\cleardoublepage
\markboth{Abbreviations}{Abbreviations}
\printnomenclature[3cm]

\chapter{Introduction}
\pagenumbering{arabic}

\section{Status quo of quantum chemical methods}
Quantum chemistry has evolved into an indispensable tool for modern chemical research. It is complementary to experimental techniques and their combination can be used to extract new information that would not be available from one of the approaches alone.\cite{Neese_2017_11003}

Density functional theory (DFT)\nomenclature{DFT}{Density functional theory} has dominated computational molecular research for many years due to its much lower computational cost compared to accurate wavefunction methods, which makes it applicable to larger systems. However, the systematic improvement of the exchange-correlation functional has turned out to be a difficult task. Routes toward systematic improvement exist,\cite{BleizHG_2013_84113, ErharBG_2016_143002, ThierSG_2019_144117} but they usually lead to methods with a computational cost that is comparable to correlated wavefunction methods. DFT-based methods that include results from wavefunction methods, like correlation from 2nd order Møller-Plesset perturbation theory (MP2)\nomenclature{MP2}{2nd order Møller-Plesset PT} in double hybrid functionals,\cite{Grimm_2006_34108, GoeriG_2014_576} are quite accurate but also have a much larger computational cost than classical density functional approximations, while often still including empirical parameters in their definition. In contrast to that, wavefunction methods are increasingly applicable to large chemical systems due to low-scaling approximations that reduce the computational cost while preserving to a large part the accuracy of the parent canonical methods.\cite{PinskRVN_2015_34108, RipliPBVN_2016_24109, GuoSVN_2016_94111, SaitoBRVN_2017_164105, MaganDN_2018_1215} Furthermore, while pure DFT is often successful in describing the potential energy surface of single-determinantal systems, it has sometimes turned out to be too inaccurate for the quantitative prediction of molecular properties that depend on fine details of the electronic structure, like nuclear magnetic resonance (NMR)\nomenclature{NMR}{Nuclear magnetic resonance} shielding tensors.\cite{StoycAIN_2018_619} Even in cases where DFT methods work for such properties, they often rely on error cancelation. This makes the further development of wavefunction-based quantum chemistry methods a very important task.

Wavefunction-based methods are often based on a single Slater determinant that qualitatively describes the electronic structure of a molecule, and such methods are called ``single-reference'' methods. The hierarchy of the single-reference coupled cluster (CC)\nomenclature{CC}{Coupled cluster} methods are the prime example for the very high accuracy that can be achieved with such methods.\cite{BartlM_2007_291}
However, a large part of chemistry involves electronic states that are dominated by more than one Slater determinant, something that is called a ``multiconfigurational'' situation. Multiconfigurational systems are often thought to require a so-called multireference treatment, i.e. a treatment that starts from a reference wavefunction that involves more than one determinant. This is however wrong and one should not confuse ``multiconfigurational'' and ``multireference''. An open-shell singlet wavefunction can for example qualitatively be described via two Slater determinants. Hence it is multiconfigurational, or at least multideterminantal. However, this kind of system can not only be described via multireference methods but for example also via single-reference spin-flip methods on top of a  $M_S=1$ triplet determinant.\cite{OrmsK_2018_13127}
On the other hand, it can be beneficial to treat systems with a single-determinantal electronic structure via multireference methods, as is done in this work for some Cu\textsuperscript{II} complexes.

Another relevant dimension apart from the correlation treatment is the treatment of relativistic effects. For many applications of quantum chemistry, it is sufficient to perform calculations based on a spin-independent nonrelativistic or scalar-relativistic Hamiltonian. There are however molecular properties, e.g. electron paramagnetic resonance (EPR)\nomenclature{EPR}{Electron paramagnetic resonance} g-matrices and hyperfine coupling constants (HFCC)\nomenclature{HFCC}{HFC constant}, as well as zero-field splittings (ZFS)\nomenclature{ZFS}{Zero-field splitting}, for which spin-dependent effects like spin-orbit coupling (SOC)\nomenclature{SOC}{Spin-orbit coupling} must be included in the treatment.
The calculation of such properties is commonly approached via perturbation theory (sum-over-states) or linear response (derivative) techniques based on a scalar wavefunction.\cite{Neese_2017_1} There are many such implementations of spin-dependent properties for DFT\cite{SchreZ_1997_3388, LenthAW_1998_4783, MalkiVSMMK_2000_9206, Neese_2001_11080, Neese_2003_3939, Neese_2007_164112} and wavefunction methods.\cite{LushiG_1996_259, VahtrMAa_1997_186, BrownGTKM_2003_9552, Neese_2007_2507, GaussKN_2009_11541, SandhKN_2013_104102} A disadvantage of these approaches is that they assume that the wavefunction response to SOC is linear. Hence, they break down whenever SOC is very strong, as with heavy elements, or when a system has low-lying excited states.
An alternative approach that overcomes this limitation is the direct calculation of relativistic many-electron wavefunctions from which properties are derived. One way to accomplish this is the use of relativistic 2- or 4-component Hamiltonians.\cite{Saue_2011_3077} These can be used together with the same methods (e.g. Hartree-Fock (HF)\nomenclature{HF}{Hartree-Fock}, configuration interaction (CI)\nomenclature{CI}{Configuration interaction} or CC) applicable to scalar Hamiltonians, but with a higher prefactor in the computational cost, since some symmetries disappear that can be exploited in the scalar case. Another possibility is the use of scalar orbitals and the introduction of spin-dependent effects at the many-electron level. Here, one can distinguish between one-step and two-step procedures.\cite{BuenkALLH_1998_3400} In a one-step procedure, SOC is included at the same level into the calculation as the electron correlation. An example is the spin-orbit CI procedure.\cite{BuenkALLH_1998_3400, SjoevoGO_1997_301, YabusZP_1999_5791, KleinTM_2006_124101} This kind of method has also recently been combined with the heat bath CI method, a method for large active spaces.\cite{MussaS_2018_154} In a two-step procedure, one first treats electron correlation using a spin-free Hamiltonian. The resulting states can then interact under the effect of spin-dependent effects like SOC. Examples include 1st order quasidegenerate perturbation theory (QDPT)\nomenclature{QDPT}{Quasidegenerate PT}\cite{BuenkALLH_1998_3400, RakowM_1996_105, GanyuN_2006_24103} and, in the context of multiconfigurational self-consistent field (MCSCF) wavefunctions, the restricted active space state-interaction spin-orbit (RASSI-SO)\nomenclature{RASSI-SO}{Restricted active space state-interaction spin-orbit}\cite{MalmqRS_2002_230} procedure. On top of reference wavefunctions of the complete active space self-consistent field (CASSCF) type, these are often the methods of choice because of their favorable cost-to-performance ratio. Recently, extensions to density matrix renormalization group wavefunctions have been proposed.\cite{Roeme_2015_44112, KnechKAR_2016_5881, SayfuC_2016_234301}
\clearpage
\section{Multireference perturbation theory}
In this work, we are focussing on the development and application of multireference perturbation theory (MRPT)\nomenclature{MRPT}{Multireference PT} methods based on a CASSCF reference. These methods still represent the most commonly used approach to multireference dynamic correlation calculations since they allow to treat much larger systems than the more accurate multireference CI (MRCI)\cite{BuenkP_1974_33, BuenkP_1975_217}\nomenclature{MRCI}{Multireference CI} and multireference CC (MRCC)\cite{KoehnHMJG_2013_176, BartlM_2007_291} \nomenclature{MRCC}{Multireference CC} methods.

The success of Møller-Plesset (MP) perturbation theory\cite{Creme_2011_509} in the single-reference framework has inspired many extensions to the multireference case. This task has proven to be much more complicated. One of the most difficult aspects in formulating an MRPT is the choice of 0th order Hamiltonian.\cite{KozloD_1994_3672} The factors that are desired for a robust MRPT include invariance with respect to orbital rotations, size consistency, and ensuring that the wavefunction remains a spin eigenfunction in all orders of the perturbative expansion.  The complete active space 2nd order perturbation theory (CASPT2)\nomenclature{CASPT2}{Complete active space 2nd order PT} method of Andersson \textit{et al.}\cite{AnderMRSW_1990_5483, AnderMR_1992_1218} played a vital role in generating interest for MRPT in particular and for multireference theories in general. A robust and efficient implementation of CASPT2 popularized the method among computational chemists. The CASPT2 as well as the 2nd order multireference Møller-Plesset perturbation theory (MRMP2)\nomenclature{MRMP2}{Multireference MP2} method of Hirao\cite{Hirao_1992_374, Hirao_1992_397} are among the most straightforward multireference extensions of MP2. Characteristic features of CASPT2 are the use of a one-electron Fock operator in the construction of the 0th order Hamiltonian and internally contracted perturber functions that span the first-order interacting space (FOIS)\nomenclature{FOIS}{First-order interacting space}\cite{McLeaL_1973_1066}. The latter differentiates CASPT2 from MRMP2 that spans the FOIS with a much larger set of Slater determinants. Unfortunately, both methods are highly prone to the so-called intruder state problem.\cite{CamacWY_2009_468} An intruder state arises if the 0th order energy of a FOIS function comes close or even falls below the energy of the reference function. In this case, the perturbation expansion becomes divergent. Roos \textit{et al.} proposed a global level-shift procedure to alleviate this problem.\cite{RoosA_1995_215, RoosAFSPMM_1996_257} Hirao and coworkers devised an analogous method that shifts individual intruder states out of the critical energy regime.\cite{ChoeWFH_2001_3913, WitekCFH_2002_957} However, the choice of level shift is somewhat arbitrary, yet it influences the calculations and therefore leads to ambiguous results.\cite{ZobelNG_2017_1482} 

In order to deal with the intruder-state problem, it was deemed necessary to include two-electron terms into the 0th order Hamiltonian.\cite{AngelCM_2000_472} Such a 0th order Hamiltonian has an eigenspectrum that more closely resembles the full Hamiltonian, which will drastically reduce the danger of intruder states. One viable choice that has been used in the past is the Epstein-Nesbet (EN)\nomenclature{EN}{Epstein-Nesbet} Hamiltonian that simply consists of the diagonal of the CI matrix.\cite{Epste_1926_695, NesbeH_1955_312} However, in addition to being not orbitally invariant and computationally expensive for larger systems, the EN 0th order Hamiltonian is known to lack the desirable property of size extensivity.\cite{MalriS_1979_55} Hence, it has largely been abandoned in PT approaches. Alternatively, Dyall’s 0th order Hamiltonian consists of the MP choice in the inactive and virtual orbital spaces while acting inside the active space like the full Hamiltonian.\cite{Dyall_1995_4909}

Angeli \textit{et al.} used a 0th order Hamiltonian based on the Dyall Hamiltonian for their highly successful N-electron valence state perturbation theory (NEVPT)\nomenclature{NEVPT}{N-electron valence state perturbation theory}.\cite{AngelCELM_2001_10252, AngelCM_2001_297} NEVPT2 has attractive features, such as exact separability and great computational benefits,\cite{SchapSN_2013_3567} thanks to the strongly contracted scheme.\cite{AngelCM_2001_297, SchapSN_2013_3567} It is also less prone to intruder states than for example CASPT2 without a level shift. Owing to these desirable features together with the availability of efficient implementations,\cite{SchapSN_2013_3567} NEVPT2 has become increasingly popular in recent years.\cite{RoemeGC_2016_204113, GuoWHSC_2016_1583, SharmC_2014_111101, GuoSVN_2016_94111}

All the above-mentioned methods are state-specific in nature and fall under the ``di\-ag\-o\-nal\-ize-then-perturb''\cite{Shavi_2002_639} type of perturbation theories. Usually, these methods manage to predict reasonable ground and excited state energies. Problems arise when the correlation treatment also changes the composition of the wavefunction in the complete active space CI (CASCI)\nomenclature{CASCI}{Complete active space CI} space to a considerable extent,\cite{Shavi_2002_639} as is commonly encountered in the treatment of magnetic exchange coupling, ionic-covalent curve crossings, valence-Rydberg mixing in excited states, and mixing of ligand field and ligand-to-metal charge transfer (LMCT)\nomenclature{LMCT}{Ligand-to-metal charge transfer} excitations, to name a few. In these cases, CASSCF gives a biased description, i.e. it treats some configurations better than others, which leads to their mixing at the CASCI level being wrong.
Since the above-mentioned methods maintain a frozen 0th order wavefunction, this can result in an erroneous prediction of ionic-covalent curve crossings,\cite{MalriHZ_1995_167} exchange couplings, or excitation energies. In all these cases, the nature of the 0th order wavefunction must be revised in order to obtain accurate results. One therefore needs methods that can treat multiple electronic states simultaneously. Such approaches are called multistate methods. They can either be realized by invoking a traditional effective-Hamiltonian-like formalism using the full CASCI space or by applying an \textit{a posteriori} variational treatment of only a handful of important states.

Methods following the latter approach fall under the so-called ``diagonalize-then-per\-turb-then-diagonalize''\cite{Shavi_2002_639} philosophy. Starting with a state-averaged (SA)\nomenclature{SA}{State-averaged} CASSCF calculation to provide model-space 0th order functions, an effective Hamiltonian is constructed in the model space using QDPT. The diagonalization of this effective Hamiltonian allows for ``state mixing'', i.e. it provides wavefunctions and energies that result from the mixing of several CASCI states. Usually, a small subset of the functions of the full CASSCF Hamiltonian are used as the model space. The intruder state problem can be significantly reduced if this model space is well separated from other 0th order states. Mixing of states was handled with some success by earlier works from Malrieu and Spiegelmann,\cite{SpiegM_1984_1235} Sheppard \textit{et al.}\cite{SheppSM_1983_1364} and also by extensions of popular MRPT methods such as Multiconfigurational QDPT (MCQDPT),\nomenclature{MCQDPT}{Multiconfigurational QDPT}\cite{Nakan_1993_7983} Multistate CASPT2 (MS-CASPT2),\nomenclature{MS-CASPT2}{Multistate CASPT2}\cite{FinleMRS_1998_299} and more recently quasidegenerate NEVPT2 (QD-NEVPT2),\nomenclature{QD-NEVPT2}{Quasidegenerate NEVPT2}\cite{AngelCM_2006_434} together with further improvements like the extended MCQDPT (XMCQDPT),\nomenclature{XMCQDPT}{Extended MCQDPT}\cite{Grano_2011_214113} extended MS-CASPT2 (XMS-CASPT2)\nomenclature{XMS-CASPT2}{Extended MS-CASPT2}\cite{ShiozGCW_2011_81106} and the very recent QD-NEVPT2 based on matrix product states (MPS)\nomenclature{MPS}{Matrix product state}.\cite{SharmJA_2016_34103}

Including a large number of states in the subsequent effective Hamiltonian treatment increases the risk of running into the intruder-state problem, which the corresponding state-specific methods tried to avoid in the first place. An additional problem with many QD approaches based on the Bloch effective Hamiltonian is the non-Hermiticity of the resulting Hamiltonian. This non-Hermiticity has a sound physical reason, namely the non-orthogonality of projections of exact states on the model space. This is not \textit{per se} a problem, since also non-Hermitian matrices can have real-valued eigenvalues, as it is the case with the exact (infinite order) effective Hamiltonian. The non-Hermiticity can however be a practical problem when working with truncated perturbation expansions of the effective Hamiltonian. In these cases unphysical complex-valued energies can potentially occur. Furthermore, many model Hamiltonians, like the ligand field theory Hamiltonian,\cite{Griff_1971_} are Hermitian, and a Hermitian \textit{ab initio}-derived effective Hamiltonian facilitates the mapping onto such a model Hamiltonian. 

The intermediate effective Hamiltonians (IEHs),\nomenclature{IEH}{Intermediate effective Hamiltonian} introduced by Malrieu and coworkers,\cite{MalriDD_1985_809} can be seen as a compromise between the use of a complete model space and state-specific approaches. IEHs ensure accurate results for a number of low-lying states but in addition contain a variational ``buffer space''. This can prevent several problems that are ubiquitous in traditional effective Hamiltonian approaches, among which are the near-degeneracy of high-energy model space components with perturber functions (the infamous intruder state problem) and the fact that it is often impossible to find a suitable target state for such high-energy components.\cite{HeullM_2009_76} The IEH concept is fairly general and can be applied to many problems in quantum chemistry.\cite{HeullM_2009_76} One particular application is the self-consistent size-consistent configuration interaction ((SC)\textsuperscript{2}CI) of Malrieu and coworkers.\cite{DaudeHM_1993_1240} It is worthwhile to mention that Gershgorn and Shavitt introduced a closely related method, called the $B_k$ method, for the truncation of the CI problem back in 1968.\cite{GershS_1968_751} The idea is quite general and applicable to both single- and multireference problems. It consists in selecting one variational space (originally suggested to be all single and double excitations from the reference function) and a perturbative one (for example triples and quadruples). Subsequent improvements were suggested\cite{DavidMD_1981_5491, RawliD_1983_424, NitzsD_1978_3103, NitzsD_1978_7201} and became known under the name “shifted $B_k$” method. An approach that is related to IEH methods in the sense that it also divides the whole model space into a primary and secondary (buffer) space is the 2nd order generalized Van Vleck perturbation theory (GVVPT2)\nomenclature{GVVPT2}{2nd order generalized Van Vleck perturbation theory} method developed by Mark Hoffmann and coworkers.\cite{KhaitSH_2002_4133, JiangKH_2009_4374}

\section{The DCD-CAS(2) and HQD-NEVPT2 methods}
This work is mainly concerned with the development of two new multistate multireference perturbation theory methods. The first one is the 2nd order dynamic correlation dressed complete active space method (DCD-CAS(2))\nomenclature{DCD-CAS(2)}{2nd order dynamic correlation dressed complete active space method}.\cite{PathaLN_2017_234109, LangN_2019_104104} It aims at incorporating the effects of dynamic correlation to 2nd order in perturbation theory into the diagonalization of the whole CASCI space and can be roughly classified as a perturb-then-diagonalize method. Since its model space is the whole CASCI space it avoids ambiguity and has a very flexible wavefunction. The method was designed to be computationally efficient for not too large active spaces and it simultaneously provides the ground and a few low-lying excited state roots. Its results will be shown in later sections to be very close to the already very successful NEVPT2 method in cases where the CASSCF wavefunction is a good starting point and the effect of state mixing is small. If state mixing becomes important, DCD-CAS(2) significantly improves over NEVPT2. The method is inspired by a special case of the IEH approach\cite{MalriDD_1985_809} and leads to working equations that are formally equivalent to those of the (shifted) $B_k$ method. Like previous approaches,\cite{DavidMD_1981_5491} our method is not exactly size-consistent. We have addressed this issue in detail both theoretically and numerically and suggested modifications to deal with this problem.\cite{PathaLN_2017_234109}

Some of the advantages of the DCD-CAS(2) method are a Hermitian effective Hamiltonian. In contrast to that, other widespread multistate perturbation theories like MS-CASPT2\cite{FinleMRS_1998_299} and QD-NEVPT2\cite{AngelBCC_2004_4043} are formulated in terms of a non-Hermitian effective Hamiltonian. Furthermore, DCD-CAS(2) uses a complete CASCI space (including energetically very high-lying states) as model space, without the danger to encounter intruder state problems for the low-lying states of interest. This is a potential advantage in cases where differential dynamic correlation effects are large. If this is the case, energetically high-lying roots can drop in energy and get into the energy regime of interest after including dynamic correlation. When using a small model space one can potentially miss such roots, while there is no such danger in a complete model space method like DCD-CAS(2).
Another advantage of DCD-CAS(2) is the preservation of orbital degeneracy of the underlying CASSCF calculation. However, the method requires a so-called bias correction in order to yield reasonable excitation energies for excited states. In the extension of DCD-CAS(2) to a spin-dependent Hamiltonian,\cite{LangN_2019_104104} one must make some \textit{ad hoc} choice of states of the CASCI space for which this bias correction should be applied. It cannot simply be applied to all roots because it can be a source of divergence for energetically higher-lying CASCI space components. A limitation of the DCD-CAS(2) method is that it is very expensive for anything but small active spaces. Furthermore, it became clear from our work on spin-dependent properties in the DCD-CAS(2) framework that the use of a single, state-averaged 0th order Hamiltonian  (a necessary requirement in DCD-CAS(2)), can lead to problems when several states with very different physical character (e.g. ligand-field and LMCT states) are included in the CASCI space.\cite{LangN_2019_104104}

In order to solve this problem, it was deemed necessary to use a formalism that uses different state-specific 0th order Hamiltonians for different parts of the effective Hamiltonian. One approach of this kind is multi-partitioning QDPT.\cite{ZaitsM_1995_597} This method shares with traditional QDPT the disadvantage of a non-Hermitian effective Hamiltonian, which can lead to unphysical complex eigenvalues. This kind of problem was for example observed for the non-Hermitian equation of motion CC (EOM-CC)\nomenclature{EOM-CC}{Equation of motion CC} method.\cite{KoehnT_2007_44105} Two popular multistate perturbation methods that use a multi-partitioning ansatz are MS-CASPT2\cite{FinleMRS_1998_299} and QD-NEVPT2.\cite{AngelBCC_2004_4043} They use the 0th order Hamiltonians of the respective single-state CASPT2 or NEVPT2 methods as state-specific 0th order Hamiltonians. In contrast, MCQDPT,\cite{Nakan_1993_7983} XMCQDPT,\cite{Grano_2011_214113} XMS-CASPT2\cite{ShiozGCW_2011_81106} and QD-NEVPT based on matrix product states\cite{SharmJA_2016_34103} all use a Hermitian effective Hamiltonian according to the Van Vleck formalism, of which so far no multi-partitioning variant has been formulated. Since all these methods use a state-averaged 0th order Hamiltonian, they should have the same problems with difficult systems as DCD-CAS(2).
In an attempt to preserve the very desirable feature of DCD-CAS(2) that it has a Hermitian effective Hamiltonian and combine it with the possibility to use state-specific 0th order Hamiltonians, we developed a combination of the multi-partitioning idea with canonical Van Vleck perturbation theory. This leads to a Hermitian variant of QD-NEVPT2 (HQD-NEVPT2)\nomenclature{HQD-NEVPT2}{Hermitian QD-NEVPT2} in a straightforward way. The method will be demonstrated to be superior to methods based on the state-averaged Dyall Hamiltonian\cite{Dyall_1995_4909} in a number of test cases.

\section{Applications}
The final parts of this dissertation are concerned with tests and applications of the new methods. Apart from the nonrelativistic variants, we also developed variants of DCD-CAS(2) and HQD-NEVPT2 that can deal with spin-dependent relativistic effects. The motivation for this is that the calculation of spin-dependent properties like g-values and HFCCs in the framework of QDPT1 often suffers from too inaccurate CASSCF wavefunctions. For example, the description of metal-ligand bonds is often too ionic at the CASSCF level.\cite{VancoMP_2007_1803} The common nondegenerate perturbation theory (PT)\nomenclature{PT}{Perturbation theory} approaches like CASPT2\cite{AnderMRSW_1990_5483, AnderMR_1992_1218} or NEVPT2\cite{AngelCELM_2001_10252, AngelCM_2001_297} can provide better energies, but do not allow for relaxation of the CAS-part of the wavefunction, which ist important for rendering the wavefunction more covalent. A study using multi-state CASPT2 (MS-CASPT2)\cite{FinleMRS_1998_299} showed that g-values of square-planar Cu complexes could be greatly improved when incorporating such relaxation effects.\cite{VancoP_2008_4011}

The principle problem in all multi-step approaches for including dynamic correlation and spin-dependent effects, like QDPT, is that they inherently contain assumptions about the relative strength of the treated perturbations. For example, the CASSCF method treats only static correlation. A subsequent NEVPT2 correction adds the effects of dynamic correlation but without relaxing the CASSCF coefficients. The subsequent QDPT1 treatment of relativistic effects then uses diagonal energies from NEVPT2 (or CASPT2) in order to approximately diagonalize SOC and other relativistic operators. Clearly, this order implies that static correlation is more important than dynamic correlation, which in turn is more important than relativity. In many cases, this is certainly a plausible order in which to treat the relevant interactions. However, in cases where SOC is larger than dynamic correlation effects or where dynamic correlation greatly revises the CASSCF descriptions, shortcomings are inevitable.
Hence, our goal was the development of an affordable method in which static correlation, dynamic correlation and relativistic interactions are treated on an equal footing without an assumption of their relative magnitudes.

Finally, we will investigate the application of our newly developed methods, DCD-CAS(2) and HQD-NEVPT2, for the parameterization of ligand field models, which are indispensable tools for understanding the electronic structure of metal complexes.

\chapter{Theoretical foundations}
\section{Conventions}
We use atomic units throughout this thesis, where $\hbar$, $4\pi\epsilon_0$, $m_e$ and $e$ are set equal to 1.\cite{SzaboO_1996_} With this choice, the speed of light is given as the inverse of the fine-structure constant, $c=1/\alpha$. Throughout this work, orbital indices $ijk...$ refer to inactive, $tuv...$ to active, and $abc...$ to virtual orbitals, while the indices $pqr...$ apply to general orbitals. Spin labels ($\alpha$ or $\beta$) are denoted by Greek letters $\sigma\tau\lambda...$
We use the symbol $a^\dagger_{p\sigma}$ to denote a creation operator that creates an electron in spatial orbital $p$ with spin $\sigma$. The corresponding annihilation operator, which destroys an electron in spatial orbital $p$ with spin $\sigma$, is denoted by $a_{p\sigma}$. The singlet excitation operators\cite{HelgaJO_2000_} are defined as
\begin{equation}
\label{Eq:definition_Epq}
E_{pq} = a^\dagger_{p\alpha}a_{q\alpha} + a^\dagger_{p\beta}a_{q\beta}
\end{equation}
and
\begin{equation}
(pq|rs) = \iint \psi_p(\mathbf{r}_1) \psi_q(\mathbf{r}_1) \frac{1}{r_{12}} \psi_r(\mathbf{r}_2) \psi_s(\mathbf{r}_2) d\mathbf{r}_1 d\mathbf{r}_2
\end{equation}
are two-electron repulsion integrals (ERI)\nomenclature{ERI}{Electron repulsion integral} in chemists' notation.\cite{SzaboO_1996_}

\section{Quantum-chemical Hamiltonians}
\label{Sec:Hamiltonians}
\subsection{Nonrelativistic and scalar-relativistic Hamiltonians}
Quantum chemistry deals to a large part with the solution of the electronic Schrödinger equation in the electrostatic potential created by nuclei that are fixed at certain positions in space. This is also called the clamped-nuclei approximation and forms the basis for the Born-Oppenheimer approximation and more refined approximations for vibronic states that incorporate the coupling of electronic and nuclear degrees of freedom.

Accurate calculations of the electronic states and energy levels require the use of methods that incorporate special relativity, since electrons, especially in molecules involving heavy elements, can reach speeds that are a sizable fraction of the speed of light. The most accurate such calculations use the 4-component Dirac-Coulomb(-Breit) Hamiltonian.\cite{Saue_2011_3077} For such methods, there is apart from energy levels that correspond to electronic states also a part of the spectrum that is continuous and at negative energies. This negative continuum corresponds to positronic degrees of freedom. Since chemistry is concerned with electrons, a multitude of different techniques has been developed over many decades to decouple the electronic and positronic degrees of freedom.\cite{Saue_2011_3077} Among the first were the Pauli (and Breit-Pauli, for multi-electron systems) treatment. It has the disadvantage that some parts of the effective 2-component Hamiltonian are not bounded from below, and hence can lead to a variational collapse.\cite{ReiheW_2009_} Parts of the Breit-Pauli Hamiltonian, like the spin-orbit operator and the spin-spin operator, are still in use today in quantum-chemical calculations and are also (partly approximated) used in this work.

Other approaches for the derivation of effective 2-component Hamiltonians are the Doug\-las-Kroll-Hess (DKH)\nomenclature{DKH}{Douglas-Kroll-Hess} theory and the zeroth-order regular approximation (ZORA)\nomenclature{ZORA}{Zeroth-order regular approximation}. The most widespread versions of these approximations neglect all spin-dependent terms in the Hamiltonian, arriving at what are called ``scalar-relativistic'' Hamiltonians. They have the same symmetry under spin rotations as the nonrelativistic electronic Hamiltonian. 

The nonrelativistic electronic Hamiltonian for an $N$-electron system (also called Born-Oppenheimer (BO)\nomenclature{BO}{Born-Oppenheimer} Hamiltonian) is given by\cite{SzaboO_1996_}
\begin{equation}
\label{Eq:nonelHamil}
H = \sum_i h_i + \sum_{i<j} \frac{1}{r_{ij}},
\end{equation}
where 
\begin{equation}
h_i = -\frac{1}{2}\nabla_i^2 - \sum_A \frac{Z_A}{r_{iA}}
\end{equation}
is the one-electron part of the Hamiltonian. It is given as the sum of electronic kinetic energy and electronic-nuclear attraction. The second part of Eq. (\ref{Eq:nonelHamil}) is the electron-electron repulsion energy. Here, $r_{ij} = |\mathbf{r}_i - \mathbf{r}_j|$,  $r_{iA} = |\mathbf{r}_i - \mathbf{R}_A|$, and $Z_A$ is the nuclear charge of nucleus $A$ (in multiples of the elementary charge). The sums over electrons $i$ and $j$ run from 1 to $N$, which denotes the total number of electrons in the system. In the following we will use the term ``scalar Hamiltonian'' whenever we mean this nonrelativistic Hamiltonan or a scalar-relativistic one, and the term ``scalar wavefunction'' for a wavefunction obtained with such a Hamiltonian.

An important aspect of scalar Hamiltonians is that they commute with the total spin and its $z$-projection,
\begin{align}
[H, \mathbf{S}^2] &= 0, \\
[H, S_z] &= 0,
\end{align}
where $\mathbf{S} = \sum_i \mathbf{s}_i$ is the total electronic spin operator. This means that eigenstates of $H$ can be written as eigenstates of these two operators. The electronic states $|\Psi^{SM}\rangle$ can therefore be characterized by two quantum numbers $S$ and $M$ such that they fulfill the eigenvalue equations
\begin{align}
\mathbf{S}^2 |\Psi^{SM}\rangle &= S(S+1)|\Psi^{SM}\rangle, \\
S_z |\Psi^{SM}\rangle &= M|\Psi^{SM}\rangle.
\end{align}
There are always $2S+1$ components with $M=-S$ to $M=S$ (in integer steps) for a given total spin $S$ that are exactly degenerate, i.e. have the same energy. Since the scalar Hamiltonians are real, orbitals can also chosen to be real (see Appendix \ref{Sec:ComplexConjugation}), which significantly simplifies the computational cost of the calculations. Since all $2S+1$ components are degenerate and related to each other by spin symmetry, the time-independent Schrödinger equation has to be solved only for one of the components. Typically the \emph{principal component} with $M=S$ is chosen. A final advantage arises when one incorporates spin-dependent relativistic effects, like SOC and direct electronic spin-spin coupling (SSC)\nomenclature{SSC}{Direct spin-spin coupling}, on top of solutions of the scalar Hamiltonians with certain spin. The calculation of matrix elements of the spin-dependent operators can in this case be simplified via the Wigner-Eckart theorem,\cite{Wigne_1959_} which is an important result of group theory.

\subsection{Spin-dependent operators}
\label{Sec:spindepop}
In this work, four different spin-dependent additions to the Hamiltonian are considered: SOC, SSC, hyperfine coupling (HFC)\nomenclature{HFC}{Hyperfine coupling} and the Zeeman interaction. These are the dominant interactions that are needed to describe EPR spectroscopy. We will express them in atomic units throughout this work.
We use an accurate and efficient spin-orbit mean field (SOMF)\nomenclature{SOMF}{Spin-orbit mean field} operator\cite{Neese_2005_34107} as the SOC operator, which is a one-electron operator in contrast to the two-electron Breit-Pauli SOC operator from which it is derived. It is given by
	\begin{equation}
	\label{Eq:HSOMF}
	{H_{{\text{SOMF}}}} = \sum\limits_i {{{\mathbf{z}}_i}}  \cdot {{\mathbf{s}}_i}
	\end{equation}
with ${{\mathbf{z}}_i}$ being a spatial and purely imaginary operator for electron $i$.\cite{Neese_2005_34107}
The Breit-Pauli SSC operator used in this work is given by\cite{McWee_1992_}
	\begin{equation}
	\label{Eq:HSSC}
	{H_{{\text{SSC}}}} =  - \frac{{g_e^2{\alpha ^2}}}{4}\sum\limits_{i < j} {\frac{{3({{\mathbf{r}}_{ij}} \cdot {{\mathbf{s}}_i})({{\mathbf{r}}_{ij}} \cdot {{\mathbf{s}}_j}) - r_{ij}^2{{\mathbf{s}}_i} \cdot {{\mathbf{s}}_j}}}{{r_{ij}^5}}}. 
	\end{equation}
Note that the operator in principle also contains a contact contribution in addition to this dipolar contribution. The contact contribution is, however, a singlet operator and therefore cannot directly contribute to ZFS. Since its effect on energies is expected to be a few cm$^{-1}$ at most, much smaller than the intrinsic accuracy of common quantum chemical methods, it can be safely ignored. We therefore do not consider it in this work.
The hyperfine interaction operator is given by
\begin{equation}
	\label{Eq:HHFC}
	{H_{{\text{HFC}}}} =  - \sum\limits_A {{{\mathbf{M}}^A}}  \cdot {{\mathbf{B}}_{{\text{HFC}}}}({{\mathbf{R}}_A}),
\end{equation} 	
where the sum is over all nuclei $A$ that have a nonzero magnetic dipole moment ${{\mathbf{M}}^A}={\gamma ^A}{{\mathbf{I}}^A}$ and ${{\mathbf{B}}_{{\text{HFC}}}}({{\mathbf{R}}_A})$ is the magnetic hyperfine field produced by the electrons at the position ${{\mathbf{R}}_A}$ of nucleus $A$. Here $\mathbf{I}^A$ is the nuclear spin and the proportionality constant ${\gamma ^A}$ is the gyromagnetic ratio of the nucleus. The hyperfine field consists of three parts: The nucleus-orbit coupling (NOC)\nomenclature{NOC}{Nucleus-orbit coupling} contribution
	\begin{equation}{{\mathbf{B}}_{{\text{NOC}}}}({{\mathbf{R}}_A}) =  - {\alpha ^2}\sum\limits_i {\frac{{{\mathbf{l}}_i^A}}{{r_{iA}^3}}}, 
	\end{equation} 
the spin-dipolar (SD)\nomenclature{SD}{Spin-dipolar} contribution
	\begin{equation}{{\mathbf{B}}_{{\text{SD}}}}({{\mathbf{R}}_A}) =  - \frac{{{g_e}{\alpha ^2}}}{2}\sum\limits_i { {\frac{{3{{\mathbf{r}}_{iA}}({{\mathbf{s}}_i} \cdot {{\mathbf{r}}_{iA}}) - r_{iA}^2{{\mathbf{s}}_i}}}{{r_{iA}^5}}} }, 
	\end{equation}
and the Fermi contact (FC)\nomenclature{FC}{Fermi contact} contribution
	\begin{equation}{{\mathbf{B}}_{{\text{FC}}}}({{\mathbf{R}}_A}) =  - \frac{{{g_e}{\alpha ^2}}}{2}\frac{{8\pi }}{3}\sum\limits_i {{{\mathbf{s}}_i}} {\delta ^3}({{\mathbf{r}}_{{\mathbf{iA}}}}).
	\end{equation}
Finally, the Zeeman Hamiltonian for the interaction with an external homogeneous magnetic field ${\mathbf{B}}$ is given by
	\begin{equation}
	\label{Eq:HZeeman}
	{H_{{\text{Zeeman}}}} =  - {\mathbf{B}} \cdot {{\mathbf{M}}^{{\text{el}}}} = \frac{1}{2}{\mathbf{B}} \cdot ({\mathbf{L}} + {g_e}{\mathbf{S}})
	\end{equation}
with the electronic magnetic dipole moment operator ${{\mathbf{M}}^{{\text{el}}}}$ and operators for total spin ${\mathbf{S}} = \sum\limits_i {{{\mathbf{s}}_i}} $ and total orbital angular momentum ${\mathbf{L}} = \sum\limits_i {{{\mathbf{l}}_i}} $.
In the equations above, ${g_e} \approx 2.0023$ is the free-electron g-value and $\alpha  \approx 1/137$ is the fine-structure constant.
Note that in a rigorous relativistic two-component treatment, there are additional spin- and magnetic-field-dependent terms in the Hamiltonian that result in so-called picture-change effects.\cite{SandhKN_2013_104102, SandhN_2012_94102} However, such extensions are outside the scope of the current work.

\section{Multireference quantum chemistry}
Nowadays, the most common multireference treatments of electronic structure start with CASSCF\cite{RoosTS_1980_157, SiegbHRL_1980_323, SiegbAHR_1981_2384} reference functions. In this method, the spatial orbitals are divided into three subspaces, called inactive, active, and virtual orbitals. The wavefunction is taken as a linear combination of states from the so-called CASCI space, which is the space of Slater determinants that have doubly occupied inactive orbitals, empty virtual orbitals, and all possible distributions of the remaining electrons among the active orbitals. This corresponds to a full CI within the active space. One of the simplest examples often encountered in practice is that of two active electrons in two active orbitals, which gives rise to a total of six Slater determinants, as shown in Figure \ref{Fig:CASCI}. A CASCI calculation can be done starting from any set of orbitals, e.g. HF orbitals. The CASSCF method is defined such that not only the CI coefficients, but also the orbitals are variationally optimized. It is a special case of the multiconfigurational self-consistent field (MCSCF)\cite{Hinze_1973_6424} method. Dynamic correlation methods that start from a CASSCF reference are called multireference methods because there are multiple reference determinants contained in the reference wavefunctions. Examples are multireference (MR)\nomenclature{MR}{Multireference} PT, CI, and CC methods.
The use of a CASSCF reference, however prevalent it might nowadays be, is not mandatory for a multireference treatment. The defining feature is simply that more than one reference determinant is defined. The orbitals from which the reference determinants are constructed can also be MCSCF or even HF orbitals.\cite{BuenkP_1974_33, BuenkP_1975_217}
\begin{figure}
\ffigbox[\FBwidth]
{\caption{Determinants of the CASCI(2,2) space.}
\label{Fig:CASCI}}
{\includegraphics[width=0.8\textwidth]{figures/CASSCF/CASCI.pdf}}
\end{figure}


\section{Theory of effective Hamiltonians}
An important role in this dissertation is played by effective Hamiltonians. An effective Hamiltonian $H^\text{eff}$ is a Hamiltonian that describes only part of the spectrum of the ``true microscopic'' Hamiltonian $H$ and acts in a ``model space'' that is smaller than the whole Hilbert space on which $H$ acts.
Often these come in the form of ``model Hamiltonians'', which are defined by a small number of parameters that are usually fitted to match experimental results. Examples are the spin Hamiltonian of EPR and NMR spectroscopy, the Heisenberg-Dirac-van-Vleck Hamiltonian for magnetic systems, the ligand field Hamiltonian of coordination chemistry, and the Hückel Hamiltonian for $\pi$-electron systems. The benefit of effective Hamiltonians is that they hide much of the complexity of the true underlying Hamiltonian and provide a language in which one can think and talk about chemical and physical phenomena. From the point of view of theory, it is desirable to connect the effective Hamiltonians with the underlying microscopic physics. This is the content of the following sections.
 
\subsection{General framework of effective Hamiltonian theory}
Our discussion is based on the theoretical framework introduced by Shavitt and Redmon.\cite{ShaviR_1980_5711} In this approach, a given basis of the Hilbert space is divided into two orthogonal sets: $\{ |{\Phi _I}\rangle \} $, which spans the so-called model space $\mathcal{H}_0$ with projector $P = \sum_I | {\Phi _I}\rangle \langle {\Phi _I}|$ and $\{ |{\Phi _K}\rangle \} $, which spans the complementary or outer space $\mathcal{H}_\text{outer}$ with projector $Q = 1 - P = \sum_K | {\Phi _K}\rangle \langle {\Phi _K}|$. This means that the Hilbert space is decomposed into the direct sum
\begin{equation}
\mathcal{H} = \mathcal{H}_0 \oplus \mathcal{H}_\text{outer}.
\end{equation}
We use indices $I$ and $J$ to denote states in the model space, and $K$ and $L$ to denote states in the complementary space. In this work, the model space can be a subspace of CASCI roots or even the complete CASCI space, in which case it can equally well be spanned by a set of orthonormal configuration state functions (CSFs)\nomenclature{CSF}{Configuration state function}. For an arbitrary operator $A$ one can write
	\begin{equation}
	A = {A_D} + {A_X},
	\end{equation} 	
where 
	\begin{equation}
	{A_D} = PAP + QAQ
	\end{equation} 	
is its block diagonal part and
	\begin{equation}
	{A_X} = PAQ + QAP
	\end{equation} 	
is its block off-diagonal part. An operator for which ${A_X} = 0$ is called block diagonal and an operator for which ${A_D} = 0$ is called block off-diagonal.
The essence of effective Hamiltonian theory consists in finding a so-called decoupling operator $U$ such that the similarity-transformed Hamiltonian
	\begin{equation}
	\mathcal{H} = {U^{ - 1}}HU
	\end{equation} 	
is block diagonal.\cite{ShaviR_1980_5711} This equation can be rewritten as
	\begin{equation}
	\label{Eq:Bloch_nonprojected}
	U\mathcal{H} = HU.
	\end{equation} 	
One can then diagonalize the effective Hamiltonian ${H^{{\text{eff}}}} = P\mathcal{H}P$ to obtain ${N_P}$ (the dimension of the model space) exact eigenenergies of $H$, together with model space states $|{\tilde \Psi _I}\rangle $ that fulfill
	\begin{equation}
	{H^{{\text{eff}}}}|{\tilde \Psi _I}\rangle  = {E_I}|{\tilde \Psi _I}\rangle. 
	\end{equation} 	
The states $|{\Psi _I}\rangle  = U|{\tilde \Psi _I}\rangle $ are then exact eigenstates of $H$ with the corresponding eigenenergy, as can be seen by
	\begin{equation}
	H|{\Psi _I}\rangle  = HU|{\tilde \Psi _I}\rangle  = U{H^{{\text{eff}}}}|{\tilde \Psi _I}\rangle  = {E_I}U|{\tilde \Psi _I}\rangle  = {E_I}|{\Psi _I}\rangle. 
	\end{equation}
This also shows that the eigenenergies of the effective Hamiltonian are exact. This procedure is visualized in Figure \ref{Fig:ST}.
\begin{figure}
\ffigbox[\FBwidth]
{\caption{Block-diagonalization of the Hamiltonian via a similarity transformation.}
\label{Fig:ST}}
{\includegraphics[width=0.8\textwidth]{figures/SimilarityTrafo/similaritytrafo.pdf}}
\end{figure}
Note that the effective Hamiltonian and its eigenstates are not uniquely defined by the requirement that $\mathcal{H}$ is block diagonal, since multiplication of $U$ with any block diagonal operator will leave $\mathcal{H}$ block diagonal.\cite{ShaviR_1980_5711} Therefore, additional conditions need to be imposed on $U$.

\subsection{Choices for the decoupling operator}
In practice, one tries to make a choice such that $|\Psi_I\rangle$ and $|\tilde{\Psi}_I\rangle$ have a large overlap.
One possible choice is ${U_D} = 1$. By acting with the projector $P$ from the left on both sides of the equation $|{\Psi _I}\rangle  = (1 + {U_X})|{\tilde \Psi _I}\rangle $, one obtains
	\begin{equation}
	|{\tilde \Psi _I}\rangle  = P|{\Psi _I}\rangle. 
	\end{equation} 	
Hence, in this case the eigenfunctions of the effective Hamiltonian are simply orthogonal projections of the exact states on the model space. Since the coefficient of $|{\tilde \Psi _I}\rangle $ in $|{\Psi _I}\rangle $ is unity, this choice corresponds to intermediate normalization. Acting with $P$ from the right on both sides of Eq. (\ref{Eq:Bloch_nonprojected}) and defining the so-called wave operator as $\Omega  = UP$, one obtains
	\begin{equation}
	\label{Eq:Bloch_intermediate}
	\Omega {H^{{\text{eff}}}} = H\Omega. 
	\end{equation} 	
Acting with $P$ from the left on both sides of this equation, one obtains
	\begin{equation}
	\label{Eq:Heff_IN_exact}
	{H^{{\text{eff}}}} = PH\Omega, 
	\end{equation} 	
which allows to rewrite Eq. (\ref{Eq:Bloch_intermediate}) in the form
	\begin{equation}
	\Omega H\Omega  = H\Omega. 
	\end{equation} 
This is a non-perturbative version\cite{Duran_1983_3184} of the generalized Bloch equation for the wave operator.\cite{Lindg_1974_2441} Note that the decoupling operator $U$ is not unitary in intermediate normalization, which means that the effective Hamiltonian is in general not Hermitian and consequently its eigenstates are not necessarily orthogonal.

Another approach is provided by the canonical Van Vleck formalism,\cite{ShaviR_1980_5711, Klein_1974_786} where one chooses the decoupling operator to be of the form
	\begin{equation}
	U = \exp (G),
	\end{equation} 	
with $G$ being an anti-Hermitian (${G^\dag } =  - G$) and block off-diagonal (${G_D} = 0$) operator. With this choice the decoupling operator is unitary. Hence, one obtains 
	\begin{equation}
	{\delta _{IJ}} = \langle {\Psi _I}|{\Psi _J}\rangle  = \langle {\tilde \Psi _I}|{U^\dag }U|{\tilde \Psi _J}\rangle  = \langle {\tilde \Psi _I}|{\tilde \Psi _J}\rangle. 
	\end{equation} 	
Therefore, the eigenfunctions of the effective Hamiltonian are, in contrast to the intermediate normalization formalism, orthogonal. One can show\cite{ShaviR_1980_5711} that the decoupling operators in the two approaches are related by
	\begin{equation}
	\label{Eq:relation_CVV_IN}
	{U_{{\text{(C)}}}} = {U_{{\text{(I)}}}}{(U_{{\text{(I)}}}^\dag {U_{{\text{(I)}}}})^{ - 1/2}}.
	\end{equation} 	
Here and in the following we use the labels I and C to distinguish quantities in the intermediate normalization and the canonical Van Vleck formalism, respectively. This relation means (see Appendix \ref{Ap:CVV_IN}) that the eigenstates of the canonical Van Vleck effective Hamiltonian are obtained by Löwdin symmetrical orthonormalization of the eigenstates of the intermediate normalization effective Hamiltonian, i.e. they are given by
	\begin{equation}
	\label{Eq:CVV_eigenstates}
	|\tilde \Psi _I\rangle^\text{L}  = \sum\limits_J | \tilde \Psi _J\rangle S_{JI}^{ - 1/2},
	\end{equation} 	
where the overlap matrix of the roots of the intermediate normalization effective Hamiltonian is introduced as ${S_{JI}} = \langle \tilde \Psi _J|\tilde \Psi _I\rangle $.
Note that the effective Hamiltonian that results from the canonical Van Vleck formalism is identical to the des Cloizeaux\cite{Cloiz_1960_321} one, as discussed by Klein\cite{Klein_1974_786} and Brandow.\cite{Brand_1975_1, Brand_1979_207}

If the $|\tilde{\Psi}_I\rangle$ are strongly non-orthogonal, i.e. have a large overlap, the orthogonalized states $|\tilde{\Psi}_I\rangle^\text{L}$ will be quite different from them. The overlap of the $|\tilde{\Psi}_I\rangle$ is however bounded by the norms of the parts of the exact states that lie in the complementary space, by means of the Cauchy-Schwarz inequality. Therefore, whenever the model space is chosen carefully, i.e. such that all exact states that one wants to describe have their major parts in the model space, the eigenfunctions $|\tilde{\Psi}_I\rangle$ and $|\tilde{\Psi}_I\rangle^\text{L}$ should be similar and will both be a valid qualitative description of the exact states.

Knowledge of the eigenfunctions and eigenvalues of the effective Hamiltonians allows to write them via a spectral decomposition. The intermediate normalization Bloch effective Hamiltonian\cite{Bloch_1958_329} is then given by
\begin{equation}
\label{Eq:HeffBloch}
  H^\text{eff}_\text{(I)} = \sum_I |\tilde{\Psi}_I\rangle E_I \langle \tilde{\Psi}_I |^\text{D},
\end{equation}
where $ | \tilde{\Psi}_I \rangle^\text{D} = \sum_J |\tilde{\Psi}_J\rangle S_{JI}^{-1}$ is a state that is dual to the projection $|\tilde{\Psi}_I\rangle$. This is also called a contravariant state. By definition, the set of original states and dual states are biorthogonal, i.e.
\begin{equation}
\langle \tilde{\Psi}_I|\tilde{\Psi}_J\rangle^\text{D} = \delta_{IJ}.
\end{equation}
The dual states are not in general the same as the original ones, since the projections are in general not orthogonal. The Hermitian canonical Van Vleck / des Cloizeaux\cite{Cloiz_1960_321} effective Hamiltonian is given by
\begin{equation}
\label{Eq:HeffCVV}
  H^\text{eff}_\text{(C)} = \sum_I |\tilde{\Psi}_I\rangle^\text{L} E_I \langle \tilde{\Psi}_I |^\text{L}.
\end{equation}

\subsection{Concepts of intermediate Hamiltonian theory}
The concept of IEHs was introduced in a seminal paper of Malrieu and coworkers.\cite{MalriDD_1985_809} They were designed to solve a fundamental problem of earlier effective Hamiltonian approaches: Sometimes determinants contribute strongly to a given exact state, i.e. should be included into the model space rather than be treated perturbatively, yet there is no single exact state that can serve as a target state for this determinant. An example is the Be atom, where apart from $(1s)^2(2s)^2$ also the electron configuration $(1s)^2(2p)^2$ is needed for a qualitatively correct description, although no bound exited state of the Be atom can be identified that has $(1s)^2(2p)^2$ as its dominant configuration.\cite{HeullM_2009_76} In the IEH approach, one does not ask an $M$-dimensional effective Hamiltonian to deliver $M$ exact eigenvalues, but only focuses on a few low-lying, say $N_\text{m}$, eigenstates. For the Be atom, this would be only the ground state. The remaining CSFs are considered to be part of a variational ``buffer space'' that ensures stability against intruder states and treats the interaction of the main model space CSFs with the CSFs in the buffer space to infinite order.
Following Malrieu’s pioneering work,\cite{MalriDD_1985_809} one can write the full many-electron Hilbert space as an orthogonal direct sum of three subspaces, 
	\begin{equation}
	\label{Eq:H0_intermediateHamiltonian}
	\mathcal{H} = {\mathcal{H}_\text{m} } \oplus {\mathcal{H}_{\text{i}}} \oplus {\mathcal{H}_{{\text{outer}}}}.
	\end{equation}
Here one calls ${\mathcal{H}_\text{m} }$ the main model space, ${\mathcal{H}_{\text{i}}}$ the intermediate space and ${\mathcal{H}_{{\text{outer}}}}$ the outer space. The intermediate space serves as the buffer space mentioned above. The combination of the main model space and the intermediate space, ${\mathcal{H}_0} = {\mathcal{H}_\text{m} } \oplus {\mathcal{H}_{\text{i}}}$, is the whole model space. We assume that there are $N_\text{m}$ (the dimension of the main model space) exact eigenfunctions of the BO Hamiltonian,
	\begin{equation}
	H|{\Psi _I}\rangle  = {E_I}|{\Psi _I}\rangle, 
	\end{equation}
such that their orthogonal projections on the whole model space,
	\begin{equation}
	|{\tilde \Psi _I}\rangle  = {P}|{\Psi _I}\rangle, 
	\end{equation}
are linearly independent; i.e. there is a one-to-one relationship between the $|{\Psi _I}\rangle $ and $|{\tilde \Psi _I}\rangle $. 
An IEH ${H^{\text{int} }}$ is then defined to be an operator acting on the model space such that it gives the exact eigenvalues when acting on the projected eigenfunctions,
	\begin{equation}
	{H^{\text{int} }}|{\tilde \Psi _I}\rangle  = {E_I}|{\tilde \Psi _I}\rangle. 
	\end{equation}
Since the $|{\tilde \Psi _I}\rangle $ in ${\mathcal{H}_\text{m} }$ do not form a complete basis of the whole model space, ${H^{{\text{int}}}}$ is not fully defined by this equation, which leads to a large variety of different IEHs.

\section{Different flavors of perturbation theory}

\subsection{Quasidegenerate perturbation theory}
In order to construct the effective Hamiltonians according to Eqs. (\ref{Eq:HeffBloch}) and (\ref{Eq:HeffCVV}), the exact eigenfunctions of the Hamiltonian must be known, which corresponds to solving the full CI problem. In order to make the problem more tractable, one can proceed by using perturbation theory instead. We assume a partitioning of the Hamiltonian 
	\begin{equation}
	H = {H_0} + V
	\end{equation} 	
into a 0th order Hamiltonian $H_0$ and a perturbation $V$. The 0th order Hamiltonian is assumed to be block diagonal, ${({H_0})_X} = 0$, and both parts are assumed to be Hermitian. The property of block diagonality can also be expressed as $H_0$ being a direct sum of operators acting in the model space and outer space,
\begin{equation}
				{H_0} = {H_{0,0}} \oplus {H_{0,{\text{outer}}}}.
				\end{equation}
Diagonalizing $H_0$ gives the 0th order states and 0th order energies,
	\begin{equation}
	{H_0}|\Psi _I^{(0)}\rangle  = E_I^{(0)}|\Psi _I^{(0)}\rangle ,\quad \;\;I \in P,
	\end{equation} 	
	\begin{equation}
	{H_0}|\Psi _K^{(0)}\rangle  = E_K^{(0)}|\Psi _K^{(0)}\rangle ,\quad \;\;K \in Q.
	\end{equation}
There are two main requirements for a 0th order Hamiltonian: it should be a good approximation for the full Hamiltonian $H$, i.e. $V$ should be small, and it should be easy to diagonalize it compared to $H$.
The so-called resolvent operator is defined by the spectral decomposition
	\begin{equation}
	{R_I} = \sum\limits_K {\frac{{|\Psi _K^{(0)}\rangle \langle \Psi _K^{(0)}|}}{{E_I^{(0)} - E_K^{(0)}}}}. 
	\end{equation} 	
Using this definition, it can easily be shown that for any operator $A$ there are the identities\cite{ShaviR_1980_5711}
	\begin{equation}
	 - {R_I}[{H_0},A]|\Psi _I^{(0)}\rangle  = QA|\Psi _I^{(0)}\rangle, 
	 \end{equation} 	
	\begin{equation}
	\label{Eq:QAP_resolvent}
	 - \sum\limits_I {{R_I}} [{H_0},A]|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| = QAP.
	 \end{equation} 	
This result will be useful later, when explicit expressions for a given operator are not available, but its commutator with the 0th order Hamiltonian is known.
The intermediate normalization effective Hamiltonian Eq. (\ref{Eq:Heff_IN_exact}) truncated at 2nd order can be shown to be\cite{ShaviR_1980_5711}
	\begin{equation}
	\label{Eq:Heff_IN}
	{H^{{\text{eff}}(0 - 2)}} = PHP + P{V_X}U_X^{(1)}P = PHP + PHQU_X^{(1)}P.
	\end{equation} 	
Note that the effective Hamiltonian does not explicitly depend on the choice of 0th order Hamiltonian and perturbation; the dependence is only indirect through $U_X^{(1)}$. This is because ${V_X} = {H_X}$ is already uniquely defined by the choice of model space and complementary space, since $H_0$ is required to be block diagonal. This point will become important later when discussing multi-partitioning of the Hamiltonian.
Using Eq. (\ref{Eq:QAP_resolvent}) and the fact that $[{H_0},U_X^{(1)}] =  - {V_X}$,\cite{ShaviR_1980_5711} it follows that $QU_X^{(1)}P = \sum_I {{R_I}} H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|$, such that the effective Hamiltonian can be written
	\begin{equation}
	{H^{{\text{eff}}(0 - 2)}} = PHP + PH\sum\limits_I {{R_I}} H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|.
	\end{equation} 	
Its matrix representation is given by
	\begin{equation}
	\label{Eq:Heff0-2IN}
	H_{IJ}^{{\text{eff}}(0 - 2)} = {H_{IJ}} + \langle \Psi _I^{(0)}|H{R_J}H|\Psi _J^{(0)}\rangle  = {H_{IJ}} + \sum\limits_K {\frac{{\langle \Psi _I^{(0)}|H|\Psi _K^{(0)}\rangle \langle \Psi _K^{(0)}|H|\Psi _J^{(0)}\rangle }}{{E_J^{(0)} - E_K^{(0)}}}}. 
	\end{equation}
The form of this effective Hamiltonian as the sum of the matrix representation of $H$ and some ``dressing'' is very typical for effective Hamiltonian theories.
In a similar fashion, one can show that, since $U_X^{(1)} = {G^{(1)}}$, the matrix representation of the canonical Van Vleck effective Hamiltonian to 2nd order is given by\cite{ShaviR_1980_5711}
	\begin{equation}
	\label{Eq:Heff0-2CVV}
	\begin{gathered}
  H_{IJ}^{{\text{eff}}(0 - 2)} = {H_{IJ}} + \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}H|\Psi _J^{(0)}\rangle  + \frac{1}{2}\langle \Psi _I^{(0)}|H{R_I}H|\Psi _J^{(0)}\rangle  \hfill \\
   = {H_{IJ}} + \frac{1}{2}\sum\limits_K {\frac{{\langle \Psi _I^{(0)}|H|\Psi _K^{(0)}\rangle \langle \Psi _K^{(0)}|H|\Psi _J^{(0)}\rangle }}{{E_J^{(0)} - E_K^{(0)}}}}  + \frac{1}{2}\sum\limits_K {\frac{{\langle \Psi _I^{(0)}|H|\Psi _K^{(0)}\rangle \langle \Psi _K^{(0)}|H|\Psi _J^{(0)}\rangle }}{{E_I^{(0)} - E_K^{(0)}}}} .  
\end{gathered} 
\end{equation} 	
This is simply the Hermitized version of the 2nd order intermediate normalization effective Hamiltonian,
	\begin{equation}
	\label{Eq:Hermitized}
	H_{({\text{C}})}^{{\text{eff}}(0 - 2)} = \frac{1}{2}(H_{({\text{I}})}^{{\text{eff}}(0 - 2)} + H{_{({\text{I}})}^{{\text{eff}}(0 - 2)\dagger} }).
	\end{equation} 	
	
One can easily derive the results of 2nd order nondegenerate\cite{Schroe_1926_437} and degenerate perturbation theory (DPT)\cite{Klein_1974_786}\nomenclature{DPT}{Degenerate PT} as special cases of the QDPT discussed above. In DPT, all model space states have the same 0th order energy $E_0^{(0)}$, which leads to
\begin{equation}
	\label{Eq:HeffDPT}
	H_{IJ}^{{\text{eff}}(0 - 2)} = {H_{IJ}} + \sum\limits_K {\frac{{\langle \Psi _I^{(0)}|H|\Psi _K^{(0)}\rangle \langle \Psi _K^{(0)}|H|\Psi _J^{(0)}\rangle }}{{E_0^{(0)} - E_K^{(0)}}}}. 
	\end{equation}
This can be considered as a special case of both the Bloch and canonical Van Vleck effective Hamiltonians, which for a degenerate model space are identical at 2nd order.
If the model space in addition is one-dimensional, the infinite order effective Hamiltonian has the exact energy of the target state as its only element. The perturbative expansion of this effective Hamiltonian is then identical to the perturbative expansion of the total energy, and one obtains to 2nd order
\begin{equation}
E = \langle \Psi_0^{(0)}|H|\Psi_0^{(0)}\rangle + \sum_{K\neq 0} \frac{\langle\Psi_0^{(0)}|H|\Psi_K^{(0)}\rangle\langle \Psi_K^{(0)}|H|\Psi_0^{(0)}\rangle}{E_0^{(0)}-E_K^{(0)}},
\end{equation}
which is the usual 2nd order Rayleigh-Schrödinger PT expression.\cite{Schroe_1926_437}
	
\subsection{Multi-partitioning QDPT}
Multi-partitioning QDPT\cite{ZaitsM_1995_597} was introduced by Zaitsevskii and Malrieu to alleviate the intruder state problem and improve energy denominators compared to the traditional QDPT. Its original formulation is based on intermediate normalization.\cite{ZaitsM_1995_597} Its basic idea, re-expressed here in the language of Shavitt and Redmon,\cite{ShaviR_1980_5711} is the following: The identity
	\begin{equation}
	Q{U_X}|\Psi _I^{(0)}\rangle  =  - {R_I}[{H_0},{U_X}]|\Psi _I^{(0)}\rangle 
	\end{equation} 	
holds for any choice of 0th order Hamiltonian ${H_0}$. One therefore chooses multiple state-specific partitionings
	\begin{equation}
	H = {H_0}(I) + V(I),
	\end{equation} 	
one for each 0th order state $|\Psi _I^{(0)}\rangle $. The 0th order Hamiltonians are assumed to have the same 0th order eigenfunctions $|\Psi_I^{(0)}\rangle$ in the model space. $E_I^{(0)}$ is defined as the 0th order energy of $H_0(I)$ belonging to the eigenfunction $|\Psi_I^{(0)}\rangle$. The eigenfunctions in the complementary space $Q$ can depend on the reference state,
\begin{equation}
H_0(I)|\Psi_K^{(0)}(I)\rangle = E_K^{(0)}(I)|\Psi_K^{(0)}(I)\rangle.
\end{equation}
One can then write
	\begin{equation}
	\label{Eq:QUXP_resolvent}
	Q{U_X}P =  - \sum\limits_I {{R_I}} (I)[{H_0}(I),{U_X}]|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|,
	\end{equation} 	
where the resolvents are now not only dependent on the reference energy but also on the 0th order Hamiltonian for which they are defined,
	\begin{equation}
	\label{Eq:statespecific_resolvents}
	{R_I}(I) = \sum\limits_K {\frac{{|\Psi _K^{(0)}(I)\rangle \langle \Psi _K^{(0)}(I)|}}{{E_I^{(0)} - E_K^{(0)}(I)}}}. 
	\end{equation}
A related idea that also relies on the separate treatment of the different model space states is the Jeziorski-Monkhorst ansatz for the wave operator,\cite{JezioM_1981_1668} which has found widespread use in MRCC.	
Expanding $U_X$ in powers of the perturbation operators $V(I)$ leads to
	\begin{equation}
	QU_X^{(1)}P = \sum\limits_I {{R_I}} (I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|.
	\end{equation} 	
Together with Eq. (\ref{Eq:Heff_IN}), the effective Hamiltonian up to 2nd order in the $V(I)$ is then
	\begin{equation}
	\label{Eq:Heff_multipart_basisindep}
	{H^{{\text{eff}}(0 - 2)}} = PHP + PHU_X^{(1)}P = PHP + PH\sum\limits_I {{R_I}} (I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|
	\end{equation} 	
and its matrix representation
	\begin{equation}
	\label{Eq:Heff_multipart}
	\begin{split}
  H_{IJ}^{{\text{eff}}(0 - 2)} &= {H_{IJ}} + \langle \Psi _I^{(0)}|H{R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   &= {H_{IJ}} + \sum\limits_K {\frac{{\langle \Psi _I^{(0)}|H|\Psi _K^{(0)}(J)\rangle \langle \Psi _K^{(0)}(J)|H|\Psi _J^{(0)}\rangle }}{{E_J^{(0)} - E_K^{(0)}(J)}}}. 
\end{split} 
\end{equation} 	

\subsection{Generalized degenerate perturbation theory}
\label{Sec:GDPT}
We finally introduce a variant of perturbation theory that approximates a state-specific IEH and was proposed already in the original paper that introduced the concept.\cite{MalriDD_1985_809} One starts by partitioning the Hamiltonian into a 0th order part and a perturbation,
\begin{equation}
H = {H_0} + V,
\end{equation}				
such that $H_0$ is the direct sum of operators acting in the main model, intermediate, and outer space, i.e. it does not mix states from these three subspaces,
				\begin{equation}
				{H_0} = {H_{0,{\text{m}}}} \oplus {H_{0,{\text{i}}}} \oplus {H_{0,{\text{outer}}}}.
				\end{equation}				
Furthermore, one assumes that all main model space functions are eigenfunctions of $H_0$ with the same eigenvalue $E_0$, i.e.
				\begin{equation}
				{H_{0,{\text{m}}}} = {E_0}{P_{\text{m}}},
				\end{equation}						
with ${P_{\text{m}}}$ being the projector on the main model space. In this context, Malrieu \textit{et al.}\cite{MalriDD_1985_809} defined an IEH whose expansion, in powers of the perturbation operator $V$, is given by
 \begin{equation}
 {H^{{\text{int}}}} = \sum\limits_n {{H^{{\text{int}},(n)}}}, 
 \end{equation}						
with the first few terms
\begin{align}
  {H^{{\text{int}},(0)}} &= {P}{H_0}{P},  \\
  {H^{{\text{int}},(1)}} &= {P}V{P},  \\
  {H^{{\text{int}},(2)}} &= {P}VRV{P} = {P}HRH{P},  \\
  {H^{{\text{int}},(3)}} &= {P}\left[ {VRVRV - V{R^2}V{P_{\text{m}}}V} \right]{P}. 
\end{align}
This perturbative expansion was given the name generalized degenerate perturbation theory (GDPT)\nomenclature{GDPT}{Generalized DPT}. The so-called resolvent operator is given by
\begin{equation}
R = \sum\limits_{E_K^{}} {\frac{{{P_K}}}{{E_0^{} - {E_K}}}}, 
\end{equation}									
where the sum is over all eigenvalues $E_K$ (with corresponding projectors $P_K$ on the eigenspaces) of the outer space 0th order Hamiltonian $H_{0, \text{outer}}$. In this work, we will truncate the expansion at the 2nd order and thus obtain
	\begin{equation}
	\label{Eq:GDPT_Hamil}
	{H^{{\text{int}}}} = {P}\left[ {H - H\sum\limits_{{E_K}} {\frac{{{P_K}}}{{{E_K} - {E_0}}}} H} \right]{P}.
	\end{equation}						

\subsection{NEVPT}
\label{Sec:NEVPT2}
The most common form of MRPT is nondegenerate perturbation theory based on a CASSCF reference wavefunction. Two variants of this approach are CASPT2\cite{AnderMRSW_1990_5483, AnderMR_1992_1218} and NEVPT2.\cite{AngelCELM_2001_10252, AngelCM_2001_297, AngelCM_2002_9138} The latter is more relevant for the current work, and we shell describe it in some detail in the following. All common variants of NEVPT2 are based on the Dyall Hamiltonian.\cite{Dyall_1995_4909} In an orbitally invariant form\cite{AngelPC_2007_743} (for orbital rotations inside the inactive, active and virtual subspaces respectively, not rotations between these subspaces), this operator is defined by
\begin{align}
\label{Eq:HDyall}{H^{{\text{Dyall}}}} &= H^\text{Dyall}_\text{nonact} + H^\text{Dyall}_\text{act}, \\
H^\text{Dyall}_\text{nonact} &= C + \sum\limits_{ij} {{F_{ij}}E_{ij}} + \sum\limits_{ab} {{F_{ab}}E_{ab}},  \\
H^\text{Dyall}_\text{act} &= \sum\limits_{tu} {(h_{tu}^\text{eff} - \tfrac{1}{2}\sum\limits_v {(tv|vu)} )E_{tu} + \tfrac{1}{2}\sum\limits_{tuvw} {(tu|vw)E_{tu}E_{vw}} }. 
\end{align}
The Fock matrix is defined via
\begin{equation}
\begin{split}
  {F_{pq}} &= {h_{pq}} + \sum\limits_{rs} {{D_{rs}}\left[ {(pq|rs) - \frac{1}{2}(pr|qs)} \right]}  \hfill \\
  \,\,\,\,\,\,\,\, &= h_{pq}^{{\text{eff}}} + \sum\limits_{tu} {{D_{tu}}\left[ {(pq|tu) - \frac{1}{2}(pt|qu)} \right]}.  \\ 
\end{split} 
\end{equation}						
The other symbols used in the definition of $H^\text{Dyall}$ are defined as
\begin{align}
h_{pq}^{{\text{eff}}} &= \langle p|h + \sum\limits_i {(2{J_i} - {K_i})} |q\rangle  = {h_{pq}} + \sum\limits_i {\left[ {2(pq|ii) - (pi|iq)} \right]}, \label{Eq:heff}\\
C &= {E_{{\text{Closed}}}} - 2\sum\limits_i {{F_{ii}}}, \\
{E_{{\text{Closed}}}} &= 2\sum\limits_i {{h_{ii}}}  + \sum\limits_{ij} {[2(ii|jj) - (ij|ji)]}. 
\end{align}
The density matrix $D_{rs}$ used in the definition of the Fock matrix is usually chosen to be the state-specific density matrix of the CASCI reference state for which one calculates the NEVPT2 correction. In this work we will also explore the use of a state-averaged density matrix, which is the average of the density matrices of all states included in the SA-CASSCF procedure.

The FOIS is the orthogonal direct sum of subspaces $S_l^{(k)}$,\cite{AngelCELM_2001_10252} where $l$ represents the non-active orbital occupation of the CSFs spanning the subspace and $k$ is the change in the number of electrons occupying active orbitals. In total one can distinguish eight different kinds of such subspaces: $S_{ij,ab}^{(0)}$, $S_{i,ab}^{( - 1)}$, $S_{ab}^{( - 2)}$, $S_{ij,a}^{( + 1)}$, $S_{ij}^{( + 2)}$, $S_{i,a}^{(0)}$, $S_a^{( - 1)}$, $S_i^{( + 1)}$. Here $i$, $j$, $a$ and $b$ are the indices of non-active electrons that are (de)populated compared to the reference CASCI functions. The perturbation functions, or \emph{perturbers}, are usually grouped into eight so-called ``excitation classes'' depending of the number of inactive and virtual orbitals in the subspace. The essential feature of NEVPT is the use of perturber functions that have well-defined inactive and virtual orbital occupation numbers, i.e. the 0th order Hamiltonian is defined to have vanishing matrix elements between different $S_l^{(k)}$. This is in contrast to CASPT2, where such coupling occurs.\cite{AnderMR_1992_1218}

NEVPT2 comes in three flavors, uncontracted, partially contracted, and strongly contracted NEVPT2, which differ in the definition of the 0th order Hamiltonian. Uncontracted NEVPT2 simply uses the complete Dyall Hamiltonian as 0th order Hamiltonian. This is the least efficient variant since the Dyall Hamiltonian has to be diagonalized in all subspaces $S_l^{(k)}$, whose sizes are in the same order of magnitude as the CASCI space. A more economic variant is the partially contracted NEVPT2. Here, the idea is to reduce the number of perturber functions by excluding those that do not interact with the reference CASCI function through the Hamiltonian. Hence, the perturbers and their energies are defined by diagonalizing the Dyall Hamiltonian in the space of internally contracted perturbers, which are functions that are obtained by acting with single and double excitation operators on the reference CASCI wavefunction. In this case the number of perturbers per $S_l^{(k)}$ space is reduced to $\mathcal{O}(N^{N_\text{act}})$, where $N$ is the number of indices on the two excitation operators that refer to active electrons and $N_\text{act}$ is the number of active electrons. For example, there are only two perturbers from the subspace $S_{ij,ab}^{(0)}$ and only $2N_\text{act}$ perturbers from the subspace $S_{i,ab}^{-1}$. Note that all functions from $S_l^{(k)}$ that are orthogonal to the subspace of internally contracted perturbers cannot interact with the reference function through the Hamiltonian. This shows that formally the total number of perturbers stays the same as in uncontracted NEVPT2 and just the definition of 0th order Hamiltonian changes. Finally, there is the strongly contracted NEVPT2, where a single perturber from each $S_l^{(k)}$ space is defined via $P_{S_l^{(k)}} H |\Psi^{(0)}\rangle$ and its energy is defined as its expectation value of the Dyall Hamiltonian. Here, $P_{S_l^{(k)}}$ is the orthogonal projector on $S_l^{(k)}$. One can again see that all other functions from $S_l^{(k)}$ that are orthogonal to this single perturber cannot interact through the Hamiltonian with the reference function.

A multistate method that is derived from NEVPT2 is the quasidegenerate NEVPT2 (QD-NEVPT2).\cite{AngelBCC_2004_4043} It consists in solving the multi-partitioning effective Hamiltonian Eq. (\ref{Eq:Heff_multipart}), where the reference-state dependent 0th order Hamiltonians are simply the ones introduced for the state-specific NEVPT2 method.

\section{Treatment of spin-dependent effects via 1st order QDPT}
In the present work, QDPT is the method of choice for comparison with the spin-dependent versions of our newly developed methods. In QDPT one starts with a set of scalar many-electron states $|\Psi_I^{SM}\rangle$. The full Hamiltonian $H^\text{scal} + V^\text{spin}$ is then diagonalized in the set of all $M$ components of these scalar-relativistic states. Usually, the scalar basis states are obtained from a CI procedure, e.g. CASCI or MRCI with single and double excitations (MRCISD)\nomenclature{MRCISD}{MRCI with single and double excitations}, i.e. they diagonalize the scalar part of the Hamiltonian. The matrix to be diagonalized in the QDPT procedure is then given by
\begin{equation}
\label{Eq:Heff_QDPT}
\langle \Psi_I^{SM}|H^\text{scal}+V^\text{spin}|\Psi_J^{S'M'}\rangle = \delta_{IJ} \delta_{SS'} \delta_{MM'} E_I^\text{scal} + \langle \Psi_I^{SM} | V^\text{spin} | \Psi_J^{S'M'}\rangle.
\end{equation}
The name \emph{quasidegenerate perturbation theory} becomes clear when comparing this to the expression Eq. (\ref{Eq:Heff0-2IN}) for the perturbative expansion of the intermediate normalization effective Hamiltonian: Up to 1st order in perturbation theory, the effective Hamiltonian is simply the matrix representation of the full Hamiltonian in the basis of states belonging to the model space. Here, the 0th order Hamiltonian is $H^\text{scal}$ and the perturbation $V^\text{spin}$. The term ``perturbation theory'' for this procedure has been criticized for being misleading and it was suggested that it could be better described as a contracted spin-orbit CI.\cite{BuenkALLH_1998_3400}

To improve the results compared to CASSCF/QDPT, a QDPT method involving NEVPT2 has been devised.\cite{DubocGSCN_2010_10750} Its basic idea is that the diagonal energies $E_I^\text{scal}$ in Eq. (\ref{Eq:Heff_QDPT}) are replaced by NEVPT2 energies, while the model space is still spanned by CASCI solutions. In this way, some effects of dynamic correlation can be introduced into the treatment. Such a strategy was also suggested for the RASSI-SO method\cite{MalmqRS_2002_230} and similar concepts have existed already for a long time.\cite{LlusaCBS_1996_5321, BaranS_2003_7439}

\section{Model Hamiltonians in chemistry}

In this section, we will take a closer look at two kinds of model Hamiltonians that are important in this work, namely different variations of spin Hamiltonians and the ligand field Hamiltonian.

\subsection{Spin Hamiltonians}
What is often called the ``true microscopic Hamiltonian'', i.e. the electronic Hamiltonian Eq. (\ref{Eq:nonelHamil}) including the scalar-relativistic and spin-dependent relativistic extensions discussed in Section \ref{Sec:Hamiltonians}, is actually already an effective Hamiltonian itself. It acts in a Hilbert space that is spanned by products $|\Phi_I^{SM}\rangle\otimes \bigotimes_{A=1}^{N_A}|M^A\rangle$, where the $|\Phi_I^{SM}\rangle$ are a complete basis of electronic states. For each nucleus $A$, only the $2I^A+1$ components with different $M^A$ of a single state with spin $I^A$ can be described. This means that states of the combined system in which a nucleus is in different states cannot be simultaneously described with the Hamiltonian above. An example for such states would be the ground state and 14.4 keV first excited state of the  \textsuperscript{57}Fe nucleus in an Fe-containing molecule, which are relevant for Mössbauer spectroscopy. The Hamiltonian only gives a subset of all physical states, and is hence an effective Hamiltonian. All information about the complex nuclear quantum state is condensed into a single parameter, the gyromagnetic ratio $\gamma_A$. This is an excellent approximation for chemistry, where energy scales are usually much smaller than the energies needed to excite nuclei, which are in the range of keV or larger.

Magnetic resonance experiments are usually interpreted in terms of so-called \emph{spin Hamiltonians} (SH)\nomenclature{SH}{Spin Hamiltonian}. The foundation of this is the observation that for the energy scales typically encountered in magnetic resonance ($1\text{cm}^{-1}$ and lower), only a few very low-lying electronic states are relevant. The microscopic Hamiltonian is then replaced by an effective Hamiltonian that operates only within the set of these low-energy states. If there are $2\tilde{S}+1$ relevant electronic states, they are typically interpreted as components of a spin multiplet with \emph{effective spin} $\tilde{S}$. This is not necessarily identical to the true spin $S$ of the electronic states in question. We use the tilde to distinguish the fictitious spin $\tilde{\mathbf{S}}$ introduced here from the physical spin $\mathbf{S}$. A complete basis for the operators in this space is given by the three effective spin operators $\tilde{S}_x, \tilde{S}_y, \tilde{S}_z$ as well as products of them.\cite{Griff_1960_457, Griff_1963_316, HeuveS_2013_54113} Traditionally, one often restricts the form of the SH to terms that are up to quadratic and bilinear in the spin operators. In this case, an arbitrary effective Hamiltonian can in general not be parametrized exactly. The SH is then written entirely in terms of spin operators and so-called \emph{spin Hamiltonian parameters}. These numbers are usually fitted to reproduce experimental results. However, they can also be connected to the underlying geometric and electronic structure by means of \textit{ab initio} theory. This allows to indirectly derive geometric and electronic structure information from spectroscopic experiments.\cite{Neese_2017_11003} Note that the microscopic Hamiltonian is already in spin Hamiltonian form for the nuclei, as seen by the presence of the nuclear spin $\mathbf{I}^A$ in Eq. (\ref{Eq:HHFC}), but not for the electrons.

In this work, we restrict ourselves to only two kinds of SHs. The first kind is used for orbitally nondegenerate molecules for which only the nonrelativistic ground state spin multiplet is relevant. The $2S+1$ components of a scalar ground state with spin $S$ form the model space for the SH, and in this case one can to a good approximation identify the fictitious spin above with the true spin of the system. The SH (up to bilinear in the spin operators) has the form
\begin{equation}
\label{Eq:SpinHamilIntrinsic}
H_\text{spin} = \mathbf{S}\mathbf{D} \mathbf{S} + \mu_B \mathbf{B}\mathbf{g}\mathbf{S} + \sum_A \mathbf{I}^A \mathbf{A}^A \mathbf{S}.
\end{equation}
Here  $\mathbf{B}$, $\mathbf{S}$, and $\mathbf{I}^A$ are vectors and vector spin operators, while $\mathbf{D}$, $\mathbf{g}$, and $\mathbf{A}^A$ are $3\times 3$ matrices and contain the parameters of the model Hamiltonian. $\mathbf{D}$ and $\mathbf{A}^A$ have units of energy (with $\mathbf{A}^A$ usually being given in MHz) and $\mathbf{g}$ is unitless. The expressions are interpreted as
\begin{equation}
\mathbf{S} \mathbf{D} \mathbf{S} = \sum_{i,j=1}^3 D_{ij} S_i S_j
\end{equation}
and similar for the remaining terms. $\mathbf{D}$ is called ZFS tensor or D-tensor. It describes the breaking of degeneracy of the $2S+1$ components of the ground multiplet even in the absence of external magnetic fields or magnetic nuclei. $\mathbf{g}$ is the g-tensor, which describes the interaction of the system with an external magnetic field, i.e. it parametrizes the system's magnetic dipole moment. Finally, $\mathbf{A}^A$ is the HFC tensor or A-tensor, which parametrizes the interaction of the electrons with nuclear magnetic moments. This means that it parametrizes the magnetic hyperfine field at the position of the respective nucleus, which is created by the spin and orbital movements of the electrons. It is common to transform the coordinate system to the principal axis frame of the D-tensor and characterize the latter by two parameters
\begin{align}
D &= D_{zz}-\frac{1}{2}(D_{xx}+ D_{yy}), \\
E &= \frac{1}{2}(D_{xx} - D_{yy})
\end{align}
called \emph{axial} and \emph{rhombic} ZFS parameters, respectively. The ratio $E/D$, called rhombicity, is often used instead of $E$. A commonly used convention for the coordinate system is such that $|D_{xx}|\leq|D_{yy}|\leq|D_{zz}|$, which leads to $0 \leq E/D \leq 1/3$.

For systems with an odd number of electrons, there is always an even degeneracy of electronic states in the absence of magnetic fields. This is the famous Kramers theorem, which is described in some detail in Appendix \ref{Sec:Kramers}. If there is no spatial symmetry, the degeneracy is twofold and the states are called Kramers doublets. The second kind of SH relevant in this work is one that acts on only the two degenerate components of a Kramers doublet as the model space. This corresponds to an effective spin of $\tilde{S}=1/2$. The SH reads
\begin{equation}
\label{Eq:SH_eff}
H_\text{spin} = \mu_B \mathbf{B}\mathbf{g}\tilde{\mathbf{S}} + \sum_A \mathbf{I}^A \mathbf{A}^A \tilde{\mathbf{S}}
\end{equation}
and describes the splitting of the Kramers degeneracy due to magnetic fields.
$\tilde {\mathbf{S}}$ is a vector of effective spin-1/2 operators that are defined as multiples of the Pauli matrices $\sigma_k$,
	\begin{equation}
	{\tilde S_k} = \frac{1}{2}{\sigma _k}.
	\end{equation}
Since these operators simply form a basis and do not have physical meaning like the real spin, they also do not have a well-defined behavior under rotation of the coordinate system. Hence, the parameters $\mathbf{g}$ and $\mathbf{A}^A$ in Eq. (\ref{Eq:SH_eff}) are no longer tensors, but should be called g-matrix and A-matrix instead.

Note that other terms than the ones introduced here can be added to the spin Hamiltonian, which are however less relevant for EPR. These include the nuclear Zeeman interaction, nuclear quadrupole interactions, and nuclear spin-spin interactions, among others.

\subsection{Ligand field theory}
\label{Sec:LFT}
Ligand field theory (LFT)\nomenclature{LFT}{Ligand field theory} is a powerful tool for the rationalization of the properties of transition metal (TM) complexes. At the heart of LFT is the finding that the ground state and some of the low-lying excited states of many TM complexes or lanthanide and actinide complexes can be qualitatively described as linear combinations of Slater determinants that only differ in the occupation of a set of five (for TM complexes) or seven (for lanthanide and actinide complexes) molecular orbitals (MOs)\nomenclature{MO}{Molecular orbital} that show similarities with the $d$ and $f$ orbitals of free atoms and ions. For simplicity, one also refers to these MOs as $d$ and $f$ orbitals, although they have covalent contributions from ligand orbitals. The theory can be based on an effective Hamiltonian of the form\cite{Griff_1971_}
\begin{equation}
\label{Eq:HLFT}
H^\text{LFT} = \sum_i h^\text{LFT}_i + \sum_{i<j}\frac{1}{r_{ij}}
\end{equation}
that acts in a model space of Slater determinants that are constructed by distributing electrons over the $d$ (or $f$) orbitals of transition metal (or lanthanide and actinide) complexes. Most importantly, the sums in Eq. (\ref{Eq:HLFT}) run only over the \emph{active} electrons, which occupy the $d$ or $f$ orbitals.
%The effective Hamiltonian Eq. (\ref{Eq:HLFT}) can actually easily be derived via diagrammatic techniques, as shown in \textcolor{red}{the appendix}.
The one-electron ligand field operator $h^\text{LFT}$ contains not only the electronic kinetic energy and nuclear attraction, but also the Coulomb and exchange field created by all electrons in closed shells, e.g. core electrons on the metal center and electrons in ligand orbitals. The matrix representation of the LFT Hamiltonian in the basis of these Slater determinants is a function of a $5\times 5$ or $7\times 7$ ligand field matrix $h^\text{LFT}_{pq}$ and of the ERIs involving the $d$ or $f$ orbitals. With one additional assumption, namely that the orbitals transform like pure $d$ or $f$ orbitals among each other under rotations, the latter integrals can be written in terms of three (four) parameters $A$, $B$, $C$ ($F_0$, $F_2$, $F_4$, $F_6$) for TM complexes (lanthanide or actinide complexes).\cite{Griff_1971_} This is the most widespread parametrization of LFT. It follows from this discussion that the LFT model can exactly parametrize the CASCI matrix for free atoms or ions, where the assumption of spherical $d$ or $f$ orbitals is exactly fulfilled.

Traditionally, the parameters of the model are obtained by a fit to experimental properties such as excitation energies, thermochemical data, EPR spectra or magnetization curves, among many others. There have been some noticeable early successes of this procedure, for example the explanation of the trends in the heats of hydration of the first row TMs using ligand field splittings deduced from absorption spectroscopy.\cite{Orgel_1952_4756, GriffO_1957_381, HolmeM_1957_1686} In fact, ligand field parameters are invaluable and intuitively appealing guides to a host of chemical and physical trends of TM-containing compounds. However, in general -- and in particular for low-symmetry situations -- fits of the LFT model to experimental data are often severely underdetermined. Consequently, the obtained model parameters may have only limited physical content. It is then appealing to resort to theory for their definition, as is explained later. 


\section{Ab initio calculation of spin Hamiltonian parameters}
We now come to the calculation of EPR spin Hamiltonian parameters from first principles. We first describe two methods to extract \emph{intrinsic} spin Hamiltonians, where the effective spin can be identified with the physical spin. One of them starts with scalar wavefunctions and adds the effects of spin-dependent operators via degenerate perturbation theory. In this way the structure of a spin Hamiltonian arises quite naturally. In the other method, one starts with states that already contain the effect of SOC up to infinite order. An exact (infinite order) effective Hamiltonian is then constructed from these states, which is fitted via the spin Hamiltonian model.
Finally, we also describe a novel method for the extraction and analysis of effective spin-1/2 Kramers doublet spin Hamiltonians.

\subsection{Derivation of spin Hamiltonians by DPT}
\label{Sec:DPT2_SHparameters}
Spin Hamiltonians arise very naturally by using DPT. Consider an orbitally non-de\-gen\-er\-ate scalar-relativistic ground state with spin $S$ that is well separated from excited states. Using the $2S+1$ components of this ground multiplet as a model space, one can use DPT, Eq. (\ref{Eq:HeffDPT}), with the spin-dependent and external-field-dependent parts of the Hamiltonian as a perturbation. Up to 2nd order, this gives the effective Hamiltonian
\begin{equation}
\label{Eq:SH_DPT2_Heff}
\begin{split}
\langle \Psi_0^{SM} | H^\text{eff} | \Psi_0^{SM'}\rangle &= \delta_{MM'}E_0^{(0)} + \langle \Psi_0^{SM} | V^\text{spin} | \Psi_0^{SM'}\rangle \\
&- \sum_{b\neq 0, M_b}\Delta_b^{-1}\langle \Psi_0^{SM} | V^\text{spin} | \Psi_b^{S_b M_b}\rangle \langle \Psi_b^{S_b M_b} | V^\text{spin} | \Psi_0^{SM'}\rangle.
\end{split}
\end{equation}
The various operators in $V^\text{spin}$ give contributions that can be parametrized in the form of the spin Hamiltonian Eq. (\ref{Eq:SpinHamilIntrinsic}).\cite{NeeseS_2003_345} In particular, for $\mathbf{D}$ there is a 1st order contribution from $H_\text{SSC}$ and a 2nd order contribution that is quadratic in $H_\text{SOC}$. For $\mathbf{g}$ there is a 1st order contribution due to the spin Zeeman operator and a 2nd order contribution that is linear in both the orbital Zeeman operator and $H_\text{SOC}$. For $\mathbf{A}$ there are finally two 1st order contributions due to the FC and SD contributions to the magnetic hyperfine field and a 2nd order contribution that is linear in both the NOC contribution to the magnetic hyperfine field and $H_\text{SOC}$. Here and in the following we drop the label $A$ for the nucleus on the HFC matrix $\mathbf{A}$ if there is no danger of confusion. For this work, only the contributions to $\mathbf{g}$ and $\mathbf{A}$ are important for interpretative purposes. They are given by
\begin{align}
g_{kl}^\text{spin} &= \delta_{kl}g_e, \label{Eq:g_spin}\\ 
g_{kl}^{\text{orb/SOC}} &= - \frac{1}{S} \sum_{\substack{b \\ (S_b = S)}}\Delta_b^{-1} \left[ \langle \Psi_0^{SS} | L_k | \Psi_b^{SS}\rangle \langle \Psi_b^{SS} | \sum_i z_i^l s_i^z | \Psi_0^{SS} \rangle + \text{c.c.}\right] \label{Eq:g_orb_SOC}
\end{align}
and
\begin{align}
A_{kl}^\text{FC} &= \delta_{kl} \frac{1}{S} \alpha^2 \gamma_A \frac{g_e}{2} \frac{8\pi}{3} \langle \Psi_0^{SS}|\sum_i \delta^3(\vec r_{iA}) s_i^z  | \Psi_0^{SS}\rangle, \label{Eq:DPT_AFC}\\ 
A_{kl}^\text{SD} &=  \frac{1}{S} \alpha^2 \gamma_A \frac{g_e}{2} \langle \Psi_0^{SS}|\sum_i \frac{3 r_{iA}^k r_{iA}^l - \delta_{kl}r_{iA}^2}{r_{iA}^5} s_i^z | \Psi_0^{SS}\rangle, \label{Eq:DPT_ASD}\\ 
 A_{kl}^{\text{NOC/SOC}} &= - \frac{1}{S} \alpha^2 \gamma_A \sum_{\substack{b \\ (S_b = S)}} \Delta_b^{-1} \left[ \langle \Psi_0^{SS} | \sum_i \frac{l_i^{A,k}}{r_{iA}^3} | \Psi_b^{SS}\rangle \langle \Psi_b^{SS} | \sum_i z_i^l s_i^z | \Psi_0^{SS} \rangle + \text{c.c.}\right] \label{Eq:DPT_ANOC_SOC} 
\end{align}
Here, c.c. denotes the complex conjugate of the term that is explicitly written out.
These expressions are well-known in the literature.\cite{McWee_1992_}\cite{NeeseS_2003_345} For completeness, we re-derive them using the notation of this work in Appendix \ref{Sec:appendix_DPT_SH}.
For the interested reader we also present in the appendix the derivation of one of the most complicated examples, the 1st order contribution to the D-tensor that arises from SSC. It should be noted that these expressions can be reformulated in the linear response framework, to avoid explicit sums over states.\cite{Neese_2017_1} Both approaches for the calculation of spin Hamiltonian parameters fail whenever the 2nd order of DPT is not sufficiently converged. This is the case if SOC is too strong or if there are low-lying excited states, such that the energy denominators get small.

\subsection{Exact effective Hamiltonian treatment}
The four spin-dependent operators that we are considering in this work can be put into two groups.
On the one hand, there is SOC and SSC, which are intrinsic properties of the electronic system. Furthermore, they can be strong enough to influence the electronic structure significantly. Hence, the treatment of these effects using DPT2 can lead to large errors and in these cases an infinite order treatment is mandatory.
The basic idea is therefore to obtain the relativistic wavefunctions $|\Psi_I\rangle$ and energies $E_I^\text{SOC+SSC}$ from a calculation that explicitly includes SOC and/or SSC. The Zeeman interaction and magnetic hyperfine interactions are usually weaker and hence a 1st order quasidegenerate perturbative treatment within the lowest $2S+1$ relativistic states is justified. An exception that is not relevant for the current work are very strong external magnetic fields. The total energy and eigenstates (including Zeeman and magnetic hyperfine interactions) are then given by the diagonalization of the matrix $\langle \Psi_I | (H_\text{scalar}+H_\text{SOC}+H_\text{SSC}+H_\text{Zeeman}+H_\text{HFC})|\Psi_J\rangle$. This gives energies $E_I^\text{total}$ that include the effect of the Zeeman and HFC interactions and states $|\Psi_I^\text{total}\rangle$ that are a unitary transformation of the $2S+1$ states $|\Psi_I\rangle$. The des Cloizeaux effective Hamiltonian Eq. (\ref{Eq:HeffCVV}), which has these energies as eigenvalues and the symmetrically orthogonalized projection $|\tilde{\Psi}_I^\text{total}\rangle^\text{L}$ of these states as eigenstates, can be written as
\begin{equation}
\begin{aligned}
H^\text{eff} &= \sum_I |\tilde{\Psi}_I^\text{total}\rangle^\text{L} E_I^\text{total} \langle \tilde{\Psi}_I^\text{total}|^\text{L}    \\
&= \sum_I |\tilde{\Psi}_I\rangle^\text{L} E_I^\text{SOC+SSC} \langle \tilde{\Psi}_I|^\text{L} +   \sum_{IJ} |\tilde{\Psi}_I\rangle^\text{L} \langle \Psi_I|(H_\text{Zeeman}+H_\text{HFC})|\Psi_J\rangle \langle \tilde{\Psi}_J |^\text{L}.
\end{aligned}
\end{equation}
Here, $|\tilde{\Psi}_I\rangle^\text{L}$ are the Löwdin symmetrically orthogonalized projections of the $|\Psi_I\rangle$ on the space spanned by the $2S+1$ degenerate components of the scalar ground state spin multiplet.
Inserting Eqs. (\ref{Eq:HHFC}) and (\ref{Eq:HZeeman}), the previous equation can be written
\begin{equation}
  \begin{aligned}
    H^\text{eff} &= \sum_I |\tilde{\Psi}_I\rangle^\text{L} E_I^\text{SOC+SSC} \langle \tilde{\Psi}_I|^\text{L} \\
               &+ \frac{1}{2} \mathbf{B} \cdot \sum_{IJ} |\tilde{\Psi}_I \rangle^\text{L} \langle \Psi_I | (\mathbf{L} + g_e \mathbf{S}) | \Psi_J \rangle \langle \tilde{\Psi}_J |^\text{L} \\
               &+ \sum_A \mathbf{I}^A \cdot \sum_{IJ} |\tilde{\Psi}_I \rangle^\text{L}\langle \Psi_I | (-\gamma^A \mathbf{B}_\text{HFC}(\mathbf{R}_A)) | \Psi_J \rangle\langle \tilde{\Psi}_J |^\text{L}.
  \end{aligned}
\end{equation}
Comparison with the spin Hamiltonian Eq. (\ref{Eq:SpinHamilIntrinsic}) shows that one can associate the following objects with each other:
\begin{align}
  \mathbf{S} \mathbf{D} \mathbf{S} &= \sum_I |\tilde{\Psi}_I\rangle^\text{L} E_I^\text{SOC+SSC} \langle \tilde{\Psi}_I|^\text{L}, \\
  \mathbf{g}\mathbf{S} &= \sum_{IJ} |\tilde{\Psi}_I \rangle^\text{L} \langle \Psi_I | (\mathbf{L} + g_e \mathbf{S}) | \Psi_J \rangle \langle \tilde{\Psi}_J |^\text{L}, \\
  \mathbf{A}^A\mathbf{S} &= - \gamma^A \sum_{IJ} |\tilde{\Psi}_I \rangle^\text{L}\langle \Psi_I |  \mathbf{B}_\text{HFC}(\mathbf{R}_A) | \Psi_J \rangle\langle \tilde{\Psi}_J |^\text{L}. \label{Eq:Heff_Amatrix_fitting}
\end{align}
Note that the 2nd and 3rd equations are vector equations, i.e. each consists of three equations at once.
One can determine the parameters $\mathbf{D}, \mathbf{g}, \mathbf{A}$ from these equations by linear least-squares fitting. The solution is uniquely determined since the model is linear.\cite{Penro_1956_17}

For ZFS, the outlined procedure was introduced by Maurice \textit{et al.}\cite{MauriBGSMG_2009_2977}. The extraction of the g-matrix along these lines is to the best of our knowledge unpublished, but has been available in ORCA for a long time. The extraction of the HFC matrix according to Eq. (\ref{Eq:Heff_Amatrix_fitting}) is a new contribution of the present work.

\subsection{Extraction and analysis of effective spin Hamiltonian parameters}
In EPR spectroscopy, one is often only interested in the 1st order energy change due to Zeeman and hyperfine interactions of a single Kramers doublet. Consider the two states $|\Phi \rangle $ and $|\bar \Phi \rangle $ of the Kramers doublet that have been obtained by a calculation including SOC and/or SSC. The 1st order energy changes can then be obtained by diagonalizing the matrix representation of the Zeeman and HFC operators in the basis of the two Kramers doublet states (1st order degenerate perturbation theory, DPT1).

By defining the elements of the dimensionless g-matrix via\cite{LanCY_2015_1750}
	\begin{align}
	\label{Eq:gl1}
	{g_{l1}} &=  - 4\Re \langle \bar \Phi |M_l^{{\text{el}}}|\Phi \rangle  = 2\Re \langle \bar \Phi |{L_l} + {g_e}{S_l}|\Phi \rangle,  \\
	\label{Eq:gl2}
	{g_{l2}} &=  - 4\Im \langle \bar \Phi |M_l^{{\text{el}}}|\Phi \rangle  = 2\Im \langle \bar \Phi |{L_l} + {g_e}{S_l}|\Phi \rangle, \\
	\label{Eq:gl3}
	{g_{l3}} &=  - 4\langle \Phi |M_l^{{\text{el}}}|\Phi \rangle  = 2\langle \Phi |{L_l} + {g_e}{S_l}|\Phi \rangle, 
	\end{align} 	
one can see that the DPT1 effective Hamiltonian for the Zeeman operator can be exactly parametrized via
	\begin{equation}
	{{\mathbf{H}}^{{\text{Zeeman}}}} = \frac{1}{2}{\mathbf{B}} {\mathbf{g}} \tilde {\mathbf{S}}.
	\end{equation} 	
This parametrization is possible because the magnetic dipole moment operator is odd under time-reversal; hence $\langle \bar \Phi |M_l^{{\text{el}}}|\bar \Phi \rangle  =  - \langle \Phi |M_l^{{\text{el}}}|\Phi \rangle $. See Appendix \ref{Sec:TimeReversal} for a derivation of this relation.

Similarly, since the operator of the hyperfine field is also odd under time reversal, the DPT1 effective Hamiltonian for the hyperfine interaction operator can be parametrized as
	\begin{equation}
	{{\mathbf{H}}^{{\text{HFC}}}} = \sum\limits_A {{{\mathbf{I}}^A}} {\mathbf{A}^A} \tilde {\mathbf{S}}
	\end{equation} 	
by defining the elements of the A-matrix via
	\begin{align}
	\label{Eq:Al1}
	A_{l1}^A &=  - 2{\gamma ^A}\Re \langle \bar \Phi |B_{{\text{HFC}}}^l({{\mathbf{R}}_A})|\Phi \rangle,  \\
	\label{Eq:Al2}
	A_{l2}^A &=  - 2{\gamma ^A}\Im \langle \bar \Phi |B_{{\text{HFC}}}^l({{\mathbf{R}}_A})|\Phi \rangle, \\
	\label{Eq:Al3}
	A_{l3}^A &=  - 2{\gamma ^A}\langle \Phi |B_{{\text{HFC}}}^l({{\mathbf{R}}_A})|\Phi \rangle. 
	\end{align}
There are two major differences between these results and the results of the previous section. The model space for the intrinsic spin Hamiltonians was a scalar ground state spin multiplet. This is not necessary here, where the model space is spanned by relativistic states that can include SOC and SSC. Furthermore, the parametrization in this section is exact, while for the procedure described in the previous section only a fit of the spin Hamiltonian to the \textit{ab initio} effective Hamiltonian is performed.

By making the proper choice of coordinate system and basis of the Kramers doublet, one can make the g-matrix or A-matrix diagonal (however in general not both at the same time, unless the molecule possesses some symmetry). An easy way to accomplish this is by singular value decomposition (SVD)\nomenclature{SVD}{Singular value decomposition}.
Given the g-matrix, one can perform an SVD
	\begin{equation}
	{\mathbf{g}} = {\mathbf{\tilde U}}{{\mathbf{\tilde g}}_{{\text{diag}}}}{{\mathbf{\tilde V}}^T},
	\end{equation} 	
where ${\mathbf{\tilde U}}$ and ${\mathbf{\tilde V}}$ are $O(3)$ matrices. We can multiply them by their own determinant (which is $ \pm 1$) to obtain matrices ${\mathbf{U}}$ and ${\mathbf{V}}$ that are from $SO(3)$. With their help one can define a new matrix
	\begin{equation}
	\label{Eq:gdiag}
	{{\mathbf{g}}_{{\text{diag}}}} = {{\mathbf{U}}^T}{\mathbf{gV}}
	\end{equation} 	
that is also diagonal. Its diagonal values are the three g-values. Note that in this procedure the sign of the g-matrix is preserved, since ${\text{det}}({{\mathbf{g}}_{{\text{diag}}}}) = {\text{det}}({\mathbf{g}})$ and all g-values have the same sign. This is because the singular values, which are the diagonal elements of ${{\mathbf{\tilde g}}_{{\text{diag}}}}$, are all positive. This is in contrast to the equation proposed by Gerloch and McMeeking\cite{GerloM_1975_2443} and first used by Bolvin \textit{et al.} in the context of \textit{ab initio} calculations,\cite{Bolvi_2006_1575} which can be used to obtain the magnitude of g-values but not their sign.
The matrix ${\mathbf{U}}$ corresponds to a rotation of the coordinate system, while the matrix ${\mathbf{V}}$ can be associated with a unitary transformation of the two states $|\Phi \rangle $ and $|\bar \Phi \rangle $ of the Kramers doublet, via the two-to-one map from $SU(2)$ to $SO(3)$.\cite{AbragB_2012_} We report in the results chapters g-shifts, which are defined as the deviation of the g-values from the free-electron g-value,
	\begin{equation}
	\Delta g = g - {g_e}.
	\end{equation} 	
Similarly, one can find two different $SO(3)$ matrices ${\mathbf{U}}$ and ${\mathbf{V}}$ such that the A-matrix is brought into diagonal form via
	\begin{equation}
	\label{Eq:Adiag}
	{{\mathbf{A}}_{{\text{diag}}}} = {{\mathbf{U}}^T}{\mathbf{AV}}.
	\end{equation} 	
Both the electronic magnetic moment operator and the hyperfine field operator consist of several terms. The magnetic moment has orbital and spin contributions, while the hyperfine field has a FC, SD and NOC contribution. Since the g-matrix and A-matrix, as defined in Eqs. (\ref{Eq:gl1})--(\ref{Eq:gl3}) and Eqs. (\ref{Eq:Al1})--(\ref{Eq:Al3}), are both linear in these operators, we can write them as sums over contributions from these several terms. We can then transform these contributions separately via Eqs. (\ref{Eq:gdiag}) and (\ref{Eq:Adiag}). The diagonal elements of the resulting matrices are interpreted as contributions of the individual operators to the g-values or HFCCs.

\section{Ab initio ligand field theory}
\label{Sec:AILFT_theory}
In the following, we give an overview of the basic ideas of the \textit{ab initio} ligand field theory (AILFT)\nomenclature{AILFT}{\textit{Ab initio} LFT} as described in the original article introducing the idea\cite{AtanaGSN_2012_149} and a recent review paper.\cite{SinghEAN_2017_2}
AILFT is based on the observation that the matrix representation of the LFT model Hamiltonian
\begin{equation}
\label{Eq:HLFT_linear}
H_{IJ}^{{\text{LFT}}}({\mathbf{p}}) = \sum\limits_k {H_{IJ}^{{\text{LFT}},k}} {p_k}
\end{equation}
is linear in the parameters $\mathbf{p}$, collected here in a vector. The parameters ${\mathbf{p}}$ include the 15 (for a $d^n$ configuration) or 28 (for a $f^n$ configuration) elements of the one-electron ligand field Hamiltonian $h^\text{LFT}$, and the electron repulsion parameters $B$ and $C$ (for a $d^n$ configuration) or $F_2$, $F_4$, $F_6$ (for a $f^n$ configuration). Note that more than one electron or hole is necessary to define electron repulsion parameters, and that $C$ is nonredundant only if more than one multiplicity block is considered. In general, there is more than one possible multiplicity for a given $d^n$ configuration, meaning that the Hamiltonian matrix can have an additional index next to $IJ$ that signifies the multiplicity. In the following, all these indices are treated as a compound index. One can then write Eq. (\ref{Eq:HLFT_linear}) in the form of the matrix-vector equation
\begin{equation}
\mathbf{H}^\text{LFT}(\mathbf{p}) = \mathbf{A} \mathbf{p}.
\end{equation}
Here, $\mathbf{H}^\text{LFT}(\mathbf{p})$ is the vectorized form of the LFT Hamiltonian Eq. (\ref{Eq:HLFT_linear}) and the matrix $\mathbf{A}$ is defined by ${A_{IJ,k}} = H_{IJ}^{{\text{LFT}},k}$.
The LFT Hamiltonian is then identified with an \textit{ab initio}-derived effective Hamiltonian $H_{IJ}^{{\text{eff}}}$, e.g. the CASCI Hamiltonian, describing the same part of the electronic spectrum. The optimal parameters describing the \textit{ab initio} Hamiltonian are obtained by least-squares fitting with the model Hamiltonian, which for linear models has a unique solution given by\cite{Penro_1956_17}
\begin{equation}
\label{Eq:linearmodel_solution}
{\mathbf{p}} = {{\mathbf{A}}^ + }{{\mathbf{H}}^{{\text{eff}}}}.
\end{equation}
Here, ${{\mathbf{A}}^ + }$ is the Moore-Penrose pseudoinverse of the matrix $\mathbf{A}$. If the parameters are nonredundant and there are more matrix elements than parameters (meaning that the system is not underdetermined), one can express the pseudoinverse as
\begin{equation}
{{\mathbf{A}}^ + } = {({{\mathbf{A}}^T}{\mathbf{A}})^{ - 1}}{{\mathbf{A}}^T}.
\end{equation}
This allows to relate Eq. (\ref{Eq:linearmodel_solution}) to the equations given in the original AILFT reference,\cite{AtanaGSN_2012_149}
\begin{align}
{\mathbf{p}} &= {({{\mathbf{A}}^{{\text{LFT}}}})^{ - 1}}{{\mathbf{b}}^{{\text{LFT}}}},\\
	A_{kl}^{{\text{LFT}}} &= \sum\limits_{IJ} {H_{IJ}^{{\text{LFT}},k}} H_{IJ}^{{\text{LFT}},l},\\
	b_k^{{\text{LFT}}} &= \sum\limits_{IJ} {H_{IJ}^{{\text{LFT}},k}} H_{IJ}^{{\text{eff}}}.
\end{align}

\chapter{Theory and implementation}
\section{DCD-CAS(2)}
\subsection{Application of the intermediate Hamiltonian to the multireference dynamic correlation problem}
The goal of our work is to develop a method that can be written as a dressed CASCI problem, where the dressing accounts for the effects of dynamic electron correlation in a perturbative way. Quite generally, a CAS space contains a large amount of superfluous information and very high energy determinants. Hence, a straightforward application of effective Hamiltonian concepts according to Bloch or des Cloizeaux would lead to intruder state problems in almost all practical applications. However, in most cases, we are only interested in a few low-lying states. These low-lying states will be dominated by only a few CSFs or determinants. Conceptually, these low-lying CSFs span the main model space of our treatment. Which and how many CSFs should be considered as belonging to the main model space depends of course very much on the system and active space. Fortunately, it will not be necessary in the 2nd order variant of our method to draw a sharp line between main model space and the remaining CSFs in the CAS, as is explained below. 
In Section \ref{Sec:GDPT} the treatment was quite general. In order to be more specific, we apply the IEH for a degenerate main model space to the treatment of dynamic correlation. We note that one is in general interested in more than one single root and that these roots should have different 0th-order energies from a physical point of view. This deficiency will later be corrected by applying a second step called “bias correction” to correct the energies of our method. We now define the model space to be a CAS($N$,$M$) space (with $N$ electrons in $M$ orbitals) composed of spin-adapted CSFs $\left\{ {\left| {\Phi _I^{SM}} \right\rangle } \right\}$. The superscript $SM$ refers to the quantum numbers of the total spin and the projection onto the $z$-axis. We will drop this superscript for the nonrelativistic treatment developed here, where only the principal component with $M = S$ is required. It will, however, be crucial for dealing with spin-dependent relativistic effects later. 

The goal of the development of DCD-CAS(2) is to define an effective Hamiltonian ${H^{{\text{DCD}}}}$ in the CAS($N$,$M$) space that adds to the CASCI matrix a state-independent dressing that incorporates dynamic correlation effects to 2nd order in the fluctuation potential into the treatment. Diagonalization of the dressed CASCI matrix then yields the actual correlated many-particle states in terms of only the model-space CSFs.

In our formulation we do not explicitly define which part of the CASCI space forms the main model space and which part the intermediate space. As an example, consider the problem of two exchange-coupled spin-1/2 systems (Section \ref{Sec:Exchange}). In order to describe the energy difference between the lowest triplet and the lowest singlet state correctly, one must allow for state mixing between a low-energy neutral singlet and a high-energy ionic singlet. The singlet main model space would naturally only contain the neutral singlet, since this corresponds to the root of interest. In our approach, it is not necessary to make this choice explicitly.

Regarding the choice of 0th order Hamiltonian, we do not have to define the operator $H_{0, \text{i}}$ because this choice has no effect on the form of the DCD-CAS(2) Hamiltonian. However, it would become important at higher orders of perturbation theory. One possible explicit choice consists in taking the main model space to be spanned by the CASCI ground state and taking the whole $H_0$ of Eq. (\ref{Eq:H0_intermediateHamiltonian}) to be identical to the Dyall Hamiltonian. In this case, $E_0$ of Eq. (\ref{Eq:GDPT_Hamil}) would be the CASCI ground state energy. The main model space energy $E_0$ must be chosen such that it is a reasonable 0th order energy for all roots of interest, which will usually be the ground state and the first few excited states. A safe choice will be the CASCI energy of the lowest state in a state-averaged calculation. This guarantees numerical stability since it is unlikely that the energy difference in the denominator will approach zero. As one reviewer of our initial paper on DCD-CAS(2)\cite{PathaLN_2017_234109} correctly remarked, with this choice our approach is also formally equivalent to a Bloch effective Hamiltonian, which has no intermediate space at all, acting in the whole CASCI space and with deficient 0th order energies for higher excited states. Interestingly, Brandow in his early papers advocated this possibility to freely choose the 0th order Hamiltonian such that the whole model space is degenerate, and to add any degeneracy-breaking parts to the perturbation.\cite{Brand_1967_771, Brand_1979_207} For the action of the 0th order Hamiltonian in the outer space we choose the Dyall Hamiltonian, which was introduced in Eq. (\ref{Eq:HDyall}) in the context of the NEVPT2 method,
			\begin{equation}
			{H_{0,{\text{outer}}}} = {P_{{\text{outer}}}}{H^{{\text{Dyall}}}}{P_{{\text{outer}}}}.
			\end{equation}						
The orbital invariance of $H^\text{Dyall}$ is a prerequisite for the orbital invariance of DCD-CAS(2), which is proven in Section \ref{Ap:OrbitalInv}.
In the definition of the Fock matrix from which the Dyall Hamiltonian is defined, $D_{rs}$ is a suitable density matrix. Since we aim for the correct description of more than one state, we use the state-averaged density matrix of the underlying state-averaged CASSCF calculation throughout this work. This defines a \emph{state-averaged} Dyall Hamiltonian. This kind of 0th order Hamiltonian was already experimentally employed for the treatment of mixed-valence compounds \cite{PastoHELMMAC_2008_174102, PastoHAELC_2009_12} and is the standard choice for the MPS-NEVPT2 method.\cite{SharmJA_2016_34103} From now on, we assume canonical orbitals, which diagonalize the Fock matrices, $F_{ij}=\epsilon_i \delta_{ij}$ and $F_{ab}=\epsilon_a \delta_{ab}$.

Since the BO Hamiltonian contains only one- and two-electron excitation operators, one can restrict the sum over the outer space perturbers in Eq. (\ref{Eq:GDPT_Hamil}) to functions in the FOIS. In our implementation this space contains all CSFs with the desired spin multiplicity that can be constructed from configurations (CFGs)\nomenclature{CFG}{Configuration} that differ by at most two excitations from some CFG in the CASCI space. By CFG, we mean a set of orbital occupation numbers that can be 0,1 or 2. In general, each CFG generates a number of CSFs that differ by the specific spin coupling of the unpaired electrons in singly occupied MOs (SOMOs)\nomenclature{SOMO}{Singly occupied MO}. Here and in the following, we will use indices $K$ and $L$ for perturbers. The matrix representation of the DCD-CAS(2) Hamiltonian in the CSF basis is then simply given by
          \begin{equation}
          \label{Eq:Heff_DCD}
          H_{IJ}^{{\text{DCD}}} = \langle {{\Phi _I}|H|{\Phi _J}} \rangle  - \sum\limits_{K \in {\text{FOIS}}} {\frac{{\langle {{\Phi _I}|H|{{\tilde \Phi }_K}} \rangle \langle {{{\tilde \Phi }_K}|H|{\Phi _J}} \rangle }}{{{E_K} - {E_0}}}}, 
          \end{equation}	
where the perturbers fulfill the eigenvalue equation
\begin{equation}
\label{Eq:DCD_perturbers}
{P_{{\text{FOIS}}}}{H^{{\text{Dyall}}}}{P_{{\text{FOIS}}}}|{\tilde \Phi _K}\rangle  = E_K^{}|{\tilde \Phi _K}\rangle. 
\end{equation}						
It is readily seen that this is simply the CASCI matrix dressed with a correction that accounts for dynamic correlation to 2nd order, which explains the name for our method. There is only a single $E_0$ chosen as the ground-state CASCI energy, instead of many $I$-dependent $E_0$ as in QDPT. This makes intruder states less likely and imparts Hermiticity to the proposed DCD-CAS(2) Hamiltonian. Note that this expression for the effective Hamiltonian is formally identical to the (shifted) $B_k$ method. The latter however uses simple CSFs as perturbers and expectation values of the full Hamiltonian as 0th order energies (EN 0th order Hamiltonian). DCD-CAS(2) differs substantially in this respect since it uses the Dyall Hamiltonian. As already mentioned in the introduction of this thesis, the EN denominators have the well-known disadvantages of destroying size consistency and unitary invariance on top of being computationally expensive, since a subset of the integrals with four virtual labels is required to compute them. It has also been pointed out by Malrieu \textit{et al.}\cite{MalriNS_1994_1440} that the shifted $B_k$ is equivalent to the original GDPT Intermediate Hamiltonian, from which we derived our working equation. The same expression for the effective Hamiltonian has also been applied to reduced model spaces based on a CAS.\cite{StaroD_1998_435} While the present work was in progress, a method with a very similar spirit that is also based on the IEH concept was proposed for the calculation of magnetic exchange couplings.\cite{TentiMAC_2016_18365}
The $|{\tilde \Phi _K}\rangle $ in Eqs. (\ref{Eq:Heff_DCD}) and (\ref{Eq:DCD_perturbers}) are linear combinations of elementary CSFs obtained by diagonalizing the Dyall Hamiltonian in the relevant excitation subspaces (see Section \ref{Sec:DiagDyall} below). These are different from the elementary CSFs $|{\Phi _K}\rangle $ that correspond to specific CFGs, which is why we use the tilde to distinguish them. Details on this aspect can be found in the implementation section.



\subsection{Perturbative correction for excitation energies}
\label{Sec:PerturbativeCorr}
The DCD-CAS(2) Hamiltonian is a 2nd order approximation to an IEH that yields exact (correlated) energies and the projection of the exact states onto the CASCI space for all states where ${E_0}$ can be considered a suitable 0th order energy. Using the ground state CASCI energy as ${E_0}$ will, in most cases, lead to good results for the ground state, even if the CASCI ground state may not be a good approximation for the projection of the true ground state. For excited states with small excitation energies, one expects that this ${E_0}$ will also be a reasonable 0th order energy. However, for higher excited states, the CASCI ground state energy is too low to be a reasonable ${E_0}$ at 2nd order. Thus, the higher the excitation energy of a given state, the more the method will underestimate the effect of dynamic correlation, leading to DCD-CAS(2) excitation energies that are too large. This behavior can be called a ``bias toward the ground state'' or ``ground state bias''.
Assuming that one wants to describe a state for which a more reasonable main model space energy is given by ${E_0} + \Delta $, the geometric series
\begin{equation}
\label{Eq:geometricseries}
\frac{1}{{1 - x}} = \sum\limits_{n = 0}^\infty  {{x^n}} \quad {\text{for |x|}} < 1
\end{equation}								
can be used with $x=\Delta/(E_K - E_0)$ to obtain the state-specific dressing matrix
\begin{equation}
\label{Eq:HDCD_statespecific}
\begin{split}
  H_{IJ}^{{\text{DCD}},(2)}(\Delta ) &=  - \sum\limits_{K \in FOIS} {\frac{{\left\langle {\Phi _I^{}|H|\tilde \Phi _K^{}} \right\rangle \left\langle {\tilde \Phi _K^{}|H|\Phi _J^{}} \right\rangle }}{{E_K^{} - (E_0^{} + \Delta )}}}  \hfill \\
  \,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\, &=  - \sum\limits_{n = 0}^\infty  {{\Delta ^n}} \sum\limits_{K \in {\text{FOIS}}}^{} {\frac{{\left\langle {\Phi _I^{}|H|\tilde \Phi _K^{}} \right\rangle \left\langle {\tilde \Phi _K^{}|H|\Phi _J^{}} \right\rangle }}{{{{(E_K^{} - E_0^{})}^{n + 1}}}}}.  \hfill \\ 
\end{split} 
\end{equation}				
This series expansion converges if ${E_0} + \Delta  < {E_K}$ for all perturbers. Hence, one can construct state-specific DCD-CAS(2) Hamiltonians from state-specific values of $\Delta$ by truncating the series expansion in Eq. (\ref{Eq:HDCD_statespecific}) after a few terms. The most straightforward approach would be to diagonalize the effective Hamiltonians including these dressings separately to obtain the respective states. Such an approach would however yield states that are not orthonormal.

We therefore follow a different approach. We assume that there is an ${E_0}$ (the ground state CASCI energy) that yields after the diagonalization of the DCD-CAS(2) Hamiltonian qualitatively correct projected states $|{\tilde \Psi _I}\rangle$ for all the targeted roots. If this is true, one can correct the energies by taking the expectation value of the state-specific dressings in Eq. (\ref{Eq:HDCD_statespecific}). 							
Using only the term that is 1st order in $\Delta_I$ gives
\begin{equation}
\label{Eq:biascorr1}
\Delta {E_I} =  - {\Delta _I}\sum\limits_{K \in {\text{FOIS}}} {\frac{{\langle {{\tilde \Psi }_I}|H|{{\tilde \Phi }_K}\rangle \langle {{{\tilde \Phi }_K}|H|{\tilde \Psi }_I}\rangle}}{{{{({E_K} - {E_0})}^2}}}} 
\end{equation}		
as the correction to the energy of the state $|\tilde{\Psi}_I\rangle$. We define the correction to the main model space energy to be
\begin{equation}
{\Delta _I} = \langle {\tilde \Psi _I}|H|{\tilde \Psi _I}\rangle  - {E_0}.
\end{equation}	
This defines the bias-corrected DCD-CAS(2) method. Note that the condition ${E_0} + \Delta  < {E_K}$ is not necessarily fulfilled for high energy roots, which means that the bias correction can potentially re-introduce intruder states that were avoided by using the ground state CASCI energy as $E_0$.
In this case the state-specific nature of the correction ensures that lower states are not affected.		
We will show in Chapter \ref{Sec:Benchmarking} that bias correction leads to significant improvements in the calculated excitation energies. The efficiency of this 1st order approach (where the energy is linear in the shift) could have been anticipated from the fact that the interpolation technique used in the shifted $B_k$ method leads to essentially straight lines.\cite{NitzsD_1978_3103} It is also important to note at this point that the bias correction, in addition to providing better estimates of excitation energies (which was our primary goal in developing it), also corrects the ground state energy. Especially in cases where the ground state strongly mixes with excited states, the CASSCF $E_0$ is not a good approximation for the ground state itself and the bias correction might become important.

\subsection{Implementation}
As will be shown in Section \ref{Sec:DCD_cost}, the cost of a DCD-CAS(2) calculation increases steeply with the size of the active space, which renders the method practical only for rather small active spaces. In these cases, a CASCI-size matrix can be held in memory entirely. We therefore do not resort to direct CI techniques like the Davidson method\cite{David_1975_87} for diagonalization of the DCD-CAS(2) Hamiltonian, but instead construct it explicitly and use simple linear algebra routines to diagonalize it.
In the following section we describe the construction of the DCD-CAS(2) effective Hamiltonian in our implementation in the ORCA electronic structure program.\cite{Neese_2018_1327} There are two main tasks in this context. The first is the diagonalization of the Dyall Hamiltonian to obtain the perturbers of Eq. (\ref{Eq:DCD_perturbers}). 
Knowing the rotation matrices for the perturbers $|\tilde{\Phi}_K\rangle$ that diagonalize the Dyall Hamiltonian, the calculation of the matrix elements $\langle {\Phi _I^{}|H|\tilde \Phi _K^{}} \rangle $, which occur in the numerator of the DCD-CAS(2) Hamiltonian, essentially boils down to the calculation of matrix elements $\langle {\Phi _I^{}|H|\Phi _K^{}} \rangle $ involving only elementary perturber CSFs. This is the second main task. 
 
\subsubsection{Diagonalization of the Dyall Hamiltonian}
\label{Sec:DiagDyall}
Using canonical orbitals, the Dyall Hamiltonian Eq. (\ref{Eq:HDyall}) is given by
\begin{equation}
H^\text{Dyall} = C + \sum_i \epsilon_i N_i + \sum_a \epsilon_a N_a + H^\text{Dyall}_\text{act},
\end{equation}
where $N_p = E_{pp}$ is the occupation number operator for orbital $p$. All CSFs are eigenfunctions of these occupation number operators, and hence they cannot induce mixing between different CSFs. The Dyall Hamiltonian contains true (non-occupation-number) excitation operators only for active orbital indices and therefore does not mix perturbers from different $S_l^{(k)}$ subspaces. This means that the Dyall Hamiltonian is block diagonal and can be diagonalized within each $S_l^{(k)}$ block separately. Within each $S_l^{(k)}$ block, the non-active part $H_{{\text{inact}}}^{{\text{Dyall}}} + H_{{\text{virt}}}^{{\text{Dyall}}} + C$ is a constant matrix and therefore does not need to be considered in the diagonalization. If for example orbitals $i$, $j$ are depopulated and orbitals $a$, $b$ are populated as compared to the reference CASCI functions, the value of this constant is $\epsilon_a+\epsilon_b-\epsilon_i-\epsilon_j+E_\text{Closed}$. One therefore just needs to diagonalize $H_{{\text{act}}}^{{\text{Dyall}}}$ within each of the $S_l^{(k)}$ spaces. At this point it is necessary to think about the structure of the perturber CSFs. The different spin-adapted CSFs belonging to the subspace $S_l^{(k)}$ can be expanded as a sum over antisymmetrized products
\begin{equation}
\label{Eq:structure_CSF}
\left| {\Phi _K^l} \right\rangle  = \sum\limits_\mu  {\left| {\Phi _\mu ^l\Psi _{K,\mu }^{}} \right\rangle }, 
\end{equation}									
where $\left\{ {\left| {\Phi _\mu ^l} \right\rangle } \right\}$ is a complete set of non-active determinants belonging to the non-active electron configuration $l$. There are $2^N$ such functions for $N$ non-active SOMOs and $\mu$ is a label to distinguish them. $\left\{ {\left| {\Psi _{K,\mu }^{}} \right\rangle } \right\}$ is a set of active-orbital wavefunctions that do not depend on the specific orbital indices in $l$, but only on the occupation pattern. With non-active and active-orbital states, we mean states in which only non-active or active orbitals have nonzero occupation numbers, respectively. See Appendix \ref{Ap:DiagDyallAux} for a proof of Eq. (\ref{Eq:structure_CSF}). In total there are 15 occupation patterns, as detailed in Table \ref{Tab:ExcitationClasses}.
\begin{table}
\centering
\small
\ttabbox
{\caption{Conventional excitation class subspaces and their corresponding non-active occupation patterns.}
\label{Tab:ExcitationClasses}}
{\begin{tabular}{cc}
\hline\hline
Excitation class subspaces &	Non-active occupation patterns \\ \hline
$S_{ij,ab}^{(0)}$	&(20|...|20), (11|...|20), (20|...|11), (11|...|11) \\
$S_{i,ab}^{( - 1)}$ &	(21|...|20), (21|...|11) \\
$S_{ab}^{( - 2)}$	& (22|...|20), (22|...|11) \\
$S_{ij,a}^{( + 1)}$	& (20|...|10), (11|...|10) \\
$S_{ij}^{( + 2)}$	& (20|...|00), (11|...|00) \\
$S_{i,a}^{(0)}$	& (21|...|10) \\
$S_a^{( - 1)}$	& (22|...|10) \\
$S_i^{( + 1)}$	& (21|...|00) \\ \hline\hline
\end{tabular}}
\end{table}
In this list, we show the occupation numbers of two inactive orbitals and of two virtual orbitals, separated by |...|, which is a placeholder for the active occupation numbers. All other inactive orbitals are doubly occupied, all other virtual orbitals empty. With the structure of the perturbers given in Eq. (\ref{Eq:structure_CSF}), the matrix elements of $H_{{\text{act}}}^{{\text{Dyall}}}$ are clearly of the form
\begin{equation}
\label{Eq:HDyallact_ME}
\langle {\Phi _K^l|H_{{\text{act}}}^{{\text{Dyall}}}|\Phi _L^l} \rangle  = \sum\limits_\mu  {\langle {\Psi _{K,\mu }^{}|H_{{\text{act}}}^{{\text{Dyall}}}|\Psi _{L,\mu }^{}} \rangle }. 
\end{equation}					
One can see that the matrix elements do not depend on the specific orbital indices in $l$, but only on the occupation pattern. In practice we therefore diagonalize $H_{{\text{act}}}^{{\text{Dyall}}}$ only once for each of the 15 occupation patterns. For each occupation pattern we construct a prototype space of CSFs, which contains only two inactive and two virtual orbitals. The rotation matrices ${C_{LK}}$ and active energies $E_K^{{\text{act}}}$ obtained from diagonalization of $H_{{\text{act}}}^{{\text{Dyall}}}$ in this prototype space are then valid for all subspaces $S_l^{(k)}$,
\begin{equation}
 |{\tilde \Phi _K^l} \rangle  = \sum\limits_L {C_{LK}^{}| {\Phi _L^l} \rangle },
 \end{equation}
 \begin{equation}
 H^\text{Dyall}_\text{act} |\tilde{\Phi}_K^l\rangle = E_K^\text{act} |\tilde{\Phi}_K^l\rangle
\end{equation}									
and depend not on $l$, but only on the occupation pattern to which $l$ belongs.
\subsubsection{Calculation of Matrix Elements between reference CSFs and perturbers}
The task of calculating the matrix elements $\langle {\Phi _I^{}|H|\Phi _K^{}} \rangle $ can be simplified by using the fact that $\langle {\Phi _I^{}|H|\Phi _K^{}} \rangle  = \langle {\Phi _I^{}|V{{_l^{(k)}}^\dag }|\Phi _K^{}} \rangle$ if $| {{\Phi _K}} \rangle $ belongs to the subspace $S_l^{(k)}$. Here $V_l^{(k)}$ is one of the perturbation operators introduced in NEVPT2.\cite{AngelCM_2002_9138} The operator $V_l^{(k)}$ is simply defined to consist of all terms of the Fock space Hamiltonian that result in a function within the subspace $S_l^{(k)}$ when acting on a function in the CASCI space. 
The perturbation operators are given by (assuming $i\leq j, a \leq b$ throughout)
\begin{align}
  V_{ij, ab}^{(0)} &= \gamma_{ij} \gamma_{ab} ((ai|bj) E_{ai} E_{bj} + (aj|bi) E_{aj} E_{bi}), \\
  V_{i, ab}^{(-1)} &= \gamma_{ab} \sum_t ((ai|bt) E_{ai} E_{bt} + (at|bi) E_{at} E_{bi}), \\
  V_{ij, a}^{(+1)} &= \gamma_{ij} \sum_t ((aj|ti) E_{aj} E_{ti} + (ai|tj) E_{ai} E_{tj}, \\
  V_{ab}^{(-2)} &= \gamma_{ab} \sum_{tu} (at|bu) E_{at} E_{bu}, \\
  V_{ij}^{(+2)} &= \gamma_{ij} \sum_{tu} (ti|uj) E_{ti} E_{uj}, \\
  V_{i, a}^{(0)} &= \sum_{tu} ((ai|tu) E_{ai} E_{tu} + (ti|au) E_{ti} E_{au}) + h_{ai}^\text{eff} E_{ai}, \\
  V_a^{(-1)} &= \sum_{tuv} (at|uv) E_{at} E_{uv} + \sum_t h^{\prime\text{eff}}_{at} E_{at}, \\
  V_i^{(+1)} &= \sum_{tuv}(ti|uv) E_{ti}E_{uv} + \sum_t h^\text{eff}_{ti} E_{ti}
\end{align}
with $h^\text{eff}_{pq}$ being defined in Eq. (\ref{Eq:heff}) and
\begin{equation}
  h^{\prime\text{eff}}_{pq} = h^\text{eff}_{pq} - \sum_t (pt|tq),
\end{equation}
\begin{equation}
\gamma_{pq} = 1 - \delta_{pq}/2 = \begin{cases} 1 \quad\text{if} \quad p\neq q \\ 1/2 \quad \text{otherwise} \end{cases}.
\end{equation}
As can be seen from these equations, each perturbation operator can be written as $V_l^{(k)} = V(1) + V(2)$, where $V(1)$ and $V(2)$ contain only one-particle excitations ($E_{pq}$) and two-particle excitations ($E_{pq}E_{rs}$), respectively. 
The matrix elements of the two-particle perturbation operators depend on the coupling coefficients $\left\langle {{\Phi _I}} \right.\left| {E_{pq}E_{rs}} \right.\left| {{\Phi _K}} \right\rangle $, of which there is a large number.
In order to circumvent having to store all double-excitation coupling coefficients, we made use of a resolution of the identity (RI)\nomenclature{RI}{Resolution of the identity} technique in our original DCD-CAS(2) implementation.\cite{PathaLN_2017_234109} A similar approach was proposed by Siegbahn for his direct CI method.\cite{Siegb_1984_417} We first construct all CFGs $\tilde R$ that are connected to at least one reference CFG and one perturber CFG by a single excitation $E_{pq}$. This defines an RI space. We then calculate the single excitation coupling coefficients 
\begin{equation}
(A_{pq}^{\tilde I,\tilde R})_{IR} = \langle \Phi_I | E_{pq} | \Phi_R\rangle
\end{equation}
between all CSFs belonging to the CFGs $\tilde I$ and $\tilde R$ (and similarly for $\tilde K$ and $\tilde R$). One can then write
  	 	  \begin{equation}
  	 	  \label{Eq:TwoElCouplingCoeff}
  	 	  \begin{aligned}
  	 	  \langle \Phi _I^{}|E_{pq}E_{rs}|\Phi _K^{}\rangle  &= \sum_{\tilde{R} \in \text{RI space}} \sum_R \langle \Phi _I^{}|E_{pq}|\Phi_R\rangle \langle \Phi_R |E_{rs}|\Phi _K^{}\rangle\\
  	 	  &=\sum\limits_{\tilde R \in {\text{RI - space}}} {{{\left( {\mathbf{A}_{pq}^{\tilde I,\tilde R} {{(\mathbf{A}_{sr}^{\tilde K,\tilde R})}^T}} \right)}_{IK}}}. 
  	 	  \end{aligned}
  	 	  \end{equation}				
In practice, all configurations $\tilde I$ and $\tilde K$ that are connected by a single excitation to a certain RI configuration $\tilde R$ are stored together with the excitations $p \to q$ and $r \to s$ that connect them. For the calculation of the Hamiltonian matrix elements, one then loops over all $\tilde R$ and within this loop calculates for each pair of connected $\tilde I$ and $\tilde K$ the contribution given in Eq. (\ref{Eq:TwoElCouplingCoeff}) and multiplies by the corresponding integrals. It should be noted that the RI space does not have to be complete for this procedure to be exact. It is just necessary that it contains all CFGs that are connected by single excitations to reference and perturber CFGs. To be more exact, this approach therefore does not use a ``resolution of the identity'', but a ``resolution of a projector''. In the subspaces considered here, this projector is equivalent to the identity.
The coupling coefficient matrices $\mathbf{A}_{pq}^{\tilde I,\tilde R}$ do not depend on the specific non-active occupation patterns. They are therefore determined only once for the prototype perturber CFGs containing two inactive and two virtual labels that we introduced for the diagonalization of the Dyall Hamiltonian in the previous section. In the calculation of the perturbation contribution, the actual orbital index is then only important in determining the integrals.
While a two-electron contribution exists for all perturbation operators, $V(1)$ is zero for the excitation spaces $S_{ij,ab}^{(0)}$, $S_{i,ab}^{( - 1)}$, $S_{ab}^{( - 2)}$, $S_{ij,a}^{( + 1)}$ and $S_{ij}^{( + 2)}$.
Only for the three remaining types of perturber spaces there are one-electron excitations. For these classes, the coupling coefficient matrices $\mathbf{A}_{pq}^{\tilde I,\tilde K}$ (where $p \to q$ is the excitation that connects the two CFGs) are precomputed for all reference CFGs $\tilde I$ and perturber CFGs $\tilde K$ that are connected to them by a single excitation. The one-electron parts of the matrix elements between functions belonging to such a pair of CFGs are then simply given by $\mathbf{A}_{pq}^{\tilde I,\tilde R}$ multiplied by some appropriate integral. The description given so far applies to the implementation of DCD-CAS(2) as described in our initial publication of the method.\cite{PathaLN_2017_234109}

Later we recognized that this is not the most efficient way to implement DCD-CAS(2).
The key observation for making a more efficient implementation is the following:
For the four (we leave out $S_{ij,ab}^{(0)}$ since it is treated separately, see Section \ref{Sec:Efficient_ijab} below) excitation classes that contain only doubly excited perturbers,
the perturbation operators are
\begin{align}
  V_{i, ab}^{(-1)} &= \sum_v ((ai|bv) E_{ai} E_{bv} + (av|bi) E_{av} E_{bi}), \\
  V_{i, aa}^{(-1)} &= \sum_v (ai|av) E_{ai} E_{av}, \\
  V_{ij, a}^{(+1)} &= \sum_v ((aj|vi) E_{aj} E_{vi} + (ai|vj) E_{ai} E_{vj}, \\
  V_{ii, a}^{(+1)} &= \sum_v (ai|vi) E_{ai} E_{vi}, \\
  V_{ab}^{(-2)} &= \sum_{vw} (av|bw) E_{av} E_{bw}, \\
  V_{aa}^{(-2)} &= \frac{1}{2} \sum_{vw} (av|aw) E_{av} E_{aw}, \\
  V_{ij}^{(+2)} &= \sum_{vw} (vi|wj) E_{vi} E_{wj}, \\
  V_{ii}^{(+2)} &= \frac{1}{2} \sum_{vw} (vi|wi) E_{vi} E_{wi}.
\end{align}
It can be seen that there are at most one or two terms in the perturbation operator that contribute
to a given matrix element $\langle \Phi_I | H | \Phi_K \rangle$. This is because the CSFs $|\Phi_K\rangle$ have well-defined active occupation numbers and therefore only one of the terms in the sums over active orbitals can contribute. This means
that for not too large active spaces, we can precalculate the double excitation
coupling coefficients once (using the prototype perturber spaces) and hold them in memory.

Table \ref{table:occpattMEs} shows the matrix elements for all different kinds of perturbers.
Note that for the cases where 2 occupation numbers change in the active space, one has to distinguish
the cases where both active orbitals are identical or different.
\begin{table}
\centering
\small
  \caption[Matrix elements between reference CFGs and perturber CFGs.]{Matrix elements between reference CFGs and perturber CFGs for the different possible excitations.}
  \label{table:occpattMEs}
  \begin{tabular}{ccc}
    \hline\hline
    Occupation pattern & Kind of perturber & Matrix element $\langle \Phi_I| H | \Phi_K \rangle$ \\ \hline
    21|...|11 & $it \rightarrow ab$ & $(ia|tb) \langle \Phi_I | E_{ia} E_{tb} | \Phi_K \rangle + (ta|ib) \langle \Phi_I | E_{ta} E_{ib} | \Phi_K \rangle$ \\ 
    21|...|20         & $it \rightarrow aa$ & $(ia|ta) \langle \Phi_I | E_{ia} E_{ta} | \Phi_K \rangle$ \\
    11|...|10        & $ij \rightarrow ta$ & $(ja|it) \langle \Phi_I | E_{ja} E_{it} | \Phi_K \rangle + (ia|jt) \langle \Phi_I | E_{ia} E_{jt} | \Phi_K \rangle $ \\
    20|...|10         & $ii \rightarrow ta$ & $(ia|it) \langle \Phi_I | E_{ia} E_{it} | \Phi_K \rangle $ \\
    22|...|11         & $tu \rightarrow ab$ & $(ta|ub) \langle \Phi_I | E_{ta} E_{ub} | \Phi_K \rangle + (ua|tb) \langle \Phi_I | E_{ua} E_{tb} | \Phi_K \rangle $ \\
             & $tt \rightarrow ab$ & $(ta|tb) \langle \Phi_I | E_{ta} E_{tb} | \Phi_K \rangle $ \\
    22|...|20         & $tu \rightarrow aa$ & $(ta|ua) \langle \Phi_I | E_{ta} E_{ua} |\Phi_K \rangle $\\
             & $tt \rightarrow aa$ & $\frac{1}{2}(ta|ta) \langle \Phi_I | E_{ta} E_{ta} |\Phi_K \rangle $\\
    11|...|00         & $ij \rightarrow tu$ & $(it|ju) \langle \Phi_I | E_{it} E_{ju} | \Phi_K \rangle + (iu|jt) \langle \Phi_I | E_{iu} E_{jt} | \Phi_K \rangle $ \\
             & $ij \rightarrow tt$ & $(it|jt) \langle \Phi_I | E_{it} E_{jt} | \Phi_K \rangle$ \\
    20|...|00         & $ii \rightarrow tu$ & $(it|iu) \langle \Phi_I | E_{it} E_{iu} | \Phi_K \rangle $ \\
             & $ii \rightarrow tt$ & $\frac{1}{2}(it|it) \langle \Phi_I | E_{it} E_{it} | \Phi_K \rangle $ \\
    \hline\hline
  \end{tabular}
\end{table}
It is now easy to see that redundant work was done in our original DCD-CAS(2) algorithm. Let $|\Phi_K\rangle$ for example be a perturber from the $S_{i, ab}^{(-1)}$ space that is connected to the reference CSF $|\Phi_I\rangle$ by a double excitation $it\rightarrow ab$. Then the RI space in our initial DCD-CAS(2) implementation contains four RI CFGs, which are connected to the reference CFG by the excitations $i\rightarrow a$, $i\rightarrow b$, $t\rightarrow a$, and $t\rightarrow b$. But this means that the same contributions are calculated redundantly, since for example $\langle \Phi_I|E_{ia}E_{tb}|\Phi_K\rangle = \langle \Phi_I|E_{tb}E_{ia}|\Phi_K\rangle$.

The improved algorithm proceeds as follows for every occupation pattern: First one loops over all prototype reference CFGs and perturber CFGs. If they are connected
via the Hamiltonian, the active orbitals $t$ (and $u$) are determined and the necessary two-electron coupling coefficients are calculated. We then loop over
all possible nonactive orbitals and all connected CFG pairs. For each such pair we multiply the coupling coefficient matrices with the corresponding integral
and add the results up to get the matrix element $\langle \Phi_I | H | \Phi_K \rangle$. Algorithm \ref{algorithm:matrixelements} shows this in more detail for the $S_{i, ab}^{(-1)}$ space.
\begin{algorithm}
  \caption{Algorithm for computing perturbative corrections for the five excitation classes with only pure double excitations. This scheme shows the procedure for the example of the $S_{i, ab}^{(-1)}$ perturber space.}
  \label{algorithm:matrixelements}
  \begin{algorithmic}[1]
    \State{\textit{\# Build coupling coefficients for prototype configurations}}
    \For{all reference CFGs $I$}  
      \For{all perturber CFGs $K$}
        \If{$I$ and $K$ are connected}
          \State{Determine and save active orbital $t$ that is involved in excitation}
          \State{Retrieve coupling coefficients from container}
          \State{\parbox{11.5cm}{Multiply coupling coefficients to obtain $\langle \Phi_I | E_{ia} E_{tb} | \Phi_K \rangle$ and $\langle \Phi_I | E_{ib} E_{ta} | \Phi_K \rangle$}}
        \EndIf
      \EndFor
    \EndFor
    \State{\textit{\# Compute perturbative correction for all $i, ab$}}
    \For{all inactive orbitals $i$}
      \State{For all $t$ read integrals $\mathbf{K}^{ti}$ from disk}
      \For{all virtual pairs $a<b$}
        \For{all reference CFGs $I$}
          \For{all perturber CFGs $K$ connected to $I$}
            \State{\parbox{11.5cm}{Multiply copies of double excitation coupling coefficient matrices with integrals $(tb|ia)$ and $(ta|ib)$}}
            \State{Add contributions to $\langle \Phi_I | H | \Phi_K \rangle$ matrix for current $i, ab$}
          \EndFor
        \EndFor
        \State{\parbox{11.5cm}{From $\epsilon_i, \epsilon_a, \epsilon_b$ and active energies, calculate denominators for all perturber CSFs}}
        \State{Calculate perturbative correction for given $i, a, b$ and add it to total}
      \EndFor
    \EndFor
  \end{algorithmic}
  
\end{algorithm}
\subsubsection{Efficient treatment for $ij\rightarrow ab$ perturbers and the difference-dedicated scheme}
\label{Sec:Efficient_ijab}
The $S_{ij,ab}^{(0)}$ perturber functions have a special structure since they are connected to reference functions by excitations involving only non-active indices. This allows to carry out much of the calculation of the contribution to the DCD-CAS(2) Hamiltonian analytically, rendering the computational treatment highly efficient. This is similar to NEVPT2, where the contribution of the $S_{ij,ab}^{(0)}$ space to the correlation energy is the same (and equal to the MP2 expression) for the uncontracted, partially contracted, and strongly contracted variant.

We start by writing the DCD-CAS(2) Hamiltonian not in the basis of reference CSFs $\left| {{\Phi _I}} \right\rangle $, but instead in the basis of CASCI roots $\left| {{\Psi _I}} \right\rangle $. For given orbitals $i,j,a,b$, the perturber functions from the linear span of the functions $E_{ai}E_{bj}\left| {{\Psi _I}} \right\rangle $ and $E_{bi}E_{aj}\left| {{\Psi _I}} \right\rangle $ are eigenfunctions of $H_{{\text{act}}}^{{\text{Dyall}}}$ with eigenvalue $E_I^{{\text{act}}} = \langle {\Psi _I}|H_{{\text{act}}}^{{\text{Dyall}}}|{\Psi _I}\rangle $. All other perturbers from $S_{ij,ab}^{(0)}$, which are orthogonal to this linear span, obviously cannot interact through the BO Hamiltonian with $\left| {{\Psi _I}} \right\rangle $. The contribution to the DCD-CAS(2) Hamiltonian due to the $ij\rightarrow ab$ class can therefore be written as
\begin{equation}
\langle \Psi_I | H_{ij,ab}^{\text{DCD}, (2)} | \Psi_J\rangle = - \delta_{IJ} \sum_{\substack{i\leq j \\ a \leq b}} \frac{\langle \Psi_I | H P_{S_{ij,ab}^{(0)}} H | \Psi_I\rangle}{\epsilon_a + \epsilon_b - \epsilon_i - \epsilon_j + E_\text{Closed} + E_I^\text{act} - E_0},
\end{equation}
where ${P_{S_{ij,ab}^{(0)}}}$ is the projector on the subspace $S_{ij,ab}^{(0)}$ and we used that the non-active part of the Dyall Hamiltonian contributes $\epsilon_a+\epsilon_b-\epsilon_i-\epsilon_j+E_\text{Closed}$ to the 0th order energy of a perturber. The numerator also occurs in the context of the strongly-contracted NEVPT2 method and is known to be equal to the squared norm of the strongly contracted perturbers.\cite{AngelCM_2002_9138} It has the value
\begin{equation}
\langle {\Psi _I}|H{P_{S_{ij,ab}^{(0)}}}H|{\Psi _I}\rangle  = N_{ij,ab}^{(0)} = 4{\gamma _{ij}}{\gamma _{ab}}[{(ib|ja)^2} - (ib|ja)(ia|jb) + {(ia|jb)^2}].
\end{equation}		
Inserting this into the formula above, we arrive at the equation
\begin{equation}
\label{Eq:ijab_matrixel}
\langle \Psi_I | H_{ij,ab}^{\text{DCD}, (2)} | \Psi_J\rangle = - \delta_{IJ} \sum_{\substack{i\leq j \\ a \leq b}} \frac{4{\gamma _{ij}}{\gamma _{ab}}[{(ib|ja)^2} - (ib|ja)(ia|jb) + {(ia|jb)^2}]}{\epsilon_a + \epsilon_b - \epsilon_i - \epsilon_j + E_\text{Closed} + E_I^\text{act} - E_0}.
\end{equation}				
Thus, while the matrix elements for this excitation class are the by far most numerous, they are also easy to handle since not much logic is involved in their processing. We also see that this excitation class only provides contributions to the diagonal elements of the DCD-CAS(2) Hamiltonian (in the basis of CASCI roots). However, the contribution is not independent of the specific diagonal element. If this was the case, the entire spectrum would just shift by the same value and excitation energies would be rigorously independent of the excitation class $ij\rightarrow ab$. This is the most important idea underlying the difference-dedicated CI (DDCI)\nomenclature{DDCI}{Difference-dedicated CI} method\cite{MiralCCM_1993_33, GarciCCM_1995_222} in which this excitation class is eliminated from the treatment. This reduces the computational burden significantly and also greatly reduces the size-consistency error, while having only little effect on vertical excitation energies. We note however that this class of excitations can be important for excitation energies at higher orders of the correlation treatment. In the way we have chosen the 0th order Hamiltonian, a dependence on the actual wavefunction $\left| {{\Psi _I}} \right\rangle$ remains through the denominator.
At this stage, it is worthwhile to look back at the reason for choosing the CASSCF ground state energy as the main model space energy, namely in order to avoid intruder-state problems and non-Hermiticity of the Bloch effective Hamiltonian. Both these effects do not occur for the $ij\rightarrow ab$ class even if the Bloch effective Hamiltonian is chosen, as long as the energies of all CASCI roots are used as 0th order energies. In this case the contribution has the form of the MP2 correlation energy,
\begin{equation}
\label{Eq:ijab_MP2}
\langle \Psi_I | H^\text{MP2} | \Psi_J\rangle = - \delta_{IJ} \sum_{ijab} \frac{{(ib|ja)^2} - (ib|ja)(ia|jb) + {(ia|jb)^2}}{\epsilon_a + \epsilon_b - \epsilon_i - \epsilon_j}.
\end{equation}
This can be seen by removing the restrictions on the indices in the sum in Eq. (\ref{Eq:ijab_matrixel}) and using the permutation symmetry of the two-electron integrals. The $ij\rightarrow ab$ contribution therefore amounts to just a constant shift of the spectrum of the Hamiltonian, while having no effect on the eigenstates. In practice, the sums over indices are restricted like in Eq. (\ref{Eq:ijab_matrixel}) to reduce computational effort. Since we are interested in a good description of some low-lying excited states as well, it seems worthwhile to try to use this form of the $ij\rightarrow ab$ contribution instead of the one dictated by rigorously following the DCD-CAS(2) Hamiltonian formalism. Since the resulting excitation energies and states would be the same as when leaving out the $ij\rightarrow ab$ class completely, this amounts to the definition of a “difference-dedicated effective Hamiltonian”. Note that the correction in Eq. (\ref{Eq:ijab_MP2}) may still be important if potential energy surfaces are studied since it provides the largest contribution to the correlation energy. Therefore it is always included in the current implementation. We will investigate the performance of the difference-dedicated DCD-CAS(2) approach in Chapter \ref{Sec:Benchmarking}.

\subsubsection{RI-DCD-CAS(2)}
\label{Sec:RIDCD}
For single-reference MP2, there exists the very successful resolution of the identity MP2 (RI-MP2) approximation.\cite{FeyerFK_1993_359} It can significantly reduce the computational cost and storage requirements compared to the canonical MP2 method, while keeping the same formal scaling. Its basic idea is to decompose the 4-index ERIs into the contraction of 3-index quantities. The nowadays most commonly used variant inserts an approximate resolution of the identity in the Coulomb metric into the ERIs, i.e.
\begin{equation}
(ia|jb) \approx \sum_{KL} (ia|K)V_{KL}^{-1}(L|jb),
\end{equation}
where the $|K)$ are one-electron basis functions that span the so-called auxiliary basis set and 
\begin{equation}
V_{KL} = (K|L) = \iint \psi_K(\mathbf{r}_1) \frac{1}{r_{12}} \psi_L(\mathbf{r}_2) d\mathbf{r}_1 d\mathbf{r}_2
\end{equation}
is the overlap matrix between the auxiliary basis functions in the Coulomb metric. This was originally called the ``V approximation''.\cite{VahtrAF_1993_514} In practice, the inverse matrix is usually condensed into the auxiliary basis functions, e.g. symmetrically via
\begin{equation}
|\tilde{K}) = \sum_L |L) V_{LK}^{-1/2},
\end{equation}
which leads to
\begin{equation}
\label{Eq:RI_contraction}
(ia|jb) \approx \sum_K (ia|\tilde{K})(\tilde{K}|jb). 
\end{equation}
This corresponds to a Löwdin symmetric orthonormalization of the auxiliary basis functions in the Coulomb metric. In matrix notation, the contraction in Eq. (\ref{Eq:RI_contraction}) can be written as
\begin{equation}
\label{Eq:RI_contraction_matrix}
\mathbf{K}^{(ij)} = \mathbf{I}^{(i)T}\mathbf{I}^{(j)},
\end{equation}
where
\begin{equation}
I^{(i)}_{Ka} = (ia|\tilde{K})
\end{equation}
are matrices containing the 3-index integrals and the exchange integral matrices
\begin{equation}
K^{(ij)}_{ab} \approx (ia|jb)
\end{equation}
contain the RI-approximated 4-index integrals. In these equations, superscript labels are storage indices, while subscript labels are row and column indices of the matrices. 

Along those lines, we implemented an RI version of DCD-CAS(2), which is particularly suited for large systems where the storage of all 4-index integrals $(ia|jb)$ would be costly. It was inspired by the unpublished implementation of RI-NEVPT2 in ORCA. In an RI calculation, the contraction in Eq. (\ref{Eq:RI_contraction_matrix}) scales as the 5th power of the number of basis functions. Any redundancy in this step should therefore be avoided, especially for the excitation classes with two virtual labels, which dominate the computational cost. For these classes, we avoid reduncancy by always treating two excitation patterns together: (20|...|20) with (20|...|11), (11|...|20) with (11|...|11), (21|...|20) with (21|...|11) and (22|...|20) with (22|...|11).
For each set of inactive and/or active labels, we first contract the corresponding integral matrices as shown in Eq. (\ref{Eq:RI_contraction_matrix}). Then we use the obtained 4-index integrals to calculate their contributions in both relevant occupation patterns. As an example, the exchange integral matrix $\mathbf{K}^{(ii)}$ for a given inactive orbital $i$ can be used to calculate contributions to the correlation energy for both the (20|...|20) and the (20|...|11) occupation patterns.

\subsection{Different variants of DCD-CAS(2) investigated in this work}
\label{Sec:DCD_variants}
So far, we have introduced several different variants of DCD-CAS(2) that will be compared in Chapter \ref{Sec:Benchmarking}. We distinguish between the conventional scheme (DCD-CAS(2), fully including all excitation classes) and the ``difference-dedicated'' scheme DD-DCD-CAS(2) = D\textsuperscript{3}CD-CAS(2)\nomenclature{D\textsuperscript{3}CD-CAS(2)}{Difference-dedicated DCD-CAS(2)}. In this scheme, the $ij\rightarrow ab$ class is left out of the treatment and only a correction is made to the total energy that is equal for all roots (Eq. (\ref{Eq:ijab_MP2})). We also compare the performance of the bias correction scheme introduced in Section \ref{Sec:PerturbativeCorr} with the uncorrected DCD-CAS(2) energies. The bias correction (up to nth order) may be indicated by bc(n)-DCD-CAS(2) but we will leave out the parentheses for the 1st order correction Eq. (\ref{Eq:biascorr1}), which is our default choice. Hence, the difference-dedicated variant with a 1st order bias correction would be given the acronym bc-D\textsuperscript{3}CD-CAS(2)\nomenclature{bc-D\textsuperscript{3}CD-CAS(2)}{1st order bias-corrected D\textsuperscript{3}CD-CAS(2)}. These acronyms were only established for the purpose of comparison and were dropped once the most effective method was established.\cite{PathaLN_2017_234109}

\section{HQD-NEVPT2}
\label{Sec:HQD}
It was already mentioned in the introduction that we observed problems in DCD-CAS(2) that could be traced back to the use of a state-averaged Dyall Hamiltonian. We will present these results later in Section \ref{Sec:EPRsquareplanarCu}. This brought us to the idea of using multi-partitioning, which makes use of state-specific 0th order energies. In order to keep the desirable property of a Hermitian effective Hamiltonian that is present in the DCD-CAS(2) method, our aim was to formulate a form of multi-partitioning that leads to a Hermitian effective Hamiltonian, which is the topic of this section.

Our new idea was that in analogy to Eq. (\ref{Eq:QUXP_resolvent}) one can use multiple partitionings of the Hamiltonian to express the relevant block of the operator $G$ of the canonical Van Vleck approach as
	\begin{equation}
	\label{Eq:QGP_resolvent_new}
	QGP =  - \sum\limits_I {{R_I}} (I)[{H_0}(I),G]|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|.
	\end{equation}
Note that this expression is exact. Using the relation\cite{ShaviR_1980_5711}
	\begin{equation}[{H_0}(I),G] =  - [{V_D}(I),G] - {V_X}(I) - \frac{1}{3}[[{V_X}(I),G],G] -  \ldots ,\end{equation}

one can expand $G$ in powers of the perturbation operators $V(I)$ and compare both sides of Eq. (\ref{Eq:QGP_resolvent_new}) order by order. This leads to the explicit expressions
	\begin{equation}
	\label{Eq:QG1P_resolvent_new}
	Q{G^{(1)}}P = \sum\limits_I {{R_I}} (I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|,
	\end{equation}
	\begin{equation}
	\begin{aligned}
	Q{G^{(2)}}P &= \sum\limits_I {{R_I}} (I){V_D}(I){R_I}(I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| \\
	&- \sum\limits_{IJ} {{R_I}} (I){R_J}(J)H|\Psi _J^{(0)}\rangle \langle \Psi _J^{(0)}|{V_D}(I)|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|,
	\end{aligned}
	\end{equation}
	\begin{equation}\begin{gathered}
  Q{G^{(3)}}P = \sum\limits_I {{R_I}} (I){V_D}(I){R_I}(I){V_D}(I){R_I}(I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| \hfill \\
   - \sum\limits_{I,I'} {{R_I}} (I){V_D}(I){R_I}(I){R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|{V_D}(I)|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| \hfill \\
   - \sum\limits_{I,I'} {{R_I}} (I){R_{I'}}(I'){V_D}(I'){R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|{V_D}(I)|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| \hfill \\
   + \sum\limits_{I,I',I''} {{R_I}} (I){R_{I'}}(I'){R_{I''}}(I'')H|\Psi _{I''}^{(0)}\rangle \langle \Psi _{I''}^{(0)}|{V_D}(I')|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|{V_D}(I)|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| \hfill \\
   - \frac{1}{3}\sum\limits_{I,I'} {{R_I}} (I)H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}(I'){R_I}(I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| \hfill \\
   - \frac{2}{3}\sum\limits_{I,I'} {{R_I}} (I){R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_I}(I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| \hfill \\
   - \frac{1}{3}\sum\limits_{I,I'} {{R_I}} (I){R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}(I')H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|. \hfill \\ 
\end{gathered} \end{equation}
Similarly, higher orders can be obtained straightforwardly, although the explicit expressions in terms of the resolvent get quickly cumbersome. The canonical Van Vleck effective Hamiltonian can be written order by order as
	\begin{equation}{H^{{\text{eff}}(0 - 1)}} = PHP,\end{equation}
	\begin{equation}{H^{{\text{eff}}(2)}} = \frac{1}{2}P[H,{G^{(1)}}]P,\end{equation}
	\begin{equation}{H^{{\text{eff}}(3)}} = \frac{1}{2}P[H,{G^{(2)}}]P,\end{equation}
	\begin{equation}{H^{{\text{eff}}(4)}} = \frac{1}{2}P[H,{G^{(3)}}]P - \frac{1}{{24}}P[[[H,{G^{(1)}}],{G^{(1)}}],{G^{(1)}}]P.\end{equation}
These equations can be derived from Eq. (46) of Shavitt and Redmon\cite{ShaviR_1980_5711} by projection with $P$ from left and right. An important observation is that one can replace ${V_X}$ in these equations by $H$ since $P{V_X}Q = PHQ$. The equations for the effective Hamiltonian are apparently independent of a particular Hamiltonian partitioning. They only implicitly depend on the partitioning through the ${G^{(n)}}$.
The analogy to Eq. (\ref{Eq:Heff_IN}) in canonical Van Vleck perturbation theory is\cite{ShaviR_1980_5711}
	\begin{equation}
	{H^{{\text{eff}}(0 - 2)}} = PHP + \frac{1}{2}P[H,{G^{(1)}}]P.
	\end{equation}
Using the expression of ${G^{(1)}}$ in terms of the resolvent, Eq. (\ref{Eq:QG1P_resolvent_new}), this effective Hamiltonian can be written
	\begin{equation}\begin{gathered}
  {H^{{\text{eff}}(0 - 2)}} = PHP + \frac{1}{2}PHQ{G^{(1)}}P - \frac{1}{2}P{G^{(1)}}QHP \hfill \\
   = PHP + \frac{1}{2}\sum\limits_I P H{R_I}(I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}| + \frac{1}{2}\sum\limits_I | \Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|H{R_I}(I)HP \hfill \\ 
\end{gathered} \end{equation}
and its matrix representation is
	\begin{equation}\begin{gathered}
  H_{IJ}^{{\text{eff}}(0 - 2)} = {H_{IJ}} + \frac{1}{2}\sum\limits_K {\frac{{\langle \Psi _I^{(0)}|H|\Psi _K^{(0)}(J)\rangle \langle \Psi _K^{(0)}(J)|H|\Psi _J^{(0)}\rangle }}{{E_J^{(0)} - E_K^{(0)}(J)}}}  \hfill \\
   + \frac{1}{2}\sum\limits_K {\frac{{\langle \Psi _I^{(0)}|H|\Psi _K^{(0)}(I)\rangle \langle \Psi _K^{(0)}(I)|H|\Psi _J^{(0)}\rangle }}{{E_I^{(0)} - E_K^{(0)}(I)}}} . \hfill \\ 
\end{gathered} \end{equation}
Like Eq. (\ref{Eq:Hermitized}), this is simply the Hermitized version of the usual multi-partitioning QDPT effective Hamiltonian based on intermediate normalization,
	\begin{equation}
	\label{Eq:CVV_Hermitized_new}
	H_{({\text{MP-C}})}^{{\text{eff}}(0 - 2)} = \frac{1}{2}(H_{({\text{MP-I}})}^{{\text{eff}}(0 - 2)} + H{_{({\text{MP-I}})}^{{\text{eff}}(0 - 2)\dagger} }).
	\end{equation}
Here, the label MP stands for multi-partitioning. We should note that many popular quantum chemistry packages already implement Eq. (\ref{Eq:CVV_Hermitized_new}) by performing an \textit{ad hoc} Hermitization of the non-Hermitian effective Hamiltonian even for methods based on multi-partitioning. In contrast to such approaches, the multi-partitioning version of canonical Van Vleck perturbation theory has been obtained here for the first time on a sound theoretical basis, which endows the results with a clear physical meaning.
For completeness, we also write out the 3rd and 4th order in more detail, for which one obtains
	\begin{equation}
	\begin{aligned}
	H_{IJ}^{{\text{eff}}(3)} &= \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}(J)V(J){R_J}(J)H|\Psi _J^{(0)}\rangle  \\
	&- \frac{1}{2}\sum\limits_{I'} {\langle \Psi _I^{(0)}|H{R_J}(} J){R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|V(J)|\Psi _J^{(0)}\rangle  + {\text{H}}{\text{.c}}{\text{.,}}
	\end{aligned}
	\end{equation}
	\begin{align*}
  &H_{IJ}^{{\text{eff}}(4)} = \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}(J)V(J){R_J}(J)V(J){R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   &- \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}(J)V(J){R_J}(J)\sum\limits_{I'} {{R_{I'}}} (I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|V(J)|\Psi _J^{(0)}\rangle  \hfill \\
   &- \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}(J)\sum\limits_{I'} {{R_{I'}}} (I')V(I'){R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|V(J)|\Psi _J^{(0)}\rangle  \hfill \\
   &+ \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}(J)\sum\limits_{I'} {{R_{I'}}} (I')\sum\limits_{I''} {{R_{I''}}} (I'')H|\Psi _{I''}^{(0)}\rangle \langle \Psi _{I''}^{(0)}|V(I')|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|V(J)|\Psi _J^{(0)}\rangle  \hfill \\
   &- \frac{1}{6}\langle \Psi _I^{(0)}|H{R_J}(J)H\sum\limits_{I'} {|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}(I')} {R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\ \stepcounter{equation}\tag{\theequation}
   &- \frac{1}{3}\langle \Psi _I^{(0)}|H{R_J}(J)\sum\limits_{I'} {{R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H} {R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   &- \frac{1}{6}\langle \Psi _I^{(0)}|H{R_J}(J)\sum\limits_{I'} {{R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H} {R_{I'}}(I')H|\Psi _J^{(0)}\rangle  \hfill \\
   &+ \frac{1}{{24}}\langle \Psi _I^{(0)}|H\sum\limits_{I'} {{R_{I'}}} (I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}(I'){R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   &+ \frac{1}{{12}}\langle \Psi _I^{(0)}|H{R_I}(I)H\sum\limits_{I'} {|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}} (I'){R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   &+ \frac{1}{{24}}\langle \Psi _I^{(0)}|H{R_I}(I)\sum\limits_{I'} {{R_{I'}}} (I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_J}(J)H|\Psi _J^{(0)}\rangle  + {\text{H}}{\text{.c}}{\text{.}} \hfill \\ 
\end{align*}
Here, H.c. stands for the Hermitian conjugate of all terms that are explicitly written out. If the $|\Psi _I^{(0)}\rangle $ are CASCI states and CASCI energies are used as 0th order energies like for the Dyall Hamiltonian, the 1st order correction to the effective Hamiltonian vanishes, $\langle \Psi _{I'}^{(0)}|V(J)|\Psi _J^{(0)}\rangle  = 0.$ Then the resulting corrections to the effective Hamiltonian are given by the simplified expressions
	\begin{equation}H_{IJ}^{{\text{eff}}(3)} = \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}(J)V(J){R_J}(J)H|\Psi _J^{(0)}\rangle  + {\text{H}}{\text{.c}}{\text{.,}}\end{equation}
	\begin{equation}\begin{gathered}
  H_{IJ}^{{\text{eff}}(4)} = \frac{1}{2}\langle \Psi _I^{(0)}|H{R_J}(J)V(J){R_J}(J)V(J){R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   - \frac{1}{6}\langle \Psi _I^{(0)}|H{R_J}(J)H\sum\limits_{I'} {|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}(I')} {R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   - \frac{1}{3}\langle \Psi _I^{(0)}|H{R_J}(J)\sum\limits_{I'} {{R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H} {R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   - \frac{1}{6}\langle \Psi _I^{(0)}|H{R_J}(J)\sum\limits_{I'} {{R_{I'}}(I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H} {R_{I'}}(I')H|\Psi _J^{(0)}\rangle  \hfill \\
   + \frac{1}{{24}}\langle \Psi _I^{(0)}|H\sum\limits_{I'} {{R_{I'}}} (I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}(I'){R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   + \frac{1}{{12}}\langle \Psi _I^{(0)}|H{R_I}(I)H\sum\limits_{I'} {|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_{I'}}} (I'){R_J}(J)H|\Psi _J^{(0)}\rangle  \hfill \\
   + \frac{1}{{24}}\langle \Psi _I^{(0)}|H{R_I}(I)\sum\limits_{I'} {{R_{I'}}} (I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}|H{R_J}(J)H|\Psi _J^{(0)}\rangle  + {\text{H}}{\text{.c}}{\text{.}} \hfill \\ 
\end{gathered} \end{equation}
While we will focus on the 2nd order variant in the following, we might consider the implementation of higher orders in future work.

Concerning the concrete implementation of the 2nd order version, we first assume that the Hamiltonian can be written
	\begin{equation}
	H = {H^{{\text{scal}}}} = {H_0}(I) + {V^{{\text{scal}}}}(I),
	\end{equation} 	
i.e. it is a spin-independent (scalar) operator, e.g. the nonrelativistic electronic Hamiltonian or the ZORA\cite{LenthBS_1993_4597, Wuelle_1998_392} or DKH\cite{Hess_1986_3742, JanseH_1989_6016} scalar-relativistic Hamiltonian, and $I$ is a label for the CASCI states. In this case, one can focus on the principal component ($M=S$) of each CASCI spin multiplet and write the multi-partitioning canonical Van Vleck effective Hamiltonian for total spin $S$ as
	\begin{equation}
	\label{Eq:Heff_HQD_new}
	H_{IJ}^{{\text{eff}},S} = \langle \Psi _I^{SS}|H|\Psi _J^{SS}\rangle  + \frac{1}{2}\sum\limits_K {\frac{{\langle \Psi _I^{SS}|H|{\Psi_K^{SS}}(J)\rangle \langle {\Psi_K^{SS}}(J)|H|\Psi _J^{SS}\rangle }}{{E_J^{(0)} - E_K^{(0)}(J)}}}  + {\text{H.c.}}
	\end{equation} 	
We propose to choose the multiple partitionings such that ${H_0}(I)$ are the 0th order Hamiltonians of the state-specific strongly contracted or partially contracted NEVPT2. Then Eq. (\ref{Eq:Heff_HQD_new}) is precisely the Hermitized version of the usual QD-NEVPT2\cite{AngelBCC_2004_4043} effective Hamiltonian. In the results presented in this paper, we restrict ourselves to the strongly contracted variant. It should be mentioned that, thanks to the simple relation between the QD-NEVPT2 and HQD-NEVPT2 effective Hamiltonians, HQD-NEVPT2 automatically inherits desirable properties like size consistency.

\section{Incorporation of spin-dependent effects}
We now consider a Hamiltonian that contains spin-independent (scalar) terms and additional, possibly spin-dependent, terms that are combined in the operator $V^\text{spin}$,
	\begin{equation}
	H = {H^{{\text{scal}}}} + V^\text{spin}.
	\end{equation}
Examples are the operators introduced in Section \ref{Sec:spindepop}. A straightforward application of the DCD-CAS(2) formalism using this Hamiltonian leads to
	\begin{equation}
	\begin{gathered}
  \langle \Phi _I^{SM}|{H^{{\text{DCD}}}}|\Phi _J^{S'M'}\rangle  =  \hfill \\
  \langle \Phi _I^{SM}|{H^{{\text{scal}}}} + V^\text{spin}|\Phi _J^{S'M'}\rangle  - \sum\limits_{K \in {\text{FOIS}}} {\frac{{\langle \Phi _I^{SM}|{H^{{\text{scal}}}} + V^\text{spin}|{{\tilde \Phi }_K}\rangle \langle {{\tilde \Phi }_K}|{H^{{\text{scal}}}} + V^\text{spin}|\Phi _J^{S'M'}\rangle }}{{{E_K} - {E_0}}}}. 
\end{gathered} 
\end{equation}
In contrast to the spin-independent case, now different total spins $S$ and all their $M$ components have to be included in the model space because they can be mixed by the perturbation. 
The lowest non-vanishing contributions that introduce dynamic correlation arise at 2nd order of perturbation theory, while the 1st order contribution vanishes since it simply leads to the CASCI matrix.
This is in contrast to the spin-dependent operators, which already make a nonzero contribution at 1st order. We therefore choose to keep only the lowest-order term for each of the two effects (i.e. neglect $V^\text{spin}$ in the 2nd order correction to the effective Hamiltonian) and arrive at
	\begin{equation}
	\label{Eq:SOCDCD_uncorrected}
	\langle \Phi _I^{SM}|{H^{{\text{DCD}}}}|\Phi _J^{S'M'}\rangle  = {\delta _{SS'}}{\delta _{MM'}}H_{IJ}^{{\text{DCD}},S} + \langle \Phi _I^{SM}|V^\text{spin}|\Phi _J^{S'M'}\rangle, 
	\end{equation}
where $H^{\text{DCD},S}_{IJ}$ is the scalar DCD-CAS(2) effective Hamiltonian for a certain spin $S$; see Eq. (\ref{Eq:Heff_DCD}). Note that this expression also implies that state-specific 0th order energies $E_0$ are used for different multiplicities.
The form of this effective Hamiltonian is very similar to QDPT (Eq. (\ref{Eq:Heff_QDPT})) including all CASCI roots (called CI-SOC previously\cite{GanyuN_2013_104113}), but expressed in the basis of CSFs instead of the basis of CASCI roots and with the scalar DCD-CAS(2) effective Hamiltonian instead of the CASCI Hamiltonian.
The effective Hamiltonian Eq. (\ref{Eq:SOCDCD_uncorrected}), just like Eq. (\ref{Eq:Heff_DCD}), suffers from the ground state bias. In practice, we therefore replace the scalar DCD Hamiltonian by a back-transformed Hamiltonian of the form
	\begin{equation}
	\label{Eq:HDCD_backtransformed}
	{{\mathbf{H}}^{{\text{DCD}},S,{\text{corr}}}} = {{\mathbf{C}}^{{\text{DCD}}}}{\mathbf{E}}{({{\mathbf{C}}^{{\text{DCD}}}})^T},
	\end{equation} 
where ${{\mathbf{C}}^{{\text{DCD}}}}$ are the state coefficients obtained from diagonalizing the DCD-CAS(2) Hamiltonian Eq. (\ref{Eq:Heff_DCD}). ${\mathbf{E}}$ is a diagonal matrix containing the difference-dedicated DCD-CAS(2) energies including 1st order bias correction for all roots over which the CASSCF is averaged, and containing the uncorrected difference-dedicated DCD-CAS(2) energies for all remaining roots. The reason for this procedure is the possible divergence of the bias correction expression for very high-energy roots of the CI space, which can happen if the geometric series Eq. (\ref{Eq:geometricseries}) used for the derivation of the bias correction is outside its radius of convergence. The final form of the spin-dependent DCD-CAS(2) effective Hamiltonian is\cite{LangN_2019_104104}
	\begin{equation}
	\label{Eq:spindepDCD}
	\langle \Phi _I^{SM}|{H^{{\text{DCD}}}}|\Phi _J^{S'M'}\rangle  = {\delta _{SS'}}{\delta _{MM'}}H_{IJ}^{{\text{DCD}},S,{\text{corr}}} + \langle \Phi _I^{SM}|V^\text{spin}|\Phi _J^{S'M'}\rangle. 
	\end{equation} 	
In order to construct it, first the scalar DCD-CAS(2) problem is solved for each spin $S$ to construct the matrix ${{\mathbf{H}}^{{\text{DCD}},S,{\text{corr}}}}$ and then the matrix elements of the operators $V$ are calculated in the basis of CSFs $|\Phi _I^{SM}\rangle $.

In a similar fashion, we consider the inclusion of spin-dependent effects into the Hamiltonian for HQD-NEVPT2, i.e.
	\begin{equation}
	H = {H^{{\text{scal}}}} + {V^{{\text{spin}}}} = {H_0}(I) + {V^{{\text{scal}}}}(I) + {V^{{\text{spin}}}}.
	\end{equation} 	
Like in the scalar version of the theory introduced in the previous Section \ref{Sec:HQD}, the state-specific strongly contracted NEVPT2 0th order Hamiltonians are used as ${H_0}(I)$. We choose the same pragmatic approach as in the spin-dependent DCD-CAS(2) method: ${V^{{\text{spin}}}}$ is only kept to 1st order in the effective Hamiltonian, while the ${V^{{\text{scal}}}}(I)$ are kept to 1st and 2nd order in the effective Hamiltonian. This results in the effective Hamiltonian
	\begin{equation}
	\langle \Psi _I^{SM}|H^\text{eff}|\Psi _J^{S'M'}\rangle = {\delta _{SS'}}{\delta _{MM'}}H_{IJ}^{{\text{eff}},S} + \langle \Psi _I^{SM}|{V^{{\text{spin}}}}|\Psi _J^{S'M'}\rangle. 
	\end{equation} 	
It bears similarities with the 1st order QDPT (Eq. (\ref{Eq:Heff_QDPT})) and spin-dependent DCD-CAS(2) (Eq. (\ref{Eq:spindepDCD})) methods and contains at the same time dynamic and static correlation as well as spin-dependent effects.

The evaluation of the matrix elements of ${V^{{\text{spin}}}}$ is identical for HQD-NEVPT2 and the spin-dependent DCD-CAS(2) method and will be described below.

\section{Evaluation of matrix elements of spin-dependent operators}
In this section, we discuss how to calculate matrix elements of the spin-dependent operators between CSFs belonging to a CAS. We will make use of spin-tensor properties and the Wigner-Eckart theorem\cite{Wigne_1959_} throughout.

\subsection{One-electron operators}
An arbitrary one-electron operator $A$ in Fock space can be written as a sum of singlet and triplet components (see Appendix \ref{Ap:proof_one_el_op} for a simple proof of this fact)
	\begin{align}
	A &= {A_S} + {A_T}, \label{Eq:one_el_op} \\ 	
	{A_T} &= \sum\limits_{m = 0, \pm 1} {A_T^{(m)}} (m), \label{Eq:triplet_op}
	\end{align} 	
with the singlet part having the form
	\begin{equation}
	\label{Eq:singlet_op}
	{A_S} = \sum\limits_{pq} {{a_{pq}}} {E_{pq}}
	\end{equation}
and the $m$-component of the triplet part having the form
	\begin{equation}
	\label{Eq:triplet_op_comp}
	A_T^{(m)}(m') = \sum\limits_{pq} {{a_{pq}}} (m')s_{pq}^{(m)}.
	\end{equation} 	
$E_{pq}$ was defined in Eq. (\ref{Eq:definition_Epq}) and the three operators
	\begin{equation}
	s_{pq}^{(m)} = \sum\limits_{\sigma \tau  = \alpha ,\beta } {s_{\sigma \tau }^{(m)}} a_{p\sigma }^\dag {a_{q\tau }}
	\end{equation} 	
are the three components of the triplet single-excitation operator. More explicitly, they are given by
	\begin{align}
	s_{pq}^{( + 1)} &=  - \frac{1}{{\sqrt 2 }}a_{p\alpha }^\dag {a_{q\beta }}, \\
	s_{pq}^{(0)} &= \frac{1}{2}(a_{p\alpha }^\dag {a_{q\alpha }} - a_{p\beta }^\dag {a_{q\beta }}), \\
	s_{pq}^{( - 1)} &= \frac{1}{{\sqrt 2 }}a_{p\beta }^\dag {a_{q\alpha }}.
	\end{align} 	
By employing the Wigner-Eckart theorem, the matrix elements of the singlet part are
	\begin{equation}\langle \Phi _I^{SM}|{A_S}|\Phi _J^{S'M'}\rangle  = {\delta _{SS'}}{\delta _{MM'}}\langle \Phi _I^{SS}|{A_S}|\Phi _J^{SS}\rangle  = {\delta _{SS'}}{\delta _{MM'}}\sum\limits_{pq} {{a_{pq}}} \langle \Phi _I^{SS}|{E_{pq}}|\Phi _J^{SS}\rangle 
	\end{equation} 	
and the matrix elements of the triplet part are
	\begin{equation}
	\label{Eq:triplet_matrixel}
	\begin{aligned}
	&\langle \Phi _I^{SM}|{A_T}|\Phi _J^{S'M'}\rangle  = \\
	&\sum\limits_{m = 0, \pm 1} {\langle \Phi _I^{SM}|A_T^{(m)}(m)|\Phi _J^{S'M'}\rangle }  = \sum\limits_{m = 0, \pm 1}  \clebschgordan{S',M',1,m,S,M} Y_{IJ}^{SS'}(m).
\end{aligned}
\end{equation} 
Note that the label $m$ for the reduced matrix element (RME)\nomenclature{RME}{Reduced matrix element} $Y_{IJ}^{SS'}(m)$ corresponds to $m'$ in Eq. (\ref{Eq:triplet_op_comp}); i.e. it is a label for the spatial operator with respect to which the RME is defined. In earlier work dealing exclusively with SOC,\cite{GanyuN_2006_24103, NeeseS_1998_6568} the spatial operator multiplying ${s^m}$ was the $ - m$-component of a vector operator (see Eq (\ref{Eq:integral_SOC}) below) because the total SOC operator is a scalar. In that case, the label $ - m$ was used for the RMEs and hence what we denote here as $Y_{IJ}^{SS'}(m)$ was previously called $Y_{IJ}^{SS'}( - m)$. We have changed the notation in order to be able to treat the general case, where operators (e.g. the components of the magnetic hyperfine field) are not necessarily scalar, and therefore the spatial operators are labeled by the $m$ of the spin operator which they multiply; see Eqs. (\ref{Eq:triplet_op}) and (\ref{Eq:triplet_op_comp}).
From the selection rules of the Clebsch-Gordan coefficients (CGC)\nomenclature{CGC}{Clebsch-Gordan coefficient} in Eq. (\ref{Eq:triplet_matrixel}) one knows that the matrix element of a triplet operator can only be nonzero if $\Delta S = 0, \pm 1$ and $\Delta M = 0, \pm 1$. This means that only RMEs of the form $Y_{IJ}^{SS}(m)$, $Y_{IJ}^{S,S - 1}(m)$ and $Y_{IJ}^{S,S + 1}(m)$ (with $m =  - 1,0,1$) need to be calculated. Furthermore, we only consider Hermitian operators in this work, which means that we can restrict ourselves to the calculation of the upper triangle of the matrix $\langle \Phi _I^{SM}|{A_T}|\Phi _J^{S'M'}\rangle $. Using Eq. (\ref{Eq:triplet_matrixel}) for a matrix element between principal component states (with $M = S$) and inserting explicit expressions for the CGC as a function of $S$ (see Appendix \ref{Sec:appendix_CGC}), the RMEs are given by the expressions
	\begin{align}
	\label{Eq:RME_SS}
	\begin{split}
  Y_{IJ}^{SS}(m') &= \frac{{\sqrt {S(S + 1)} }}{S}\langle \Phi _I^{SS}|A_T^{(0)}(m')|\Phi _J^{SS}\rangle  \hfill \\
   &= \frac{{\sqrt {S(S + 1)} }}{{2S}}\sum\limits_{pq} {{a_{pq}}} (m')\langle \Phi _I^{SS}|2s_{pq}^{(z)}|\Phi _J^{SS}\rangle,    
\end{split} \\
	\label{Eq:RME_SS-1}
	\begin{split}
  Y_{IJ}^{S,S - 1}(m') &= \langle \Phi _I^{SS}|A_T^{( + 1)}(m')|\Phi _J^{S - 1,S - 1}\rangle  \hfill \\
   &=  - \frac{1}{{\sqrt 2 }}\sum\limits_{pq} {{a_{pq}}} (m')\langle \Phi _I^{SS}|s_{pq}^{( + )}|\Phi _J^{S - 1,S - 1}\rangle,   
\end{split} \\
	\label{Eq:RME_SS+1}
	\begin{split}
  Y_{IJ}^{S,S + 1}(m') &= \sqrt {\frac{{2S + 3}}{{2S + 1}}} \langle \Phi _I^{SS}|A_T^{( - 1)}(m')|\Phi _J^{S + 1,S + 1}\rangle  \hfill \\
   &= \frac{1}{{\sqrt 2 }}\sqrt {\frac{{2S + 3}}{{2S + 1}}} \sum\limits_{pq} {{a_{pq}}} (m')\langle \Phi _I^{SS}|s_{pq}^{( - )}|\Phi _J^{S + 1,S + 1}\rangle. 
\end{split} 
\end{align} 	
Since we know that matrix elements are evaluated between CAS CSFs, the expressions for matrix elements obtained so far can be simplified further, based on the difference of occupation numbers. If the two CFGs differ by two or more excitations, the matrix element will be 0. If they differ by one excitation, then the RME will be equal to a single integral times a coupling coefficient. If the two CFGs are identical, there will remain a single sum over orbitals including diagonal elements of the integrals. For triplet operators we can in this case exclude inactive orbitals from the sum, since
	\begin{equation}s_{ii}^{(m)}|\Phi _J^{SM}\rangle  = 0.
	\end{equation} 	
The general methodology presented so far can be used to calculate matrix elements of arbitrary one-electron operators. All one has to do is specify the operator via the integrals ${a_{pq}}$ and ${a_{pq}}(m')$ of Eqs. (\ref{Eq:singlet_op}) and (\ref{Eq:triplet_op_comp}), which we will do in the following for the one-electron operators considered in this work.
We can write the SOMF operator in Fock space as
	\begin{equation}{H_{{\text{SOMF}}}} = \sum\limits_m {\sum\limits_{pq} {{{( - 1)}^m}z_{pq}^{( - m)}} } s_{pq}^{(m)}.
	\end{equation}	
Hence, in this case we identify
	\begin{equation}
	\label{Eq:integral_SOC}
	{a_{pq}}(m) = {( - 1)^m}z_{pq}^{( - m)}.
	\end{equation} 	
The Fock space version of the $l$ component ($l = x,y,z$) of the hyperfine field operator at position ${{\mathbf{R}}_A}$ is
	\begin{equation}
	\begin{aligned}
	&B_{{\text{HFC}}}^{(l)}({{\mathbf{R}}_A}) = \\
	&{\alpha ^2}\left( { - \sum\limits_{pq} {{{\left( {\frac{{l_i^{A(l)}}}{{r_{iA}^3}}} \right)}_{pq}}} {E_{pq}} - \frac{{{g_e}}}{2}\frac{{8\pi }}{3}\sum\limits_{pq} {\psi _p^ * } ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A})s_{pq}^{(l)} - \frac{{{g_e}}}{2}\sum\limits_{k = 1}^3 {\sum\limits_{pq} {V_{pq}^{(lk)}} } s_{pq}^{(k)}} \right),
	\end{aligned}
	\end{equation} 	
where ${\psi _p}$ is the $p$th MO and 
	\begin{equation}V_{pq}^{(lk)} = \langle p|\frac{{3r_{iA}^{(l)}r_{iA}^{(k)} - {\delta _{kl}}r_{iA}^2}}{{r_{iA}^5}}|q\rangle 
	\end{equation} 	
are electric field gradient integrals. For the FC operators, the integrals needed for evaluation of Eqs. (\ref{Eq:RME_SS})--(\ref{Eq:RME_SS+1}) are 
	\begin{align}{a_{pq}}( + 1) &=  - \frac{1}{{\sqrt 2 }}\psi _p^ * ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A}), \\
	{a_{pq}}( - 1) &= \frac{1}{{\sqrt 2 }}\psi _p^ * ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A})
	\end{align} 	
for the operator $\sum\limits_{pq} {\psi _p^ * } ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A})s_{pq}^{(x)}$,
	\begin{equation}{a_{pq}}( + 1) = {a_{pq}}( - 1) = \frac{i}{{\sqrt 2 }}\psi _p^ * ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A})
	\end{equation} 	
for the operator $\sum\limits_{pq} {\psi _p^ * } ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A})s_{pq}^{(y)}$ and
	\begin{equation}{a_{pq}}(0) = \psi _p^ * ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A})
	\end{equation} 	
for the operator $\sum\limits_{pq} {\psi _p^ * } ({{\mathbf{R}}_A}){\psi _q}({{\mathbf{R}}_A})s_{pq}^{(z)}$, with all other ${a_{pq}}(m)$ being zero.
For the SD operator $\sum\limits_{k = 1}^3 {\sum\limits_{pq} {V_{pq}^{(lk)}} } s_{pq}^{(k)}$ one obtains
	\begin{align}
	{a_{pq}}( + 1) &= \frac{1}{{\sqrt 2 }}( - V_{pq}^{(lx)} + iV_{pq}^{(ly)}), \\
	{a_{pq}}(0) &= V_{pq}^{(lz)}, \\
	{a_{pq}}( - 1) &= \frac{1}{{\sqrt 2 }}(V_{pq}^{(lx)} + iV_{pq}^{(ly)}).
	\end{align} 	
These integrals can be inserted into general functions to calculate matrix elements according to Eqs. (\ref{Eq:RME_SS}) to (\ref{Eq:RME_SS+1}) and (\ref{Eq:triplet_matrixel}). SOC is however a special case since no matrix element has to be calculated in the case that two CFGs are equal. This is because the diagonal integrals $z_{pp}^{( - m)}$ are Hermitian and purely imaginary and hence 0. For the spin Zeeman operator (which is a triplet operator) we also do not use this general machinery, since the action of the total spin operator only depends on the quantum numbers $S$ and $M$, and not on any other details of the CSFs.
\subsection{The spin-spin coupling operator}
An arbitrary two-electron operator can, in analogy to Eq. (\ref{Eq:one_el_op}), be written as a sum of singlet, triplet, and quintet spin tensor components. We will however not discuss this most general case, since we are only interested in the SSC operator Eq. (\ref{Eq:HSSC}), which is a pure quintet operator (\textit{vide infra}). The SSC operator (which is a scalar) can be expressed as the dot product of two Cartesian tensors,
	\begin{equation}{H_{{\text{SSC}}}} = \sum\limits_{k,l = 1}^3 {\sum\limits_{i < j} {d_{ij}^{(kl)}} } s_i^{(k)}s_j^{(l)},
	\end{equation} 	
where the Cartesian components of the two-electron electric field gradient operator are given by
	\begin{equation}d_{12}^{(kl)} =  - \frac{{g_e^2{\alpha ^2}}}{4}\frac{{3r_{12}^{(k)}r_{12}^{(l)} - {\delta _{kl}}r_{12}^2}}{{r_{12}^5}}.
	\end{equation} 	
Here the prefactor is included for convenience. Note that this is a traceless symmetric tensor, which means it only has a rank 2 (and no rank 1 or rank 0) part.\cite{VahtrLMAaR_2002_133}
Replacing the Cartesian tensor components by spherical ones, the SSC operator assumes the form
	\begin{equation}{H_{{\text{SSC}}}} = \sum\limits_{m = 0, \pm 1, \pm 2} {{{( - 1)}^m}\sum\limits_{i < j} {d_{ij}^{( - m)}} S_{ij}^{(m)}}, 
	\end{equation} 	
where ${S^{(m)}}$ are the five quintet operators acting on the four-dimensional space of two coupled spin-1/2 systems. They are discussed in more detail in Appendix \ref{Ap:permrel}.
The Fock space version of the SSC operator can then be written
	\begin{align}
	\label{Eq:HSSC_irred_FS}
	{H_{{\text{SSC}}}} &= \sum\limits_{m = 0, \pm 1, \pm 2} {H_{{\text{SSC}}}^{(m)}(m)}, \\
	H_{{\text{SSC}}}^{(m)}(m') &= \frac{{{{( - 1)}^{m'}}}}{2}\sum\limits_{pqrs} {d_{pqrs}^{( - m')}S_{pqrs}^{(m)}}. 
	\end{align} 	
Here the two-electron electric field gradient integrals in physicists’ notation\cite{SzaboO_1996_} are
	\begin{equation}
	d_{pqrs}^{( - m)} = \langle pq|d_{12}^{( - m)}|rs\rangle. 
	\end{equation} 	
In this work, we use the RI approximation for these integrals.\cite{GanyuGTMN_2010_144111} The components of the quintet double excitation operator are given by
	\begin{equation}
	S_{pqrs}^{(m)} = \sum\limits_{\sigma \tau \lambda \kappa } {\langle \sigma \tau |{S^{(m)}}|\lambda \kappa \rangle }   a_{p\sigma }^\dag a_{q\tau }^\dag {a_{s\kappa }}{a_{r\lambda }}.
	\end{equation} 	
More explicitly, they are
\begin{align}
S_{pqrs}^{( + 2)} &= \frac{1}{2}s_{pr}^{( + )}s_{qs}^{( + )},	\\
S_{pqrs}^{( + 1)} &=  - \frac{1}{2}[s_{pr}^{(z)}s_{qs}^{( + )} + s_{pr}^{( + )}s_{qs}^{(z)}], \\
S_{pqrs}^{(0)} &= \frac{1}{{2\sqrt 6 }}\left[ {4s_{pr}^{(z)}s_{qs}^{(z)} - {\delta _{qr}}{E_{ps}} + \frac{1}{2}({E_{ps}}{E_{qr}} - 4s_{ps}^{(z)}s_{qr}^{(z)})} \right], \\
S_{pqrs}^{( - 1)} &= \frac{1}{2}[s_{pr}^{(z)}s_{qs}^{( - )} + s_{pr}^{( - )}s_{qs}^{(z)}], \\
S_{pqrs}^{( - 2)} &= \frac{1}{2}s_{pr}^{( - )}s_{qs}^{( - )}. 	
\end{align}
Using Eq. (\ref{Eq:HSSC_irred_FS}) we can, like we did above, express matrix elements via the Wigner-Eckart theorem,
	\begin{equation}\langle \Phi _I^{SM}|{H_{{\text{SSC}}}}|\Phi _J^{S'M'}\rangle  = \sum\limits_{m = 0, \pm 1, \pm 2} {\left( {\begin{array}{*{20}{c}}
  {S'}&2&\vline & S \\ 
  {M'}&m&\vline & M 
\end{array}} \right)} X_{IJ}^{SS'}(m).
\end{equation} 	
After using the selection rules $\Delta S = 0, \pm 1, \pm 2$ and $\Delta M = 0, \pm 1, \pm 2$ there are five kinds of SSC RMEs that need to be calculated. Similarly to the one-electron case, they can be expressed in terms of principal components (using the CGCs in Appendix \ref{Sec:appendix_CGC})
	\begin{align}
	\begin{split}
  X_{IJ}^{SS}(m') &= \sqrt {\frac{{(S + 1)(2S + 3)}}{{S(2S - 1)}}} \langle \Phi _I^{SS}|H_{{\text{SSC}}}^{(0)}(m')|\Phi _J^{SS}\rangle   \\
   &= \frac{{{{( - 1)}^{m'}}}}{2}\sqrt {\frac{{(S + 1)(2S + 3)}}{{S(2S - 1)}}} \sum\limits_{pqrs} {d_{pqrs}^{( - m')}} \langle \Phi _I^{SS}|S_{pqrs}^{(0)}|\Phi _J^{SS}\rangle 
\end{split} \\
\begin{split}
  X_{IJ}^{S,S - 1}(m') &= \sqrt {\frac{{S + 1}}{{S - 1}}} \langle \Phi _I^{SS}|H_{{\text{SSC}}}^{( + 1)}(m')|\Phi _J^{S - 1,S - 1}\rangle   \\
   &= \frac{{{{( - 1)}^{m'}}}}{2}\sqrt {\frac{{S + 1}}{{S - 1}}} \sum\limits_{pqrs} {d_{pqrs}^{( - m')}} \langle \Phi _I^{SS}|S_{pqrs}^{( + 1)}|\Phi _J^{S - 1,S - 1}\rangle 
\end{split} \\
\begin{split}
  X_{IJ}^{S,S - 2}(m') &= \langle \Phi _I^{SS}|H_{{\text{SSC}}}^{( + 2)}(m')|\Phi _J^{S - 2,S - 2}\rangle   \\
   &= \frac{{{{( - 1)}^{m'}}}}{2}\sum\limits_{pqrs} {d_{pqrs}^{( - m')}} \langle \Phi _I^{SS}|S_{pqrs}^{( + 2)}|\Phi _J^{S - 2,S - 2}\rangle 
\end{split} \\
\begin{split}
  X_{IJ}^{S,S + 1}(m') &= \sqrt {\frac{{(S + 2)(2S + 3)}}{{S(2S + 1)}}} \langle \Phi _I^{SS}|H_{{\text{SSC}}}^{( - 1)}(m')|\Phi _J^{S + 1,S + 1}\rangle   \\
   &= \frac{{{{( - 1)}^{m'}}}}{2}\sqrt {\frac{{(S + 2)(2S + 3)}}{{S(2S + 1)}}} \sum\limits_{pqrs} {d_{pqrs}^{( - m')}} \langle \Phi _I^{SS}|S_{pqrs}^{( - 1)}|\Phi _J^{S + 1,S + 1}\rangle  
\end{split} \\
\begin{split}
  X_{IJ}^{S,S + 2}(m') &= \sqrt {\frac{{2S + 5}}{{2S + 1}}} \langle \Phi _I^{SS}|H_{{\text{SSC}}}^{( - 2)}(m')|\Phi _J^{S + 2,S + 2}\rangle   \\
   &= \frac{{{{( - 1)}^{m'}}}}{2}\sqrt {\frac{{2S + 5}}{{2S + 1}}} \sum\limits_{pqrs} {d_{pqrs}^{( - m')}} \langle \Phi _I^{SS}|S_{pqrs}^{( - 2)}|\Phi _J^{S + 2,S + 2}\rangle. 
\end{split} 
\end{align} 	
In order to achieve an efficient implementation, these equations can be further simplified based on a knowledge of the occupation number differences of states $I$ and $J$, and by using special properties of the quintet double excitation operators. Here we follow the discussion of Gilka \textit{et al.}\cite{GilkaTM_2008_44102} Two essential ingredients of their derivation are what they call “selection rules” and a “permutational relation”. While they introduce them on the level of matrix elements, we prefer to discuss them on the level of the quintet double excitation operators. The permutational relation then corresponds to the statement that 
	\begin{equation}
	\label{Eq:perm_rel}
	S_{pqrs}^{(m)} =  - S_{pqsr}^{(m)} =  - S_{qprs}^{(m)} = S_{qpsr}^{(m)},
	\end{equation} 	
from which it trivially follows that
	\begin{equation}
	\label{Eq:selection_rules_SSC}
	S_{pqrr}^{(m)} = S_{pprs}^{(m)} = 0,
	\end{equation} 	
which is our analogue of the selection rules. Our proof of the permutational relation Eq. (\ref{Eq:perm_rel}) is given in Appendix \ref{Ap:permrel}. Using Eqs. (\ref{Eq:perm_rel}) and (\ref{Eq:selection_rules_SSC}), we arrive at
	\begin{equation}
	\label{Eq:SSC_matrixel_simplifiedI}
	\sum\limits_{pqrs} {d_{pqrs}^{(m')}} \langle \Phi _I^{SM}|S_{pqrs}^{(m)}|\Phi _J^{S'M'}\rangle  = 2\sum\limits_{p < q} {[d_{pqpq}^{(m')} - d_{pqqp}^{(m')}]} \langle \Phi _I^{SM}|S_{pqpq}^{(m)}|\Phi _J^{S'M'}\rangle 
	\end{equation} 	
if $I$ and $J$ have identical occupation numbers,
\begin{equation}
\label{Eq:SSC_matrixel_simplifiedII}
	\sum_{pqrs} {d_{pqrs}^{(m')}} \langle \Phi_I^{SM}|S_{pqrs}^{(m)}|\Phi_J^{S'M'}\rangle  = 2\sum_{\substack{p \\  (p \ne t,u) }} {[d_{tpup}^{(m')} - d_{tppu}^{(m')}]} \langle \Phi_I^{SM}|S_{tpup}^{(m)}|\Phi_J^{S'M'}\rangle
\end{equation}
if they differ by a single excitation $t \to u$ (we use active orbital labels since CSFs from a CAS have identical occupation numbers in the inactive and virtual orbital spaces) and 
	\begin{equation}
	\label{Eq:SSC_matrixel_simplifiedIII}
	\sum\limits_{pqrs} {d_{pqrs}^{(m')}} \langle \Phi _I^{SM}|S_{pqrs}^{(m)}|\Phi _J^{S'M'}\rangle  = 2[d_{tuvw}^{(m')} - d_{tuwv}^{(m')}]\langle \Phi _I^{SM}|S_{tuvw}^{(m)}|\Phi _J^{S'M'}\rangle 
	\end{equation} 	
if they differ by a double excitation $tu \to vw$ (with $t \ne u,    v \ne w$).
Furthermore, it was pointed out by Gilka \textit{et al.} that closed shells do not contribute,\cite{GilkaTM_2008_44102} which means that orbitals $p$ and $q$ in Eqs. (\ref{Eq:SSC_matrixel_simplifiedI}) and (\ref{Eq:SSC_matrixel_simplifiedII}) that are doubly occupied in both bra and ket can be removed from the summations. This is because the operators $S_{prqr}^{(m)}$ and $S_{rprq}^{(m)}$ produce 0 when they act on a wavefunction in which orbital $r$ is doubly occupied. Our own proof of this fact is presented in Appendix \ref{Ap:closedshells}.
To stay in line with the implementation of SSC within the MRCI/QDPT framework in ORCA,\cite{GanyuN_2008_114117} only matrix elements of the SSC operator between states of the same multiplicity are considered in the following.

\section{Formal properties of the methods}

\subsection{Lack of size consistency of DCD-CAS(2)}
\label{Sec:DCD_SC_proof}
Size consistency is a desirable property for any quantum-chemical method. There is some ambiguity in this term and it is sometimes used interchangeably with the term size extensivity.\cite{BartlP_1978_561, NooijSM_2005_2277} We understand size consistency as the exact additivity of the energy of two noninteracting systems $A$ and $B$. Size consistency is often related to multiplicative separability of the wavefunction.\cite{Mayer_2003_}

Unfortunately, the DCD-CAS(2) method is not strictly size-consistent. To understand why, it is important to understand the reason for size consistency of the CASSCF method.
We assume that all orbitals of the supersystem $AB$ of the two noninteracting systems are localized on either of the fragments, which can always be chosen like this when using a one-electron basis set consisting of atom-centered functions. Under this condition, one can show that the Fock space BO Hamiltonian ${H^{AB}}$ is just the sum of the corresponding operators ${H^A}$ and ${H^B}$ of the isolated systems.\cite{HelgaJO_2000_} The same is true for the Dyall Hamiltonian.\cite{AngelCELM_2001_10252} The reason is that a one- or two-electron integral can only be nonzero if all involved orbitals are located on the same subsystem. We assume additionally that a CASSCF calculation on the supersystem yields inactive, active and virtual orbital spaces that are the combinations of the corresponding orbital spaces of the fragments. 

The fragment Hamiltonians ${H^A}$ and ${H^B}$ clearly conserve the local electron numbers $N_A^{}$ and $N_B^{}$, since they do not contain excitations between orbitals located on different fragments. The same is therefore also true for their sum $H^{AB}$. This means that the total Hamiltonian ${H^{AB}}$ is block diagonal in the supersystem CASCI space, with different blocks corresponding to different distributions of electrons over the two subsystems. The block belonging to a certain choice of electron numbers $N_A^{}$ and $N_B^{}$ has the matrix form
	\begin{equation}
	{{\mathbf{H}}^{AB}} = {{\mathbf{H}}^A} \otimes {{\mathbf{1}}^B} + {{\mathbf{1}}^A} \otimes {{\mathbf{H}}^B},
	\end{equation}								
which leads to the eigenstates of $\mathbf{H}^{AB}$ being given as antisymmetrized products (tensor products) of the eigenstates of $\mathbf{H}^A$ and $\mathbf{H}^B$ (multiplicative separability) and the corresponding eigenenergies being the sum of the fragment energies (additive separability).\cite{Mayer_2003_, HelgaJO_2000_} This concludes the proof of size consistency of CASSCF under the stated assumptions.
Ideally, the DCD-CAS(2) Hamiltonian should share this property, such that	
\begin{equation}
\label{Eq:separable_DCD}
{{\mathbf{H}}^{{\text{DCD}},AB}} = {{\mathbf{H}}^{{\text{DCD}},A}} \otimes {{\mathbf{1}}^B} + {{\mathbf{1}}^A} \otimes {{\mathbf{H}}^{{\text{DCD}},B}}.
\end{equation}						
The 0th and 1st order contribution to the DCD-CAS(2) Hamiltonian is just the CASCI matrix, which is separable as we have just shown. Therefore we would only have to show that the 2nd order dynamic correlation contribution alone is separable for Eq. (\ref{Eq:separable_DCD}) to be true. For the supersystem $AB$, we only need to consider perturbers that preserve the electron numbers in the two subsystems, since the total Hamiltonian conserves these numbers. Also, since the total Hamiltonian is additive, it cannot connect perturbers that involve excitations on both subsystems. More explicitly, one has
\begin{equation}
\langle \Phi_I^A \Phi_J^B| H^{AB} | \Phi_K^A \Phi_L^B\rangle = \langle \Phi_I^A|H^A|\Phi_K^A\rangle \underbrace{\langle \Phi_J^B|\Phi_L^B\rangle}_{=0} + \underbrace{\langle \Phi_I^A|\Phi_K^A\rangle}_{=0}\langle \Phi_J^B|H^B|\Phi_L^B\rangle = 0.
\end{equation}
Therefore, the most general perturber function that can make a non-vanishing contribution can be written in tensor product form as $| {\tilde \Phi _{LI}^{AB}} \rangle  = | {\tilde \Phi _L^A} \rangle  \otimes | {\Psi _I^B} \rangle $ or $| {\tilde \Phi _{IL}^{AB}} \rangle  = | {\Psi _I^A} \rangle  \otimes | {\tilde \Phi _L^B} \rangle $, where $| {\Psi _I^A} \rangle $ and $| {\Psi _I^B} \rangle $  are eigenfunctions of the CASCI Hamiltonians of subsystems $A$ and $B$ with eigenenergies $E_I^{A,(0)}$ and $E_I^{B,(0)}$. Using the additivity of the Dyall Hamiltonian, $H^{\text{Dyall},AB}=H^{\text{Dyall},A}+H^{\text{Dyall},B}$, one obtains 
		\begin{equation}
		\begin{split}
  H_{}^{{\text{Dyall}},AB}\left| {\tilde \Phi _L^A} \right\rangle  \otimes \left| {\Psi _I^B} \right\rangle  &= \left( {E_L^A + E_I^{B,(0)}} \right)\left| {\tilde \Phi _L^A} \right\rangle  \otimes \left| {\Psi _I^B} \right\rangle, \\
  H_{}^{{\text{Dyall}},AB}\left| {\Psi _I^A} \right\rangle  \otimes \left| {\tilde \Phi _L^B} \right\rangle  &= \left( {E_I^{A,(0)} + E_L^B} \right)\left| {\Psi _I^A} \right\rangle  \otimes \left| {\tilde \Phi _L^B} \right\rangle. 
\end{split} 
\end{equation}		
Thus, these perturbers indeed diagonalize the supersystem Dyall Hamiltonian. By choosing the main model space 0th order energy to be additive, $E_0^{AB} = E_0^A + E_0^B$ (e.g. by choosing CASCI ground state energies), the 2nd order dressing for the complete system in the basis of tensor product CASCI roots (for those we use compound labels $IJ$ and $MN$, the first index referring to a CASCI root of subsystem $A$ and the second index to a root of subsystem $B$) is given by
\begin{equation}
\label{Eq:HDCD_supersystem}
\begin{split}
  &H_{IJ,MN}^{{\text{DCD}},AB(2)} = \sum\limits_K {\frac{{\left\langle {\Psi _I^A\Psi _J^B|H_{}^{AB}|\tilde \Phi _{IK}^{AB}} \right\rangle \left\langle {\tilde \Phi _{IK}^{AB}|H_{}^{AB}|\Psi _M^A\Psi _N^B} \right\rangle }}{{E_I^{A,(0)} + E_K^B - E_0^A - E_0^B}}}  \\
  &+ \sum\limits_K {\frac{{\left\langle {\Psi _I^A\Psi _J^B|H_{}^{AB}|\tilde \Phi _{KJ}^{AB}} \right\rangle \left\langle {\tilde \Phi _{KJ}^{AB}|H_{}^{AB}|\Psi _M^A\Psi _N^B} \right\rangle }}{{E_K^A + E_J^{B,(0)} - E_0^A - E_0^B}}} \\
   &= \sum\limits_K {\frac{{\left\langle {\Psi _J^B|H_{}^B|\tilde \Phi _K^B} \right\rangle \left\langle {\tilde \Phi _K^B|H_{}^B|\Psi _N^B} \right\rangle }}{{E_I^{A,(0)} - E_0^A + E_K^B - E_0^B}}\delta _{IM}^{} + } \sum\limits_K {\frac{{\left\langle {\Psi _I^A|H_{}^A|\tilde \Phi _K^A} \right\rangle \left\langle {\tilde \Phi _K^A|H_{}^A|\Psi _M^A} \right\rangle }}{{E_K^A - E_0^A + E_J^{B,(0)} - E_0^B}}} \delta _{JN}^{}. 
\end{split}
\end{equation}	
On the other hand, to give a separable dynamic correlation correction, we would need to have (see Eq. (\ref{Eq:separable_DCD}))
\begin{equation}
\begin{gathered}
  H_{IJ,MN}^{{\text{DCD}},AB(2)} = H_{I,M}^{{\text{DCD}},A(2)}{\delta _{JN}} + H_{J,N}^{{\text{DCD}},A(2)}{\delta _{IM}} \hfill \\
   = \sum\limits_K {\frac{{\left\langle {\Psi _I^A|{H^A}|\tilde \Phi _K^A} \right\rangle \left\langle {\tilde \Phi _K^A|{H^A}|\Psi _M^A} \right\rangle }}{{E_K^A - E_0^A}}} {\delta _{JN}} + \sum\limits_K {\frac{{\left\langle {\Psi _J^B|{H^B}|\tilde \Phi _K^B} \right\rangle \left\langle {\tilde \Phi _K^B|{H^B}|\Psi _N^B} \right\rangle }}{{E_K^B - E_0^B}}{\delta _{IM}}}.
\end{gathered} 
\end{equation}	
We see that the DCD-CAS(2) Hamiltonian is not size-consistent because in general (unless the CASCI space is degenerate) we have $E_J^{B,(0)} - E_0^B \ne 0$ and $E_I^{A,(0)} - E_0^A \ne 0$ for arbitrary $I$ and $J$. If ${E_0}$ is chosen to be the ground state CASSCF energy, the denominators are then too large in the composite system due to the non-vanishing terms, leading to a dynamic correlation correction that is underestimated compared to the two individual systems.
For the difference-dedicated scheme introduced before, we note that the $ij\rightarrow ab$ contribution to the dressing matrix is exactly separable for all cases, which is clear since MP2 gives separable energies.

One special case that is of interest is that of a closed-shell system $A$ and an open-shell system $B$, i.e. all active orbitals of the supersystem are located on $B$. We derived above that only locally excited perturbers can make a non-vanishing contribution to the effective Hamiltonian. Since only fragment $B$ has active orbitals, all excitation classes except $ij\rightarrow ab$ (where there are no active orbitals involved in the definition of the perturbers) can only contain contributions of perturbers that consist of the ground state on fragment $A$ and a perturber on fragment $B$, i.e. $|\Psi_0^A \tilde{\Phi}_K^B\rangle$. The 2nd order dressing contribution due to these excitation classes is therefore
\begin{equation}
\label{Eq:HDCD_closedopen}
H_{JN}^{\text{DCD}, AB(2)}= \sum_K \frac{\langle \Psi_J^B | H_B | \tilde{\Phi}_K^B\rangle \langle \tilde{\Phi}_K^B | H_B | \Psi_N^B\rangle}{E_K^B - E_0^B} = H_{JN}^{\text{DCD}, B(2)}.
\end{equation}
Since the CASCI space on fragment $A$ is one-dimensional, we dropped the superfluous index for fragment $A$, which is why the dressing matrix on the left side of Eq. (\ref{Eq:HDCD_closedopen}) has only two indices in contrast to the four indices in Eq. (\ref{Eq:HDCD_supersystem}).
This shows that for this special case (two noninteracting fragments of which one is closed-shell), all excitation classes except $ij\rightarrow ab$ are exactly separable.
Together with the separability of the $ij\rightarrow ab$ contribution in the difference-dedicated scheme, this means that difference-dedicated DCD-CAS(2) is exactly separable for the case of a closed-shell fragment far apart from another fragment with active orbitals. This is the very important property of core separability.\cite{Grano_2011_214113} It means that the results will for example not deteriorate when treating metal complexes with large molecular ligands containing many atoms. For the non-difference-dedicated scheme, there will however be a size-consistency error that comes from the $ij\rightarrow ab$ excitation class.

Another interesting observation arises under the assumption that the ground state DCD-CAS(2) solutions for both the subsystems and the supersystem are identical to the CASCI ground states, i.e. there is no state mixing. Then the 2nd-order contribution to the energy is given by
\begin{equation}
\begin{aligned}
&E_0^{\text{DCD}, AB(2)} = H_{00, 00}^{\text{DCD}, AB(2)} \\
&= \sum_K \frac{\langle \Psi_0^B | H^B | \tilde \Phi_K^B\rangle \langle \tilde \Phi_K^B| H^B | \Psi_0^B\rangle}{E_K^B - E_0^B} + \sum_K \frac{\langle \Psi_0^A | H^A | \tilde \Phi_K^A\rangle \langle \tilde \Phi_K^A| H^A | \Psi_0^A\rangle}{E_K^A - E_0^A} \\
&= E_0^{\text{DCD}, A(2)} + E_0^{\text{DCD}, B(2)}.
\end{aligned}
\end{equation}
Here we assumed that the ground state CASCI energies are chosen as $E_0$ for the DCD-CAS(2) procedure. In reality, the assumption will never be exactly fulfilled except in special cases. However, it shows that if state mixing effects in the ground state are weak, the DCD-CAS(2) energies can be expected to be approximately size-consistent. It is also clear that for higher excited states the size-consistency errors will be larger than for lower excited states. The numerical investigations (\textit{vide infra}) reveal that size-consistency errors are also reduced by the bias-correction scheme. Furthermore, bc-D\textsuperscript{3}CD-CAS(2) results will be shown to be often very close to the results of NEVPT2, which is exactly size-consistent.

\subsection{Orbital invariance and preservation of orbital degeneracy of DCD-CAS(2)}
\subsubsection{Orbital invariance}
\label{Ap:OrbitalInv}
The discussions of the invariance under orbital rotations and of the preservation of orbital degeneracies both profit from a formulation in terms of operator equations instead of matrix representations in a certain many-electron basis set. The DCD-CAS(2) effective Hamiltonian in basis-independent form is given by (compare with Eq. (\ref{Eq:GDPT_Hamil}))
\begin{equation}
\label{Eq:HDCD_operatorequation}
	{H^{{\text{DCD}}}} = {P}\left[ {H - H\sum\limits_{{E_K}} {\frac{{{P_K}}}{{{E_K} - {E_0}}}} H} \right]{P},
\end{equation}
where
\begin{equation}
P_K = \sum_{K\text{ with }E_K} |\tilde{\Phi}_K\rangle \langle \tilde{\Phi}_K|
\end{equation}
and
\begin{equation}
P_\text{FOIS}H^\text{Dyall}P_\text{FOIS}|\tilde{\Phi}_K\rangle = E_K |\tilde{\Phi}_K\rangle.
\end{equation}
The CASCI space itself is clearly invariant under rotations among the inactive, active, and virtual orbitals, respectively, because any determinant expressed in terms of rotated orbitals can be written as a linear combination of determinants formed from the original orbitals. This is possible since the space is spanned by all determinants that result from the distribution of the active electrons over the active orbitals, i.e. it is an active-orbital full CI space. The same is also true for spin-adapted CSFs instead of determinants. This argument can be extended to the space of perturbers: For any given non-active orbital occupation $l$, the perturbers again constitute a CAS space (denoted as $S_l^{(k)}$ in the nomenclature introduced in Section \ref{Sec:NEVPT2}) that is invariant under orbital rotations.
Since the reference space and the perturber spaces are invariant, the same is true for the projectors ${P}$ and $P_\text{FOIS}$. The Hamiltonians $H$ and $H^\text{Dyall}$ are invariant since they both contain full contractions of all three sets of orbital indices.\cite{Kong_2010_2603} This means that the operator  $P_\text{FOIS}H^\text{Dyall}P_\text{FOIS}$ is invariant and so are its eigenvalues $E_K$ as well as its eigenspaces and the corresponding projectors ${P_K}$. This shows that the whole $H^\text{DCD}$, as defined by the basis-independent operator equation Eq. (\ref{Eq:HDCD_operatorequation}) is constructed from operators that are invariant under orbital rotations. Its eigenfunctions and eigenenergies, i.e. the DCD-CAS(2) solutions, which fulfill
\begin{equation}
H^\text{DCD} |\tilde{\Psi}_I\rangle = \tilde{E}_I |\tilde{\Psi}_I\rangle,
\end{equation}
are therefore also independent of the choice of orbitals.

In analogy to Eq. (\ref{Eq:HDCD_operatorequation}), we can also write the state-specific dressing matrices defined in Eq. (\ref{Eq:HDCD_statespecific}) in a basis-independent form given by
\begin{equation}
\label{Eq:StatespecificDressing_operatorequation}
H^{\text{DCD},(2)}(\Delta) = - \sum_{n=0}^\infty \Delta^n PH \sum_{E_K} \frac{P_K}{(E_K-E_0)^{n+1}}HP.
\end{equation}
The bias-corrected energies, which are defined via expectation values of (truncated forms of) this operator in the invariant states $|\tilde{\Psi}_I\rangle$, are therefore also invariant under orbital rotations in the three subspaces.

\subsubsection{Preservation of orbital degeneracy}
For the discussion of orbital degeneracies, i.e. degeneracies between states that are due to spatial symmetry, one can profit from the basis-independent operator equations introduced in the previous section.
We assume that the set of active orbitals is closed under the action of any symmetry operator, i.e. all components of orbitals that transform according to some multidimensional irreducible representation are included. This means that also the CASCI space is closed under the action of any symmetry operator. It can easily be shown that the orthogonal projector on a subspace of states that transform irreducibly among each other is a totally symmetric operator, i.e. it commutes with any symmetry operator. This means that the projector $P$ on the CASCI space, and therefore also the CASCI Hamiltonian $PHP$, are totally symmetric operators.
Then the CASCI solutions transform according to irreducible representations of the molecular point group. If these representations are multidimensional, this leads to the occurrence of orbital degeneracy.

This discussion is straightforwardly extended to DCD-CAS(2). Like the CASCI space, also the FOIS is closed under symmetry operators and therefore the projector $P_\text{FOIS}$ is a totally symmetric operator. Then $P_\text{FOIS}H^\text{Dyall}P_\text{FOIS}$ is totally symmetric and its eigenfunctions, the perturbers $|\tilde{\Phi}_K\rangle$ transform irreducibly. This in turn means that the projectors $P_K$ are totally symmetric, which shows that both the DCD-CAS(2) Hamiltonian Eq. (\ref{Eq:HDCD_operatorequation}) and the state-specific operators Eq. (\ref{Eq:StatespecificDressing_operatorequation}) defining the bias correction are totally symmetric. The DCD-CAS(2) eigenfunctions $|\tilde{\Psi}_I\rangle$ therefore form irreducible representations. Furthermore, the shift $\Delta_I$ and therefore also the dressing matrices Eq. (\ref{Eq:StatespecificDressing_operatorequation}) are identical for eigenfunctions $|\tilde{\Psi}_I\rangle$ that belong to the same irreducible representation. This is because the expectation value of a totally symmetric operator for states that transform as different components of the same multidimensional irreducible representation are identical. This finally shows that orbital degeneracy is preserved not only for the uncorrected DCD-CAS(2) but also after bias correction.

\subsection{Computational cost of DCD-CAS(2)}
\label{Sec:DCD_cost}
Before coming to numerical results, we briefly discuss the kind of systems that are tractable by DCD-CAS(2). Since the method uses an uncontracted perturber space and has an asymptotic computational cost that grows approximately as the 3rd power with the size of the CASCI space, it is obviously not suited for extremely large active spaces. With the current implementation, systems with up to about 600 to 800 basis functions can be routinely handled for small to medium-sized active spaces. We note here that also other multistate MRPT methods like XMS-CASPT2 with the MS-MR contraction scheme have a cubic scaling with respect to the number of states.\cite{YanaiSXCKGS_2017_4829} However, for these methods the scaling does not have any drastic consequences since usually only a few roots are included into the model space, while DCD-CAS(2) uses the whole CASCI space as model space. Since the $ij\rightarrow ab$ class can be handled very efficiently as shown in Section \ref{Sec:Efficient_ijab}, the most expensive class for systems that are currently tractable is $i\rightarrow ab$ with a (21|..|11) occupation pattern. In the following we assume determinants instead of CSFs for simplicity, which is justified since the use of CSFs only reduces the prefactor, but not the exponent of the scaling of the computational cost with respect to system size. Then the number of perturbers in this class is proportional to $N_{{\text{det}}}^{i,ab} \times {N_{{\text{inact}}}} \times N_{{\text{virt}}}^2$, where $N_{{\text{det}}}^{i,ab}$ is the number of determinants with one hole in orbital $i$ and two electrons in orbitals $a$ and $b$. Therefore, the computational cost for construction of the $\langle {\Phi _I}|H|{\Phi _K}\rangle $ matrix elements scales quadratically with the number of virtual orbitals. Since the rotation from the $|{\Phi _K}\rangle $ to the $|{\tilde \Phi _K}\rangle $ basis is done separately for each choice of $i$, $a$ and $b$, the total cost for this transformation is proportional to ${N_{{\text{det}}}} \times {(N_{{\text{det}}}^{i,ab})^2} \times {N_{{\text{inact}}}} \times N_{{\text{virt}}}^2$, where $N_\text{det}$ is the number of reference determinants. It again scales quadratically with respect to the number of virtual orbitals, but dominates the cost due to the larger prefactor for medium-sized systems. Eventually, for large enough systems, the computational cost will be dominated by the transformation of ERIs from the atomic orbital (AO)\nomenclature{AO}{Atomic orbital} to the MO basis, which scales as the 5th power of the number of basis functions. However, this step also occurs in the NEVPT2 or CASPT2 methods. Hence, in the limit of a small active space and a large molecule, the costs of NEVPT2 and DCD-CAS(2) are comparable. If this is the case, the computational cost related to the integral transformation can be reduced by using the RI version of DCD-CAS(2) that was introduced in Section \ref{Sec:RIDCD}. In practice, this limit has not been observed, and for accessible system sizes the computational cost is usually dominated by parts of the algorithm other than the integral transformation.

\subsection{Model space non-invariance}
\subsubsection{Multi-partitioning and model space invariance}
Granovsky\cite{Grano_2011_214113} introduced the requirement that the effective Hamiltonian of a multistate perturbation theory method should be a function of the model space, rather than a function of any particular choice of basis in this subspace, like the CASSCF roots. In other words, the effective Hamiltonian should be invariant under unitary transformations of the reference functions. We call this property model space invariance.
The definitions given above are somewhat vague, since the CASSCF roots, which are the usual “particular choice” of basis in the model space, are by themselves a function of the complete subspace only (obtained by diagonalizing the Hamiltonian in this subspace). The only exception to this statement is the occurrence of degenerate CASSCF roots. An alternative definition of non-invariance could be that the 0th order Hamiltonian, as a function of the model space states, must have the same functional form for any basis of the model space. In our opinion the issue boils down to the following: Assuming that at the CASCI level two electronic states are exactly degenerate, these states can be arbitrary linear combinations of a given set of many-electron basis functions in the degenerate subspace. The results of a MRPT should then preferably be invariant under unitary transformations within this degenerate set because otherwise they are not well-defined. This invariance property is actually also important in situations of near-degeneracy of the CASCI solutions (for example around conical intersections or in the vicinity of avoided crossings), even though a non-invariant MRPT is also well-defined in this case. Consider for example a conical intersection.
 The electronic energies for a small degeneracy-breaking displacement from a nuclear geometry where two states are degenerate can be obtained by considering the displacement as a perturbation and performing 1st order degenerate perturbation theory (DPT1). This amounts to the diagonalization of the displaced electronic Hamiltonian in the basis of the degenerate electronic states, leading to two solutions that have the characteristic double cone topology. Focusing for example on the upper sheet of the potential energy surface (PES)\nomenclature{PES}{Potential energy surface}, it is now possible, by properly choosing the direction of the displacement within the so-called $g$-$h$ plane\cite{Yarko_1998_511} (the two-dimensional subspace in which the degeneracy is broken), to obtain any arbitrary linear combination of the two degenerate electronic states as an eigenstate. This follows from the discussion of the geometric phase effect by Mead and Truhlar.\cite{MeadT_1979_2284} But since the result of a non-invariant MRPT is not independent of the actual linear combination and is continuous with respect to nuclear displacements, the energy can show unphysical artifacts (while ideally it should remain constant) when travelling along a small loop around the point of degeneracy in nuclear space.
The usual QDPTs with a single ${H_0}$ can be considered as special cases of the intermediate normalization and canonical Van Vleck variants of multi-partitioning perturbation theory described above, by defining
	\begin{equation}
	{H_0}(I) = {H_0}
	\end{equation}
for all 0th order states $I$. Multi-partitioning therefore provides a unified framework in which many of the most popular multistate MRPTs can be discussed. We are now interested in what is needed for a theory to be invariant and investigate why some established theories do not have this property. In the following discussion we stick to the intermediate normalization formalism, since the canonical Van Vleck version does not add any new aspects regarding non-invariance, and to the 2nd order of perturbation theory; see the expression for ${H^{{\text{eff}}(0 - 2)}}$ in Eq. (\ref{Eq:Heff_multipart_basisindep}).
All terms in the resolvent in Eq. (\ref{Eq:statespecific_resolvents}) that correspond to a nondegenerate 0th order CASCI state are well-defined. Let us concentrate on a partial sum of terms that belong to a degenerate level. Defining two different bases of the degenerate space (distinguished by primed and unprimed indices) that are connected via a unitary transformation,
	\begin{equation}
	|\Psi _{I'}^{(0)}\rangle  = \sum\limits_{J \in {\text{deg}}} | \Psi _J^{(0)}\rangle {U_{JI'}},
	\end{equation}
it is necessary for uniqueness of the MRPT procedure that
	\begin{equation}
	\begin{split}
	\sum\limits_{I' \in {\text{deg}}} {{R_{I'}}} (I')H|\Psi _{I'}^{(0)}\rangle \langle \Psi _{I'}^{(0)}| &= \sum\limits_{IJ \in {\text{deg}}} {\left[ {\sum\limits_{I' \in {\text{deg}}} {{U_{II'}}} {R_{I'}}(I')U_{I'J}^\dag } \right]} H|\Psi _I^{(0)}\rangle \langle \Psi _J^{(0)}| \\
	&= \sum\limits_{I \in {\text{deg}}} {{R_I}} (I)H|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|,
	\end{split}
\end{equation}
which is fulfilled if
	\begin{equation}
	\label{Eq:condition_invariance_multipart}
	\sum\limits_{I' \in {\text{deg}}} {{U_{II'}}} {R_{I'}}(I')U_{I'J}^\dag  = {\delta _{IJ}}{R_I}(I).
	\end{equation}
Note that the unitary matrix introduced here is unrelated to the unitary decoupling operator of canonical Van Vleck perturbation theory, for which the same symbol $U$ was used. Eq. (\ref{Eq:condition_invariance_multipart}) is true if the 0th order Hamiltonians $H_0(I)$ for all $I$ in the degenerate space are identical, which can for example be achieved by constructing it with state-averaged orbitals and orbital energies in the case that there are degeneracies among the CASCI solutions. In order to ensure a continuous PES, it is then necessary to also have some kind of state-averaging when states are only nearly degenerate, which could e.g. be achieved with a switching function that mixes in some character of other states into the 0th order Hamiltonian if these states are close in energy. Such an approach has been reported recently.\cite{LiLE_2019_144107} However, our experience shows that NEVPT2 with a state-specific 0th order Hamiltonian usually has a significantly lower total energy than SA-NEVPT2, sometimes by as much as 10 eV or more; see Appendix \ref{Sec:appendix_SSvsSANEVPT2totalE} for an example. With SA-NEVPT2 we mean a version of NEVPT2 that uses the same Dyall Hamiltonian, constructed using the state-averaged density matrix, for all roots.
This means that using a state-averaged 0th order Hamiltonian in cases of (near-)degeneracy and using a state-specific 0th order Hamiltonian when other states are well separated probably leads to an unbalanced treatment of different regions on the PES, and possible artificial “bumps” in the MRPT energies in regions of (near-)degeneracy. This leads us to the conclusion that a balanced and model-space invariant multistate MRPT within the multi-partitioning framework is only possible by making all 0th order Hamiltonians identical, i.e. abandoning the whole multi-partitioning idea and returning to traditional QDPT.

\subsubsection{Importance of different forms of invariance}
Having established that a true multi-partitioning theory probably cannot be made fully invariant in a consistent way, we now investigate different forms of non-invariance and address the question whether the kind of non-invariance introduced by the multi-partitioning is an acceptable price to pay in order to have a better 0th order description.
The 0th order Hamiltonians can be separated into a part that acts in the model space and a part that acts in the complementary space,
	\begin{equation}
	\label{Eq:H0PPQQ}
	{H_0}(I) = H_0^{PP} + H_0^{QQ}(I) = \sum\limits_J | \Psi _J^{(0)}\rangle E_J^{(0)}\langle \Psi _J^{(0)}| + \sum\limits_{K \in {\text{FOIS}}} | \Psi _K^{(0)}(I)\rangle E_K^{(0)}(I)\langle \Psi _K^{(0)}(I)|.
	\end{equation}
Note that one can always ensure that the PP part of the 0th order Hamiltonian is identical for all reference states $I$ by defining it like in Eq. (\ref{Eq:H0PPQQ}). We discussed above that one source of non-invariance is multi-partitioning itself, i.e. having different $H_0^{QQ}(I)$ for states that are degenerate at the CASCI level. This $I$-dependence has two common reasons:
\begin{itemize}
\item The spaces of perturbers depend on $I$ (contracted perturbers).
\item	A state-specific model operator (e.g. Fock operator or Dyall Hamiltonian) is used.
\end{itemize}
But also in traditional QDPT the single ${H_0}$ can be ill-defined if e.g. CASCI state projectors are used in its definition (called “type I” non-invariance by Granovsky\cite{Grano_2011_}). This is the case in traditional MS-CASPT2 (even if the MS-MR contraction scheme and a state-averaged Fock operator are used) and MCQDPT2. In both cases, the $PP$ part of $H_0$ is ($F$ denoting the state-averaged Fock operator)
\begin{equation}
\label{Eq:H0noninv}
	H_0^{PP} = \sum\limits_I | \Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|F|\Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|,
\end{equation}
which is not well-defined if there are accidental degeneracies among the CASCI roots. This non-invariance issue is solved in XMCQDPT2 and XMS-CASPT2, where the $PP$ part of $H_0$ is
	\begin{equation}
	\label{Eq:H0inv}
	H_0^{PP} = PFP = \sum\limits_{IJ} | \Psi _I^{(0)}\rangle \langle \Psi _I^{(0)}|F|\Psi _J^{(0)}\rangle \langle \Psi _J^{(0)}|.
	\end{equation}
Note that this kind of non-invariance does not occur in QD-NEVPT2. This is because the latter uses Dyall’s Hamiltonian as a model operator: when replacing $F$ by $H_\text{Dyall}$, Eqs. (\ref{Eq:H0noninv}) and (\ref{Eq:H0inv}) are identical, since the Dyall Hamiltonian has vanishing off-diagonal matrix elements in the CASCI state basis. Table \ref{Tab:Methods_noninvariance} contains an overview of the different sources of non-invariance in several variants of multistate MRPT.
\begin{table}
\small
\ttabbox
{\caption{Comparison of different MRPT methods according to different reasons for model space non-invariance.}
\label{Tab:Methods_noninvariance}}
{\input{Tables/Methods_noninvariance.tex}}
\end{table}
The only fully invariant methods in this list are uncontracted QD-NEVPT2 with a state-averaged Dyall Hamiltonian, XMS-CASPT2 with the MS-MR contraction scheme, and XMCQDPT2. DCD-CAS(2) is excluded from the discussion since it does not properly fit into the framework introduced here. Also note that XMS-CASPT2 with the SS-SR scheme (state-specific contraction spaces) can be considered as a so far unrecognized example of the combination of multi-partitioning with Van Vleck perturbation theory.
There are hints that the different sources of non-invariance discussed above are not all equally bad. In the original paper by Granovsky, the only investigated non-invariant theories were MS-CASPT2 and MCQDPT2, which both have “type I” non-invariance. In these cases severe artifacts were observed. There is however a presentation by Granovsky that contains unpublished results about the non-invariance of QD-NEVPT2.\cite{Grano_2011_} It is shown there that the non-invariance in QD-NEVPT2 has actually much less severe consequences than the one in MS-CASPT2 or in MCQDPT2. This leads us to conclude that non-invariance due to multi-partitioning is not as much of a problem as the ``type I'' non-invariance. This assumption will be further investigated in Section \ref{Sec:allene_noninvariance}.

\chapter{Tests of the DCD-CAS(2) and HQD-NEVPT2 methods}
\label{Sec:Benchmarking}
In order to assess the different variants of DCD-CAS(2), we discuss in this chapter calculations for traditional test cases in which multistate methods are crucial, namely the LiF avoided crossing and the treatment of magnetic exchange coupling.
We also perform numerical tests to investigate basic properties of the methods, like the extent of size-consistency violation in DCD-CAS(2), the  breaking (or not) of orbital degeneracy, as well as the extent of model space non-invariance and occurrence of complex eigenvalues in the non-Hermitian QD-NEVPT2. 

\section{Tests of DCD-CAS(2)}
\subsection{Computational details}
For the numerical evaluation of the size-consistency errors in the ground state, we performed computations on three systems with varying active spaces: (a) 2 Li\textsubscript{2} molecules with a minimal CASSCF(2,2) for the monomer ($2s$ orbitals active) and a corresponding CASSCF(4,4) for the noninteracting dimer, (b) 2 Be atoms with CASSCF(2,4) ($2s$ and $2p$ orbitals active) for the monomer and CASSCF(4,8) for the dimer and (c) 2 N atoms with CASSCF(3,3) for a single atom ($2p$ orbitals active) and CASSCF(6,6) for the dimer. For the noninteracting systems, a distance of 100 Å was chosen. The def2-TZVP basis set\cite{WeigeA_2005_3297} was used and energy and gradient convergence thresholds of $E_\text{tol} = 10^{-11}$ and $g_\text{tol}=10^{-6}$ were chosen in order to remove numerical noise. 
For the MRCI calculations, the thresholds $T_\text{sel}$ and $T_\text{pre}$ were set to 0.0. Only one root was optimized in all cases. For Li\textsubscript{2} and Be a singlet state was chosen in both the monomer and the noninteracting dimer. For the N atom, a quartet state was chosen, which is coupled to a singlet in the noninteracting dimer.

For the investigation of size-intensivity errors in excitation energies, we investigated a benzene molecule with different noble-gas atoms at a distance of 100 Å from its center. The def2-TZVP basis set was used. The reference calculation was a CASSCF(6,6) (including the six valence $\pi$ electrons and orbitals of benzene in the active space) averaged over the lowest seven singlet and six triplet roots, with convergence thresholds $E_\text{tol} = 10^{-11}$ and $g_\text{tol}=10^{-5}$.

For the investigation of the avoided crossing between potential energy curves in the LiF molecule, we also used the def2-TZVP basis. The reference calculation was a CASSCF(2,2) (Li $2s$ and F $2p_z$ active), averaged over the two lowest singlet roots and with convergence thresholds of $E_\text{tol} = 10^{-11}$ and $g_\text{tol}=10^{-6}$. For the MRCI calculations, $T_\text{sel}$ and $T_\text{pre}$ were set to 0.0 and a direct inversion in the iterative subspace (DIIS)\cite{Pulay_1980_393}\nomenclature{DIIS}{Direct inversion in the iterative subspace} solver was used since for this system the default Davidson solver\cite{David_1975_87} converges to a wrong excited state. The residual and energy convergence thresholds for the MRCI calculations $R_\text{tol}$ and $E_\text{tol}$ were tightened to $10^{-8}$.

For an investigation of magnetic exchange in three model exchange coupled dimers, the def2-TZVP basis set was used. For the so-called copper ``paddlewheel'' complex  Cu\textsubscript{2}(µ-CH\textsubscript{3}COO)\textsubscript{4}(H\textsubscript{2}O)\textsubscript{2}, the resulting DDCI calculations would be too computationally expensive; hence def2-SVP was used on all atoms except Cu.
The reference calculations were CASSCF(2,2) including one localized magnetic orbital on each center (H atom or Cu atom). For H--He--H, those are the H $1s$ orbitals, for Cu dimers those are the $d$ orbitals that have their orbital lobes in the direction of the ligand atoms. The CASSCF calculations were averaged over the lowest triplet and lowest singlet state with convergence thresholds of $E_\text{tol} = 10^{-10}$ and $g_\text{tol} = 10^{-4}$. For the DDCI calculations, $T_\text{pre}$ was set to 0.0 while different values of $T_\text{sel}$ were tried (see below). $R_\text{tol}$ and $E_\text{tol}$ were tightened to $10^{-8}$.

All calculations in this section were re-run compared to our original publication,\cite{PathaLN_2017_234109} with slightly different computational details in a few occasions. For example, our initial publication used the aug-cc-pVTZ basis set for the investigation of size-consistency errors in the noninteracting dimers. Also note that the two rows for Li\textsubscript{2}···Li\textsubscript{2} and Be···Be in Table II of that publication have been accidentally swapped.

\subsection{Size consistency} 
Table \ref{Tab:GS_sizeconsistency} shows, in accordance with the analytical proof in Section \ref{Sec:DCD_SC_proof}, that DCD-CAS(2) is not strictly size-consistent. However, the ground state size-consistency errors are only on the order of micro-Hartrees for the uncorrected DCD-CAS(2) scheme. This error is accentuated in the uncorrected DCD-CAS(2) due to the ground state bias introduced as a result of using the CASSCF ground state energy in the denominator of the 2nd order Hamiltonian. This is the reason for the observed improvement in the size consistency when the bias correction is added. Since the $ij\rightarrow ab$ excitation class contributes a large amount (also in terms of the bias) to the diagonal matrix elements of the Hamiltonian, a further substantial improvement is achieved by using the difference-dedicated scheme. Hence, we can safely argue that the slight lack of ground state size consistency will be of little to no consequences in practical applications.\cite{RinteAVG_2005_44105} Attention is also drawn to the case of the nitrogen molecule, where all variants of DCD-CAS(2) are exactly size-consistent. This is exactly what was predicted on theoretical grounds in Section \ref{Sec:DCD_SC_proof}. 
\begin{table}
\small
\centering
\ttabbox
{\caption[Ground state size-consistency errors for several variants of DCD-CAS(2) along with NEVPT2 and MRCI.]{Ground state size-consistency errors ($|E_\text{dimer} - 2E_\text{monomer}|$) in µHa for several variants of DCD-CAS(2) along with NEVPT2 and MRCI. A distance of 1.0 Å was maintained for each Li\textsubscript{2} molecule; see the supplementary material of our original publication for Cartesian coordinates.\cite{PathaLN_2017_234109} The noninteracting systems were placed 100 Å away from each other for the super-molecule calculations.}
\label{Tab:GS_sizeconsistency}}
{\input{Tables/GS_sizeconsistency.tex}}
\end{table}

While total energies should be size-extensive\cite{BartlP_1978_561} (i.e. be proportional to the system size), excitation energies for local excitations should be size-intensive,\cite{KochJJH_1990_3345} i.e. independent of the total system size. For an assessment of size-intensivity errors in excitation energies, we employed a different model system: a molecular system in the presence of a spectator system, such that all the active orbitals belong to the molecular system alone. This is an important test for transition metal complexes with increasingly larger closed-shell ligands. For this case study, we chose our molecular system to be benzene (Bz) and placed noble-gas atoms of increasing size, namely He, Ne, Ar, and Kr, far from its center. In Table \ref{Tab:XBz_sizeconsistency} we report the difference in valence $\pi$-$\pi^\ast$ excitation energies (in meV) of Bz+X (X=He, Ne, Ar and Kr) with respect to the corresponding excitation energies of benzene for a few low-lying singlet and triplet states. CASSCF and NEVPT2 both give the same excitation energies in the presence of all noble-gas atoms, as is expected of a size-consistent theory. These results are therefore not shown in the table. In accordance to our theoretical analysis, the error increases with increasing system size for the uncorrected DCD-CAS(2). This is expected since the total correlation energy is increasing with the system size as well. As can be seen from the values for bc-DCD-CAS(2) in Table \ref{Tab:XBz_sizeconsistency}, the situation improves strongly once the spectrum is bias-corrected. It is also seen that the error is significantly smaller for the triplet excitations. 
The difference-dedicated scheme removes all size-intensivity errors in excitation energies. Both D\textsuperscript{3}CD-CAS(2) and its bias-corrected version predict exactly the same excitation spectrum in the presence of the noble-gas atoms. This outcome agrees well with Malrieu’s argument in favor of DDCI that excluding the $ij\rightarrow ab$ excitations (or including it globally for all roots, as in our case) reduces size-consistency errors.\cite{MiralCCM_1993_33, GarciCCM_1995_222}
Remember also the theoretical proof we gave in Section \ref{Sec:DCD_SC_proof} that the D\textsuperscript{3}CD-CAS(2) will be exactly size-consistent for this kind of model problem (open-shell system in the presence of a noninteracting closed-shell spectator system).
\begin{table}
\small
\centering
\caption[Size-intensivity errors in valence $\pi$-$\pi^\ast$ excitation energies of benzene in the presence of a noninteracting noble-gas atom.]{Size-intensivity errors in valence $\pi$-$\pi^\ast$ excitation energies (in meV) with respect to benzene (Bz) for supersystems consisting of Bz+He, Bz+Ne, Bz+Ar, and Bz+Kr for DCD-CAS(2) and bc-DCD-CAS(2) methods. D\textsuperscript{3}CD-CAS(2) and bc-D\textsuperscript{3}CD-CAS(2) have no size-intensivity errors for excitation energies in these systems, since the noble gases are closed-shell atoms.}
\label{Tab:XBz_sizeconsistency}
\input{Tables/XBz_sizeconsistency.tex}
\end{table}


\subsection{Avoided crossing}

Predicting an avoided crossing between the neutral and ionic potential energy curves of the same spatial and spin symmetry remains a quintessential test in the debate around multistate methods.\cite{SpiegM_1984_1235, SpiegM_1984_1259, SivalKAN_2016_54104} On one hand, the CASSCF treatment predicts a too short distance and too large energy gap for the crossing, which is obviously not useful for further property computations or collision studies.  Dynamic correlation affects the ionic state much more than the neutral state and not including this effect results in a qualitatively incorrect wavefunction. However, straightforward inclusion of dynamic correlation via state-specific theories, 2nd or higher order, based on the bad CASSCF reference is bound to fail if the wavefunction is not allowed to relax. ``Blindly'' following the CASSCF wavefunction results in a double-crossing instead of an avoided one. The reason is that the reference CASSCF wavefunction is a very bad approximation for the true correlated state between the distances where the avoided crossing occurs at the CASSCF and the correlated level. The \textit{a posteriori} corrections via a quasidegenerate treatment including only the states of interest improves the description by removing the double-crossing artifact and otherwise maintaining roughly the same features as the corresponding contracted formulation. The MS-CASPT2 potential energy curves around conical intersections have however been shown to suffer from artifacts and singularities.\cite{Grano_2011_214113, SerraML_2005_104107, DeViPHSR_2008_136} It has been explained that these artifacts stem from the non-invariance of the method under rotations of the 0th order states in the model space.\cite{Grano_2011_214113} Similar methods like QD-NEVPT2 are also noninvariant and therefore expected to show such artifacts.\cite{Grano_2011_214113, SharmJA_2016_34103}
The presented arguments clearly demonstrate the need for a “perturb-then-diagonalize” method to tackle this problem. Recently developed invariant theories, like XMCQDPT2, XMS-CASPT2 and QD-NEVPT2 based on matrix product states, are expected to further improve the overall nature of the curves but are not investigated in this work. We apply the DCD-CAS(2) method to compute the ionic-covalent curve crossing in LiF which has been a subject of study for over four decades now.\cite{BauscL_1988_4246, KahnHS_1974_3530, WerneM_1981_5802} Angeli \textit{et al.} discuss this case in detail in the papers presenting their ideas on decontraction.\cite{AngelBCC_2004_4043, AngelCCM_2006_234109} They use the same basis as used by Bauschlicher and Langhoff in their full CI study.\cite{BauscL_1988_4246} In this setting, the CASSCF crossing occurs around 4.1 Å and the full CI crossing around 6.6 Å. The QD-NEVPT2 predicts 5.8 Å and 6.2 Å for the strongly contracted (SC)\nomenclature{SC}{Strongly contracted} and partially contracted (PC)\nomenclature{PC}{Partially contracted} treatments, respectively. MS-CASPT2 calculations done by the same authors turn out to be closer to the SC variant. We take these values as rough guidelines for our analysis. 
In this work, we stick to a minimal active space of two electrons in two active orbitals, consisting of the $2s$ of Li and $2p_z$ of F. When the goal is a very good agreement with the experiment, an active space of six electrons in six orbitals is often used for this molecule, but we use a minimal active space since it contains all essential physics. The orbitals obtained from the SA-CASSCF(2,2) calculation are used to perform dynamic correlation computations via NEVPT2, QD-NEVPT2, MRCI+Q and DCD-CAS(2) variants. Here, +Q denotes the multireference analog of Davidson’s correction, which is computed as $(1 - W){E_c}$, with ${E_c}$ being the uncorrected correlation energy and $W$ ($\leq 1$) the weight of the reference configurations in the total normalized wavefunction. Table \ref{Tab:crossingpoints_gaps} shows the points of minimum vertical energy differences from the employed methods.
\begin{table}
\small
\centering
\ttabbox
{\caption[Crossing point and energy difference for the avoided crossing of LiF.]{Crossing point (in Å) and energy difference (in eV) at the crossing point for the avoided crossing of LiF computed with DCD-CAS(2) variants compared to CASSCF, QD-NEVPT2, and MRCI+Q at the CAS(2,2)/def2-TZVP level of theory.}
\label{Tab:crossingpoints_gaps}}
{\input{Tables/LiF_crossingpoints_gaps.tex}}
\end{table}
It is encouraging to see that all the reported DCD-CAS(2) variants perform well. All variants predict qualitatively correct potential energy surfaces. The numerical performance is comparable but still shows non-negligible deviations from the MRCI+Q results used as a reference. We mostly attribute this to the shortcomings of the low-order perturbation treatment of the dynamic correlation energy. We show the uncorrected DCD-CAS(2) PES in comparison to the well-known double crossing of NEVPT2 and its correction by the QD-NEVPT2 in Figure \ref{Fig:LiF_overview}.
\begin{figure}
\includegraphics[width=\textwidth]{figures/LiF_avoidedcrossing/LiF_overview-crop}
\caption[Potential energy curves for the first two $^1\Sigma^+$ states of LiF in the avoided crossing region.]{Potential energy curves for the first two $^1\Sigma^+$ states of LiF in the avoided crossing region. The energy of each method is reported relative to the ground state energy in the dissociation limit. The figure shows a comparison of the uncorrected DCD-CAS(2) with NEVPT2 and QD-NEVPT2.}
\label{Fig:LiF_overview}
\end{figure}
Figure \ref{Fig:LiF_closeup} shows a close-up of the avoided crossing region of the potential energy curves of the first two $^1\Sigma^+$ states.
\begin{figure}
\includegraphics[width=\textwidth]{figures/LiF_avoidedcrossing/LiF_closeup-crop}
\caption[Close-up of the potential energy curves for the first two $^1\Sigma^+$ states of LiF in the avoided crossing region.]{Close-up of the potential energy curves for the first two $^1\Sigma^+$ states of LiF in the avoided crossing region. The energy of each method is reported relative to the ground state energy in the dissociation limit. The figure shows a comparison of several DCD-CAS(2) variants with MRCI+Q.}
\label{Fig:LiF_closeup}
\end{figure}
The DCD-CAS(2) results in all variants are rather close to the QD-NEVPT2 results. Furthermore, the potential energy curves are smoother and do not show the unphysical artifact of the QD-NEVPT2 curve in the avoided crossing region of the CASSCF solutions around a distance of 4 Å.
It is also encouraging to observe that the DCD-CAS(2) and D\textsuperscript{3}CD-CAS(2) results are very similar after including the bias correction.

\subsection{Magnetic exchange coupling}
\label{Sec:Exchange}
The qualitative and quantitative estimation of the electronic structure and properties of systems consisting of two or more interacting open-shell magnetic ions has been a constant source of discussion within both the wavefunction and DFT communities.\cite{HayTH_1975_4884} Here, we present a brief résumé of the problem. For details, the reader is referred to a recent review\cite{MalriCCGG_2014_429} as well as the series of landmark papers by Calzado and coworkers.\cite{CalzaCMC_2002_2728, CalzaCMC_2002_3985, CalzaATCM_2009_44327} We use a simple valence only model with two unpaired electrons in two MOs $a$ and $b$, assumed to be localized at the magnetic centers. The corresponding space of four determinants with $M_S=0$ gives rise to four wavefunctions. The first two are a purely neutral triplet state
\begin{equation}
  |{}^3{\Psi _u}\rangle  = \frac{1}{{\sqrt 2 }}(|a\bar b\rangle  - |b\bar a\rangle )
\end{equation}
and a purely ionic singlet state
\begin{equation}
  |{}^1{\Psi _u}\rangle  = \frac{1}{{\sqrt 2 }}(|a\bar a\rangle  - |\bar bb\rangle ).
\end{equation}
The two remaining singlet states have the same symmetry and can therefore mix. They are dominated by either neutral or ionic character and can be written as linear combinations of two states that are purely neutral or purely ionic, 
\begin{align}
|^1\Psi_g^\text{N}\rangle &= \frac{1}{\sqrt{2}}(|a\bar b\rangle + |b\bar a\rangle),\\
|^1\Psi_g^\text{I}\rangle &= \frac{1}{\sqrt{2}}(|a\bar a\rangle + |b\bar b\rangle).
\end{align}
The lower energy one, which is essentially neutral, is given by 
\begin{equation}
|^1\Psi_g\rangle = C_\text{N} |^1\Psi_g^\text{N}\rangle + C_\text{I} |^1\Psi_g^\text{I}\rangle
\end{equation}
with $C_\text{N}>C_\text{I}>0$. The higher energy, essentially ionic, one is given by
\begin{equation}
|^1\Psi'_g\rangle = -C_\text{I} |^1\Psi_g^\text{N}\rangle + C_\text{N} |^1\Psi_g^\text{I}\rangle.
\end{equation}
As represented schematically in Figure \ref{Fig:exchangecoupling}, one can see that the sign and magnitude of the coupling constant ($2J$, the energy difference between the lowest singlet and triplet states) depends on the contribution of the ionic part $|^1\Psi_g^\text{I}\rangle $ in the final correlated ground state wavefunction. This mixing determines the amount of stabilization of the essentially neutral $\left| {{}^1{\Psi _g}} \right\rangle $ state. $K_{ab}$ denotes the direct exchange integral between magnetic orbitals $a$ and $b$,\cite{CalzaCMC_2002_2728} which quantifies the stabilization and destabilization of the CSFs with respect to the determinants obtained from orbitals $a$ and $b$.
\begin{figure}
\centering
\ffigbox[\FBwidth]
{\caption[Schematic representation for the interpretation of magnetic exchange coupling between two local spin-1/2 subsystems.]{Schematic representation for the interpretation of magnetic exchange coupling between two local spin 1/2 subsystems. The three parts of the figure represent (a) pure determinants constructed from the localized orbitals and (b) spin- and spatial-symmetry adapted CSFs. Here the ones with gerade symmetry increase their energy by $K_{ab}$, the ones with ungerade symmetry decrease their energy by the same amount. (c) two CSFs of the same space and spin symmetry are allowed to mix.}
\label{Fig:exchangecoupling}}
{\includegraphics[width=0.8\textwidth]{figures/Exchangecoupling_schematic/energylevels-crop.pdf}}
\end{figure}
The ionic singlets are much too high in energy in CASSCF treatments but relax greatly under the influence of dynamic correlation. In fact, higher order dynamic correlation methods, like the DDCI method,\cite{BordaCGIRC_2007_154} are standard tools for such computations but they become impractical rather quickly with increasing system size. This is the reason why more cost-effective alternatives, like MRPT, are desirable. “Diagonalize-then-perturb” approaches that apply corrections on top of this badly described 0th order wavefunction are not able to make much difference. Traditional QDPT using the whole four-dimensional model space is often not very useful because of the high energy gap between the neutral and ionic singlet states, which can lead to divergence for the ionic states.\cite{AngelCCM_2006_234109} The ionic character of the ground state singlet is known to increase by a factor of five or more, reported as $C_\text{I}/C_\text{N}$ ratios in previous DDCI studies of such systems.\cite{CalzaCMC_2002_3985}
We have chosen three systems to demonstrate the improvements that DCD-CAS(2) offers in predicting magnetic exchange coupling constants relative to state-specific MRPT theories. However, it should not be forgotten that this is only a 2nd order treatment that cannot catch all relevant physical effects which enter into the relative spin-state energies.\cite{CalzaCMC_2002_2728} 
The prototypical model system H--He--H is chosen for its sheer simplicity in describing the phenomenon. The two other examples involve two well-studied binuclear Cu\textsuperscript{II} complexes with different bridging ligands, [Cu\textsubscript{2}Cl\textsubscript{6}]\textsuperscript{2\textminus} and Cu\textsubscript{2}(µ-CH\textsubscript{3}COO)\textsubscript{4}(H\textsubscript{2}O)\textsubscript{2}. A number of studies discuss the physical properties as well as the electronic structure and magnetic properties of these systems.\cite{HayTH_1975_4884, MalriCCGG_2014_429, FiggiM_1956_3837, GuedeSF_1979_1021} Although there have been some suggestions of using extended active spaces\cite{CalzaACM_2010_185} and magnetically optimized orbitals,\cite{AngelC_2012_34104} we stick to a minimal active space of two electrons in two (localized) orbitals to focus on the physics of the problem. In addition to reporting the exchange coupling constant ($2J$), we also provide the percentage contribution of the neutral and ionic states to the final singlet wavefunction as obtained by the diagonalization of the corresponding Hamiltonian. This demonstrates the effect of dressing introduced in DCD-CAS(2) on the singlet neutral ground state by increasing the contribution of the higher lying ionic state. 

Before coming to the numerical results, we investigate a technical aspect of the reference DDCI calculations. The ORCA MRCI program is of the individually selecting type. This means that among all single and double excitations on top of the reference space only those CFGs are selected and included into the diagonalization space that have a contribution at 2nd order PT that is larger than some threshold $T_\text{sel}$. The sensitivity of the calculated exchange coupling constants on this parameter for DDCI and DDCI+Q is shown in Table \ref{Tab:DDCI_convergence}.
\begin{table}
\small
\centering
\ttabbox
{\caption[Convergence of the exchange coupling constants $2J$ at the DDCI level.]{Convergence of the DDCI and DDCI+Q exchange coupling constants $2J$ (in cm\textsuperscript{\textminus 1}) with tightening the perturber selection threshold T\textsubscript{sel}.}
\label{Tab:DDCI_convergence}}
{\input{Tables/ConvergenceDDCIExchangeCoupling.tex}}
\end{table}
It can be seen that for the pure DDCI, the exchange coupling converges fairly slowly. Even at the smallest tested nonzero threshold of $10^{-10}$ there is still a relatively large deviation for the \Cuacetate\ molecule. For DDCI+Q the convergence is quicker, with relatively accurate results already for a threshold of $10^{-9}$. These results still show that the threshold of $10^{-6}$ used in ORCA by default will lead to completely unreliable results. In the following, we set $T_\text{sel}$ to 0, meaning all excited CFGs are included into the diagonalization without individual selection.

The numerical results are presented in Table \ref{Tab:Exchangecoupling}.
\begin{table}
\small
\centering
\ttabbox
{\caption[Exchange coupling constants and contribution of the ionic CFG to the ground state singlet wavefunction.]{Exchange coupling constants (in cm\textsuperscript{-1}) and contribution of the ionic CFG to the ground state singlet wavefunction computed at various levels of theory. The CI methods are Full CI for H--He--H and DDCI+Q for the Cu dimers.}
\label{Tab:Exchangecoupling}}
{\input{Tables/ExchangeCoupling.tex}}
\end{table}
Results from all the variants of DCD-CAS(2) lie in between that of NEVPT2 and CI treatments (full CI in the case of H--He--H model and DDCI+Q in case of the copper complexes). CASSCF and the CI methods represent the lowest and highest degrees of mixing with the ionic states, respectively. We expect the mixing achieved by DCD-CAS(2) to fall between these two. For Cu\textsubscript{2}(µ-CH\textsubscript{3}COO)\textsubscript{4}(H\textsubscript{2}O)\textsubscript{2}, the ionic contribution is increased by an order of magnitude for DDCI and a $2J$ value roughly six times that of NEVPT2 is achieved. Although DCD-CAS(2) $2J$ values are not in perfect agreement with the CI methods, they are a considerable improvement from the CASSCF/NEVPT2 ones. The ionic contribution to the ground state singlet wavefunction is even almost perfectly reproduced by D\textsuperscript{3}CD-CAS(2). Decontraction is unavoidable for the calculation of coupling constants and [Cu\textsubscript{2}Cl\textsubscript{6}]\textsuperscript{2\textminus} is a good example. The experimental estimate for the value of $2J$ for this complex is in a range of 0 to –40 cm\textsuperscript{\textminus 1}\cite{CasteMC_1994_377} and a largely accepted value is around –35 cm\textsuperscript{\textminus 1}.\cite{CalzaCMC_2002_3985} CASSCF underestimates the mixing so much that a triplet ground state is predicted for [Cu\textsubscript{2}Cl\textsubscript{6}]\textsuperscript{2\textminus} and subsequent NEVPT2 is also not able to predict the correct ground state multiplicity. While DCD-CAS(2) improves the estimate in the correct direction, it is still not able to predict the correct sign. With bias correction, the sign is corrected. D\textsuperscript{3}CD-CAS achieves a very good mixing ratio of the high lying ionic state and with bias-correction it predicts a value for $2J$ with roughly the correct magnitude. 
A look at the corresponding neutral to ionic ratios in the ground state wavefunction is helpful in understanding the situation. The ionic contribution in the singlet wavefunction for the conventional DCD-CAS(2) treatment increases but an evidently better estimate is reached only with the difference-dedicated version. Since the energy difference between the states of same symmetry is quite high, the bias correction plays an important role in both cases. 
The effects of the DCD/D\textsuperscript{3}CD-CAS(2) corrections are nicely revealed upon examining the matrix elements of the corresponding effective Hamiltonian. We report in Table \ref{Tab:Matrixels_mixingratios} the difference between diagonal elements, $\Delta  = H_{II}^{} - H_{NN}$, and the ionic/neutral off-diagonal effective Hamiltonian matrix element $H_{IN}$. ${C_\text{I}}/{C_\text{N}}$ ratios are also reported to show the extent of mixing of the ionic with the neutral functions in these methods. The mixing ratios are readily estimated by 2nd order perturbation theory to be roughly 
\begin{equation}
\frac{{C_\text{I}}}{{C_\text{N}}} \approx  \frac{H_\text{NI}}{\Delta}.
\end{equation}
Table \ref{Tab:Matrixels_mixingratios} shows the extent of stabilization of the ionic contribution with respect to the 0th order treatment.
\begin{table}
\small
\centering
\ttabbox
{\caption[$C_\text{I}/C_\text{N}$ ratio and Hamiltonian matrix elements.]{$C_\text{I}/C_\text{N}$ ratio and Hamiltonian matrix elements (in eV).}
\label{Tab:Matrixels_mixingratios}}
{\input{Tables/Matrixels_mixingratios.tex}}
\end{table}
The mixing changes by a factor of four to five for D\textsuperscript{3}CD-CAS compared to CASSCF. This change is almost exclusively caused by the lowering of the diagonal energy of the ionic configuration in the dressed Hamiltonian, while the off-diagonal coupling matrix element remains largely unaffected by the dynamic correlation dressing. The stabilization of the ionic contributions is dramatic. For the two dicopper systems, the dressing changes the effective energy of the ionic configurations from about 24 eV to 5--6 eV, which is certainly in the realistic range.\cite{CalzaCMC_2002_3985} However, the appropriate stabilization does only occur in the difference-dedicated scheme.
Hence, it is instructive to analyze the differences between the difference-dedicated and non-difference-dedicated schemes. We return to the contribution of the $ij\rightarrow ab$ excitation class for the conventional DCD-CAS Hamiltonian, as explained in Section \ref{Sec:Efficient_ijab}. One can write the denominator of Eq. (\ref{Eq:ijab_matrixel}) as $\epsilon_a+\epsilon_b - \epsilon_i - \epsilon_b + \Delta E_I$. For the ground state, $I=0$, one has $\Delta E_I=0$ and the denominator has the usual MP2 form. But for excited states the difference $\Delta E_I$ (approximately 24~eV for both Cu complexes at the CASSCF level) can severely underestimate the contribution from the $ij\rightarrow ab$ class and introduce a bias into the diagonal elements, which is particularly large in this case. Thus, we see that even when dynamic correlation dressing via the conventional DCD-CAS(2) improves the singlet and triplet ground states, giving better estimates of the coupling constant, the $H_\text{II}$ value is rather large (more than the CASSCF one for the copper acetate complex) because of this unwanted ground state bias. This can be considered as an artifact of our formulation and we have already proposed a cure for this via the difference-dedicated approach. In this case, an overall inclusion of the  $\langle \Psi _I| H_{ij,ab}^{{\text{DCD}},(2)}  | \Psi _J \rangle $ for all CASCI states does not affect the ground state but removes the bias from the excited state, resulting in larger mixing and even better estimates of the coupling constant. The contribution from the off-diagonal term is also expected to increase the mixing between the neutral and ionic contributions but these effects are visible only at the 3rd order in PT and beyond.\cite{CalzaATCM_2009_44327} This explains the small values we obtain for the $H_{\text{NI}}$ elements. The change observed in the $H_{\text{NI}}$ elements in case of the DCD-CAS(2) in Table \ref{Tab:Matrixels_mixingratios} is only due to the fact that the contribution to the $ij\rightarrow ab$ class is included in the basis of CASCI roots and then transformed back to the CSF basis.

\section{Atomic multiplets}
We investigated the performance of DCD-CAS(2) and HQD-NEVPT2 for the calculation of spin-orbit-coupled excitation energies of the series of free divalent $3d$ TM ions from Ti\textsuperscript{2+} to Cu\textsuperscript{2+}. The calculations used the DKH-def2-QZVPP\cite{PantaCLN_2008_908} basis set and the DKH2\cite{Hess_1986_3742, JanseH_1989_6016} scalar-relativistic Hamiltonian. A minimal active space with five $d$-like active orbitals was chosen and the SA-CASSCF was averaged over all possible roots of all multiplicities. To avoid numerical noise in the investigation of orbital degeneracies, the calculations were converged to \textit{extremescf} accuracy.

Before discussing the results in the presence of SOC, we first have a look at the nonrelativistic excitation energies for the Co\textsuperscript{2+} ion in Table \ref{Tab:NonrelMultCoII}.
\begin{table}
\small
\centering
\ttabbox
{\caption[Vertical excitation energies for all $d$-$d$ excited states of the Co\textsuperscript{2+} ion.]{Vertical excitation energies (in cm\textsuperscript{\textminus 1}) for all $d$-$d$ excited states of the Co\textsuperscript{2+} ion at the CASSCF(7,5)/DKH-def2-QZVPP level with the DKH2 scalar-relativistic Hamiltonian. Averaged values and standard deviations thereof (in parentheses) are reported for NEVPT2 (in cm\textsuperscript{\textminus 1}). Values for CASSCF and all variants of DCD-CAS(2) are exactly degenerate.}
\label{Tab:NonrelMultCoII}}
{\input{Tables/Nonrel_MultipletEnergies_CoII.tex}}
\end{table}
It can be seen that while CASSCF gives excitation energies that are systematically too large, NEVPT2 and the bias-corrected variants of DCD-CAS(2) give excitation energies in quite close agreement with the experiment. These results also show that the errors due to the ground-state bias in the uncorrected energies can be quite large, here up to about 3000 cm\textsuperscript{\textminus 1}. Another interesting aspect is the fact that NEVPT2, like is expected for an internally contracted theory, is not model space invariant and therefore breaks orbital degeneracy of the underlying CASSCF references. The corresponding standard deviation within each (ideally exactly degenerate) $LS$ term is given in parentheses. The breaking is especially large for the $^2P$ and $^2H$ terms. The reason for this is a peculiar feature of $d^3$ and $d^7$ free ions or atoms like V\textsuperscript{2+} and Co\textsuperscript{2+}. At the CASSCF level, there is an accidental degeneracy between the $^2P$ and $^2H$ terms, which is also shown in Table \ref{Tab:NonrelMultCoII}. If spherical symmetry is not exploited, these two terms can arbitrarily mix at the CASSCF level, leading to unphysical 0th order wavefunctions. A subsequent NEVPT2 calculation cannot correct these unphysical 0th order wavefunctions, while DCD-CAS(2) produces pure $^2P$ or $^2H$ states by means of the dynamic-correlation-induced energy splitting between the two terms.

Having shown the superiority of the bias-correction scheme and the preservation of orbital degeneracy by all DCD-CAS(2) versions at the nonrelativistic level, we now move on to excitation energies in the presence of SOC. We sum up the main results of the calculations in Table \ref{Tab:MaxMean}. Detailed information on the excitation energies of all ions can be found in the supplementary material of our original publication.\cite{LangN_2019_104104}
\begin{table}
\small
\centering
\ttabbox
{\caption[Results for the excitation energies of free transition metal ions.]{Results for the excitation energies of free transition metal ions, expressed as mean absolute error (MAE) and maximum absolute error (MAX) with respect to the experiment for all total $J$ levels of each ion (in eV).}
\label{Tab:MaxMean}}
{\input{Tables/MII_AbsoluteAndMeanErrors_inclHQD.tex}}
\end{table}
It is evident that both NEVPT2 and DCD-CAS(2) provide significant improvements over CASSCF and agree reasonably well with the experimental results. Only for Mn\textsuperscript{2+} there are still relatively large errors. Note that the error for Cu\textsuperscript{2+} is so small because this ion has only one $LS$ term ($^2D$); hence the accuracy is not determined by nonrelativistic excitation energies but by the treatment of SOC. The difference between NEVPT2 and DCD-CAS(2) results is quite small, indicating that state-mixing effects in these systems are weak.
We are also interested in a comparison of NEVPT2 and HQD-NEVPT2, since both are not model space invariant. Table \ref{Tab:NEV_QDNEV_STD} shows the average standard deviation within the total angular momentum multiplets, calculated with NEVPT2 and HQD-NEVPT2. On average, HQD-NEVPT2 has slightly larger standard deviations, meaning the breaking of degeneracies is slightly stronger. But with the exception of the Mn\textsuperscript{2+} ion, the standard deviation always stays in the same order of magnitude as the NEVPT2 one. For two of the ions, namely V\textsuperscript{2+} and Co\textsuperscript{2+}, the average standard deviation of HQD-NEVPT2 is considerably lower than that of the nondegenerate NEVPT2.
The reason is that the degeneracy breaking at the NEVPT2 level of the $^2H$ and $^2P$ terms for V\textsuperscript{2+} and Co\textsuperscript{2+} also propagates to the relativistic calculations.
The exact state energies belonging to the $^2P$ and $^2H$ terms are given for the Co\textsuperscript{2+} ion in Table \ref{Tab:degbreaking}. 
 For the $^2H$ term of Co\textsuperscript{2+} the degeneracy breaking within the two levels $J=11/2$ and $J=9/2$ is so strong that we could not with confidence assign states to these two levels based on their energy. We therefore assigned the twelve states with lowest energy to $J=11/2$ and the remaining ten states to $J=9/2$. The obtained standard deviations within the two levels of 168.8 cm\textsuperscript{\textminus 1} and 167.7 cm\textsuperscript{\textminus 1} are larger than many energy splittings that are of relevance for magnetic phenomena. Even though the symmetry breaking in excited states is probably less important for magnetism, its occurrence is still disconcerting. DCD-CAS(2) on the other hand does, like CASSCF, exactly preserve the degeneracies also at the relativistic level. These results also demonstrate that our scheme for applying the bias-correction idea in the context of the spin-dependent DCD-CAS(2) (Eqs. (\ref{Eq:HDCD_backtransformed}) and (\ref{Eq:spindepDCD})) leads to results that are consistent with NEVPT2 in cases where state-mixing effects are weak.
It is also quite remarkable to observe that HQD-NEVPT2 can approximately restore the degeneracy within the different terms, considering that it is based on state-specific 0th order Hamiltonians that are constructed for unphysically mixed CASCI states.
\begin{table}
\small
\centering
\ttabbox
{\caption[Standard deviation within total angular momentum multiplets.]{Standard deviation (in cm\textsuperscript{\textminus 1}) within total angular momentum multiplets. The averaging is done over all multiplets except J=0 and J=1/2, which are always degenerate.}
\label{Tab:NEV_QDNEV_STD}}
{\input{Tables/NEV_QDNEV_STD.tex}}
\end{table}
\begin{table}
\small
\centering
\ttabbox
{\caption[Energies of the states belonging to the $^2P$ and $^2H$ terms of the Co\textsuperscript{2+} ion at the NEVPT2 and HQD-NEVPT2 levels.]{Energies of the states (in cm\textsuperscript{\textminus 1}) belonging to the $^2P$ and $^2H$ terms of the Co\textsuperscript{2+} ion at the NEVPT2 and HQD-NEVPT2 levels. Shown are also the standard deviations $\sigma$ within the multiplets of a given total angular momentum quantum number $J$. For NEVPT2, the energies were sorted into the different categories by ordering them according to energy, since a clear assignment was not possible. For comparison, the results of bc-D\textsuperscript{3}CD-CAS(2), which does not break degeneracy, are also shown.}
\label{Tab:degbreaking}}
{\input{Tables/degeneracybreaking_CoII_relativistic.tex}}
\end{table}

\section{Final choices for the DCD-CAS(2) method}
Based on the assembled numerical results, we make a default choice for the DCD-CAS(2) method. Our tests have demonstrated that the difference-dedicated variant is uniformly superior to the non-difference-dedicated method. It is also computationally more attractive since there is only a single MP2-like energy correction for all states that can be very efficiently computed. Likewise, our tests have indicated that the bias correction is absolutely necessary in order to obtain good excitation energies that mimic proper state specific results. The 1st order bias correction already appears to be sufficient in practical applications. Finally, it is advantageous to employ the lowest CASCI energy as $E_0$ since this guarantees numerically stability of the method. Owing to the bias correction, the sensitivity of the results with respect to this choice is very limited. Hence, in the future and the remainder of this thesis we will refer to the variant termed bc-D\textsuperscript{3}CD-CAS(2) in the nomenclature of Section \ref{Sec:DCD_variants} as \emph{the} DCD-CAS(2) method.

\section{Tests of QD-NEVPT2 and HQD-NEVPT2}
\subsection{Investigation of non-invariance in a model system}
\label{Sec:allene_noninvariance}
In order to assess the severeness of the model space non-invariance of the HQD-NEVPT2 method, we use as a test case the accidental same symmetry conical intersection of the allene molecule in $C_s$ symmetry, as investigated by Granovsky.\cite{Grano_2011_214113} The geometry, scan parameters, and basis set are chosen exactly identical as in the investigation of the non-invariance of MS-CASPT2 and MCQDPT2;\cite{Grano_2011_214113} see also Appendix \ref{Sec:appendix_geombasis_allene}. The result is shown in Figure \ref{Fig:ConicalIntersection}, where the scan angles are defined relative to the angles in the minimum energy crossing point geometry of the SA-CASSCF calculation. Since the conical intersection in this system is accidental, it is clear that it will not occur at exactly the same geometry in the SA-CASSCF (where it occurs by definition at both scanned angles being 0°) and in the HQD-NEVPT2. It was previously shown that MS-CASPT2 and MCQDPT2 (which have “type I” non-invariance) show severe irregularities of the PES around the point of degeneracy of the underlying SA-CASSCF calculation, essentially over the whole range of scanned angles.\cite{Grano_2011_214113} In contrast to that, Figure \ref{Fig:ConicalIntersection} shows that the effect of non-invariance of the HQD-NEVPT2 method is much smaller, and the PES is only affected in regions in the center of the figure where the reference states are nearly degenerate (closer than about 0.1 eV) in the underlying SA-CASSCF. In these regions, one observes a slightly increased or reduced distance of the isolines. Apparently, HQD-NEVPT2 is very useful for most parts of the PES even though it is not exactly model space invariant.
\begin{figure}
\ffigbox[\FBwidth]
{\caption[Energy difference between the two lowest $^1A'$ states of allene in $C_s$ symmetry.]{Energy difference (in Ha) between the two lowest $^1A'$ states of allene in $C_s$ symmetry calculated by HQD-NEVPT2. Shown is an unrelaxed surface scan varying the two internal degrees of freedom described in the main text. The reference geometry (center of the figure) corresponds to the minimum point of degeneracy between the two states at the SA-CASSCF(4,4) level.}
\label{Fig:ConicalIntersection}}
{\includegraphics[width=\textwidth]{figures/ConicalIntersection/qdnev_ci-crop.pdf}}
\end{figure}

\subsection{Occurrence of complex eigenvalues}
The main advantage of a Hermitian effective Hamiltonian is that its eigenvalues are guaranteed to be real and its eigenstates are orthonormal. A non-Hermitian real Hamiltonian can have complex eigenvalues, which come in complex-conjugate pairs. There is an increased tendency for the appearance of complex eigenvalues for (nearly) degenerate states, which can be qualitatively understood by investigating as a model the real $2 \times 2$ eigenvalue problem ${\mathbf{HC}} = E{\mathbf{C}}$ with
	\begin{equation}
	{\mathbf{H}} = {E_0} + \left( {\begin{array}{*{20}{c}}
  {\Delta /2}&a \\ 
  b&{ - \Delta /2} 
\end{array}} \right).
\end{equation}
It has the eigenvalues ${E_ \pm } = {E_0} \pm \frac{1}{2}\sqrt {{\Delta ^2} + 4ab} $. If the matrix is Hermitian, $ab$ is non-negative and the eigenvalues are obviously real. For a non-Hermitian real matrix, one can distinguish the following cases:
\begin{itemize}
\item$ab > 0$: The eigenvalues are real and their difference is larger than $\Delta$.
\item$ab = 0$: The eigenvalues are equal to the diagonal values ${E_0} \pm \Delta /2$.
\item$ - {\Delta ^2}/4 < ab < 0$: The eigenvalues are real and their difference is smaller than $\Delta$.
\item$ab =  - {\Delta ^2}/4$: The eigenvalues are degenerate and equal to $E_0$, the average of the two diagonal values.
\item$ab <  - {\Delta ^2}/4$: The eigenvalues are a conjugate pair of complex numbers.
\end{itemize}
In Table \ref{Tab:QDNEV_complex} we show the ligand field and LMCT excitation energies of the [CuCl\textsubscript{4}]\textsuperscript{2\textminus} complex in two different geometries, belonging to the $D_{4h}$ and $D_{2d}$ point groups, and calculated with the traditional (non-Hermitian) QD-NEVPT2. The geometries were optimized in the gas phase. The remaining computational details and a more thorough investigation of these complexes can be found in Section \ref{Sec:LFvsLMCT}. For the crystal geometries also introduced in that section, degeneracy is sufficiently broken (corresponding to a larger $\Delta$ in the $2\times 2$ model) that complex eigenvalues do not occur.
\begin{table}
\small
\centering
\ttabbox
{\caption[Excitation energies (real and imaginary parts) of {[CuCl\textsubscript{4}]}\textsuperscript{2\textminus} calculated with non-Hermitian QD-NEVPT2.]{Excitation energies $\Delta E$ (real and imaginary parts) of [CuCl\textsubscript{4}]\textsuperscript{2\textminus} calculated with non-Hermitian QD-NEVPT2.}
\label{Tab:QDNEV_complex}}
{\input{Tables/QDNEV_complex.tex}}
\end{table}
It can be seen in Table \ref{Tab:QDNEV_complex} that complex energy values appear in some cases. The real part of the energies is very close to HQD-NEVPT2 results (see Section \ref{Sec:LFvsLMCT}) and the imaginary part is small (in this example not larger than on the order of 1 meV). There are no pronounced state-mixing effects in these systems. The off-diagonal elements of the effective Hamiltonian have a magnitude of at most around 0.1 eV and the non-Hermitian contribution, which can lead to complex eigenvalues, is significantly smaller than that (on the order of a few meV). This explains the observation that complex eigenvalues only occur for energies that are expected to be (nearly) degenerate. This is also the reason why possible imaginary parts cannot be large in this system. It is then clear that for nondegenerate levels (corresponding to large $\Delta$ in the model problem), even negative (small) $ab$ will not lead to the occurrence of complex roots. This is only possible if $\Delta$ is equally small. But for other systems with possibly large state mixings, i.e. with significant off-diagonal elements, much larger imaginary parts can be expected for nearly degenerate levels, and in general the occurrence of imaginary parts can be expected also
for levels that are rather far from being degenerate. 
As another example for the occurrence of complex eigenvalues in the non-Hermitian theory, Figure \ref{Fig:verticalcut} shows a one-dimensional PES scan of the allene system already introduced before. It can be observed that in the region close to where a weakly avoided crossing is expected, the eigenvalues of the non-Hermitian QD-NEVPT2 become complex, while HQD-NEVPT2 shows the correct expected behavior. It can also be seen that the energies at the non-Hermitian QD-NEVPT2 level already show unphysical behavior way before they actually become degenerate and acquire an imaginary part. A similar unphysical behavior has been observed for EOM-CC applied to conical intersections.\cite{KoehnT_2007_44105}
\begin{figure}
\ffigbox[\FBwidth]
{\caption[Vertical cut through the surface shown in Figure \ref{Fig:ConicalIntersection} at the non-Hermitian QD-NEVPT2 and HQD-NEVPT2 levels.]{Vertical cut through the surface shown in Figure \ref{Fig:ConicalIntersection} at the non-Hermitian QD-NEVPT2 and HQD-NEVPT2 levels. The CCCH torsion angle is fixed at 3° relative to the reference geometry. This is very close to the angle where the HQD-NEVPT2 conical intersection occurs; hence the very weakly avoided crossing at this level of theory. For non-Hermitian QD-NEVPT2 both the real part and the sum of real and imaginary part is plotted in case of complex eigenvalues. The energies are plotted relative to $-116.06149$ Ha, which is the average energy of the HQD-NEVPT2 states in the avoided crossing region.}
\label{Fig:verticalcut}}
{\includegraphics[width=\textwidth]{figures/CI_verticalcut/allene_cut-crop.pdf}}
\end{figure}
The pragmatic practice of discarding imaginary parts and taking the real parts as physical energies is not satisfying in such cases because it means that energies that should not be degenerate are artificially made degenerate. This is why we prefer working with a Hermitian effective Hamiltonian from the beginning, obviating the need to resort to such \textit{ad hoc} solutions.

\chapter{Applications}
The spin-dependent DCD-CAS(2) method was tested for a range of properties of TM complexes.\cite{LangN_2019_104104} After the description of the test sets and computational details, we investigate the performance of spin-dependent DCD-CAS(2) when using a minimal active space containing the five metal $d$-derived MOs together with the appropriate number $n$ of electrons for the $d^n$ configuration of the metal center. We have calculated ZFS parameters $D$ and $E/D$ of six $3d$ TM complexes and g-shifts for a subset of the complexes studied by Singh \textit{et al.}\cite{SinghAN_2018_4662} Afterwards, we present the performance for the calculation of EPR parameters of (pseudo) square-planar Cu complexes because the failure of nondegenerate MRPT is well understood in this case. The results of that study were one of the main motivations for the development of the HQD-NEVPT2, whose performance for the EPR parameters of the Cu complexes is therefore also tested. Finally, we investigate the performance of HQD-NEVPT2 for optical spectra of two conformers of [CuCl\textsubscript{4}]\textsuperscript{2\textminus}. Figure \ref{Fig:Molecules_testset} shows all molecules investigated in this chapter. The used abbreviations are Ph=phenyl, iPr=isopropyl, Me=methyl, acac=acetylacetonato, dmiz=dimethylimidazole, sacsac=dithioacetylacetonato, tacacen= N,N'-ethylenebis(thioacetylacetoneiminate), cyclam= 1,4,8,11-tetra\-aza\-cyclo\-tetra\-decane,  en=ethylenediamine, gly=glycine, dtc=N,N-di\-ethyl\-di\-thio\-carba\-mate, mnt=ma\-leo\-nitrile\-di\-thio\-late.
\begin{figure}
\ffigbox[\FBwidth]
{\caption[Molecules used for tests of spin-dependent DCD-CAS(2) and of HQD-NEVPT2.]{Molecules (in the geometries employed in the calculations) used for tests of spin-dependent DCD-CAS(2) and of HQD-NEVPT2. Rows 1 and 2: Molecules used for the investigation of ZFS with a minimal active space. Rows 3 and 4: Molecules used for the investigation of g-shifts with a minimal active space. Rows 5 and 6: Pseudo-square-planar Cu complexes used for the investigation of EPR parameters (g-shifts and HFCCs) using an extended active space.}
\label{Fig:Molecules_testset}}
{\includegraphics[width=0.8\textwidth]{figures/molecules_text_croppedandscaled.png}}
\end{figure}

\section{Test sets and computational details}
All calculations were performed using a development version of ORCA.\cite{Neese_2018_1327} 
For the minimal active space calculations we used the DKH2 scalar relativistic Hamiltonian and performed state-averaged (SA)-CASSCF calculations with the set of five $d$ orbitals chosen active, averaged over all roots of all multiplicities of the whole CASCI space. For the ZFS calculations, both SOC and SSC were included in the relativistic calculations. Geometry optimizations were performed with BP86, the scalar-relativistic DKH2 Hamiltonian, DKH-def2-TZVP, SARC/J auxiliary basis and grid5. For the Co complexes, the linear Fe(I) complex\cite{ZadroXALGNL_2013_577} as well as the two Ni\textsuperscript{II} complexes,\cite{IvaniBDFMMST_2006_3261}\cite{MroziSPDVGVK_2001_107} we used the crystal structures and only optimized the hydrogen atom positions because the optimized geometries otherwise deviated too much from the crystal structures. In the case of the Co complexes, we first truncated the crystal structures, saturating with H atoms, in order to reproduce the models previously defined as \textbf{\textsuperscript{H}3} and \textbf{\textsuperscript{H}4}.\cite{MaganSKGN_2011_8741} For the remaining complex [Mn(acac)\textsubscript{3}], we constructed the structure \textit{in silico} and did a full geometry optimization. We used the AutoAux procedure\cite{StoycAN_2017_554} in ORCA to generate auxiliary basis sets for the RI-calculation of two-electron electric field gradient integrals needed for SSC. For the systems used in the g-shift study, the geometries were taken from the supplementary material of Singh \textit{et al.}\cite{SinghAN_2018_4662} For both the ZFS and the g-shift investigation we employed the DKH-def2-TZVP basis set in all multireference calculations.

The geometries of all complexes for the study of the EPR parameters of (pseudo) square-planar Cu\textsuperscript{II} complexes were optimized at the unrestricted Kohn-Sham (UKS)\nomenclature{UKS}{Unrestricted Kohn-Sham} level with the BP86 exchange-correlation functional, using the scalar-relativistic DKH2 Hamiltonian and the DKH-def2-TZVP basis set.
Since picture-change effects on HFCCs can be large already for relatively light elements (like $3d$ transition metals)\cite{SandhKN_2013_104102} and they are not yet implemented in conjunction with the spin-dependent DCD-CAS(2) method, we choose to do all HFCC calculations at the nonrelativistic level. Comparison of nonrelativistic domain-based local pair natural orbital coupled cluster singles doubles (DLPNO-CCSD)\nomenclature{DLPNO}{Domain-based local pair natural orbital}\nomenclature{CCSD}{CC with single and double excitations}\cite{RipliPBVN_2016_24109, SaitoBRVN_2017_164105} calculations to relativistic ones with picture-change included show that the error introduced by this is relatively small compared to the errors intrinsic to the methods. We found that the error is typically smaller than 1\% for SD contributions and smaller than 5\% for FC contributions; see Appendix \ref{Sec:appendix_nonrelvsrelHFCC}. For g-matrices of transition metal complexes it has been found that a relativistic calculation (even without inclusion of picture change effects) improves the agreement with experiment.\cite{SandhN_2012_94102} For 1st row TM complexes, the improvement is however relatively small, and the g-shifts are similar between relativistic and nonrelativistic calculations; see Appendix \ref{Sec:appendix_relgshifts_CuII}. For consistency with the HFCC calculations, we therefore choose to also use the nonrelativistic Hamiltonian in this case.

DLPNO-CCSD calculations of HFCCs\cite{SaitoN_2018_34104} based on a preceding unrestricted HF (UHF)\nomenclature{UHF}{Unrestricted HF} calculation were performed with the decontracted def2-TZVP basis set, using AutoAux\cite{StoycAN_2017_554} to generate the auxiliary basis set and explicitly correlating core electrons (no frozen core).
All multireference calculations for the Cu complexes are based on a SA-CASSCF(11,6) calculation. The active orbitals were chosen to be the Cu $3d$ orbitals together with the bonding counterpart of the ${d_{{x^2} - {y^2}}}$ orbital (with orbital lobes in the direction of the coordinating atoms). In order not to have the orbitals biased toward the ligand-field states, we chose the weight of the LMCT state to be five times higher than each of the five ligand field states in the state averaging. Like for the CC calculations, we use the decontracted def2-TZVP basis set (DKH-def2-TZVP for relativistic calculations). Finally, we performed B3LYP\cite{StephDCF_1994_11623} calculations of g-matrices\cite{Neese_2001_11080} and A-matrices\cite{Neese_2003_3939} with the same basis sets and grid6.
Note that in some cases we have reverted the sign of two of the HFCCs in order to match the signs obtained experimentally and/or by the CC calculations. This is possible by a unitary transformation within the Kramers doublet, which keeps the A-matrix diagonal.
In some instances we also performed calculations with state-averaged NEVPT2 (SA-NEVPT2), which is the usual (strongly contracted) NEVPT2 with a Dyall Hamiltonian that is not state-specific for each state, but constructed from the state-averaged density matrix. It is exactly this state-averaged Dyall Hamiltonian that we use in the DCD-CAS(2) method, in order to fulfill the requirement of a common 0th order Hamiltonian for all states. In this way, one can understand which part of the difference between NEVPT2 and DCD-CAS(2) results is simply due to a different 0th order Hamiltonian, instead of state-mixing effects.

We want to point out that all calculations reported in this work are single-point calculations performed at the minimum nuclear configuration of the respective potential energy surface. This is an approximation and previous work has shown that EPR parameters (especially the FC contribution to HFCCs) can in some cases change quite drastically over the range of nuclear configurations accessible in the vibrational ground state.\cite{Chipm_1983_3112, Carmi_1987_351, BaronGMS_1993_6787, GilkaTM_2008_258} When assuming validity of the Born-Oppenheimer approximation, the effect of vibrations can be estimated by calculating the expectation value of the property hypersurface in the vibrational ground state (vibrational averaging). We choose not to discuss this procedure further in the following because it is completely independent of the underlying electronic structure method used to calculate the property surface. Since DCD-CAS(2) is not a very high accuracy method, we consider the vibrational effects negligible when comparing the results to experimental numbers. 

\section{Minimal active space results}
\subsection{Zero-field splittings}
The results of the ZFS calculations are shown in Table \ref{Tab:minAS_ZFS}. It can be seen that the predictions by NEVPT2 and DCD-CAS(2) are usually quite similar. 
\begin{table}
\small
\centering
\ttabbox
{\caption[Spin Hamiltonian parameters $D$ and $E/D$ for various mononuclear $3d$ complexes.]{Spin Hamiltonian parameters $D$ (in cm\textsuperscript{\textminus 1}) and $E/D$  for various mononuclear $3d$ complexes. Both SOC and SSC are included in the calculations. The spin of the nonrelativistic ground-state multiplets is 1 for the two Ni complexes, 2 for the Mn complex, and 3/2 for the remainder.}
\label{Tab:minAS_ZFS}}
{\input{Tables/minAS_ZFS.tex}
}
\end{table}
The largest change occurs for the [Ni(sarcophagine)]\textsuperscript{2+} complex, with a reduction of $D$ by about 12\% when going from NEVPT2 to DCD-CAS(2). We included the two (pseudo)octahedral Ni\textsuperscript{II} complexes to our test set because we expected that an influence of state mixing behavior could show up there. In an octahedral ligand field, $d^8$ systems have a nonrelativistic $^3A_{2g}$ ground state. Since the SOC operator transforms as $T_{1g}$, only excited states that transform like the product ${A_{2g}} \otimes {T_{1g}} = {T_{2g}}$ are expected to contribute to the ZFS. Indeed the ZFS is dominated by an excited $^3T_{2g}$ term and the lower one of two excited $^1T_{2g}$ terms. Since there is a second term of the same symmetry for the singlet multiplicity, some state mixing could be expected to occur. However, no sizeable state mixing between those two terms was observed for either Ni complex. For the [Ni(sarcophagine)]\textsuperscript{2+} complex, there occurs a different state mixing that can only be explained by the fact that the complex deviates from perfect $O_h$ symmetry. The states of the lowest $^1T_{2g}$ term mix with the lowest $^1A_{1g}$ state, which is slightly lower in energy. The mixing is relatively weak (around 1\% admixing) for the first two roots of the $^1T_{2g}$ term, which contribute negatively to $D$, and sizable (around 7\% admixing) for the third root of the $^1T_{2g}$ term, which contributes positively to $D$. The mixing pushes the energy of the third $^1T_{2g}$ state slightly up, reducing the magnitude of its contribution to $D$. This can explain the smaller $D$ value obtained by DCD-CAS(2) compared with NEVPT2. One should also mention the importance of SSC for the accurate prediction of ZFS. For example, the DCD-CAS(2) $D$ value without SSC is $-3.99$ cm\textsuperscript{\textminus 1} for Mn(acac)\textsubscript{3} and $1.32$ cm\textsuperscript{\textminus 1} for [Ni(sarcophagine)]\textsuperscript{2+} compared with the more accurate values presented in Table \ref{Tab:minAS_ZFS}.

\subsection{g-shifts}
The minimal active space g-shift results are shown in Table \ref{Tab:minAS_gshifts}. It can be seen that there are some changes in g-shifts between NEVPT2 and DCD-CAS(2). Comparison with SA-NEVPT2, which uses the same 0th order Hamiltonian, reveals that these changes are dominated by state mixing effects for the Co\textsuperscript{II} complexes. Analysis of the state compositions shows that the doublet CASCI roots 5 and 7 of [Co(sacsac)\textsubscript{2}] are heavily intermixed in the DCD-CAS(2) state. This mixing is however difficult to analyze since many different states are involved.
In most cases the difference between NEVPT2 and DCD-CAS(2) is very subtle and their (dis)agreement with experiment is comparable. Also in those cases where DCD-CAS(2) provides a limited improvement (Co complexes), there is still a very large error with respect to the experiment.
\begin{table}
\centering
\small
\ttabbox
{\caption[g-shifts of various mononuclear $3d$ complexes with spin 1/2.]{g-shifts (in ppt) of various mononuclear $3d$ complexes with spin 1/2.}
\label{Tab:minAS_gshifts}}
{\input{Tables/minAS_gshifts.tex}}
\end{table}

\section{Electron paramagnetic resonance parameters of square-planar Cu complexes}
\label{Sec:Results_EPR}
In this section, we follow the chronological order in which the results were originally published and first discuss only the results of DCD-CAS(2) compared with state-specific approaches. In the last part, we then include the discussion of HQD-NEVPT2, which was developed as an answer to the problems found when using DCD-CAS(2).
\label{Sec:EPRsquareplanarCu}
\subsection{Effect of state mixing on EPR parameters of square-planar $d^9$ complexes}
The qualitative theory of EPR parameters for Cu\textsuperscript{II} complexes has been extensively discussed over the past decades.\cite{Smith_1970_3108, ChowCW_1973_2629, ArambM_1985_6071, NeeseS_2003_345, MakiM_1958_31} We reiterate the pertinent details here in order to facilitate the discussion of our computational results.
The ground state of square-planar $d^9$ molecules can be qualitatively described as a single Slater determinant in which all MOs are doubly occupied (DOMOs)\nomenclature{DOMO}{Doubly occupied MO} except for a single one that is singly occupied (SOMO) and has the form of a ${d_{{x^2} - {y^2}}}$ orbital. Applying 2nd order DPT\cite{NeeseS_2003_345} (see Section \ref{Sec:DPT2_SHparameters}) to this kind of system leads to the following expressions for the EPR parameters:
	\begin{equation}
	\label{Eq:gorb}
	\Delta {g_{kl}} = 2\sum\limits_{t({\text{doubly}})} {\Delta E_t^{ - 1}\langle {\psi _t}|{l^k}|{\psi _{{\text{SOMO}}}}\rangle \langle {\psi _{{\text{SOMO}}}}|{z^l}|{\psi _t}\rangle }, 
	\end{equation}
	\begin{equation}
	\label{Eq:ANOC}
	A_{kl}^{{\text{NOC/SOC}}} = 2{\alpha ^2}{\gamma _A}\sum\limits_{t({\text{doubly}})} \Delta  E_t^{ - 1}\langle {\psi _t}|\frac{{{l^{A,k}}}}{{r_A^3}}|{\psi _{{\text{SOMO}}}}\rangle \langle {\psi _{{\text{SOMO}}}}|{z^l}|{\psi _t}\rangle, 
	\end{equation}
	\begin{equation}
	\label{Eq:AFC}
	A_{kl}^{{\text{FC}}} = {\delta _{kl}}{\alpha ^2}{\gamma _A}\frac{{{g_e}}}{2}\frac{{8\pi }}{3}|{\psi _{{\text{SOMO}}}}({{\mathbf{R}}_A}){|^2},
	\end{equation}
	\begin{equation}
	\label{Eq:ASD}
	A_{kl}^{{\text{SD}}} = {\alpha ^2}{\gamma _A}\frac{{{g_e}}}{2}\langle {\psi _{{\text{SOMO}}}}|\frac{{3r_A^kr_A^l - {\delta _{kl}}r_A^2}}{{r_A^5}}|{\psi _{{\text{SOMO}}}}\rangle. 
	\end{equation}
Here it is assumed that the total spin is $S = 1/2$ and that all excited states that contribute to the 2nd order properties (Eqs. (\ref{Eq:gorb}) and (\ref{Eq:ANOC})) can be described as a single Slater determinant where one electron has been excited from a DOMO $t$ to the ground state SOMO. $\Delta {E_t}$ is the corresponding excitation energy. This physical picture is visualized in Figure \ref{Fig:squareplanar_orbitals}.

\begin{figure}
\centering
\ffigbox[\FBwidth]
{\caption[Simple orbital diagram for the electronic structure of square-planar Cu\textsuperscript{II} complexes.]{Simple orbital diagram (using $D_{4h}$ point group labels) for the qualitative model assumed for the electronic structure of square-planar Cu\textsuperscript{II} complexes. The orbital occupation belongs to the ground state and the arrows designate the possible excitations leading to excited states: $d$-$d$ (or ligand field (LF)) transitions and a ligand-to-metal charge transfer (CT) excitation.}
\label{Fig:squareplanar_orbitals}}
{\includegraphics[width=0.8\textwidth]{figures/Cu_squareplanar/CuCl42--crop.pdf}}
\end{figure}

In contrast to the other $d$ orbitals, the metal ${d_{{x^2} - {y^2}}}$ orbital has its lobes in the direction of the ligands in a square-planar coordination environment. Hence the ground state SOMO will be an antibonding linear combination of this orbital with some admixture of ligand orbitals. A $d$ orbital $t$ that is doubly occupied in the ground state can on the other hand be assumed to be mostly metal-centered. The angular momentum operator ${l^k}$ simply rotates it into a linear combination of the whole set of five metal $d$ orbitals. The overlap of its ${d_{{x^2} - {y^2}}}$-like contribution with the ground state SOMO will then be smaller if the latter has more ligand character. The same is true for the NOC integral, where the operator is even more local due to the $r_A^{ - 3}$ dependence. For the SOC operator we assume for our qualitative discussion that it has the form of the effective nuclear charge approximation\cite{KosekGSM_1995_12764} and that only the contribution from the metal nucleus is included. This is justified since ligand nuclei have smaller angular momentum and smaller ${Z_{{\text{eff}}}}$. This leads to
	\begin{equation}
	\langle {\psi _{{\text{SOMO}}}}|{z^l}|{\psi _t}\rangle  \approx \frac{{{\alpha ^2}}}{2}Z_{{\text{eff}}}^M\langle {\psi _{{\text{SOMO}}}}|\frac{{{l^l}}}{{{r^3}}}|{\psi _t}\rangle. 
	\end{equation}
One can see that under these assumptions the SOC integral is approximately proportional to the NOC integral. Therefore, also the SOC integral will be smaller if the covalency in the ground state SOMO is increased. Finally, the FC and SD integrals in Eqs.~(\ref{Eq:AFC}) and (\ref{Eq:ASD}) will be larger if the AOs of the atom for which the HFCC is evaluated have a larger contribution to the ground state SOMO, due to the local nature of the operators. 
For active spaces containing only a single hole, like the chosen CAS(11,6), a special property arises. Any given set of states, which are unitary transformations of the CAS CSFs, can be turned into single Slater determinants by a suitable rotation among the active orbitals; see Appendix \ref{Ap:SDOs}.
We call the set of these orbitals \emph{single determinant orbitals} (SDOs)\nomenclature{SDO}{Single determinant orbital}. Using these orbitals, state mixing within our chosen CASCI space can be interpreted in terms of orbital rotations.

The problem with CASSCF is that its description of the ground state SOMO of the investigated complexes is too ionic, i.e. with too little contribution from ligand AOs. The same problem persists for NEVPT2, since it cannot revise the CAS part of the wavefunction. This remains true when one explicitly includes the corresponding ligand-dominated bonding counterpart to the ground state SOMO in the active space. The LMCT configuration, where this orbital is singly occupied, is too high in energy at the CASSCF level; hence its contribution to the ground state is too small.\cite{GinerA_2015_124305} There is also a recent benchmark of CASSCF and NEVPT2 for the prediction of g-shifts,\cite{SinghAN_2018_4662} where these trends were thoroughly investigated. Dynamic correlation dressing can decrease the energy of the LMCT configuration with respect to the ground state and therefore allow for state mixing. For the systems studied here, this state mixing between the ground configuration and the LMCT configuration can be described simply as a change of orbitals. The larger the weight of the LMCT state, the more ligand character will be mixed into the ground state SOMO (which is the singly occupied SDO of the ground state), meaning the metal-ligand bond will be more covalent.

\subsection{g-shifts}
The g-shifts calculated at different levels of theory compared with experimental values can be found in Table \ref{Tab:Cu_gvalues}.
\begin{table}
\centering
\small
\caption[g-shifts calculated with different methods and compared with the experiment.]{g-shifts (in ppt) calculated with different methods and compared with the experiment.}
\label{Tab:Cu_gvalues}
\input{Tables/Cu_gvalues.tex}
\end{table}
One readily observes that the values at the CASSCF level are too large, as expected from the fact that the CASSCF description of metal-ligand bonds is too ionic. Since the g-shift is a 2nd order property, NEVPT2 can give improved values through modified nonrelativistic excitation energies. DCD-CAS(2) can revise the wavefunction and therefore yields smaller values than NEVPT2. The lowering in magnitude is however too strong and the g-shifts are generally too low at this level of theory. For the two sulfur-containing complexes ([Cu(dtc)\textsubscript{2}], [Cu(mnt)\textsubscript{2}]\textsuperscript{2\textminus}), the values are even lower than the ones obtained with B3LYP, which is notorious for giving too small g-shifts due to an overly covalent description of the metal-ligand bond.\cite{Neese_2001_11080}

\subsection{Ligand hyperfine couplings}
\label{Sec:ligandHFC}
It was previously shown that ligand HFCCs (even for nuclei beyond the 2nd row like sulfur) are dominated by FC and SD HFC,\cite{Neese_2003_3939} while the SOC-induced NOC contribution is relatively small and can be approximately neglected here. Therefore, we directly compare the FC and SD contributions to the ligand HFCCs with the complete isotropic and anisotropic parts of the experimental HFCCs. This approximation is naturally worse for the heavier ligand nuclei S and Cl. The results are shown in Table \ref{Tab:LigandHFC}.
\begin{table}
\centering
\small
\ttabbox
{\caption[Ligand HFCCs.]{Ligand HFCCs (in MHz).}
\label{Tab:LigandHFC}}
{\input{Tables/ligand_HFC.tex}
\floatfoot{\textsuperscript{a}Shown are the isotropic and anisotropic parts of the experimental HFCCs as estimates for the FC and SD contributions. \\
\textsuperscript{b}Experimental values are averages for \textsuperscript{35}Cl and \textsuperscript{37}Cl because these lines could not be resolved separately.}}
\end{table}
For the ligand HFCCs, there are nonzero FC contributions already for the methods based on a CAS, due to spin delocalization. The increasing covalency at the DCD-CAS(2) level improves the values, but they are still too small compared to the DLPNO-CCSD and experimental results. The remaining error is probably due to the missing spin polarization. The SD contribution is also increased when going from CASSCF/NEVPT2 to DCD-CAS(2) and agrees in most cases well with the experimental values.

\subsection{Cu hyperfine couplings}
For a CAS wavefunction, the spin density, which is proportional to the FC contribution to HFCCs, comes from partial occupation of active orbitals. If all active orbitals have a node at the metal nucleus (as is the case for the calculations here), there is no contribution of the FC interaction to metal HFCCs, which is in contrast to experimental results. The problem is that the spin density comes from spin polarization of the (at the CAS level closed-shell) core electrons due to dynamic correlation, an effect that is present at the CCSD level but not at the CASSCF, NEVPT2 or DCD-CAS(2) levels. Since this important feature is missing, we can therefore not directly compare our results with experimental HFCCs. We can however compare the anisotropic part of the HFCCs (which contains contributions from SD and NOC) with the experiment, and the results of this comparison are given in Appendix \ref{Sec:appendix_Aaniso}. As it turns out, DCD-CAS(2) has for this anisotropic part the best agreement with the experiment among all compared methods, which is due to fortuitous error cancellation.
In the following we take a closer look at the individual contributions. Assuming that DLPNO-CCSD yields semi-quantitative results for the FC and SD contributions to HFCCs (see Section \ref{Sec:ligandHFC} and previous benchmarks\cite{SaitoN_2018_34104}), we can compare directly with the SD contribution as predicted by other methods. The results are shown in Table \ref{Tab:HFC_SD}.
\begin{table}
\centering
\small
\caption[SD contribution to the \textsuperscript{63}Cu HFCCs.]{Comparison of different methods with DLPNO-CCSD for the prediction of the SD contribution (in MHz) to the \textsuperscript{63}Cu HFCCs.}
\label{Tab:HFC_SD}
\input{Tables/HFC_SD.tex}
	\end{table}
One can see that there is not much difference between CASSCF and NEVPT2 results since the wavefunction is unchanged. The DCD-CAS(2) and B3LYP values are quite similar to each other and are smaller than the CASSCF/NEVPT2 values, indicating a larger amount of covalency in the SOMOs of the complexes. The fact that bonds are too covalent at the DFT level manifests itself in too small HFCCs. The comparison with DLPNO-CCSD results shows that DFT as well as DCD-CAS(2) underestimate the values, which seems to indicate that the description of the SOMO at the DCD-CAS(2) level is too covalent. It is surprising considering the too ionic wavefunction that CASSCF predicts the SD contributions to the HFCCs quite well compared with DLPNO-CCSD. This good agreement is probably due to a fortuitous error cancellation with electron correlation effects that are missing at the CAS level and are of the opposite sign compared to the effect of missing covalency.
The 2nd order NOC contribution to A-matrices is currently not implemented at the DLPNO-CCSD level. In order to arrive at a reference value, we subtracted the DLPNO-CCSD values for the FC and the SD contribution from experimental HFCCs to get an estimate for the NOC contribution to the metal HFCCs. The results of this procedure are shown in Table \ref{Tab:HFC_ANOC}.
\begin{table}
\small
\centering
\ttabbox
{\caption[NOC contribution to the \textsuperscript{63}Cu HFCCs.]{Comparison of the NOC contribution to the \textsuperscript{63}Cu HFCCs (in MHz) for different methods compared with the experimental/DLPNO-CCSD reference. The CASSCF, NEVPT2 and DCD-CAS(2) values have all been obtained through the method described in this work, while the B3LYP values are obtained via analytical derivative techniques.}
\label{Tab:HFC_ANOC}}
{\input{Tables/HFC_ANOC.tex}
\floatfoot{\textsuperscript{a}Experimental values were reported as field differences $\Delta B$ and were converted to energy units via the relation $A = {\mu _B}g\Delta B$. \\
\textsuperscript{b}While the two smaller components were quite anisotropic in the CC calculation, they are assigned the same value experimentally, hence these reference values might be problematic. \\
\textsuperscript{c}Experimental values are probably averages for both Cu isotopes 63 and 65.}}
\end{table}

Since the NOC contribution is a 2nd order property (similar to the g-shift), there is, in contrast to the SD results before, a large change in values when going from CASSCF to NEVPT2 due to the corrected excitation energies. Again, DCD-CAS(2) leads to smaller values than NEVPT2 through the additional effect of increased covalency. Like before, the values are very close to the B3LYP results, which severely underestimate the values compared to the estimate obtained from the experiment and DLPNO-CCSD calculations. Together with an overly covalent SOMO, this may also be explained by overestimated excitation energies; see Section \ref{Sec:reasons_underestimation} below. It is again surprising that CASSCF and NEVPT2 yield relatively good results despite the overly ionic wavefunction.

\subsection{Reason for underestimation of Cu g-shifts and HFCCs at the DCD-CAS(2) level}
\label{Sec:reasons_underestimation}
The results obtained so far indicate that at the DCD-CAS(2) level the description of copper-ligand bonds is too covalent, which affects 1st and 2nd order properties. Furthermore, the nonrelativistic excitation energies of states that can directly contribute to the 2nd order properties are possibly too high. We now investigate the reason for this behavior. Table \ref{Tab:excitationenergies} shows relative nonrelativistic energies at different levels of theory.
\begin{table}
\small
\centering
\ttabbox
{\caption[Nonrelativistic energies at different levels of theory.]{Nonrelativistic energies (in eV) at different levels of theory. GS and LMCT denote the ground state and LMCT state, which are both of $^2B_{1g}$ symmetry. E\textsubscript{1} to E\textsubscript{4} denote the $d$-$d$ excited states.}
\label{Tab:excitationenergies}}
{\input{Tables/Cu_excitationenergies.tex}}
\end{table}
We also show in this table values obtained at the SA-NEVPT2 level of theory. We can see that excitation energies are generally quite similar between NEVPT2 and SA-NEVPT2, with one exception: The excitation energy to the highest energy state (which is the LMCT state) is always much smaller at the SA-NEVPT2 level than at the NEVPT2 level. For the two sulfur-containing complexes, the excitation energy to this state even drops below 1~eV at the SA-NEVPT2 level. This is clearly a deficiency of the 0th order Hamiltonian, which cannot describe such different states as ligand field states and LMCT states simultaneously. We therefore expect that the energy difference of the diagonal elements of the DCD-CAS(2) effective Hamiltonian is too low due to the use of this state-averaged 0th order Hamiltonian. Assuming that off-diagonal elements are not affected to a large extent, this means that the state mixing between the CASCI ground state and the CASCI LMCT state is too strong. Hence the description of the bonding at the DCD-CAS(2) level becomes too covalent. This is also nicely illustrated by the Löwdin Cu spin populations shown in Table \ref{Tab:spinpopulations}. For DLPNO-CCSD, the spin populations are based on the unrelaxed density. Compared to CASSCF, it can be seen that CC improves the wavefunction by delocalizing the SOMO from Cu to the ligands. In DCD-CAS(2) and especially B3LYP, this delocalization effect seems to be too strong, as demonstrated by the small Cu spin populations.
\begin{table}
\small
\centering
\ttabbox
{\caption{Löwdin Cu spin populations at various levels of theory.}
\label{Tab:spinpopulations}}
{\input{Tables/spinpopulations.tex}}
\end{table}
Another effect of the overly strong mixing is that the ground state energy is lowered much more than it should be. As one can see in the last two columns of Table \ref{Tab:excitationenergies}, this increases the excitation energies to the first excited states substantially although their total energies remain more or less unchanged. This provides another possible mechanism for why the 2nd order properties (g-shifts and NOC contributions to HFCCs) are too small.
In the following we will disentangle these two effects for the example of the [Cu(NH\textsubscript{3})\textsubscript{4}]\textsuperscript{2+} complex. All three operators that occur in Eqs. (\ref{Eq:gorb}) and (\ref{Eq:ANOC}) transform like rotations in the approximate point group $D_{4h}$, i.e. they belong to the representation ${A_{2g}} \oplus {E_g}$. Knowing that the ground state has approximate ${B_{1g}}$ symmetry, this means that only the excited state of ${B_{1g}} \otimes {A_{2g}} = {B_{2g}}$ symmetry can contribute to the parallel component and only the excited state of ${B_{1g}} \otimes {E_g} = {E_g}$ symmetry can contribute to the orthogonal component of $\Delta g$ and ${A_{{\text{NOC}}}}$. Table \ref{Tab:selected_excitationenergies} shows the DCD-CAS(2) excitation energies for these two states compared with the corresponding values from a coupled cluster calculation with single, double and perturbative triple excitations (CCSD(T))\nomenclature{CCSD(T)}{CC with single, double and perturbative triple excitations} and the experiment. The CC calculations use the excited state determinants constructed from SDOs as a reference. We loosened the thresholds slightly to enable convergence of some of the CC calculations; see Appendix \ref{Sec:appendix_CCSDT_NH3} for a demonstration of the validity of this approach.
\begin{table}
\small
\centering
\ttabbox
{\caption[{[Cu(NH\textsubscript{3})\textsubscript{4}]}\textsuperscript{2+} excitation energies of the two states that can in 2nd order contribute to the g-shifts and HFCCs.]{[Cu(NH\textsubscript{3})\textsubscript{4}]\textsuperscript{2+} excitation energies (in eV) of the two states that can in 2nd order PT contribute to the g-shifts and NOC contributions to HFCCs.}
\label{Tab:selected_excitationenergies}}
{\input{Tables/selected_excenergies.tex}}

\end{table}
Assuming validity of DPT2, we can (since only a single state contributes to each of the EPR parameters for the [Cu(NH\textsubscript{3})\textsubscript{4}]\textsuperscript{2+} molecule) approximately correct for the erroneous DCD-CAS(2) excitation energies by scaling the parameters with the CCSD(T) or experimental excitation energies,
	\begin{equation}
	\Delta {g_{{\text{scaled}}}} = \Delta {g_{{\text{DCD-CAS(2)}}}} \times \frac{{\Delta {E_{{\text{DCD-CAS(2)}}}}}}{{\Delta {E_{{\text{CC/exp}}}}}},
	\end{equation}
and analogously for the HFCCs. The results of this procedure are shown in Table \ref{Tab:gA_scaled}. After this correction, the scaled g-shifts come out slightly too large even though the wavefunction is too covalent, as demonstrated by the spin populations in Table \ref{Tab:spinpopulations}. This seems to indicate once more that the influence of dynamic correlation on the wavefunction cannot be neglected, especially for the g-shifts. For the HFCCs on the other hand, the remaining discrepancy between scaled DCD-CAS(2) results and experiment are in line with the overestimation of covalency in the ground state SOMO.
\begin{table}
\small
\centering
\caption[g-shifts and NOC contribution to HFCCs for {[Cu(NH\textsubscript{3})\textsubscript{4}]}\textsuperscript{2+}.]{g-shifts (in ppt) and NOC contribution to HFCCs (in MHz) for [Cu(NH\textsubscript{3})\textsubscript{4}]\textsuperscript{2+}. Shown are original DCD-CAS(2) results and results that are improved via scaling with experimental and CCSD(T) excitation energies. The reference values are taken from Table \ref{Tab:Cu_gvalues} and Table \ref{Tab:HFC_ANOC}.}
\label{Tab:gA_scaled}
\input{Tables/gA_scaled.tex}
\end{table}

\subsection{Performance of HQD-NEVPT2}
\begin{figure}
\centering
\ffigbox[\FBwidth]
{\caption[SD contribution to \textsuperscript{63}Cu HFCCs.]{Comparison of the SD contribution to \textsuperscript{63}Cu HFCCs (in MHz) calculated with different methods and DLPNO-CCSD as a reference. For simplicity only the component parallel to the $C_4$ axis (filled marker) and the average of the two orthogonal components (hollow marker) are shown. Perfect agreement is indicated by the dashed gray line.}
\label{Fig:ASD}}
{\includegraphics[width=\textwidth]{figures/EPRparameters/ASD/ASD-crop.pdf}}
\end{figure}

We finally discuss the performance of HQD-NEVPT2 for the prediction of EPR parameters in the set of square-planar Cu\textsuperscript{II} complexes. One of the main motivations for the development of HQD-NEVPT2 was that with its state-specific Dyall Hamiltonians it should be able to correct for the shortcomings of DCD-CAS(2) observed in the previous section.

\begin{figure}
\centering
\ffigbox[\FBwidth]
{\caption[NOC contribution to \textsuperscript{63}Cu HFCCs.]{Comparison of the NOC contribution to \textsuperscript{63}Cu HFCCs (in MHz) calculated with different methods and a combined DLPNO-CCSD and experimental reference. For simplicity only the component parallel to the $C_4$ axis (filled marker) and the average of the two orthogonal components (hollow marker) are shown. Perfect agreement is indicated by the dashed gray line. The \mbox{$D_{2d}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus}} molecule is excluded here because no suitable experimental reference was found.}
\label{Fig:ANOC}}
{\includegraphics[width=\textwidth]{figures/EPRparameters/ANOC/ANOC-crop.pdf}}
\end{figure}

The Löwdin Cu spin populations for the different complexes computed with HQD-NEVPT2 are also shown in Table \ref{Tab:spinpopulations}. It can be seen that the results from HQD-NEVPT2 agree on average best with the DLPNO-CCSD spin populations among the compared methods, although they are still too small, especially for the S-coordinating ligands dtc and mnt. The values are significantly larger than the DCD-CAS(2) values, which can be traced back to a better description of the LMCT configuration with the state-specific Dyall Hamiltonians in the framework of the HQD-NEVPT2.

\begin{figure}
\centering
\ffigbox[\FBwidth]
{\caption[g-shifts of square-planar Cu\textsuperscript{II} complexes.]{Comparison of g-shifts calculated with different methods and the experiment. For simplicity only the component parallel to the $C_4$ axis (filled marker) and the average of the two orthogonal components (hollow marker) are shown. Perfect agreement is indicated by the dashed gray line.}
\label{Fig:gshifts}}
{\includegraphics[width=\textwidth]{figures/EPRparameters/g-shifts/gshifts-crop.pdf}}
\end{figure}

We now come to the performance for the calculation of EPR parameters. In order to facilitate the comparison, we also show the results from Tables \ref{Tab:Cu_gvalues}, \ref{Tab:HFC_SD} and \ref{Tab:HFC_ANOC} graphically. Figure \ref{Fig:ASD} and Figure \ref{Fig:ANOC} show the results for the SD and NOC contributions to the \textsuperscript{63}Cu HFCCs for the different molecules in the test set, relative to the reference values. We noticed in the previous sections that, for these properties, CASSCF/QDPT and NEVPT2/QDPT performed best among all compared methods. This is quite counterintuitive considering the too ionic wavefunction at this level as demonstrated by the large spin populations in Table \ref{Tab:spinpopulations}. We concluded that these properties cannot be described sufficiently well with a CASCI type wavefunction, to which also the relaxed wavefunctions of a DCD-CAS(2) or HQD-NEVPT2 calculation belong, and that there is probably a fortuitous cancellation of errors in the case of CASSCF and NEVPT2. It is still encouraging to see that HQD-NEVPT2 gives better results than DCD-CAS(2) due to the more balanced description of the wavefunction.

Figure \ref{Fig:gshifts} shows the parallel and orthogonal g-shifts for the molecules of the test set calculated with different methods and compared with the experiment. As discussed in the previous section, NEVPT2 almost always overestimates the g-shifts, while DCD-CAS(2) almost always underestimates them. HQD-NEVPT2 turns out to be relatively accurate except for the [CuCl\textsubscript{4}]\textsuperscript{2\textminus} complexes, where the predicted values are too large, and the orthogonal component of the [Cu(gly)\textsubscript{2}] g-shifts. Here the accuracy of the reference value is unclear because it predicts two equal orthogonal components while all computational methods predict a quite large difference of the two components. On average, HQD-NEVPT2 performs best among the compared methods for the prediction of this property. It therefore seems to be a serious alternative to established methods for the prediction of g-shifts, at least for the case of Cu\textsuperscript{II} complexes.

\section{Ligand field and LMCT excitation energies of [CuCl\textsubscript{4}]\textsuperscript{2\textminus}}
\label{Sec:LFvsLMCT}
In Section \ref{Sec:Results_EPR} there were hints that a state-averaged ${H_0}$ is a bad choice when both ligand field and charge transfer states are treated simultaneously. In order to investigate this further, we compare in this section the performance of state-specific 0th order Hamiltonians with state-averaged ones for the simultaneous prediction of ligand field and LMCT excitation energies in the [CuCl\textsubscript{4}]\textsuperscript{2\textminus} anion. This is a difficult problem for quantum chemistry, although recently there appeared a quite accurate single-reference quantum-chemical treatment of the charge transfer states of this molecule.\cite{EharaPLG_2012_94} The difference between this section and Section \ref{Sec:Results_EPR} is that in the latter the LMCT state was an “artificial” (experimentally non-observable) one that was only included into the active space to improve the description of the ground state. In contrast to that, we investigate in this section experimentally observable LMCT states in order to find out whether the previously found behavior is part of a general trend.

The [CuCl\textsubscript{4}]\textsuperscript{2\textminus} anion exists in two geometries, depending on the crystal environment: A more common distorted-tetrahedral ($D_{2d}$) geometry with a $^2B_2$ ground state and a square-planar ($D_{4h}$) geometry with a $^2B_{2g}$ ground state (with the ligands between the coordinate axes, such that the SOMO is the $d_{xy}$ orbital).\cite{Smith_1976_93} Absorption spectra of a multitude of compounds from both categories have been recorded for many decades. For the Cl\textsuperscript{\textminus} ligand, hybridization is expected to be weak. Therefore, only those orbitals derived from Cl-$3p$ orbitals need to be considered as donor orbitals for the LMCT excitations. There are twelve of them, of which four have $\sigma $ character and eight have $\pi $ character. In the $D_{4h}$ geometry, the $\sigma$ orbitals transform as ${A_{1g}} \oplus {B_{2g}} \oplus {E_u}$. The $\pi$ orbitals can be classified as four in-plane orbitals, which transform as ${A_{2g}} \oplus {B_{1g}} \oplus {E_u}$ and four out-of-plane orbitals, which transform as ${A_{2u}} \oplus {B_{1u}} \oplus {E_g}$. In the $D_{2d}$ geometry, the $\sigma$ orbitals and the “out-of-plane” $\pi$ orbitals transform as ${A_1} \oplus {B_2} \oplus E$, while the “in-plane” $\pi $ orbitals (having vertical nodal planes) transform as ${A_2} \oplus {B_1} \oplus E$. Electric dipole-allowed transitions are only possible to $E_u$ and $B_{1u}$ states in $D_{4h}$ symmetry and to $E$ and $A_1$ states in $D_{2d}$ symmetry. The experimental ultraviolet-visible (UV/Vis)\nomenclature{UV/Vis}{Ultraviolet-visible spectroscopy} spectra in the charge-transfer region are dominated by two strong bands in the $D_{4h}$ case and three strong bands in the $D_{2d}$ case. Assuming that these belong to electric-dipole allowed transitions, there are three possible sets of ligand donor orbitals in the $D_{4h}$ case (two times $e_u$ and $b_{1u}$) and five possible sets in the $D_{2d}$ case (two times $a_1$ and three times $e$). For the $D_{4h}$ case, we simply included all $e_u$ and $b_{1u}$ ligand orbitals into the active space, which leads to a SA-CASSCF(19,10) reference calculation, with a balanced ratio of ligand-field versus charge transfer roots in the state averaging. For the $D_{2d}$ geometry, there are differing opinions in the literature regarding the character of the ligand donor orbitals in the three dominant bands, although there seems to be consensus that two of them have $E$ symmetry and one of them $A_1$ symmetry.\cite{BirdD_1968_392, DesjaPCMS_1983_4590} A very thorough combined experimental and theoretical work came to the conclusion that one of them originates from a non-bonding set of $p$-$\pi$ orbitals with $e$ symmetry, while the other two correspond to an excitation from an $e$ set of $\sigma $ oriented $p$ orbitals and an $a_1$ orbital of $\sigma$ character.\cite{DesjaPCMS_1983_4590} These results were taken into account to choose the active space for a CASSCF(19,10) calculation on the $D_{2d}$ complex. The choice of orbitals was also verified by comparison with a larger active space CASSCF(25,13) calculation including all ligand orbitals of $e$ and $a_1$ symmetry; see Appendix \ref{Sec:appendix_CAS2513}. The SDOs for the two gas phase optimized structures from the previous section are shown in Figure \ref{Fig:LMCT_orbitals}.
\begin{figure}
\ffigbox[\FBwidth]
{\caption[Gas phase CASSCF(19,10) SDOs for {[CuCl\textsubscript{4}]}\textsuperscript{2\textminus}.]{Gas phase CASSCF(19,10) SDOs for [CuCl\textsubscript{4}]\textsuperscript{2\textminus} in $D_{4h}$ geometry (left) and $D_{2d}$ geometry (right). From top to bottom, the SDOs correspond to the SOMO of the different electronic states in order of increasing energy. Isovalues of 0.05 were chosen.}
\label{Fig:LMCT_orbitals}}
{\includegraphics[width=\textwidth]{figures/LMCT_orbitals/allorbitals_cropped_scaled.png}}
\end{figure}

In order to describe the systems more realistically, we employed an embedded cluster approach\cite{Staem_2005_219} that has proven to be a viable technique for the modelling of many different properties of solid systems.\cite{MaganRHTKSN_2013_7260, KubasBOMRN_2016_4207, DittmINM_2019_9303} As a crystal with $D_{2d}$ ions we chose Cs\textsubscript{2}CuCl\textsubscript{4}, which crystallizes in the space group type Pnma with lattice parameters $a$=9.70 Å, $b$=7.60 Å, $c$=12.35 Å and 4 formula units (28 atoms) per unit cell.\cite{HelmhK_1952_1176} For $D_{4h}$ symmetry, we chose (N-mph)\textsubscript{2}CuCl\textsubscript{4} (N-mph = N-methylphenethylammonium), which crystallizes in the space group type P2\textsubscript{1}/c with lattice parameters $a$=6.4952 Å, $b$=22.678 Å, $c$=8.5844 Å and angle β=116.08°, and two formula units (106 atoms) per unit cell.\cite{HarloWWS_1974_2106} The unit cells were repeated in all three directions to create a supercell whose surface is at least 30 Å from the atoms in the center. The [CuCl\textsubscript{4}]\textsuperscript{2\textminus} units were treated quantum mechanically, and the remaining atoms of the supercell as point charges. To prevent charge flow from the quantum region to the embedding charges, SDD effective core potentials\cite{FuentPSV_1982_418, DolgWSP_1987_866, BergnDKSP_1993_1431, LeiniNKSDB_1996_274} were put on all positive point charges within a distance of 5 Å from any quantum-mechanical atom. One exception were positive charges representing H atoms, since the latter do not have core electrons and therefore no ECP is defined for them. We also performed calculations where Li ECPs were put on H point charges and the results were very similar; see Appendix \ref{Sec:appendix_excenergies_beforeaveraging}. The embedding charges were determined iteratively using CHELPG\cite{BreneW_1990_361} electrostatic charges from DLPNO-CCSD\cite{RipliPBVN_2016_24109, SaitoBRVN_2017_164105} calculations. The details of the embedding calculations can be found in Appendix \ref{Sec:appendix_detailsembedding}. One important effect of this more realistic description is that the symmetry of the [CuCl\textsubscript{4}]\textsuperscript{2\textminus} units is lowered. In Cs\textsubscript{2}CuCl\textsubscript{4} the symmetry is lowered from $D_{2d}$ to $C_s$, while in (N-mph)\textsubscript{2}CuCl\textsubscript{4} it is lowered from $D_{4h}$ to $D_{2h}$. We will still use the approximate $D_{2d}$ and $D_{4h}$ symmetry labels in the following for simplicity. For the $D_{2d}$ complex, the symmetry lowering had the effect that the (19,10) active space was not stable anymore. The second $e$ set of ligand orbitals mixed with an orbital of pseudo $b_1$ symmetry. We therefore included this as an active orbital to end up with a (21,11) active space, with the weights for both $d$-$d$ and LMCT states adjusted such that each group contributes 50\%.

The DKH2\cite{Hess_1986_3742, JanseH_1989_6016} scalar-relativistic Hamiltonian and the DKH-def2-TZVP\cite{PantaCLN_2008_908} basis set was used throughout. The resulting excitation energies calculated with different variants of NEVPT2 and DCD-CAS(2) on top of the CASSCF references are shown in Table \ref{Tab:D2d_excitations} and Table \ref{Tab:D4h_excitations}. We also computed excitation energies using ``ground-state'' open-shell DLPNO-CCSD(T)\cite{SaitoBRVN_2017_164105} with the single-determinant CASSCF roots as references and with AutoAux\cite{StoycAN_2017_554} to generate the auxiliary basis set. 
The convergence threshold for the CC residual equations unfortunately had to be slightly loosened from the default value to enable convergence to the excited states; hence we report a reduced number of digits that, we believe, are still significant.
Details can be found in Appendix \ref{Sec:appendix_thresholdsCC}. The energies of all states belonging to a degenerate term in the pseudo symmetry group were averaged. In the case of the second $^2E$ state of the $D_{2d}$ system, we also included a third state originating from the additional $b_1$ orbital in the average. The exact numbers before the averaging are presented in Appendix \ref{Sec:appendix_excenergies_beforeaveraging}.
\begin{table}
\small
\centering
\ttabbox
{\caption[Excitation energies belonging to the $d$-$d$ and charge transfer transitions of $D_{2d}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus}.]{Excitation energies (in eV) belonging to the $d$-$d$ transitions and the three strongest bands in the charge transfer region of the $D_{2d}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} UV/Vis absorption spectrum. For the DLPNO reference, the threshold on the residual convergence was loosened to 0.003.}
\label{Tab:D2d_excitations}}
{\input{Tables/D2d_excitations.tex}
\floatfoot{\textsuperscript{a}Experimentally, the $^2E$ $d$-$d$ state is slightly split by a distortion. We use the average of the two energies as a reference. \\
\textsuperscript{b}This value is obtained by averaging the energy of only two instead of all three states that correspond to this level, since one of the calculations did not converge.}}
\end{table}
\begin{table}
\small
\centering
\ttabbox
{\caption[Excitation energies belonging to the $d$-$d$ and charge transfer transitions of $D_{4h}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus}.]{Excitation energies (in eV) belonging to the $d$-$d$ transitions and the dipole-allowed bands in the charge transfer region of the $D_{4h}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} UV/Vis absorption spectrum (with all H atoms modeled as point charges). For the DLPNO reference, the threshold on the residual convergence was loosened to 0.0005.}
\label{Tab:D4h_excitations}}
{\input{Tables/D4h_excitations.tex}
\floatfoot{\textsuperscript{a}Experimentally, the $^2E$ $d$-$d$ state is slightly split by a distortion. We use the average of the two energies as a reference.}}
\end{table}
It can be observed that NEVPT2 and QD-NEVPT2 results are very close, so there is only limited occurrence of state mixing and the CASSCF states provide reasonable 0th order references. On average, both methods overestimate the excitation energies but still compare relatively well with the experiment. The DLPNO-CCSD(T) excitation energies are quite similar to the NEVPT2 ones, but predict slightly lower excitation energies for $d$-$d$ transitions. We assume that the CC results provide good reference numbers to judge the other methods. We presume that the still relatively large deviations of the CC calculations from experiment has other reasons than the electronic structure method itself. For example, some sources of error might be the use of geometries obtained from the crystal structures, the fact that our methodology cannot describe the polarizability of the crystal environment, and deviations between vertical excitation energies and absorption band maxima. 
Note that the calculated oscillator strength (not shown in the table) for the transition to the $^2B_{1u}$ excited state in $D_{4h}$ geometry is very small, which explains why it is not observed experimentally.
SA-NEVPT2 and DCD-CAS(2) give decent results for the ligand field excitations but severely underestimate the LMCT excitation energies compared to the CC results. This is another demonstration of the fact that the state-averaged Dyall Hamiltonian is simply not accurate enough when treating ligand-field and charge transfer states simultaneously. State-specific Dyall Hamiltonians are necessary, which means that multi-partitioning theory becomes a necessity.

\chapter{An improvement of AILFT by means of multistate perturbation theory}
Already in our initial work on the DCD-CAS(2) method,\cite{PathaLN_2017_234109} we observed for one specific complex, [CrF\textsubscript{6}]\textsuperscript{3\textminus}, that this new method might provide a better starting point for the AILFT parametrization than the NEVPT2 method that has been predominantly used so far to include dynamic correlation. In the present chapter, we investigate if this finding is part of a more general trend by comparing the performance of our newly developed multistate methods DCD-CAS(2) and HQD-NEVPT2 when they are combined with AILFT.

\section{Choices for the \textit{ab initio} effective Hamiltonians}
The most obvious choice for the \textit{ab initio} effective Hamiltonian to be used in the AILFT procedure (see Section \ref{Sec:AILFT_theory}) is a CASCI Hamiltonian with the corresponding $d$-like or $f$-like MOs chosen as active orbitals. One can write the CASCI matrix via a spectral resolution as
	\begin{equation}
	\label{Eq:HLFT_CAS}
	{\mathbf{H}}_{{\text{CASCI}}}^{{\text{eff}}} = {{\mathbf{C}}_{{\text{CASCI}}}}{{\mathbf{E}}_{{\text{CASCI}}}}{\mathbf{C}}_{{\text{CASCI}}}^T,
	\end{equation}
where ${{\mathbf{E}}_{{\text{CASCI}}}}$ is a diagonal matrix containing the CASCI energies and ${{\mathbf{C}}_{{\text{CASCI}}}}$ is the CASCI coefficient matrix with respect to the CSF basis. As we noted in Section \ref{Sec:LFT}, the only approximation when describing Eq. (\ref{Eq:HLFT_CAS}) via the LFT model is the parametrization of the two-electron integrals. For a real complex, with a symmetry-lowering ligand environment, the active orbitals have lower than full spherical symmetry. For example, the $d$ orbitals in an octahedral complex split into distinct $e_g$ and $t_{2g}$ sets. If covalency is not too large, the CASCI Hamiltonian is usually nevertheless very well described by the LFT model. Apart from extreme cases, the root-mean-square deviations (RMSD)\nomenclature{RMSD}{Root-mean-square deviation} between \textit{ab initio} and LFT state energies at the CASCI level are typically not much larger than 0.1 eV.\cite{SinghEAN_2017_2}

One problem with this version of AILFT is that dynamic correlation is missing from the CASCI method, which also limits the accuracy of the derived AILFT model. A way to incorporate dynamic correlation in a computationally efficient way is MRPT2, a popular variant of which is NEVPT2. One can define a NEVPT2 effective Hamiltonian in analogy to Eq. (\ref{Eq:HLFT_CAS}) via back-transformation of the NEVPT2 energies with the CASCI coefficients,
	\begin{equation}
	\label{Eq:HLFT_NEV}
	{\mathbf{H}}_{{\text{NEVPT2}}}^{{\text{eff}}} = {{\mathbf{C}}_{{\text{CASCI}}}}{{\mathbf{E}}_{{\text{NEVPT2}}}}{\mathbf{C}}_{{\text{CASCI}}}^T.
	\end{equation}
This means that the CASCI part of the wavefunction is unchanged, while the total energies are corrected for dynamic correlation.
Here, ${{\mathbf{E}}_{{\text{NEVPT2}}}}$ is a diagonal matrix containing the NEVPT2 energies. This choice of effective Hamiltonian often leads to better agreement with the experiment than the CASCI Hamiltonian. However, past experience has shown that the LFT model provides a significantly inferior parametrization for this Hamiltonian than for the CASCI Hamiltonian, as is evident from a larger RMSD between \textit{ab initio} and LFT energies, which is often increased by an order of magnitude or more.\cite{SinghEAN_2017_2} This large discrepancy can partially absorb the gain in accuracy of NEVPT2 over CASCI.

The two multistate methods developed in this thesis, DCD-CAS(2) and HQD-NEVPT2, do not fix the CASCI parts of the wavefunctions, but instead allow them to mix and relax under the effect of dynamic correlation. This potentially provides a more balanced modification of the CASCI matrix under the effect of dynamic correlation, compared to the NEVPT2 approach where only the diagonal energies are modified but the CASCI coefficients stay identical.
In DCD-CAS(2), one defines the effective Hamiltonian as
	\begin{equation}
	\label{Eq:HLFT_DCD}
	{\mathbf{H}}_{{\text{DCD-CAS(2)}}}^{{\text{eff}}} = {{\mathbf{C}}_{{\text{DCD-CAS(2)}}}}{{\mathbf{E}}_{{\text{DCD-CAS(2)}}}}{\mathbf{C}}_{{\text{DCD-CAS(2)}}}^T.
	\end{equation}
Here, the energies ${\mathbf{E}}_{{\text{DCD-CAS(2)}}}$ contain the 1st order bias correction.
In HQD-NEVPT2, the effective Hamiltonian in the CSF basis must also be reconstructed from energies and CI coefficients,
	\begin{equation}
	\label{Eq:HLFT_HQD}
	{\mathbf{H}}_{{\text{HQD-NEVPT2}}}^{{\text{eff}}} = {{\mathbf{C}}_{{\text{HQD-NEVPT2}}}}{{\mathbf{E}}_{{\text{HQD-NEVPT2}}}}{\mathbf{C}}_{{\text{HQD-NEVPT2}}}^T,
	\end{equation}
since the effective Hamiltonian is usually formulated in the basis of eigenstates of a prior CASCI calculation. The effective Hamiltonians Eqs. (\ref{Eq:HLFT_DCD}) and (\ref{Eq:HLFT_HQD}) have been newly implemented in a development version of the ORCA electronic structure program\cite{Neese_2018_1327} for the present work.

Eqs. (\ref{Eq:HLFT_NEV}), (\ref{Eq:HLFT_DCD}) and (\ref{Eq:HLFT_HQD}) represent the different choices for \textit{ab initio} effective Hamiltonians including the effect of dynamic correlation that we investigate in this chapter. By fitting the LFT model to these effective Hamiltonians, one can then obtain “renormalized” parameters in the sense of Gerloch \textit{et al.}\cite{GerloHW_1981_1}

\section{Test set and computational details}
To test the different approaches, we compiled a diverse set of spectroscopically well-documented TM complexes. It includes homoleptic octahedral $3d^3$ complexes (Cr\textsuperscript{III} with ligands F\textsuperscript{\textminus}, Cl\textsuperscript{\textminus}, Br\textsuperscript{\textminus}, I\textsuperscript{\textminus}, CN\textsuperscript{\textminus}, NH\textsubscript{3}), the $4d^3$ complexes [MoCl\textsubscript{6}]\textsuperscript{3\textminus} and [TcF\textsubscript{6}]\textsuperscript{2\textminus}, and the $5d^3$ complexes IrF\textsubscript{6} and [ReX\textsubscript{6}]\textsuperscript{2\textminus} (with X=F, Cl, Br). In order to have different $d^n$ occupations present, we also include the series of tetrahedral divalent chloride complexes of metals from the first transition row from Ti to Ni. The $3d^3$ Cr(acac)\textsubscript{3} and $3d^4$ Mn(acac)\textsubscript{3} complexes are included as examples for chelate complexes, and the $3d^2$ [FeO\textsubscript{4}]\textsuperscript{2\textminus} and [MnO\textsubscript{4}]\textsuperscript{3\textminus} complexes as examples for TM complexes with high +VI and +V oxidation states, respectively. Systems with only 1 electron or 1 hole in the $d^n$ manifold were not included, since electron-electron repulsion does not play a role for them and they can always be exactly parametrized by the LFT model.

We performed all calculations with a development version of the ORCA electronic structure program.\cite{Neese_2018_1327} The DKH2 scalar-relativistic Hamiltonian\cite{Hess_1986_3742, JanseH_1989_6016} was used in all calculations. Since there is no basis set optimized for a relativistic Hamiltonian for all elements present in the test set, we used DKH-def2-TZVP\cite{PantaCLN_2008_908} for elements lighter than Kr (including $3d$ TMs), Sapporo-DK-TZP\cite{NoroSK_2012_1124} for elements lighter than Xe (including $4d$ TMs), and SARC-DKH-TZVP\cite{PantaCLN_2008_908, PantaN_2009_2229, PantaN_2011_677, PantaN_2012_1292} for everything heavier. The reason for this choice is that we wanted to treat as many elements as possible consistently, and the DKH-def2-TZVP was specifically recontracted for use together with the SARC basis sets.\cite{PantaCLN_2008_908} Only for $4d$ elements, where neither of these two basis sets is defined, the Sapporo basis set was used. Auxiliary basis sets, if needed, were constructed using AutoAux.\cite{StoycAN_2017_554} Geometry optimizations were performed with DFT using the BP86\cite{Perde_1986_8822}\cite{Becke_1988_3098} exchange-correlation functional with D3BJ\cite{GrimmAEK_2010_154104, GrimmEG_2011_1456} dispersion correction, grid5 integration grids, and the conductor-like polarizable continuum model (C-PCM)\nomenclature{C-PCM}{Conductor-like polarizable continuum model}\cite{BaronC_1998_1995} with infinite permittivity in order to approximately account for environment effects. Unless otherwise mentioned, the multireference calculations were performed on top of reference states and orbitals obtained from a CASSCF($N$,5) calculation averaged over all possible roots of all multiplicities.  The default option in ORCA was used, where all multiplicity blocks are assigned the same total weight. For a $d^3$ system there are for example 10 quartet and 40 doublet roots. This gives a weight of 0.5/10=0.05 for each quartet root and a weight of 0.5/40=0.0125 for each doublet root. The strongly-contracted\cite{AngelCM_2001_297, AngelCM_2002_9138} version of (HQD-)NEVPT2 was used throughout.

\section{Results}
\subsection{Validation of the computational protocol}
TM complexes usually exist in some environment (solution, crystal) that influences their properties. An often applied computationally inexpensive approach to account for such environment effects is the use of an implicit solvation model like C-PCM.\cite{BaronC_1998_1995} We start by investigating its effect for a set of octahedral Cr\textsuperscript{III} complexes with different ligands.

Table \ref{Tab:CrX_bondlengths} shows the bond lengths obtained in a geometry optimization with or without C-PCM. Table \ref{Tab:CrX6_energies_geometries} shows the quartet excitation energies obtained from CASSCF and NEVPT2 calculations on top of those geometries, with averaging over all quartet and doublet states.
\begin{table}
\small
\centering
\ttabbox
{\caption[Cr-X bond lengths for the {[CrX\textsubscript{6}]}\textsuperscript{n} series.]{Cr-X bond lengths (in Å) for the [CrX\textsubscript{6}]\textsuperscript{n} series with and without C-PCM, compared to the experiment.}
\label{Tab:CrX_bondlengths}}
{\input{Tables/CrX_bondlengths.tex}}
\end{table}
\begin{table}
\small
\centering
\ttabbox
{\caption[Quartet excitation energies for the {[CrX\textsubscript{6}]}\textsuperscript{n} series.]{Quartet excitation energies (in eV) for the [CrX\textsubscript{6}]\textsuperscript{n} series obtained with different geometries.}
\label{Tab:CrX6_energies_geometries}}
{\input{Tables/CrX6_energies_geometries.tex}
\floatfoot{\textsuperscript{a}K\textsubscript{2}NaCrF\textsubscript{6}\cite{WoodFKD_1963_890} This system has an experimental metal ligand distance that is closest to the C-PCM geometry among the systems in Table \ref{Tab:CrX_bondlengths}. \\
\textsuperscript{b}CrCl\textsubscript{3}\cite{WoodFKD_1963_890}\\
\textsuperscript{c}CrBr\textsubscript{3}\cite{WoodFKD_1963_890}\\
\textsuperscript{d}K\textsubscript{3}Cr(CN)\textsubscript{6}\cite{AlexaG_1968_4260}\\
\textsuperscript{e}[Cr(NH\textsubscript{3})\textsubscript{6}](ClO\textsubscript{4})\textsubscript{3} in H\textsubscript{2}O\cite{Linha_1944_224, Schlae_1957_65}
}}
\end{table}
It can be observed that the structures optimized with C-PCM have smaller metal-ligand bond lengths, which agree better with the experimental bond lengths in all cases except for the CN\textsuperscript{\textminus} ligand, where even the gas-phase-optimized bond length is too short. Taken together, this suggests that the inclusion of C-PCM will in general be beneficial for accurate structures. For excitation energies the situation is less clear-cut. Using C-PCM geometries, the first excitation energy is usually well represented, while the second one is typically overestimated. Using the gas phase geometries, this situation is reversed: the first excitation energy is usually underestimated, while the second excitation energy is usually closer to experiment. There is a general trend that the NEVPT2 method with triple-zeta basis sets overestimates excitation energies for $d$-$d$ transitions, as exemplified by our recent study of the excitation energies of free ions in the gas phase,\cite{LangN_2019_104104} where discrepancies due to an incorrect description of the environment can be excluded. This overestimation of excitation energies was also discussed in the recent AILFT review article.\cite{SinghEAN_2017_2} This means that the good results for second excitation energies using NEVPT2 and the gas phase geometries rely on error cancellation between the too long bond distances (leading to smaller excitation energies) and errors in the NEVPT2 method (leading to larger excitation energies). We therefore prefer the results based on the \mbox{C-PCM}-optimized geometries, since they do not rely on such error cancellation. The data suggests that a smaller metal-ligand distance leads to larger excitation energies, which is also intuitively obvious since in this case the ligand field is stronger. This explains that the calculation of excitation energies based on the gas phase geometry (which is closer to the experimental geometry) agrees better with the experiment for the CN\textsuperscript{\textminus} ligand.

Apart from state averaging over all roots (quartet and doublet), we also investigated results obtained with state averaging over only the quartet roots; see Appendix \ref{Sec:appendix_CrIII_quartetaveraging}. The results are very similar in the two state averaging protocols. This implies that here the exact choice is not too important for the results. One should note however that the quality of the AILFT fit can of course suffer if several multiplicity blocks of the effective Hamiltonian are parametrized simultaneously.

\subsection{RMSDs and comparison with experimental excitation energies}
Before comparing the RMSD between LFT and \textit{ab initio} energies for the different methods investigated in this work, we discuss some fundamental limitations of the most simple LFT model used here. The parametrization of the electron-electron repulsion in terms of the three Racah parameters assumes that the partially occupied orbitals are pure spherically symmetric $d$ orbitals. This is only exactly true for free atoms and ions. In complexes, this assumption is not exactly fulfilled due to covalency, which renders the electron-electron repulsion anisotropic. In the most general case, the 120 permutationally distinct two-electron integrals between the $d$ orbitals are all unique and should be considered as independent parameters in the model. For systems with some residual symmetry, the number of independent parameters is of course smaller. For example, in an octahedral complex there are 10 independent parameters which completely capture the anisotropy of the electron-electron repulsion at the CASSCF level.\cite{AtanaDR_2004_97}\cite{Griff_1971_}\cite{Daul_1994_867} Neglecting this anisotropy will inevitably lead to disagreement between the model energies and the \textit{ab initio} energies, which correctly include this anisotropy. Hence the RMSD will be larger. One should however note that for Werner type complexes with limited covalency, the assumption of isotropic electron-electron repulsion is often a very good one and then RMSDs at the CASSCF level are small. While in this work we focus on the pure LFT model with isotropic electron-electron repulsion, we plan to investigate models that explicitly include anisotropy in future work.

Figure \ref{Fig:rmsd} shows the RMSD between the LFT energies and the \textit{ab initio} energies for all investigated methods and complexes. The exact numbers are given in Appendix \ref{Sec:appendix_AILFT_exactnumbers}. Some general trends can be observed. Even at the CASSCF level, the RMSD varies between 0.01 eV and 0.32 eV, correlating well with the covalency of the $d$-like active MOs. 
\begin{figure}
\ffigbox[\FBwidth]
{\caption[Total RMSDs between AILFT and \textit{ab initio} state energies.]{Total RMSDs between AILFT and \textit{ab initio} state energies for different methods and complexes.}
\label{Fig:rmsd}}
{\includegraphics[width=0.8\textwidth]{figures/AILFT_Figures/RMSD/rmsd-crop.pdf}}
\end{figure}
This is expected, since overlap with ligand orbitals will reduce the symmetry of the orbitals from purely spherical and therefore make the approximation of the two-electron integrals in terms of the three Racah parameters worse. The NEVPT2 RMSD is always significantly larger than the CASSCF RMSD, and they correlate well: If the CASSCF RMSD is large for a particular compound, then usually also the NEVPT2 one will be large compared to other compounds. The RMSDs for the multistate methods HQD-NEVPT2 and DCD-CAS(2) improve significantly over the NEVPT2 values. DCD-CAS(2) performs best for all molecules, but its performance is usually closely matched by HQD-NEVPT2. Only for a few cases (the octahedral $5d$ complexes, [MnCl\textsubscript{4}]\textsuperscript{2\textminus}, and [FeO\textsubscript{4}]\textsuperscript{2\textminus}) is the HQD-NEVPT2 fit slightly worse than the NEVPT2 one.

The effect of these RMSDs is seen in Table \ref{Tab:allexcitationenergies}, which shows excitation energies calculated with the \textit{ab initio} methods and the LFT models derived from them, compared to experimental band maxima. This comparison is obviously inflicted with a number of uncertainties since the band maxima do not correspond to vertical excitation energies and are also influenced by a variety of environment effects that we do not attempt to model here. Nevertheless, as shown below, there is still reasonably good agreement. It can be observed in Table \ref{Tab:allexcitationenergies} that in cases where NEVPT2 gives results that are in closer agreement with the experiment, like for the Cr\textsuperscript{III} halide complexes, the large RMSD of the corresponding AILFT fit (see Appendix \ref{Sec:appendix_AILFT_exactnumbers} for exact numbers) leads to AILFT(NEVPT2) energies that are often not better than the CASSCF values. HQD-NEVPT2 and DCD-CAS(2) on the other hand give, thanks to the much better fit as reflected by the smaller RMSDs, LFT models that have a closer agreement with the experiment than the one fitted to NEVPT2. Also for many other complexes does the smaller RMSD at the HQD-NEVPT2 and DCD-CAS(2) levels lead to LFT models that have a better agreement with the experiment than the models that are derived from state-specific NEVPT2. In some cases, one can observe that the large RMSD for NEVPT2 leads to fortuitous cancellation of errors when the NEVPT2 \textit{ab initio} energies already deviate strongly from the experimental values. This is for example the case for IrF\textsubscript{6}. Here, NEVPT2 and DCD-CAS(2) both predict a first excitation energy of 1.25 eV, which is larger than the experimental 1.09 eV. Due to the larger RMSD, the AILFT(NEVPT2) value of 1.07 then agrees better than the corresponding AILFT(DCD-CAS(2)) value of 1.15 eV. Also for the two complexes with metals in high oxidation states, [FeO\textsubscript{4}]\textsuperscript{2\textminus} and [MnO\textsubscript{4}]\textsuperscript{3\textminus}, the AILFT values, especially the DCD-CAS(2) ones, benefit from such error cancellation. One should be careful in using such a model that has a large RMSD, since the parameters might have limited physical significance.

\input{Tables/allexcitationenergies_longtable.tex}

We also display the correlation between the calculated and experimental excitation energies from Table \ref{Tab:allexcitationenergies} in Figure \ref{Fig:correlation_abinitio} for the exact \textit{ab initio} numbers and in Figure \ref{Fig:correlation_AILFT} for the numbers obtained from the different AILFT models. The complexes [FeO\textsubscript{4}]\textsuperscript{2\textminus} and [MnO\textsubscript{4}]\textsuperscript{3\textminus}, for which LFT was not expected to work well in the first place, were excluded from these figures since they would significantly distort the results.
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[Correlation between experimental and \textit{ab initio} excitation energies.]{Correlation between experimental excitation energies and excitation energies calculated with different \textit{ab initio} methods for the data shown in Table \ref{Tab:allexcitationenergies} (excluding the two complexes with high oxidation states). The gray dashed line denotes perfect agreement.}
\label{Fig:correlation_abinitio}}
{\includegraphics[width=0.8\textwidth]{figures/AILFT_Figures/correlation_calc_expt/wo_highox/correlation_abinitio-crop.pdf}}
\end{figure}
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[Correlation between experimental and AILFT excitation energies.]{Correlation between experimental excitation energies and energies of the AILFT models derived from different \textit{ab initio} methods for the data shown in Table \ref{Tab:allexcitationenergies} (excluding the two complexes with high oxidation states). The gray dashed line denotes perfect agreement.}
\label{Fig:correlation_AILFT}}
{\includegraphics[width=0.8\textwidth]{figures/AILFT_Figures/correlation_calc_expt/wo_highox/correlation_AILFT-crop.pdf}}
\end{figure}
Table \ref{Tab:mrMAD} gives the slopes of the linear least-squares fits for the relationship between experimental and calculated excitation energies. For the methods including dynamic correlation (NEVPT2, HQD-NEVPT2, DCD-CAS(2)), it can be observed that the slopes of the \textit{ab initio} numbers are usually larger than the slopes of the AILFT models. For the latter, the slopes are much closer to the ideal value of 1.0, which would mean that there is no systematic under- or overestimation. This behavior is another manifestation of the above-mentioned error cancellation between the overestimation of excitation energies at the level of 2nd order perturbation theory and the systematic underestimation of the energies through the imperfect AILFT fits. As mentioned above, this error cancellation is partially removed by the better fit and hence lower RMSDs of the AILFT models derived from the multistate theories HQD-NEVPT2 and DCD-CAS(2). Therefore, the AILFT slopes of these two methods are slightly larger than the corresponding AILFT(NEVPT2) slope. Comparing the Pearson correlation coefficients $r$ also shown in Table \ref{Tab:mrMAD}, one can observe that the value is closer to the ideal value of 1.0 for the methods including dynamic correlation than for CASSCF. The AILFT models have a slightly smaller correlation coefficient, which can be attributed to the fitting errors. One can also see that AILFT based on the multistate methods HQD-NEVPT2 and DCD-CAS(2) has a slightly improved correlation coefficient compared to the state-specific NEVPT2 method. The mean absolute deviations (MAD) shown in Table \ref{Tab:mrMAD} are around 0.3 eV for the correlated methods. This is less than the deviations at the CASSCF level and certainly in reasonable agreement considering the intrinsic accuracy of 2nd order perturbation theory\cite{SchapSN_2013_3567} as well as the neglect of explicit environmental effects and experimental uncertainties. It can be observed that the multistate methods have a slightly smaller MAD than state-specific NEVPT2, while the AILFT models have the smallest MADs, again due to the above-mentioned error cancellation.
\begin{table}
\small
\centering
\ttabbox
{\caption[Slopes $m$ of the linear regression line, Pearson correlation coefficient $r$, and MAD between theoretical and experimental excitation energies.]{Slopes $m$ of the linear regression line, Pearson correlation coefficient $r$, and MAD between theoretical and experimental excitation energies (excluding the two complexes with high oxidation states). AI denotes the pure \textit{ab initio} prediction, while AILFT denotes the prediction from the extracted LFT model.}
\label{Tab:mrMAD}}
{\input{Tables/m_r_MAD.tex}}
\end{table}

\subsection{Trends in the extracted ligand field parameters}
We now investigate the behavior of the ligand field parameters extracted via AILFT from the different \textit{ab initio} effective Hamiltonians. For octahedral and tetrahedral complexes, the one-electron ligand field matrix can be parametrized by a single number, the ligand field splitting $\Delta$. This quantity is the difference between the ligand-field orbital energies of the $t_{2(g)}$ and $e_{(g)}$ set. Figure \ref{Fig:Delta} shows $\Delta$ for all complexes in the test set which are (approximately) tetrahedral or octahedral. For the complexes which do not have this symmetry exactly, orbital energies were averaged to derive the $t_{2(g)}$ and $e_{(g)}$ orbital energies.
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[Ligand field splittings $\Delta$.]{Ligand field splittings $\Delta$ for all complexes in the test set that are approximately octahedral or tetrahedral. All ligand field orbital energies belonging to degenerate sets in the pseudo symmetry group were averaged.}
\label{Fig:Delta}}
{\includegraphics[width=0.85\textwidth]{figures/AILFT_Figures/Delta/Delta-crop.pdf}}
\end{figure}
One can observe that there is a clear trend toward slightly larger ligand field splittings when using multistate perturbation theory methods compared to the state-specific NEVPT2. Only for the extremely covalent complexes [FeO\textsubscript{4}]\textsuperscript{2\textminus} and [MnO\textsubscript{4}]\textsuperscript{3\textminus} there is an exception to this finding at the DCD-CAS(2) level. Figures \ref{Fig:B} and \ref{Fig:C} show the values of the extracted Racah parameters $B$ and $C$, while Figure \ref{Fig:CoverB} shows their ratio $C/B$.
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[AILFT Racah parameter $B$.]{AILFT Racah parameter $B$ derived from different \textit{ab initio} methods for all complexes in the test set.}
\label{Fig:B}}
{\includegraphics[width=0.85\textwidth]{figures/AILFT_Figures/B/B-crop.pdf}}
\end{figure}
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[AILFT Racah parameter $C$.]{AILFT Racah parameter $C$ derived from different \textit{ab initio} methods for all complexes in the test set.}
\label{Fig:C}}
{\includegraphics[width=0.85\textwidth]{figures/AILFT_Figures/C/C-crop.pdf}}
\end{figure}
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[AILFT Racah parameter ratio $C/B$.]{AILFT Racah parameter ratio $C/B$ derived from different \textit{ab initio} methods for all complexes in the test set.}
\label{Fig:CoverB}}
{\includegraphics[width=0.85\textwidth]{figures/AILFT_Figures/CoverB/CoverB-crop.pdf}}
\end{figure}
It can be seen that in almost all cases the extracted $B$ is smaller, while $C$ is usually slightly larger for the multistate methods than for NEVPT2. For [FeO\textsubscript{4}]\textsuperscript{2\textminus} the $C$ parameter is even negative at the NEVPT2 level, which is clearly unphysical, and a result of the bad fit via the LFT model as a consequence of the large covalency and anisotropy in this system. At the level of the two multistate methods, the value of $C$ for this complex is positive, but remains unreasonably small in magnitude. As a consequence of the larger values of $C$ and smaller values of $B$ at the multistate level, also the ratio $C/B$ increases in most cases. This results in a value that is closer to the often cited estimate of $C/B \approx 4$ for $3d$ TM complexes that can be derived under the assumption that the radial parts of the $d$ orbitals are Slater functions.\cite{SinghEAN_2017_2}

\subsection{Analysis of state-mixing effects in [CrX\textsubscript{6}]\textsuperscript{3\textminus}}
In order to better understand the observations reported above, we investigate the effect of state mixing in the multistate MRPT methods for the example of the Cr\textsuperscript{III} halide complexes, in particular [CrF\textsubscript{6}]\textsuperscript{3\textminus}. The \textit{ab initio} and AILFT energies of this system calculated at the state-specific NEVPT2 and at the HQD-NEVPT2 level are depicted in Figure \ref{Fig:leveldiagram}. At first sight, there is no significant difference between the energy levels for the different methods. However, upon closer inspection, one observes that the AILFT(NEVPT2) values differ much more strongly from the NEVPT2 values than the AILFT(HQD-NEVPT2) values from the HQD-NEVPT2 values. This finding is in agreement with the larger RMSD discussed above. When looking at the energy level diagrams, this behavior is quite surprising since the results of NEVPT2 and HQD-NEVPT2 seem very similar. Hence, state mixing seems to have a very minor effect on the energies. Also the general trend that the imperfect AILFT fit leads to an under- rather than overestimation of the excitation energies at the AILFT level compared to the \textit{ab initio} energies is nicely illustrated by Figure \ref{Fig:leveldiagram}.
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[Ligand-field energies of {[CrF\textsubscript{6}]}\textsuperscript{3\textminus}.]{All ligand field energies of [CrF\textsubscript{6}]\textsuperscript{3\textminus} relative to the ground state calculated with NEVPT2 and HQD-NEVPT2 together with the corresponding AILFT fits. The quartet energy levels are shown in red and the doublet energy levels in blue. The vertical axis is cut at 5 eV, i.e. some higher-lying doublet states are calculated but not shown, to make the differences between the different methods better visible.}
\label{Fig:leveldiagram}}
{\includegraphics[width=0.8\textwidth]{figures/AILFT_Figures/CrF6_energylevels/leveldiagram-crop.pdf}}
\end{figure}
The ligand field energies calculated with the state-specific NEVPT2 and HQD-NEVPT2 are also shown in Table \ref{Tab:CrF6_energies}. One can clearly see that some state mixing between states of the same symmetry takes place at the HQD-NEVPT2 level, which repels the energy levels compared to NEVPT2. For example $^4T_{1g}(1)$ and $^4T_{1g}(2)$, $^2T_{2g}(3)$ and $^2T_{2g}(4)$, and $^2E_{g}(3)$ and $^2E_{g}(4)$ (highlighted with bold font in Table \ref{Tab:CrF6_energies}) are such pairs of levels whose energies are repelled by letting them mix under the influence of dynamic correlation.
\begin{table}
\small
\centering
\ttabbox
{\caption[Energies of all $d$-$d$ states of {[CrF\textsubscript{6}]}\textsuperscript{3\textminus}.]{Energies (in eV, relative to the ground state) of all $d$-$d$ states of [CrF\textsubscript{6}]\textsuperscript{3\textminus} for different methods. Pairs of states in which clearly a repulsion of energies levels due to state mixing happens are printed in bold.}
\label{Tab:CrF6_energies}}
{\input{Tables/CrF6_energies.tex}}
\end{table}

For simplicity we now focus on only the quartet roots and try to understand why state mixing leads to a better parametrization via the LFT model. As shown in Appendix \ref{Sec:appendix_4T1g_D4hanalysis}, one component of the $^4T_{2g}$ level can be chosen as the $xy\rightarrow x^2-y^2$ excited Slater determinant, while the $xy\rightarrow z^2$ singly excited Slater determinant and the $xz,yz\rightarrow z^2,x^2-y^2$ doubly excited Slater determinant correspond to the same component (belonging to the $A_{2g}$ irreducible representation of the $D_{4h}$ subgroup) of the two $^4T_{1g}$ CSFs, which will mix to form the final $^4T_{1g}$ states. In order to make sure that these states stay pure in the calculations, i.e. not mixed with the other excited states of the same energy, we very slightly tetragonally distorted the complex along the $z$ direction from perfect octahedral symmetry, such that the effective point group is $D_{4h}$. More explicitly, we elongated the bonds in the $z$ direction by ${10^{ - 5}}{\mkern 1mu} {\mkern 1mu} {\text{{\AA}}}$. A graphical depiction of the CSFs is shown in Figure \ref{Fig:drawing}.
 \begin{figure}
\ffigbox[\FBwidth]
{\caption[Quartet CSFs for an octahedral $d^3$ complex.]{Quartet CSFs for an octahedral d\textsuperscript{3} complex. Only one representative for each multidimensional irreducible representation is shown.}
\label{Fig:drawing}}
{\includegraphics[width=0.8\textwidth]{figures/AILFT_Figures/d3_oct_CSFs/drawing-crop.pdf}}
\end{figure}

The ligand field Hamiltonian for the quartet states of an octahedral $d^3$ system (setting the energy of the lowest state equal to 0) can be written in the basis of the quartet CSFs ${\Phi _1} = |xy,xz,yz\rangle $, ${\Phi _2} = |{x^2} - {y^2},xz,yz\rangle $, ${\Phi _3} = |{z^2},xz,yz\rangle $ and ${\Phi _4} = |xy,{z^2},{x^2} - {y^2}\rangle $ as
	\begin{equation}
	\label{Eq:LFTmodel}
	{{\mathbf{H}}^{{\text{LFT}}}} = \left( {\begin{array}{*{20}{c}}
  0&0&0&0 \\ 
  0&\Delta &0&0 \\ 
  0&0&{\Delta  + 12B}&{6B} \\ 
  0&0&{6B}&{2\Delta  + 3B} 
\end{array}} \right).
\end{equation}
One can see that in this model the first excitation energy is exactly identical to $H_{22}^{{\text{LFT}}} = \Delta $. The difference between the diagonal values $H_{22}^{{\text{LFT}}}$ and $H_{33}^{{\text{LFT}}}$ (the energies of the two singly excited Slater determinants) is $12B$, which is exactly twice the off-diagonal element of the $^4T_{1g}$ block. The last diagonal element is equal to $H_{44}^{{\text{LFT}}} = 2H_{22}^{{\text{LFT}}} + 3B$. It is also important to note that in the LFT model Eq. (\ref{Eq:LFTmodel}) the ratio of ligand field splitting $\Delta $ and Racah parameter $B$ can be written as a function of the coefficients of the lower-energy $^4T_{1g}$ state, i.e.
	\begin{equation}
	\label{Eq:DeltaoverB}
	\frac{\Delta }{B} = 6\left( {\frac{{{C_2}}}{{{C_1}}} - \frac{{{C_1}}}{{{C_2}}}} \right) + 9,
	\end{equation}
where ${C_1}$ and ${C_2}$ are the coefficients of the first and second $^4T_{1g}$ CSF, respectively. The derivation of this equation is shown in Appendix \ref{Sec:appendix_derivationDeltaoverB}.
The \textit{ab initio} Hamiltonians for the fluoride, chloride, and bromide complexes are given in Table \ref{Tab:quartetblocks}.
\begin{table}
\small
\centering
\ttabbox
{\caption[Quartet blocks of the \textit{ab initio} effective Hamiltonian matrices for complexes {[CrX\textsubscript{6}]}\textsuperscript{3\textminus}.]{Quartet blocks of the \textit{ab initio} effective Hamiltonian matrices for complexes [CrX\textsubscript{6}]\textsuperscript{3\textminus} with different halide ligands X\textsuperscript{−}. The matrix elements are given in eV. The DCD-CAS(2) effective Hamiltonians are similar to the HQD-NEVPT2 ones and can be found in Appendix \ref{Sec:appendix_AILFT_DCDHeff}.}
\label{Tab:quartetblocks}}
{\input{Tables/quartetblocks.tex}}
\end{table}
When going from CASCI to NEVPT2, one can observe in all three cases that the first excitation energy (corresponding to $\Delta $ in the LFT model) increases, while the off-diagonal matrix element of the $^4T_{1g}$ block (proportional to $B$ in the LFT model) decreases. At the same time the eigenfunctions of the CASCI and NEVPT2 effective Hamiltonians are identical by definition. This means that, according to Eq. (\ref{Eq:DeltaoverB}), the ratio $\Delta /B$ should stay constant if the LFT model provides a perfect fit. These two requirements are obviously in conflict, which explains why it is not possible to fit the NEVPT2 effective Hamiltonian as well as the CASCI Hamiltonian with the LFT model. For the DCD-CAS(2) and HQD-NEVPT2 effective Hamiltonians on the other hand, the diagonal elements of the $^4T_{1g}$ block have a much larger difference, corresponding to a larger $\Delta /B$ ratio. This leads to better fits of these effective Hamiltonians via the LFT model, with smaller RMSDs.

That the HQD-NEVPT2 effective Hamiltonian can be better approximated by the LFT model than the NEVPT2 effective Hamiltonian can also be seen in a different way. From Eq.~(\ref{Eq:LFTmodel}) it follows that, once the parameter $\Delta $ is set equal to the matrix element $H_{22}^{{\text{LFT}}}$, $B$ can be determined from three different matrix elements, i.e.
	\begin{align}
	{B_{33}} &= (H_{33}^{{\text{LFT}}} - H_{22}^{{\text{LFT}}})/12, \\
	{B_{34}} &= H_{34}^{{\text{LFT}}}/6, \\
	{B_{44}} &= (H_{44}^{{\text{LFT}}} - 2H_{22}^{{\text{LFT}}})/3.
	\end{align}
In the LFT model, these three equations must of course lead to exactly the same $B$ value. One can however also apply these equations to the \textit{ab initio} effective Hamiltonian instead of the LFT Hamiltonian, and then the values for $B$ will in general be different. Their variance is then a measure for how good the effective Hamiltonian can be described with the LFT model. Table \ref{Tab:RacahB_variants} gives the values for different \textit{ab initio} methods and ligands.
\begin{table}
\small
\centering
\ttabbox
{\caption[Racah parameter $B$ extracted from different matrix elements of the effective Hamiltonian after fixing the ligand field splitting.]{Racah parameter $B$ (in eV) extracted from different matrix elements of the effective Hamiltonian after fixing the ligand field splitting.}
\label{Tab:RacahB_variants}}
{\input{Tables/RacahB_variants.tex}}
\end{table}
It can be seen that for CASCI, the three values are almost identical for the quite ionic complex [CrF\textsubscript{6}]\textsuperscript{3\textminus}, while their difference grows when going to the more covalent chloride and bromide complexes. The reason is that the $t_{2g}$ and $e_g$ orbital sets differ more in the complexes with stronger covalency, which leads to more anisotropic electron-electron repulsion. For NEVPT2, the $B_{33}$ and $B_{34}$ values are similar for all three complexes, but $B_{44}$ is very small or even negative, which is unphysical. This can again be seen as an effect of the too constrained form of the NEVPT2 effective Hamiltonian, which incorporates dynamic correlation only on the level of total energies, but not on the level of the wavefunctions. HQD-NEVPT2 corrects this shortcoming and the three resulting $B$ values are quite similar, as is expected by the better AILFT fit for this level of theory.

When comparing the NEVPT2 and HQD-NEVPT2 effective Hamiltonians for [CrF\textsubscript{6}]\textsuperscript{3\textminus} in Table \ref{Tab:quartetblocks} one can also observe that the matrix elements change quite substantially, e.g. by 0.24 eV for the diagonal matrix elements of the $^4T_{1g}$ block. At the same time the effect of the state mixing on the total energies is relatively small (about 0.04 eV, see Table \ref{Tab:CrF6_energies}). This explains the question raised by Figure \ref{Fig:leveldiagram} why the fit is so much worse at the NEVPT2 level and shows that one should not judge the importance of state mixing by only looking at total energies.

The fitted LFT parameters for [CrF\textsubscript{6}]\textsuperscript{3\textminus} are shown in Table \ref{Tab:energies_LFTparams} together with the quartet energies. The nephelauxetic ratio $\beta  = {B_{{\text{complex}}}}/{B_{{\text{gaseous}}}}$ also given in Table \ref{Tab:energies_LFTparams} is determined with respect to calculations on the free Cr\textsuperscript{3+} ion. It can be clearly seen that the better fit for DCD-CAS(2) and HQD-NEVPT2 improves the value of $\Delta $, which corresponds to the first excitation energy and has an experimental estimate of 2.00 eV (see Table \ref{Tab:allexcitationenergies}). Allen \textit{et al.} e.g. obtained $\Delta  = 1.88{\mkern 1mu} {\mkern 1mu} {\text{eV}}$ and $B = 0.092{\mkern 1mu} {\mkern 1mu} {\text{eV}}$ by LFT fitting to experimental energies, corresponding to a roughly 20\% nephelauxetic reduction with $\beta  = 0.81$.\cite{AllenEW_1971_2538} It is interesting that the LFT parameters derived from the multistate methods are closer to those parameters than the prediction of the state-specific NEVPT2 method.
\begin{table}
\small
\centering
\ttabbox
{\caption[Excitation energies and LFT parameters for octahedral {[CrF\textsubscript{6}]}\textsuperscript{3\textminus}.]{Excitation energies and LFT parameters (all quantities except the nephelauxetic ratio in eV) for octahedral [CrF\textsubscript{6}]\textsuperscript{3\textminus} with a bond length of 1.9408 Å (averaged).}
\label{Tab:energies_LFTparams}}
{\input{Tables/energies_LFTparams.tex}}
\end{table}

\chapter{Conclusions}
\section{DCD-CAS(2) and HQD-NEVPT2}
In the present work, we have developed two new 2nd order perturbative multistate methods for
the inclusion of dynamic correlation on top of CASSCF references. Multistate dynamic correlation methods do not perform a state-specific correction on top of a single CASSCF state, but construct an effective Hamiltonian in a model space, such that the CASCI
coefficients can relax under the effect of dynamic correlation. This is important whenever there are components in the CASCI space that have large differential dynamic correlation, which means that their energetic separation at the CASCI level is wrong. The amount of mixing of those components in the CASCI states does then not match that encountered in the exact wavefunctions.

The method developed first, DCD-CAS(2), is inspired by an intermediate effective Hamiltonian (IEH) with a one-dimensional main model space, the generalized degenerate perturbation theory (GDPT).\cite{MalriDD_1985_809} This makes the effective Hamiltonian Hermitian by using a single main model space energy $E_0$ in the denominator, which is chosen as the ground-state CASSCF energy of the respective multiplicity block. DCD-CAS(2) is completely uncontracted, i.e. it does not use the CASCI roots in the definition of the 0th order Hamiltonian, which leads to the preservation of orbital degeneracies in contrast to the widely used contracted perturbation theories like CASPT2 and NEVPT2.
DCD-CAS(2) suffers from size-inconsistency
problems that we have thoroughly discussed and for which we suggested
suitable remedies. Using the CASSCF ground state energy in
the denominator introduces a bias toward the ground state that leads to overestimated excitation energies. We introduced the successful bias correction to remove this problem, of which the 1st order version was already shown to be sufficient in practice. Our numerical results show that the size-consistency and
bias issues can be efficiently alleviated for both ground and
excited state calculations by means of the combination of the difference-dedicated
scheme and bias correction. This results in a pragmatic two-step approach: first, obtain a stable, intruder-free ground state
and second, get good excitation energies by applying the bias
correction. This variant was therefore chosen as the default for DCD-CAS(2) calculations.
In general, DCD-CAS(2) provides results
close to NEVPT2 in cases where the 0th order CASSCF wavefunction is good and superior results
otherwise. Recently, first results from other groups appeared that used DCD-CAS(2) for their computational chemistry work.\cite{AndreABCA_2019_116577, KotrlH_2019_14046}

The DCD-CAS(2) method was also extended to include spin-dependent relativistic effects into the Hamiltonian. The method consists in the construction of an effective Hamiltonian that contains
static correlation, dynamic correlation, and relativistic effects on an
equal footing. Solving the eigenvalue problem of this Hamiltonian
yields energies that contain dynamic correlation and spin-dependent
effects and yields wavefunctions that are mixed with respect to the
CASCI ones under the combined effects of electron correlation and
relativity.
The spin-dependent operators considered in this work comprise everything that is necessary for the prediction of magnetic
properties and EPR parameters, namely, SOC, HFC, Zeeman interaction, and SSC. In order to be able to directly compare with experimentally determined quantities, we implemented EPR g-matrices,
A-matrices, and D-tensors and presented a novel way to find their principal values and decompose the
latter according to different physical contributions.
In the investigation of EPR parameters of square-planar Cu\textsuperscript{II} complexes, it was however found that the use of a single state-averaged Dyall Hamiltonian in DCD-CAS(2) is a severe limitation for the accuracy of the method, especially if states of different physical character (like ligand-field and charge transfer states) are described simultaneously.

This led to the development of the HQD-NEVPT2 method. It is based on a novel combination of multi-partitioning theory with canonical Van Vleck perturbation theory. At 2nd order, the nonrelativistic version of the method turns out to be an effective Hamiltonian that is simply the Hermitized version of the QD-NEVPT2 effective Hamiltonian. Spin-dependent effects are incorporated along the lines of the spin-dependent DCD-CAS(2) method.
Compared with DCD-CAS(2), the proposed method retains the advantage of a Hermitian effective Hamiltonian, which ensures that eigenvalues are real and makes a mapping to Hermitian model Hamiltonians, like the LFT Hamiltonian, possible. Due to the state-specific 0th order Hamiltonians used in its construction, the method is expected to perform better in cases where states with very different physical character are present in the CASCI space. Furthermore, it will be possible to apply it to much larger active spaces than DCD-CAS(2), essentially for all systems where state-specific NEVPT2 is applicable. One disadvantage of the new approach compared with DCD-CAS(2) is that it is not based on the IEH idea. This could possibly lead to intruder state problems when constructing an effective Hamiltonian including all roots of a very large CASCI space. In most cases where DCD-CAS(2) is applicable (due to the high computational cost when applying it to larger active spaces), e.g. if only the five metal $d$ orbitals are chosen active, it should however not pose any problems to treat the whole CASCI space as the model space within this method. In such cases an IEH treatment is often not necessary because there are no unphysical high energy roots in the CASCI space.

Our analysis showed that it is probably not possible to formulate a multi-partitioning theory that is exactly model space invariant, a desirable property of multistate methods that was introduced several years ago.\cite{Grano_2011_214113} Previously, it has been shown that non-invariant theories can lead to artifacts and irregularities. However, we demonstrated for the example of the same symmetry conical intersection of the allene molecule that the non-invariance of HQD-NEVPT2 is much less severe than that of theories like MS-CASPT2 or MCQDPT2. The small disadvantage of a not exactly invariant theory was shown to be outweighed by the possibility to use state-specific 0th order Hamiltonians.
\clearpage
\section{Applications}
The nonrelativistic DCD-CAS(2) method was shown to be successful in describing the avoided crossing between a neutral and ionic state in the LiF molecule, as well as for the description of magnetic exchange in exchange-coupled dimers. A big advantage of the method is the fact that it preserves orbital degeneracies. In the absence of strong state-mixing effects, the default version of DCD-CAS(2) was shown to give energies that are in close agreement with state-specific NEVPT2.

Tests of the spin-dependent DCD-CAS(2) method on
transition metal systems using a minimal active space containing
only metal $d$ orbitals showed only small effects of state mixing
and results that are mostly in agreement with the nondegenerate
NEVPT2/QDPT method. We also compared our new method with
other approaches for the prediction of EPR parameters of pseudo-square-planar Cu\textsuperscript{II} complexes, where it is well understood that
CASSCF and nondegenerate NEVPT2 give too large values due to
a ground state SOMO that has too little contribution from ligand
orbitals. The spin-dependent DCD-CAS(2) method was shown to
ameliorate this problem by effectively reducing the energy of the
LMCT configuration with respect to the ground state configuration under the effect of dynamic correlation. This leads to enhanced
mixing between the two, which corresponds to a rotation of the
ground state SOMO such that it becomes more covalent. However, we observed that this effect is too pronounced such that the values
of EPR parameters are overcorrected compared to results at the
CASSCF or NEVPT2 levels. In many cases, we observed values that
were quite similar to predictions by B3LYP. We found the reason for
this behavior of the DCD-CAS(2) method to be the use of a state-averaged 0th order Hamiltonian.

HQD-NEVPT2 was shown to perform well for the simultaneous treatment of ligand-field and charge transfer states, as shown for the calculation of the excitation energies of \CuCl\ in two different geometries. For this problem, the use of a state-averaged Dyall Hamiltonian leads to a drastic underestimation of the LMCT excitation energies. Furthermore, it was shown that it is advantageous to have a Hermitian effective Hamiltonian since the traditional non-Hermitian QD-NEVPT2 leads to the appearance of complex energy eigenvalues especially in cases of (near-)degeneracy.
Tests for the calculation of EPR parameters in the set of square-planar Cu\textsuperscript{II} complexes have shown that HQD-NEVPT2 leads to a better description of the covalency in the ground state, due to a more realistic description of the LMCT configuration that is included in the active space. This improves the results compared to the spin-dependent DCD-CAS(2) values. For SD and NOC contributions to HFCCs, the resulting values are still too low, and the surprising quality of CASSCF and NEVPT2 results indicates that there are some sizable errors due to the CAS-only wavefunction. However, the description of g-shifts with our new method is better than with any other method of similar computational cost that we are aware of. Hence, HQD-NEVPT2 is a promising candidate for the calculation of this property.

Finally, we introduced the DCD-CAS(2) and HQD-NEVPT2 effective Hamiltonians into \textit{ab initio} ligand field theory (AILFT).
We compared the new AILFT versions with the previous ones based on CASSCF and NEVPT2 for a diverse test set of transition metal complexes with metals from different periods and groups of the periodic table, different ligands, different coordination environments, and different oxidation states. Compared to NEVPT2, which is so far the standard choice for including the effects of dynamic correlation into AILFT, the multistate methods were shown to yield better fits of the ligand field model to the \textit{ab initio} effective Hamiltonians. For some systems (e.g. the octahedral Cr\textsuperscript{III} halide series), the better RMSD between the \textit{ab initio} energies and the energies predicted by the extracted LFT models led to better agreement between the AILFT energies and the experiment. 
An investigation of the LFT parameters for the whole test set showed that for the
multistate methods there is a clear trend for the ligand field splitting $\Delta$ of tetrahedral
and octahedral complexes to increase compared to NEVPT2. The Racah parameter $B$
usually decreases, while the value of $C$ (and therefore also the ratio $C/B$) increases. Since the agreement of the extracted model with the \textit{ab initio} effective Hamiltonians is better, these model parameters reflect more closely the
physical picture described by the \textit{ab initio} methods.
In order to understand the mechanism for the smaller RMSDs at the multistate levels, we
investigated in detail the case of the quartet states of the \CrF complex. We found that
after inclusion of dynamic correlation, there is a tendency to increase the ligand field
splitting $\Delta$, which can be interpreted in terms of increased metal-ligand covalence, and
to decrease at the same time the magnitude of the Racah parameter $B$. At the NEVPT2
level, these parameters cannot change independently from their CASSCF values since the
wavefunctions are required to stay the same. At the multistate level on the other hand,
the CASSCF wavefunctions can mix under the effect of dynamic correlation, which allows $\Delta$ and $B$ to vary independently. We think that a similar mechanism for the reduction of
RMSDs when going from NEVPT2 to the multistate methods is occurring for the whole
test set, i.e. that only after the possibility of state mixing the parameters $\Delta$ and $B$ are
independent of each other and can follow their individual preferences for change after
dynamic correlation. This could explain the general trends observed for the extracted LFT
parameters.

\section{Outlook}
Based on the results in this thesis, there are many interesting possible routes for future work.
We found that CASSCF and NEVPT2 perform
quite poorly for the prediction of g-shifts but give relatively decent
results for SD and NOC contributions to HFCCs. In contrast to that, the values at the HQD-NEVPT2 level, which was thought to provide a better description due to the better description of covalency, were too low. This shows
that fixing the problem of missing covalency in the CASSCF wavefunction is probably not sufficient in order to arrive at accurate results for these parameters, and the influence of dynamic
correlation on the wavefunction, beyond a rotation within the 0th
order CASCI space, cannot be neglected. 
In this respect, the further exploration of two-component correlated methods based on a scalar reference calculation seems to be a promising direction.\cite{WangGW_2008_64113}

Our AILFT results showed that methods that allow for state mixing can lead to better fits via
the LFT model. The accuracy was however limited by some systematic errors of the
perturbation theory methods. A natural extension would therefore be the use of more accurate electron correlation treatments that include state mixing, e.g. using the MR-EOM-CC method.\cite{DattaN_2012_204107, DemelDN_2013_134108, NooijDDKSLHN_2014_81102} This can potentially have the same benefits of a better fit between LFT model and \textit{ab initio} effective Hamiltonian as the new methods introduced in the present work, while not suffering from the limitations of low-order perturbation theory. A downside of this approach would be the much larger computational cost.

While many problems have been solved in the presented work, some are still left open. The two developed multistate perturbation theory methods DCD-CAS(2) and HQD-NEVPT2 have different advantages and disadvantages. DCD-CAS(2) is very flexible by using the complete CASCI space as a model space. Since it is based on the IEH concept, its lowest states are not affected by intruder states occurring for high-energy model space components. Another advantage is that it exactly preserves orbital degeneracies. Disadvantages of DCD-CAS(2) are its high computational cost for larger active spaces and deficiencies in the state-averaged Dyall Hamiltonian used in its construction. These problems are solved by HQD-NEVPT2, which improves the simultaneous description of states with very different physical character, due to the state-specific 0th order Hamiltonians used in its construction. However, it acts in a model space of manually chosen CASCI roots, which limits its flexibility and generality. Furthermore, it was shown in this work that the multi-partitioning concept cannot easily be reconciled with model space invariance, another desirable property. Therefore, HQD-NEVPT2 energies show artifacts around points of degeneracy and break orbital degeneracy, although it was demonstrated that this is much less severe than for other non-invariant theories like MS-CASPT2 and MCQDPT2. One should mention that it was previously found that a state-averaged Dyall Hamiltonian can be superior to a state-specific one also in other cases.\cite{PastoHELMMAC_2008_174102, PastoHAELC_2009_12} A method that is generally applicable to any multiconfigurational problem and that fulfills all desirable properties mentioned in this work while being applicable also to larger molecular systems does therefore still not exist.

An interesting alternative to the current work is the 0th order Hamiltonian suggested by Fink in the context of the ``retaining the excitation degree perturbation theory''.\cite{Fink_2006_461, Fink_2009_39} It consists of all terms of the Fock space Hamiltonian that leave the number of electrons in the different orbital subspaces (inactive, active, virtual) invariant. Therefore, it does not depend on the specific reference state under investigation. It is very close to the full electronic Hamiltonian but costly to evaluate since perturber CSFs with different non-active occupations can be coupled. Using a canonical MRPT implementation, it is only possible to use this 0th order Hamiltonian for small model systems. However, there has been interesting recent work that made the use of this 0th order Hamiltonian feasible by using MPS compression\cite{SharmJA_2016_34103}\cite{SharmA_2015_102815} or stochastic sampling.\cite{JeanmSA_2017_44107} A combination of these approaches with spin-dependent effects could be a promising route for future work.
Another alternative is the use of MRCC. Although successful variants have been developed in recent years, they are still usually limited to rather small systems. Also the complexity of these theories is very high, and they can only be implemented using automatic code generation.\cite{KoehnHMJG_2013_176} One could also think about including the effect of higher excitations by moving toward perturbation theory methods that are truncated at higher than 2nd order. The equations presented in this work for the multi-partitioning canonical Van Vleck perturbation theory lay the foundations for such further developments.

Many of the problems associated with finding better multireference methods probably stem from the desire to develop methods that can be applied to \emph{any} electronic state. However, the partitioning into single-configurational and multi-configurational states is a highly artificial one. By definition a multiconfigurational system is anything that is \emph{not} single-configurational. This includes examples like the ozone molecule,\cite{GlezaEXR_2010_8923} the Be atom,\cite{HeullD_1988_1046} excited states,\cite{RoosAF_1992_5} systems with multiple broken bonds, as well as many transition metal compounds. Therefore, methods that are supposed to be able to treat such diverse situations need great flexibility, and therefore are nowadays usually based on CASSCF reference calculations. A possible route for future work are methods that are not applicable to \emph{any} multiconfigurational situation but are tailored toward specific applications. Considering the success of single reference theory, it e.g. seems desirable to develop methods that can accurately treat the ground states of multiconfigurational transition metal complexes close to their equilibrium geometry, even if those methods do not allow for correct bond breaking. Such methods could for example be based on reference states that correspond to a single orbital configuration,\cite{LiP_1994_8812} instead of a whole CASSCF reference.
This would mean that some of the ``black box'' character that quantum chemical method developers often aim for is lost. Instead, the calculations need an \textit{a priori} idea of the electronic structure of the system under investigation, which could be provided by experimental insight. One should not forget that even for the highly successful single reference methods the user makes a biased assumption about the electronic structure of the system under investigation, namely that it can be described well by a single Slater determinant.
Therefore, experimental insight into the electronic structure of molecules will be necessary to guide our thinking and obtain meaningful results from computations for a long time to come.






\appendix
\chapter{Additional derivations and theoretical discussion}
\section{Proof that any one-electron operator can be written as a sum of singlet and triplet parts}
\label{Ap:proof_one_el_op}
The Hilbert space ${\mathcal{H}^{(1)}}$ of a single electron can be written as the tensor product of a spin space and a coordinate space,
	\begin{equation}
	{\mathcal{H}^{(1)}} = {\mathcal{H}^{\text{s}}} \otimes {\mathcal{H}^{\text{r}}}.
	\end{equation} 	
Here, ${\mathcal{H}^{\text{s}}}$ is isomorphic to the Hilbert space ${\mathbb{C}^2}$ of complex 2-component vectors and ${\mathcal{H}^{\text{r}}}$ is the space of square-integrable complex functions on the three-dimensional coordinate space. A complete basis for the operators on ${\mathcal{H}^{(1)}}$ is given by tensor products of basis operators of the spaces ${\mathcal{H}^{\text{s}}}$ and ${\mathcal{H}^{\text{r}}}$. Let ${s_i}$ ($i =$ 0 to 3) denote a set of basis functions for operators on spin space and ${o_i}$ an infinite set of basis functions for operators on coordinate space. Then an arbitrary operator $A$ acting on one-electron wavefunctions can be written as
	\begin{equation}
	A = \sum\limits_{ij} {{C_{ij}}} {s_i} \otimes {o_j} = \sum\limits_i {{s_i}}  \otimes \sum\limits_j {{C_{ij}}} {o_j}.
	\end{equation} 	
If one defines $a(i): = \sum\limits_j {{C_{ij}}} {o_j}$ and chooses as a basis in spin space the $2 \times 2$ identity matrix together with the irreducible spin operators ${s^{(m)}}$ ($m = 0, \pm 1$), this means that $A$ can be written
	\begin{equation}
	A = a + \sum\limits_{m = 0, \pm 1} a (m){s^{(m)}},
	\end{equation} 	
where $a$ and the $a(m)$ are pure spatial operators. The Fock-space version of the operator $A$ is then given by
	\begin{equation}
	A = \sum\limits_{pq} {{a_{pq}}} {E_{pq}} + \sum\limits_{m = 0, \pm 1} {\sum\limits_{pq} {{a_{pq}}} } (m)s_{pq}^{(m)}.
	\end{equation} 	
\section{Important Clebsch-Gordan coefficients}
\label{Sec:appendix_CGC}
\begin{align}
    \clebschgordan{S, S, 1, 0, S, S} &= \frac{S}{\sqrt{S(S+1)}}, \\
    \clebschgordan{S-1, S-1, 1, 1, S, S} &= 1, \\
    \clebschgordan{S+1, S+1, 1, -1, S, S} &= \sqrt{\frac{2S+1}{2S+3}}, \\
    \clebschgordan{S, S, 2, 0, S, S} &= \sqrt{\frac{S(2S-1)}{(S+1)(2S+3)}}, \\
    \clebschgordan{S-1, S-1, 2, 1, S, S} &= \sqrt{\frac{S-1}{S+1}}, \\
    \clebschgordan{S-2, S-2, 2, 2, S, S} &= 1, \\
    \clebschgordan{S+1, S+1, 2, -1, S, S} &= \sqrt{\frac{S(2S+1)}{(S+2)(2S+3)}}, \\
    \clebschgordan{S+2, S+2, 2, -2, S, S} &= \sqrt{\frac{2S+1}{2S+5}}.
\end{align}

\section{Derivation of the permutational relation}
\label{Ap:permrel}
The space of operators acting on the four-dimensional space of two coupled spin 1/2 systems is spanned by sixteen basis operators. Among these there are five quintet operators that have the form\cite{McWee_1965_1717}
	\begin{align}
	{S^{( + 2)}} &= \frac{1}{2}s_1^{( + )}s_2^{( + )}, \\
	{S^{( + 1)}} &=  - \frac{1}{2}(s_1^{( + )}s_2^{(z)} + s_1^{(z)}s_2^{( + )}), \\
	{S^{(0)}} &= \frac{1}{{\sqrt 6 }}(2s_1^{(z)}s_2^{(z)} - \frac{1}{2}(s_1^{( + )}s_2^{( - )} + s_1^{( - )}s_2^{( + )})), \\
	{S^{( - 1)}} &= \frac{1}{2}(s_1^{( - )}s_2^{(z)} + s_1^{(z)}s_2^{( - )}), \\
	{S^{( - 2)}} &= \frac{1}{2}s_1^{( - )}s_2^{( - )}.
	\end{align} 	
A good explanation of how to couple tensor operators of lower rank (here 1) to those of higher rank (here 2) can be found in the book by Boča.\cite{Boca_1999_} For our purposes it is useful to look at the matrix representation in the basis $\{ |\alpha \alpha \rangle ,|\alpha \beta \rangle ,|\beta \alpha \rangle ,|\beta \beta \rangle \} $:
	\begin{align}
	\label{Eq:repr_S2}
	{S^{( + 2)}} &= \left( {\begin{array}{*{20}{c}}
  0&0&0&{\frac{1}{2}} \\ 
  0&0&0&0 \\ 
  0&0&0&0 \\ 
  0&0&0&0 
\end{array}} \right), \\
	\label{Eq:repr_S1}
	{S^{( + 1)}} &= \left( {\begin{array}{*{20}{c}}
  0&{ - \frac{1}{4}}&{ - \frac{1}{4}}&0 \\ 
  0&0&0&{\frac{1}{4}} \\ 
  0&0&0&{\frac{1}{4}} \\ 
  0&0&0&0 
\end{array}} \right), \\
	\label{Eq:repr_S0}
	{S^{(0)}} &= \left( {\begin{array}{*{20}{c}}
  {\frac{1}{{2\sqrt 6 }}}&0&0&0 \\ 
  0&{ - \frac{1}{{2\sqrt 6 }}}&{ - \frac{1}{{2\sqrt 6 }}}&0 \\ 
  0&{ - \frac{1}{{2\sqrt 6 }}}&{ - \frac{1}{{2\sqrt 6 }}}&0 \\ 
  0&0&0&{\frac{1}{{2\sqrt 6 }}} 
\end{array}} \right), \\
	\label{Eq:repr_S-1}
	{S^{( - 1)}} &= \left( {\begin{array}{*{20}{c}}
  0&0&0&0 \\ 
  {\frac{1}{4}}&0&0&0 \\ 
  {\frac{1}{4}}&0&0&0 \\ 
  0&{ - \frac{1}{4}}&{ - \frac{1}{4}}&0 
\end{array}} \right), \\
	\label{Eq:repr_S-2}
	{S^{( - 2)}} &= \left( {\begin{array}{*{20}{c}}
  0&0&0&0 \\ 
  0&0&0&0 \\ 
  0&0&0&0 \\ 
  {\frac{1}{2}}&0&0&0 
\end{array}} \right).
\end{align} 	
We denote the Hermitian permutation operator for the two spins by the symbol $P$. Its matrix representation is given by
	\begin{equation}
	P = \left( {\begin{array}{*{20}{c}}
  1&0&0&0 \\ 
  0&0&1&0 \\ 
  0&1&0&0 \\ 
  0&0&0&1 
\end{array}} \right).
\end{equation} 	
One can see that for all five ${S^{(m)}}$ operators the 2nd and 3rd columns are identical, which means that there is the identity
	\begin{equation}
	{S^{(m)}} = {S^{(m)}}P.
	\end{equation} 	
From this follows
	\begin{equation}
	\label{Eq:symmetry_quintetop}
	S_{\sigma \tau \lambda \kappa }^{(m)} = \langle \sigma \tau |{S^{(m)}}|\lambda \kappa \rangle  = \langle \sigma \tau |{S^{(m)}}P|\lambda \kappa \rangle  = \langle \sigma \tau |{S^{(m)}}|\kappa \lambda \rangle  = S_{\sigma \tau \kappa \lambda }^{(m)},
	\end{equation} 	
so the quintet double excitation operators fulfill the permutational relation
	\begin{equation}
	S_{pqrs}^{(m)} = \sum\limits_{\sigma \tau \lambda \kappa } {S_{\sigma \tau \lambda \kappa }^{(m)}} a_{p\sigma }^\dag a_{q\tau }^\dag {a_{s\kappa }}{a_{r\lambda }} =  - \sum\limits_{\sigma \tau \lambda \kappa } {S_{\sigma \tau \kappa \lambda }^{(m)}} a_{p\sigma }^\dag a_{q\tau }^\dag {a_{r\lambda }}{a_{s\kappa }} =  - S_{pqsr}^{(m)}.
	\end{equation} 	
Here we used Eq. (\ref{Eq:symmetry_quintetop}) and anticommuted the two annihilation operators. Analogously, one can conclude that ${S^{(m)}} = P{S^{(m)}}$ because the 2nd and 3rd \emph{row} in any of the ${S^{(m)}}$ operators is identical. Hence, $S_{\sigma \tau \lambda \kappa }^{(m)} = S_{\tau \sigma \lambda \kappa }^{(m)}$, which leads to the second permutational relation
	\begin{equation}
	S_{pqrs}^{(m)} =  - S_{qprs}^{(m)},
	\end{equation} 	
where we have this time anticommuted the \emph{creation} operators. This concludes the proof of Eq. (\ref{Eq:perm_rel}).
\section{Vanishing contribution of closed shells}
\label{Ap:closedshells}
If the matrix representations of the ${S^{(m)}}$ operators (Eqs. (\ref{Eq:repr_S2}) to (\ref{Eq:repr_S-2})) are divided into four blocks of size $2 \times 2$ each, it can be checked by visual inspection that the diagonal elements of each of these $2 \times 2$ blocks have opposite sign (or are zero). We can express this in the form of the equation
	\begin{equation}
	S_{\sigma \alpha \lambda \alpha }^{(m)} =  - S_{\sigma \beta \lambda \beta }^{(m)},
	\end{equation} 	
which is true for any $m$ and spin labels $\sigma ,\lambda $ and can be rewritten as
	\begin{equation}
	\label{Eq:aux_relation_closedshells}
	\sum\limits_\tau  {S_{\sigma \tau \lambda \tau }^{(m)}}  = 0.
	\end{equation} 	
Now, let $|{\Phi _{r\bar r}}\rangle $ be a state in which spatial orbital $r$ is doubly occupied and let $p,q$ be two orbitals that are different from $r$. Then
	\begin{equation}
	S_{prqr}^{(m)}|{\Phi _{r\bar r}}\rangle  = \sum\limits_{\sigma \tau \lambda \kappa } {S_{\sigma \tau \lambda \kappa }^{(m)}} a_{p\sigma }^\dag a_{r\tau }^\dag {a_{r\kappa }}{a_{q\lambda }}|{\Phi _{r\bar r}}\rangle  = \sum\limits_{\sigma \tau \lambda \kappa } {S_{\sigma \tau \lambda \kappa }^{(m)}} a_{p\sigma }^\dag {a_{q\lambda }}a_{r\tau }^\dag {a_{r\kappa }}|{\Phi _{r\bar r}}\rangle. 
	\end{equation} 	
Here, it is used that $q$ and $r$ are unequal in order to anticommute the annihilator past the creator. Using
	\begin{equation}
	a_{r\tau }^\dag {a_{r\kappa }}|{\Phi _{r\bar r}}\rangle  = {\delta _{\tau \kappa }}|{\Phi _{r\bar r}}\rangle, 
	\end{equation} 	
we arrive at
	\begin{equation}
	S_{prqr}^{(m)}|{\Phi _{r\bar r}}\rangle  = \sum\limits_{\sigma \lambda } {\left( {\sum\limits_\tau  {S_{\sigma \tau \lambda \tau }^{(m)}} } \right)} a_{p\sigma }^\dag {a_{q\lambda }}|{\Phi _{r\bar r}}\rangle  = 0,
	\end{equation} 	
which is zero because of Eq. (\ref{Eq:aux_relation_closedshells}). By using the permutational relation, it also follows that
	\begin{equation}
	S_{rprq}^{(m)}|{\Phi _{r\bar r}}\rangle  = 0.
	\end{equation} 	
\section{Single determinant orbitals}
\label{Ap:SDOs}
For an active space with $2m - 1$ electrons in $m$ orbitals (i.e. one hole in the active orbital space), each CSF (we choose the principal component with $M = S = 1/2$) is associated with exactly one hole in a certain active orbital $t$, i.e. it can be written
	\begin{equation}
	|{\Phi _t}\rangle  = {a_{t\beta }}|{\text{full}}\rangle, 
	\end{equation} 	
where $|{\text{full}}\rangle $ is the closed-shell Slater determinant that has all active orbitals doubly occupied. Both CASCI or DCD-CAS(2) states $|{\Psi _I}\rangle $ are defined via a unitary transformation of those CSFs, i.e.
	\begin{equation}
	|{\Psi _I}\rangle  = \sum\limits_t | {\Phi _t}\rangle {C_{tI}} = {\tilde a_{I\beta }}|{\text{full}}\rangle 
	\end{equation} 	
with
	\begin{equation}
	{\tilde a_{I\beta }} = \sum\limits_t {{a_{t\beta }}} {C_{tI}}.
	\end{equation} 	
These are annihilators for a unitarily rotated set of active orbitals
	\begin{equation}
	{\tilde \psi _I} = \sum\limits_t {C_{It}^{ - 1}} {\psi _t}.
	\end{equation} 	
The determinant $|{\text{full}}\rangle $ is invariant under this unitary transformation of orbitals. Hence the states $|{\Psi _I}\rangle $ are single Slater determinants, with all active orbitals doubly occupied except for ${\tilde \psi _I}$, which is singly occupied. We therefore call this new choice of active orbitals \emph{single-determinant orbitals} (SDOs). We note that the set of SDOs is also the unique set of simultaneous natural orbitals for all the states $|{\Psi _I}\rangle $. The idea of SDOs has been discussed for the first time (without giving it this name yet) in the supplementary material of our previous work on the DCD-CAS(2) method.\cite{PathaLN_2017_234109}

\section{Auxiliary result for the diagonalization of the Dyall Hamiltonian}
\label{Ap:DiagDyallAux}
For a given total spin $S$, we use a counting index $K$ for all the different perturber CSFs $|\Phi^l_{K}\rangle$ from the space $S_l^{(k)}$. Such a CSF has well-defined occupation numbers, both in the set of non-active orbitals and in the set of active orbitals. $l$ is a label that denotes collectively the non-active occupation numbers. Let furthermore $l_\text{act}(K)$ be a label that denotes the active occupation numbers of the CSF $K$. Let $|\Phi_\mu^l\rangle$ be the full set of Slater determinants with non-active occupation $l$ and having empty active orbitals, while $|\Phi_\nu^{l_\text{act}(K)}\rangle$ is the full set of Slater determinants with active occupation numbers $l_\text{act}(K)$ and having all non-active orbitals empty. There are $2^N$ such Slater determinants if there are $N$ SOMOs among the occupation numbers $l$ or $l_\text{act}$. The full set of the antisymmetrized products (tensor products) $|\Phi_\mu^l\otimes\Phi_\nu^{l_\text{act}(K)}\rangle$ forms a complete basis for any state that is characterized by the occupation numbers $l$ and $l_\text{act}(K)$. One can therefore write
\begin{equation}
\label{Eq:expansion_CSF}
|\Phi^l_{K}\rangle = \sum_{\mu\nu} C_{\mu\nu}^K |\Phi_\mu^l \otimes \Phi_\nu^{l_\text{act}(K)}\rangle = \sum_\mu |\Phi_\mu^l \otimes \Psi_{K, \mu}\rangle
\end{equation}
with
\begin{equation}
|\Psi_{K, \mu}\rangle = \sum_\nu C_{\mu\nu}^K |\Phi_\nu^{l_\text{act}(K)}\rangle.
\end{equation}
This result is similar to the Schmidt decomposition.
Since the active part of the Dyall Hamiltonian acts only on the active part of the wavefunction, one has
\begin{equation}
\langle \Phi^l_K | H_\text{act}^\text{Dyall}|\Phi^l_L\rangle = \sum_{\mu\mu'} \langle \Phi^l_\mu | \Phi^l_{\mu'}\rangle \langle \Psi_{K,\mu} | H_\text{act}^\text{Dyall}|\Psi_{L,\mu'}\rangle = \sum_\mu \langle \Psi_{K,\mu} | H_\text{act}^\text{Dyall}|\Psi_{L,\mu}\rangle,
\end{equation}
which is Eq. (\ref{Eq:HDyallact_ME}).
Here we used that the determinants $|\Phi_\mu^l\rangle$ are orthonormal.
\section{Nature of the eigenfunctions of the canonical Van Vleck effective Hamiltonian}
\label{Ap:CVV_IN}
Let (I) and (C) denote objects in the intermediate normalization or canonical Van Vleck formalism, respectively. We start by showing that the operator $U_\text{(I)}^\dag {U_\text{(I)}}$ is positive definite. It is obviously Hermitian, which means that there exists an orthonormal basis $\{ |\alpha \rangle \} $ of eigenstates. The corresponding eigenvalues
	\begin{equation}
	\alpha  = \langle \alpha |U_\text{(I)}^\dag {U_\text{(I)}}|\alpha \rangle  = ||{U_\text{(I)}}|\alpha\rangle |{|^2} > 0
	\end{equation} 	
must be positive, since ${U_\text{(I)}}$ is assumed to be invertible, which is only possible if ${U_\text{(I)}}|\alpha \rangle  \ne 0$. Hence, we conclude that $U_\text{(I)}^\dag {U_\text{(I)}}$ is positive definite. This is important since it means that its inverse, square root, and inverse square root all exist.

We can write an exact eigenstate of the Hamiltonian that is modeled by the chosen model space as
\begin{equation}
|\Psi_I\rangle = U_\text{(I)} |\tilde{\Psi}_I^\text{(I)}\rangle = U_\text{(C)} |\tilde{\Psi}_I^\text{(C)}\rangle.
\end{equation}
Then Eq. (\ref{Eq:relation_CVV_IN}) immediately leads to
	\begin{equation}
	\label{Eq:old54}
	|\tilde \Psi _I^\text{(C)}\rangle  = U_\text{(C)}^{-1}{U_\text{(I)}}|\tilde \Psi_I^\text{(I)}\rangle = {(U_\text{(I)}^\dag {U_\text{(I)}})^{1/2}}|\tilde \Psi _I^\text{(I)}\rangle. 
	\end{equation} 	

Since $(U_\text{(I)})_X$ is anti-Hermitian, one has $U_\text{(I)} = 1 + (U_\text{(I)})_X$ and $U_\text{(I)}^\dagger = 1 - (U_\text{(I)})_X$ and therefore $U_\text{(I)}^\dag U_\text{(I)} = 1 - (U_\text{(I)})_X^2$. This shows that $U_\text{(I)}^\dag U_\text{(I)}$ is also block diagonal. One can therefore write
	\begin{equation}
	\label{Eq:old56}
	\begin{gathered}
  U_\text{(I)}^\dag U_\text{(I)}|\tilde \Psi _I^\text{(I)}\rangle  = PU_\text{(I)}^\dag U_\text{(I)}|\tilde \Psi _I^\text{(I)}\rangle  = \sum\limits_J {|\tilde \Psi _J^\text{(I)}{\rangle ^D}\langle } \tilde \Psi _J^\text{(I)}|U_\text{(I)}^\dag U_\text{(I)}|\tilde \Psi _I^\text{(I)}\rangle  \hfill \\
   = \sum\limits_J {|\tilde \Psi _J^\text{(I)}{\rangle ^D}\langle } {\Psi _J}|{\Psi _I}\rangle  = \sum\limits_J {|\tilde \Psi _J^\text{(I)}{\rangle ^D}{\delta _{JI}} = } |\tilde \Psi _I^\text{(I)}{\rangle ^D}. 
\end{gathered} 
\end{equation} 	
Here $|\tilde \Psi _I^\text{(I)}{\rangle ^D}$ is the dual (contravariant) state with respect to $|\tilde \Psi _I^\text{(I)}\rangle$, which can be expressed as
	\begin{equation}
	\label{Eq:old57}
	|\tilde \Psi _I^\text{(I)}{\rangle ^D} = \sum\limits_J {|\tilde \Psi _J^\text{(I)}\rangle S_{JI}^{ - 1}} 
	\end{equation} 	
with the overlap matrix ${S_{JI}} = \langle \tilde \Psi _J^\text{(I)}|\tilde \Psi _I^\text{(I)}\rangle $. Combining Eqs. (\ref{Eq:old54}), (\ref{Eq:old56}) and (\ref{Eq:old57}), one obtains Eq. (\ref{Eq:CVV_eigenstates}), i.e. the $|\tilde{\Psi}_I^\text{(C)}\rangle$ are given by Löwdin symmetrical orthonormalization of the states $|\tilde{\Psi}_I^\text{(I)}\rangle$.

\section{Antilinear operators, complex conjugation, time reversal, and Kramers symmetry}
This section is mainly based on the book by Abragam and Bleaney.\cite{AbragB_2012_} Apart from the content found there, our own observations are added to the discussion in a few occasions.
\subsection{Antilinear and antiunitary operators}
An antilinear operator $A$ on Hilbert space is an operator that fulfills
\begin{equation}
A(\alpha|\Psi\rangle + \beta|\Phi\rangle) = \alpha^\ast A|\Psi\rangle + \beta^\ast A|\Phi\rangle.
\end{equation}
Most operators encountered in quantum mechanics are linear operators. From their theory, one is used to the fact that they can also act to the left on bra states. This does not make sense for antilinear operators. For example, the expression $\langle \Phi|A$, where $A$ is an antilinear operator, is obviously an \emph{antilinear} functional on Hilbert space. Hence, it is clear that it cannot be written as a single bra state, since any bra is a \emph{linear} functional. When encountering matrix elements like $\langle \Phi|A|\Psi\rangle$, one should therefore remember that $A$ is only defined for operation to the right. To avoid pitfalls, it makes sense to consider this in the notation and write $\langle \Phi|A\Psi\rangle$. It is also a useful fact that the product of two antilinear operators is linear and the product of a linear and an antilinear operator is antilinear.

The adjoint $A^\dagger$ of an antilinear operator $A$ is defined such that for arbitrary states $|\Phi\rangle$ and $|\Psi\rangle$ one has
\begin{equation}
\langle \Phi|A\Psi\rangle = \langle A^\dagger\Phi|\Psi\rangle^\ast = \langle \Psi|A^\dagger \Phi\rangle.
\end{equation}
An antilinear operator $A$ is called antiunitary if it fulfills for arbitrary states $|\Phi\rangle$ and $|\Psi\rangle$ the relation
\begin{equation}
\langle A\Phi|A\Psi\rangle = \langle \Phi|\Psi\rangle^\ast,
\end{equation}
which is equivalent to
\begin{equation}
AA^\dagger = A^\dagger A = 1.
\end{equation}
The latter relation is identical to that fulfilled by linear operators that are unitary.

\subsection{Complex conjugation}
\label{Sec:ComplexConjugation}
Given a certain orthonormal basis $\{|a\rangle\}$ of Hilbert space, the \emph{complex conjugation operator} $K_a$ with respect to this basis is defined to be the antilinear operator which maps any basis vector $|a\rangle$ to itself, i.e.
\begin{equation}
K_a |a\rangle = |a\rangle.
\end{equation}
For an arbitrary Hilbert space state $|\Psi\rangle$ with basis set expansion $|\Psi\rangle = \sum_a C_a |a\rangle$, one then gets
\begin{equation}
K_a |\Psi\rangle = \sum_a C_a^\ast |a\rangle
\end{equation}
by extension.
In other words, the operator $K_a$ maps any state to the one which has complex-conjugated coefficients when represented in the basis $\{|a\rangle\}$.
The most common one-electron basis is that formed by simultaneous eigenstates of the position and $s_z$ operator, $|\mathbf{r}, m_s\rangle$. When talking about the complex conjugation operator in the following, we will always implicitly mean complex conjugation with respect to this basis. We will therefore drop the label and simply write $K$.
One should also mention that the complex conjugation operator is not only antilinear but also antiunitary, i.e. one has
\begin{equation}
K^\dagger = K = K^{-1}.
\end{equation}

Equipped with the definition of the complex conjugation operator, one can also rigorously define what is meant with the complex conjugate $|\Psi\rangle^\ast$ of a state $|\Psi\rangle$, namely
\begin{equation}
|\Psi\rangle^\ast = K |\Psi\rangle.
\end{equation}
This means that the complex-conjugate of an electronic 1-particle state has a 2-com\-po\-nent wavefunction (representation in the $|\mathbf{r}, m_s\rangle$ basis) that is simply the complex conjugate of the wavefunction of the original state. We define the complex conjugate of an operator $A$ as
\begin{equation}
A^\ast = K A K.
\end{equation}
In analogy to numbers, one calls states and operators real if
\begin{equation}
|\Psi\rangle^\ast = |\Psi\rangle,
\end{equation}
\begin{equation}
A^\ast = A
\end{equation} 
and one calls them purely imaginary if
\begin{equation}
|\Psi\rangle^\ast = -|\Psi\rangle,
\end{equation}
\begin{equation}
A^\ast = -A.
\end{equation}

A useful property of real Hermitian operators $H$ is that their eigenstates can be chosen real. The reason for this is sketched in the following. Let $|\Psi\rangle$ be an eigenstate of a real Hamiltonian. Then also $|\Psi\rangle^\ast$ is an eigenstate with the same energy. One can distinguish two cases. If $|\Psi\rangle$ and $|\Psi\rangle^\ast$ are linearly dependent, their linear combination $|\Psi\rangle+|\Psi\rangle^\ast$ is real and is also an eigenstate with the same energy. If they are linearly independent, one can construct the two linearly independent real states $|\Psi\rangle+|\Psi\rangle^\ast$ and $\frac{1}{i}(|\Psi\rangle-|\Psi\rangle^\ast)$.

\subsection{Time reversal}
\label{Sec:TimeReversal}
Time reversal is an operation that transforms any quantum state into a state that has all momenta and angular momenta (including spin) reversed. Since this represents a ``symmetry operator'' according to Wigner (meaning that it leaves transition probabilities between states unchanged), the operator can only be represented by a unitary or antiunitary operator on Hilbert space. This is called Wigner's theorem. One can conclude by simple arguments that only the 2nd option leads to physically meaningful results, i.e. time reversal must be represented by an antiunitary operator.\cite{AbragB_2012_}\cite{Weinb_1995_} Since the product of two antiunitary operators is a unitary operator, it is clear that one can pick an arbitrary antiunitary operator and that time reversal can be written as a product of this operator and a unitary operator. In practice this auxiliary antiunitary operator is usually chosen as the complex conjugation operator $K$ defined above. For a single electron, one can then show that the unitary operator is given by a 180° rotation in spin space around the $y$-axis, such that one has
\begin{equation}
\theta = K \exp(-i\pi s_y).
\end{equation}
On the many-electron Hilbert space, the time reversal operator is simply defined as the tensor product of the time reversal operators on the one-electron Hilbert spaces, i.e.
\begin{equation}
\theta = \bigotimes_n \theta_n = K\exp(-i\pi S_y),
\end{equation}
where now $K=K_1\otimes \dots K_N$ is the complex conjugation operator with respect to the many-electron space-spin standard basis and $S_y$ is the $y$-component of the total spin operator. Given an electronic state $|\Psi\rangle$, one defines the \emph{Kramers conjugate} $|\bar\Psi\rangle$ to be the state that results from action of the time reversal operator, i.e.
\begin{equation}
|\bar\Psi\rangle = \theta |\Psi\rangle.
\end{equation}
One calls a linear operator $A$ even or odd under time-reversal if
\begin{equation}
\theta A \theta^\dagger = \theta^\dagger A \theta = \pm A^\dagger.
\end{equation}
Examples for odd operators are the momentum as well as spin and orbital angular momentum operators.
One can easily show that a time-odd operator $A$ has opposite expectation values for a given state and its Kramers conjugate,
\begin{equation}
\langle \bar\Psi|A|\bar\Psi\rangle = \langle \Psi|\theta^\dagger A \theta \Psi\rangle^\ast = - \langle \Psi|A^\dagger|\Psi\rangle^\ast = - \langle \Psi | A | \Psi\rangle.
\end{equation}

\subsection{Kramers theorem}
\label{Sec:Kramers}
Consider a system where the number of electrons $N$ is odd. The operator $\text{exp}(-i\pi S_y)$ is real and therefore one has
\begin{equation}
\label{Eq:theta_squared}
\theta^2 = \text{exp}(-2\pi i S_y) = \bigotimes_n \text{exp}(-2\pi i s_{yn}) = \bigotimes_n (-1) = -1.
\end{equation}
Here we used that a 360$^\circ$ spin rotation changes the sign of a one-electron wavefunction and that there is an odd number of terms in the tensor product in Eq. (\ref{Eq:theta_squared}).
The overlap of a state and its Kramers conjugate is then given by
\begin{equation}
\langle \Psi|\bar\Psi\rangle = \langle \Psi|\theta \Psi\rangle = \langle\theta \Psi | \theta^2\Psi\rangle^\ast = - \langle \Psi|\bar\Psi\rangle.
\end{equation}
This shows that any state is orthogonal to its Kramers conjugate for systems with an odd number of electrons. If $|\Psi\rangle$ is an eigenstate of a time-reversal-invariant Hamiltonian $H$ (i.e. $\theta^\dagger H \theta = H$),
\begin{equation}
H|\Psi\rangle = E|\Psi\rangle,
\end{equation}
then obviously also
\begin{equation}
H|\bar\Psi\rangle = E|\bar\Psi\rangle.
\end{equation}
The Hamiltonian is always time-reversal-invariant in the absence of external magnetic fields.
This shows the famous Kramers theorem: For a system with an odd number of electrons, the degeneracy of each energy eigenvalue is even in the absence of magnetic fields. In the simplest case where there is no other symmetry, the degeneracy of each level is twofold and one calls the pairs of degenerate states Kramers doublets.

\section{Representatives of orbitally degenerate quartet states of octahedral $d^3$ complexes}
\label{Sec:appendix_4T1g_D4hanalysis}
It is possible to investigate an octahedral system in the $D_{4h}$ subgroup. In this case $xz,yz$ belong to the $E_g$, $xy$ to the $B_{2g}$, $z^2$ to the $A_{1g}$, and $x^2-y^2$ to the $B_{1g}$ irreducible representations. A state that has a half-filled $E_g$ shell, i.e. both the $xz$ and the $yz$ orbital singly occupied with a spin-up electron, has symmetry $A_{2g}$. The ground state, with $xy$, $xz$, and $yz$ singly occupied, therefore has ${A_{2g}} \otimes {B_{2g}} = {B_{1g}}$ symmetry. The singly excited Slater determinants have the following symmetries:
\begin{itemize}
\item	$xy \rightarrow z^2$: ${A_{2g}} \otimes {A_{1g}} = {A_{2g}}$ 
\item	$xy \rightarrow x^2-y^2$: ${A_{2g}} \otimes {B_{1g}} = {B_{2g}}$
\item	$xz/yz \rightarrow z^2$: ${E_g} \otimes {B_{2g}} \otimes {A_{1g}} = {E_g}$
\item	$xz/yz \rightarrow x^2-y^2$: ${E_g} \otimes {B_{2g}} \otimes {B_{1g}} = {E_g}$
\end{itemize}
The doubly excited Slater determinants have the following symmetries:
\begin{itemize}
\item	$xz,yz \rightarrow z^2,x^2-y^2$: ${B_{2g}} \otimes {A_{1g}} \otimes {B_{1g}} = {A_{2g}}$
\item	$xz/yz,xy \rightarrow z^2, x^2-y^2$: ${E_g} \otimes {A_{1g}} \otimes {B_{1g}} = {E_g}$
\end{itemize}
The irreducible representations of $O_h$ transform in the $D_{4h}$ subgroup as
\begin{itemize}
\item	$A_{2g}$: $B_{1g}$
\item	$T_{1g}$: ${A_{2g}} \oplus {E_g}$
\item	$T_{2g}$: ${B_{2g}} \oplus {E_g}$
\end{itemize}
One can see that this is in accordance with the above results and that the $xy\rightarrow x^2-y^2$ excited Slater determinant is one component of the $^4T_{2g}$ excited level, while the $xy\rightarrow z^2$ and $xz,yz\rightarrow z^2,x^2-y^2$ excited Slater determinants will mix to form one component of each of the two excited $^4T_{1g}$ levels.

\section{Derivation of $\Delta/B$ in terms of $^4T_{1g}$ coefficients}
\label{Sec:appendix_derivationDeltaoverB}
An arbitrary real $2 \times 2$ Hermitian matrix can be written
	\begin{equation}
	{\mathbf{H}} = {E_0}{\mathbf{I}} + \left( {\begin{array}{*{20}{c}}
  { - \Delta E/2}&V \\ 
  V&{\Delta E/2} 
\end{array}} \right),
\end{equation}
where ${E_0}$ is a constant shift that does not influence the eigenvectors, ${\mathbf{I}}$ is the $2 \times 2$ identity matrix, $\Delta E$ is the difference between the diagonal elements, and $V$ is the off-diagonal coupling matrix element. Diagonalizing ${\mathbf{H}}$, i.e. solving its eigenvalue equation, leads to two solutions with energies
	\begin{equation}
	{E_ \pm } =  \pm \frac{1}{2}\sqrt {{{(\Delta E)}^2} + 4{V^2}} .
	\end{equation}
The eigenvector belonging to the lower-energy solution ${E_ - }$ can be written as
	\begin{equation}
	\left( {\begin{array}{*{20}{c}}
  {{C_1}} \\ 
  {{C_2}} 
\end{array}} \right) = N\left( {\begin{array}{*{20}{c}}
  { - (\Delta E/V + \sqrt {{{(\Delta E/V)}^2} + 4} )/2} \\ 
  1 
\end{array}} \right),
\end{equation}
where $N$ is an arbitrary normalization constant. This means that
	\begin{equation}
	 - (\Delta E/V + \sqrt {{{(\Delta E/V)}^2} + 4} )/2 = {C_1}/{C_2}.
	 \end{equation}
Solving this equation for $\Delta E/V$ gives
	\begin{equation}
	\label{Eq:DeltaoverB_auxiliary}
	\frac{{\Delta E}}{V} = \frac{{{C_2}}}{{{C_1}}} - \frac{{{C_1}}}{{{C_2}}}.
	\end{equation}
For the $2 \times 2$ $^4T_{1g}$ block of the LFT Hamiltonian of an octahedral $d^3$ complex (see Eq. (\ref{Eq:LFTmodel})), one has
	\begin{equation}
	\frac{{\Delta E}}{V} = \frac{{\Delta  - 9B}}{{6B}} = \frac{{\Delta /B - 9}}{6},
	\end{equation}
which leads, combined with Eq. (\ref{Eq:DeltaoverB_auxiliary}), to Eq. (\ref{Eq:DeltaoverB}),
	\begin{equation}
	\frac{\Delta }{B} = 6\frac{{\Delta E}}{V} + 9 = 6\left( {\frac{{{C_2}}}{{{C_1}}} - \frac{{{C_1}}}{{{C_2}}}} \right) + 9.
	\end{equation}
	
\section{Derivation of spin Hamiltonian parameters using DPT}
\label{Sec:appendix_DPT_SH}
\subsection{g-matrix}
We start with the derivation of the g-matrix. There is a 1st order contribution coming from the spin Zeeman interaction,
\begin{equation}
H_\text{Zeeman}^\text{spin} = \mu_B g_e \mathbf{B}\cdot \mathbf{S}.
\end{equation}
This is apparently already in the form of the spin Hamiltonian in Eq. (\ref{Eq:SpinHamilIntrinsic}) and leads to a contribution to the g-matrix given in Eq. (\ref{Eq:g_spin}). Apart from that, there is a 2nd order contribution coming from the orbital Zeeman interaction,
\begin{equation}
H_\text{Zeeman}^\text{orb} = \mu_B \mathbf{B} \cdot \mathbf{L}
\end{equation}
and the SOC operator $H_\text{SOC}$. We assume that the SOC operator is in the form of an effective one-particle operator, like the SOMF operator Eq. (\ref{Eq:HSOMF}) or the effective nuclear charge SOC operator.\cite{KosekGSM_1995_12764} Inserting these operators into Eq. (\ref{Eq:SH_DPT2_Heff}), the contribution of the effective Hamiltonian is given by
\begin{equation}
\label{Eq:SH_Heff_contribution}
- \sum_{b\neq 0, M_b} \Delta_b^{-1}[\langle \Psi_0^{SM}|H_\text{Zeeman}^\text{orb}|\Psi_b^{S_b M_b}\rangle \langle \Psi_b^{S_b M_b}| H_\text{SOC} | \Psi_0^{SM'}\rangle + \text{c.c.}].
\end{equation}
Since the orbital Zeeman operator is a singlet operator, it cannot couple different total spins or $M_S$ sublevels. Hence, the matrix element is given by
\begin{equation}
\label{Eq:Matrixel_orbZeeman}
\langle \Psi_0^{SM}|H_\text{Zeeman}^\text{orb}|\Psi_b^{S_b M_b}\rangle = \delta_{SS_b} \delta_{MM_b} \mu_B \mathbf{B} \cdot \langle \Psi_0^{SS}|\mathbf{L}|\Psi_b^{SS}\rangle.
\end{equation}
The matrix element of the SOC operator is given by (already including the restrictions imposed by the Kronecker deltas in the previous expression)
\begin{equation}
\label{Eq:Matrixel_SOC}
\begin{aligned}
\langle \Psi_b^{SM}|H_\text{SOC}|\Psi_0^{SM'}\rangle &= \sum_{m=0, \pm 1} \langle \Psi_b^{SM}|H_\text{SOC}^{(m)}(m)|\Psi_0^{SM'}\rangle \\
&= \frac{1}{S} \sum_{m=0, \pm 1} \langle SM|S^m|SM'\rangle\langle \Psi_b^{SS}|H_\text{SOC}^{(0)}(m)|\Psi_0^{SS}\rangle \\
&= \frac{1}{S} \sum_{l=1}^3 \langle SM|S^l|SM'\rangle\langle \Psi_b^{SS}|H_\text{SOC}^{(0)}(l)|\Psi_0^{SS}\rangle.
\end{aligned}
\end{equation}
Here we first wrote the SOC operator as a sum over spherical spin tensor components (see Eq. (\ref{Eq:triplet_op})), then applied the Wigner Eckart replacement theorem,\cite{McWee_1992_} and finally switched back from spherical to Cartesian components.
Using Eqs. (\ref{Eq:Matrixel_orbZeeman}) and (\ref{Eq:Matrixel_SOC}), one sees that Eq. (\ref{Eq:SH_Heff_contribution}) assumes the form of the SH in Eq. (\ref{Eq:SpinHamilIntrinsic}) with the corresponding contribution to the g-matrix given by Eq. (\ref{Eq:g_orb_SOC}).

\subsection{A-matrix}
There are two 1st order contributions to the effective Hamiltonian that come from the FC and SD contributions to the hyperfine interaction operator,
\begin{align}
H_\text{HFC}^\text{FC} &= \alpha^2 \frac{g_e}{2}\frac{8\pi}{3}\sum_A \gamma^A \mathbf{I}^A \cdot \sum_i \delta^3(\mathbf{r}_{iA})\mathbf{s}_i, \\
H_\text{HFC}^\text{SD} &= \alpha^2 \frac{g_e}{2}\sum_A \gamma^A \mathbf{I}^A \cdot \sum_i \frac{3\mathbf{r}_{iA}(\mathbf{s}_i\cdot \mathbf{r}_{iA}) - r_{iA}^2 \mathbf{s}_i}{r_{iA}^5}.
\end{align}
Both operators are triplet operators, like the SOC operator. In close analogy to Eq. (\ref{Eq:Matrixel_SOC}), one can therefore write the matrix elements of these operators as
\begin{equation}
\label{Eq:DPT_Heff_FCSD}
\langle \Psi_0^{SM}|H_\text{HFC}^\text{FC/SD}|\Psi_0^{SM'}\rangle = \frac{1}{S} \sum_{l=1}^3 \langle SM|S^l|SM'\rangle\langle \Psi_0^{SS}|H_\text{HFC}^{\text{FC/SD}(0)}(l)|\Psi_0^{SS}\rangle
\end{equation}
with
\begin{align}
H_\text{HFC}^{\text{FC}(0)}(l) &= \alpha^2 \frac{g_e}{2} \frac{8\pi}{3} \sum_A \gamma^A I^{A,l} \sum_i \delta^3(\mathbf{r}_{iA})s_i^z, \\
H_\text{HFC}^{\text{SD}(0)}(l) &= \alpha^2 \frac{g_e}{2} \sum_A \gamma^A \sum_k I^{A,k} \sum_i \frac{3r_{iA}^k r_{iA}^l - \delta_{kl} r_{iA}^2}{r_{iA}^5} s_i^z.
\end{align}
With this, Eq. (\ref{Eq:DPT_Heff_FCSD}) is clearly of the form of the SH Eq. (\ref{Eq:SpinHamilIntrinsic}) if the corresponding contributions to the A-matrix are defined as in Eqs. (\ref{Eq:DPT_AFC}) and (\ref{Eq:DPT_ASD}). Apart from these two contributions, there is a 2nd order contribution that is given by
\begin{equation}
\label{Eq:SH_Heff_NOC_SOC}
- \sum_{b\neq 0, M_b} \Delta_b^{-1}[\langle \Psi_0^{SM}|H_\text{HFC}^\text{NOC}|\Psi_b^{S_b M_b}\rangle \langle \Psi_b^{S_b M_b}| H_\text{SOC} | \Psi_0^{SM'}\rangle + \text{c.c.}]
\end{equation}
and arises from SOC and the NOC part of the HFC Hamiltonian,
\begin{equation}
H_\text{HFC}^\text{NOC} = \alpha^2 \sum_A \gamma^A \mathbf{I}^A \cdot \sum_i \frac{\mathbf{l}_i^A}{r_{iA}^3}.
\end{equation}
Like the orbital Zeeman operator, this is a singlet operator and its matrix elements are therefore given by
\begin{equation}
\label{Eq:Matrixel_NOC}
\langle \Psi_0^{SM}|H_\text{HFC}^\text{NOC}|\Psi_b^{S_b M_b}\rangle = \delta_{SS_b} \delta_{MM_b} \alpha^2 \sum_A \gamma^A \mathbf{I}^A \cdot \langle \Psi_0^{SS}|\sum_i \frac{\mathbf{l}_i^A}{r_{iA}^3}|\Psi_0^{SS}\rangle.
\end{equation}
Inserting this, together with Eq. (\ref{Eq:Matrixel_SOC}), into Eq. (\ref{Eq:SH_Heff_NOC_SOC}) shows that this contribution is also in the spin Hamiltonian form of Eq. (\ref{Eq:SpinHamilIntrinsic}), with the corresponding contribution to the A-matrix given by Eq. (\ref{Eq:DPT_ANOC_SOC}).

\subsection{Derivation of the 1st order contribution of direct electronic spin-spin coupling to the D-tensor}
\label{Sec:DtensorSSC}
Using the Wigner Eckart replacement theorem,\cite{McWee_1992_} one obtains
\begin{equation}
\langle \Psi_0^{SM}|H_\text{SSC}^{(m)}(m)|\Psi_0^{SM'}\rangle = \frac{\langle \Psi_0^{SS}|H_\text{SSC}^{(0)}(m)|\Psi_0^{SS}\rangle}{\langle SS|[\mathbf{S}\otimes \mathbf{S}]^2_0|SS\rangle}\langle SM|[\mathbf{S}\otimes \mathbf{S}]^2_m|SM'\rangle.
\end{equation}
The matrix element of the full SSC operator is then given by (after writing the dot product of 2nd rank tensors in terms of Cartesian instead of spherical components)
\begin{equation}
\langle \Psi_0^{SM}|H_\text{SSC}|\Psi_0^{SM'}\rangle = \sum_{K,L=1}^3\frac{\langle \Psi_0^{SS}|H_\text{SSC}^{(0)}(KL)|\Psi_0^{SS}\rangle}{\langle SS|[\mathbf{S}\otimes \mathbf{S}]^2_0|SS\rangle}\langle SM|S_K S_L|SM'\rangle.
\end{equation}
Using $[\mathbf{S}\otimes \mathbf{S}]^2_0 = \frac{1}{\sqrt{6}}(3S_z^2 - \mathbf{S}^2)$, the denominator can be shown to be
\begin{equation}
\langle SS|[\mathbf{S}\otimes \mathbf{S}]^2_0|SS\rangle = \frac{1}{\sqrt{6}}S(2S-1).
\end{equation}
Together with
\begin{equation}
H_\text{SSC}^{(0)}(KL) = - \frac{g_e^2 \alpha^2}{4} \sum_{i<j} \frac{3r_{ij}^K r_{ij}^L - \delta_{KL} r_{ij}^2}{r_{ij}^5}\frac{1}{\sqrt{6}}(2 s_i^z s_j^z - s_i^x s_j^x - s_i^ys_j^y)
\end{equation}
this gives the final result
\begin{equation}
\langle \Psi_0^{SM}|H_\text{SSC}|\Psi_0^{SM'}\rangle = \langle SM|\sum_{K,L=1}^3 D_{KL}S_K S_L|SM'\rangle
\end{equation}
with
\begin{equation}
D_{KL} = \frac{g_e^2}{4}\frac{\alpha^2}{S(2S-1)} \langle \Psi_0^{SS}|\sum_{i<j} \frac{\delta_{KL} r_{ij}^2 - 3 r_{ij}^K r_{ij}^L}{r_{ij}^5}(2s_i^z s_j^z - s_i^x s_j^x - s_i^y s_j^y) | \Psi_0^{SS}\rangle.
\end{equation}

\chapter{Additional numerical data}
\section{Comparison of nonrelativistic and relativistic DLPNO-CCSD Cu-HFCCs}
\label{Sec:appendix_nonrelvsrelHFCC}
A comparison of nonrelativistic and relativistic DLPNO-CCSD \textsuperscript{63}Cu HFCCs can be found in Table \ref{Tab:NonrelRelHFCC}.
\begin{table}
\small
\centering
\ttabbox
{\caption[Comparison of nonrelativistic and relativistic DLPNO-CCSD \textsuperscript{63}Cu HFCCs.]{Comparison of nonrelativistic and relativistic DLPNO-CCSD \textsuperscript{63}Cu HFCCs (in MHz). The relativistic calculation uses the DKH2 Hamiltonian and picture change effects as well as a finite nucleus model.}
\label{Tab:NonrelRelHFCC}}
{\input{Tables/NonrelRelHFCC.tex}
}
\end{table} 

\section{Relativistic g-shifts for square-planar Cu\textsuperscript{II} complexes}
\label{Sec:appendix_relgshifts_CuII}
Table \ref{Tab:CuII_gshifts_relativistic} shows the scalar-relativistic g-shifts for the test set of square-planar Cu\textsuperscript{II} complexes.
\begin{table}
\small
\centering
\ttabbox
{\caption[Scalar-relativistic g-shifts compared with the experiment.]{Scalar-relativistic (without picture change) g-shifts (in ppt) calculated with different methods and compared with the experiment.}
\label{Tab:CuII_gshifts_relativistic}}
{\input{Tables/CuII_gshifts_relativistic.tex}
}
\end{table}

\section{Comparison of calculated and experimental anisotropic HFCCs}
\label{Sec:appendix_Aaniso}
Table \ref{Tab:A_aniso} compares the anisotropic part of the HFCCs obtained from calculations with the experimental values. Note that the SD contribution (which is completely anisotropic) and the anisotropic part of the NOC contribution have opposite signs. Both contributions are individually too small in magnitude at the DCD-CAS(2) level (see the main text), but the opposite sign of the contributions leads to a fortuitous error cancellation. Thus it turns out that DCD-CAS(2) has the best agreement with experiment among the compared methods.

\begin{table}
\small
\centering
\ttabbox
{\caption[Comparison of calculated and experimental anisotropic \textsuperscript{63}Cu HFCCs.]{Comparison of calculated and experimental anisotropic \textsuperscript{63}Cu HFCCs (in MHz).}
\label{Tab:A_aniso}}
{\input{Tables/A_aniso.tex}
}
\end{table}

\section{Calculation of CCSD(T) excitation energies for [Cu(NH\textsubscript{3})\textsubscript{4}]\textsuperscript{2+}}
\label{Sec:appendix_CCSDT_NH3}
We calculated CCSD(T) energies for all six states of the [Cu(NH\textsubscript{3})\textsubscript{4}]\textsuperscript{2+} molecule based on the CASSCF single-determinant wavefunctions (in the basis of SDOs) of a preceding SA-CASSCF calculation. We used a nonrelativistic Hamiltonian and the contracted def2-TZVP basis set. With the default convergence threshold of $2.5 \times {10^{ - 5}}$ , only three of the calculations converged. We therefore loosened the threshold to a value of $1.5 \times {10^{ - 4}}$, which made all calculations converge. Table \ref{Tab:CCSDT_thresholds_NH3} shows the comparison of the total energies obtained with the two thresholds.

\begin{table}
\small
\centering
\ttabbox
{\caption[Comparison of CCSD(T) total energies with default and loosened threshold.]{Comparison of CCSD(T) total energies (in Ha) with default and loosened threshold.}
\label{Tab:CCSDT_thresholds_NH3}}
{\input{Tables/CCSDT_thresholds_NH3.tex}
}
\end{table}

For the three states that also converged with default thresholds, one can observe that the difference is smaller than the two digits after the decimal point (in eV) that we report for excitation energies, hence we conclude that the loosened threshold is acceptable.

\section{Comparison of SA-NEVPT2 and state-specific NEVPT2 total energies}
\label{Sec:appendix_SSvsSANEVPT2totalE}
As an example of our observation that total energies obtained with state-specific NEVPT2 are usually significantly lower than total energies obtained with state-averaged NEVPT2, we show in Table \ref{Tab:SSvsSANEVPT2} the energies of all ligand field roots of the \Cosacsac\ complex calculated with the two methods, using the geometry and computational details from our previous work.\cite{LangN_2019_104104}

\input{Tables/SSvsSANEVPT2.tex}

\section{Results of CASSCF(25,13) for $D_{2d}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus}}
\label{Sec:appendix_CAS2513}
In the CASSCF(25,13) calculation, we included all ligand-based orbitals of $e$ and $a_1$ symmetry together with the $d$ orbitals into the active space. In order to have a balanced treatment of ligand-field versus charge transfer states, the latter got assigned a lower weight, such that the total weight of ligand-field versus charge transfer states is 1:1. As can be seen in Table \ref{Tab:excenergies_oscstrengths}, the CASSCF(25,13)/NEVPT2 excitation energies correlate very well with the experimental band maxima and also the computed oscillator strengths predict three dominant transitions. Looking at the SDOs in Figure \ref{Fig:CAS2513_SDOs}, one can see that the ligand donor orbitals belonging to these three dominant LMCT transitions are exactly the ones that are included in the active space in the calculations of Section \ref{Sec:LFvsLMCT}.
\begin{figure}
\ffigbox[\FBwidth]
{\caption[Ligand-centered SDOs of the CASSCF(25,13) calculation on $D_{2d}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus}.]{Ligand-centered SDOs of the CASSCF(25,13) calculation on $D_{2d}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus}. From top to bottom, they are the SOMOs of the LMCT states in order of increasing energy.}
\label{Fig:CAS2513_SDOs}}
{\includegraphics[width=0.7\textwidth]{figures/ligandorbitals_cropped_scaled.png}}
\end{figure}

\begin{table}
\small
\centering
\ttabbox
{\caption[Excitation energies and oscillator strengths of $D_{2d}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus}.]{Excitation energies (eV) and oscillator strengths $f$ belonging to the $d$-$d$ transitions and all bands in the charge transfer region belonging to $A_1$ and $E$ symmetry of the $D_{2d}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} UV/Vis absorption spectrum.}
\label{Tab:excenergies_oscstrengths}}
{\input{Tables/excenergies_oscstrengths.tex}
\floatfoot{\textsuperscript{a}Experimentally, the $^2E$ d-d state is slightly split by a distortion. We use the average of the two energies as a reference.}
}
\end{table}

\section{Thresholds for the CC calculations of excitation energies in [CuCl\textsubscript{4}]\textsuperscript{2\textminus}}
\label{Sec:appendix_thresholdsCC}
It was demonstrated in Appendix \ref{Sec:appendix_CCSDT_NH3} that one can expect meV accuracy by reducing the residual convergence threshold to $s=0.00015$. Since not all calculations converged with this threshold, we successively loosened the threshold and investigated the changes in total energy when going from one threshold to the next one. These numbers are presented in Tables \ref{Tab:CCconvergence_D2d} to \ref{Tab:CCconvergence_D4h_Li}. All values that are left out correspond to calculations that did not converge.

\begin{table}
\small
\centering
\ttabbox
{\caption[Coupled cluster total energies with different convergence thresholds for the $D_{2d}$ complex.]{Coupled cluster total energies (in Ha) with different convergence thresholds $s$ for the $D_{2d}$ complex.}
\label{Tab:CCconvergence_D2d}}
{\input{Tables/CCconvergence_D2d.tex}
}
\end{table} 
  	
\begin{table}
\small
\centering
\ttabbox
{\caption[Coupled cluster total energies with different convergence thresholds for the $D_{4h}$ complex without ECPs on H point charges.]{Coupled cluster total energies (in Ha) with different convergence thresholds $s$ for the $D_{4h}$ complex without ECPs on H point charges.}
\label{Tab:CCconvergence_D4h_Hatom}}
{\input{Tables/CCconvergence_D4h_Hatom.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[Coupled cluster total energies with different convergence thresholds for the $D_{4h}$ complex with Li ECPs on some H point charges.]{Coupled cluster total energies (in Ha) with different convergence thresholds $s$ for the $D_{4h}$ complex with Li ECPs on some H point charges.}
\label{Tab:CCconvergence_D4h_Li}}
{\input{Tables/CCconvergence_D4h_Li.tex}
}
\end{table}

It can be seen that $s=0.0005$ introduces errors in the range of a few meV. We therefore choose to present two digits after the decimal point for numbers obtained with this threshold. The $s=0.003$ threshold introduces additional errors of up to 0.06 eV. We therefore choose to present only one digit after the decimal point for numbers obtained with this threshold.

\section{Excitation energies of [CuCl\textsubscript{4}]\textsuperscript{2\textminus} before averaging}
\label{Sec:appendix_excenergies_beforeaveraging}
Tables \ref{Tab:excenergies_beforeaveraging_D2d}  to \ref{Tab:excenergies_beforeaveraging_D4h_Li} show the excitation energies for [CuCl\textsubscript{4}]\textsuperscript{2\textminus} before averaging over quasidegenerate roots.
\begin{table}
\small
\centering
\ttabbox
{\caption[All excitation energies of $D_{2d}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus} before averaging.]{All excitation energies (in eV) of $D_{2d}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} in crystal embedding before averaging over energies that should be degenerate in the pseudo symmetry group. A residual convergence threshold of 0.003 was used for the DLPNO-CCSD(T) calculations.}
\label{Tab:excenergies_beforeaveraging_D2d}}
{\input{Tables/excenergies_beforeaveraging_D2d.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[All excitation energies of $D_{4h}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus} (with bare point charges at H atom positions) before averaging.]{All excitation energies (in eV) of $D_{4h}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} in crystal embedding (with bare point charges at H atom positions) before averaging over energies that should be degenerate in the pseudo symmetry group. A residual convergence threshold of 0.0005 was used for the DLPNO-CCSD(T) calculations.}
\label{Tab:excenergies_beforeaveraging_D4h_Hatom}}
{\input{Tables/excenergies_beforeaveraging_D4h_Hatom.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[All excitation energies of $D_{4h}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus} (with Li ECPs at some H atom positions) before averaging.]{All excitation energies (in eV) of $D_{4h}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} in crystal embedding (with Li ECPs at some H atom positions) before averaging over energies that should be degenerate in the pseudo symmetry group. A residual convergence threshold of 0.0005 was used for the DLPNO-CCSD(T) calculations, except for the highest energy $E_u$ level, where a threshold of 0.003 was necessary to achieve convergence.}
\label{Tab:excenergies_beforeaveraging_D4h_Li}}
{\input{Tables/excenergies_beforeaveraging_D4h_Li.tex}
}
\end{table}

\section{Results for the Cr\textsuperscript{III} series with only quartet roots included}
\label{Sec:appendix_CrIII_quartetaveraging}
Table \ref{Tab:CrX6_onlyquartets} shows the quartet excitation energies of the complexes in the Cr\textsuperscript{III} series with only quartet roots included in the state averaging.
\begin{table}
\small
\centering
\ttabbox
{\caption[Quartet excitation energies for the {[CrX\textsubscript{6}]}\textsuperscript{n} series averaged over only the quartet roots.]{Quartet excitation energies (in eV) for the [CrX\textsubscript{6}]\textsuperscript{n} series obtained with different geometries and averaged over only the quartet roots.}
\label{Tab:CrX6_onlyquartets}}
{\input{Tables/CrX6_onlyquartets.tex}
\floatfoot{\textsuperscript{a}K\textsubscript{2}NaCrF\textsubscript{6}\cite{WoodFKD_1963_890} This system has an experimental metal ligand distance that is closest to the C-PCM geometry among the systems in Table \ref{Tab:CrX_bondlengths}. \\
\textsuperscript{b}CrCl\textsubscript{3}\cite{WoodFKD_1963_890}\\
\textsuperscript{c}CrBr\textsubscript{3}\cite{WoodFKD_1963_890}\\
\textsuperscript{d}K\textsubscript{3}Cr(CN)\textsubscript{6}\cite{AlexaG_1968_4260}\\
\textsuperscript{e}[Cr(NH\textsubscript{3})\textsubscript{6}](ClO\textsubscript{4})\textsubscript{3} in H\textsubscript{2}O\cite{Linha_1944_224, Schlae_1957_65}
}}
\end{table}

\section{Additional \textit{ab initio} effective Hamiltonians}
\label{Sec:appendix_AILFT_DCDHeff}
The quartet block of the DCD-CAS(2) effective Hamiltonian in the CSF basis is
	\begin{equation}{\mathbf{H}}_{{\text{DCD-CAS(2)}}}^{{\text{eff}}} = \left( {\begin{array}{*{20}{c}}
  0&0&0&0 \\ 
  0&{1.880}&0&0 \\ 
  0&0&{3.168}&{0.652} \\ 
  0&0&{0.652}&{4.052} 
\end{array}} \right)\end{equation}
for the [CrF\textsubscript{6}]\textsuperscript{3\textminus} complex,
	\begin{equation}{\mathbf{H}}_{{\text{DCD-CAS(2)}}}^{{\text{eff}}} = \left( {\begin{array}{*{20}{c}}
  0&0&0&0 \\ 
  0&{1.682}&0&0 \\ 
  0&0&{2.844}&{0.603} \\ 
  0&0&{0.603}&{3.640} 
\end{array}} \right)\end{equation}
for the [CrCl\textsubscript{6}]\textsuperscript{3\textminus} complex and
	\begin{equation}{\mathbf{H}}_{{\text{DCD-CAS(2)}}}^{{\text{eff}}} = \left( {\begin{array}{*{20}{c}}
  0&0&0&0 \\ 
  0&{1.638}&0&0 \\ 
  0&0&{2.767}&{0.591} \\ 
  0&0&{0.591}&{3.550} 
\end{array}} \right)\end{equation}
for the [CrBr\textsubscript{6}]\textsuperscript{3\textminus} complex.

\section{Exact numerical data for RMSDs and trends in ligand field parameters}
\label{Sec:appendix_AILFT_exactnumbers}
The exact numbers for the RMSDs between AILFT and \textit{ab initio} state energies are shown in Table \ref{Tab:TotalRMSDs}. Tables \ref{Tab:Exactnumbers_Delta} to \ref{Tab:Exactnumbers_CoverB} show the exact numbers for the ligand field parameters $\Delta$, $B$, $C$, and the ratio $C/B$.
\begin{table}
\small
\centering
\ttabbox
{\caption[Total RMSDs between AILFT and \textit{ab initio} state energies.]{Total RMSDs (in eV) between AILFT and \textit{ab initio} state energies.}
\label{Tab:TotalRMSDs}}
{\input{Tables/TotalRMSDs.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[Ligand field splittings $\Delta$.]{Ligand field splittings $\Delta$ (in eV) for all complexes in the test set that are approximately octahedral or tetrahedral. All ligand field orbital energies belonging to degenerate sets in the pseudo symmetry group were averaged.}
\label{Tab:Exactnumbers_Delta}}
{\input{Tables/Exactnumbers_Delta.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[AILFT Racah parameter $B$.]{AILFT Racah parameter $B$ (in eV) derived from different \textit{ab initio} methods for all complexes in the test set.}
\label{Tab:Exactnumbers_B}}
{\input{Tables/Exactnumbers_B.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[AILFT Racah parameter $C$.]{AILFT Racah parameter $C$ (in eV) derived from different \textit{ab initio} methods for all complexes in the test set.}
\label{Tab:Exactnumbers_C}}
{\input{Tables/Exactnumbers_C.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[AILFT Racah parameter ratio $C/B$.]{AILFT Racah parameter ratio $C/B$ derived from different \textit{ab initio} methods for all complexes in the test set.}
\label{Tab:Exactnumbers_CoverB}}
{\input{Tables/Exactnumbers_CoverB.tex}
}
\end{table}

\chapter{Miscellaneous}

\section{Geometries and basis set for the non-invariance test in the allene molecule}
\label{Sec:appendix_geombasis_allene}
The Z-matrix for the scan of the two angles v1 (CCC bend angle) and v2 (simultaneous CCCH torsion angles) in the ORCA input format is given by
\begin{verbatim}
C 0 0 0 0.0 0.0 0.0
C 1 0 0 1.396886 0.0 0.0
C 1 2 0 1.396886 {134.128769+v1} 0.0
H 3 1 2 1.076186 121.393623 {149.053879+v2}
H 3 1 2 1.082524 118.809540 {-51.126972-v2}
H 2 1 3 1.076186 121.393623 {-149.053879-v2}
H 2 1 3 1.082524 118.809540 {51.126972+v2}
\end{verbatim}

The basis set (in the GAMESS-US\cite{SchmiBBEGJKMNSWDM_1993_1347} basis set format), which is a modification of the Dunning-Hay SVP basis set\cite{DunniH_1977_1} as downloaded from the EMSL Basis Set Exchange\cite{SchucDESGCLW_2007_1045} website, is given by
\begin{verbatim}
HYDROGEN
S   3
  1     19.2384000              0.0328280
  2      2.8987000              0.2312040
  3      0.6535000              0.8172260
S   1
  1      0.1630642              1.0000000

CARBON
S   7
  1   4233.0000000              0.0012200
  2    634.9000000              0.0093420
  3    146.1000000              0.0454520
  4     42.5000000              0.1546570
  5     14.1900000              0.3588660
  6      5.1480000              0.4386320
  7      1.9670000              0.1459180
S   2
  1      5.1480000             -0.1683670
  2      0.4962000              1.0600910
S   1
  1      0.1533000              1.0000000
P   4
  1     18.1600000              0.0185390
  2      3.9860000              0.1154360
  3      1.1430000              0.3861880
  4      0.3594000              0.6401140
P   1
  1      0.1146000              1.0000000
D   1
  1      0.7500000              1.0000000
\end{verbatim}

\section{Description of the embedded cluster approach}
\label{Sec:appendix_detailsembedding}
\subsection{Supercell of the $D_{2d}$ compound}
Cs\textsubscript{2}CuCl\textsubscript{4} crystallizes in the space group type Pnma with lattice parameters $a$=9.70 Å, $b$=7.60 Å, $c$=12.35 Å and 4 formula units (28 atoms) per unit cell. For modelling, we repeated the unit cell 8 times in $a$ direction, 10 times in $b$ direction and 6 times in $c$ direction, which leads to an approximately cubic cell of dimension 77.6 Å × 76 Å × 74.1 Å and a total of 13440 atoms. Of those, only a central [CuCl\textsubscript{4}]\textsuperscript{2\textminus} unit is treated quantum mechanically.

\subsection{Supercell of the $D_{4h}$ compound}
(N-mph)\textsubscript{2}CuCl\textsubscript{4} crystallizes in the space group type P2\textsubscript{1}/c with the lattice parameters $a$=6.4952 Å, $b$=22.678 Å, $c$=8.5844 Å and angle $\beta$=116.08°, and two formula units (106 atoms) per unit cell. In our chosen coordinate system, the lattice vectors (in Å) are given by
	\begin{equation}
	{\mathbf{a}} = \left( {\begin{array}{*{20}{c}}
  {6.4952} \\ 
  {0.0} \\ 
  {0.0} 
\end{array}} \right),
\end{equation}
	\begin{equation}
	{\mathbf{b}} = \left( {\begin{array}{*{20}{c}}
  {0.0} \\ 
  {22.678} \\ 
  {0.0} 
\end{array}} \right),
\end{equation}
	\begin{equation}
	{\mathbf{c}} = \left( {\begin{array}{*{20}{c}}
  { - 3.77392262} \\ 
  {0.0} \\ 
  {7.71034574} 
\end{array}} \right).
\end{equation}
In order to have a minimal distance of 35 Å from the center of the supercell to the surface, one needs a rhombus in the $a$-$c$-plane of side length 70 Å / sin(180°−β) $\approx$ 78 Å. In order to approximately fulfill this, we repeated the unit cell 12 times in $a$ direction, 4 times in $b$ direction and 9 times in $c$ direction. This gives a supercell with dimensions of approximately 78 Å × 91 Å × 78 Å. One would expect that this leads to a total of 45792 atoms (12×4×9×106), but since we chose a unit cell that has Cu atoms on its surface, the actual total number (including the “duplicates” on the surface) is 45948. To keep the total system neutral, the charges of surface Cu atoms are scaled down in the embedding calculations, as explained below.

\subsection{Determination of charges}
For the determination of the point charges, we decided to perform calculations only on single ions. We also tried quantum calculations of larger clusters including both cations and anions, in order to allow for non-integral total charge on the individual ions. The presence of several unpaired electrons (on the Cu anions) made it however hard to converge the SCF.
This means that by definition the charge of Cs\textsuperscript{+} is +1, since it is monoatomic. For the other ions (the two forms of [CuCl\textsubscript{4}]\textsuperscript{2\textminus} and N-mph\textsuperscript{+}), we selected representatives from roughly the center of the supercell and performed a series of DLPNO-CCSD calculations with CHELPG to determine the charges: First a gas phase calculation, then a calculation with the quantum-mechanical system embedded in the gas phase charges (iteration 1), and finally a calculation with the quantum-mechanical system embedded in charges from the previous embedding calculation (iteration 2). The resulting charges from that calculation were roughly converged and were used to calculate the excitation energies presented in the main part of the manuscript. The detailed values of the point charges are shown in Tables \ref{Tab:PC_D2d} to \ref{Tab:PC_Nmph_Li}. The order of the atoms in those tables is the same as the order within the Cartesian coordinates given in Tables \ref{Tab:D2d_geometry} to \ref{Tab:Nmph_geometry}.

\begin{table}
\small
\centering
\ttabbox
{\caption[Point charges of $D_{2d}$-{[CuCl\textsubscript{4}]\textsuperscript{2\textminus}}.]{Point charges of $D_{2d}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} determined with CHELPG from DLPNO-CCSD densities. The charges obtained in iteration 2 are the ones used for the calculation of excitation energies.}
\label{Tab:PC_D2d}}
{\input{Tables/PC_D2d.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[Point charges of $D_{4h}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus} obtained without ECPs on H atom point charges.]{Point charges of $D_{4h}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} determined with CHELPG from DLPNO-CCSD densities without ECPs on H atom point charges. The charges obtained in iteration 2 are the ones used for the calculation of excitation energies.}
\label{Tab:PC_D4h_Hatom}}
{\input{Tables/PC_D4h_Hatom.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[Point charges of Nmph\textsuperscript{+} obtained without ECPs on H atom point charges.]{Point charges of Nmph\textsuperscript{+} determined with CHELPG from DLPNO-CCSD densities without ECPs on H atom point charges. The charges obtained in iteration 2 are the ones used for the calculation of excitation energies.}
\label{Tab:PC_Nmph_Hatom}}
{\input{Tables/PC_Nmph_Hatom.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[Point charges of $D_{4h}$-{[CuCl\textsubscript{4}]}\textsuperscript{2\textminus} obtained with Li ECPs on H atom point charges in the vicinity of the quantum region.]{Point charges of $D_{4h}$-[CuCl\textsubscript{4}]\textsuperscript{2\textminus} determined with CHELPG from DLPNO-CCSD densities with Li ECPs on H atom point charges in the vicinity of the quantum region. The charges obtained in iteration 2 are the ones used for the calculation of excitation energies.}
\label{Tab:PC_D4h_Li}}
{\input{Tables/PC_D4h_Li.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption[Point charges of Nmph\textsuperscript{+} obtained with Li ECPs on H atom point charges in the vicinity of the quantum region.]{Point charges of Nmph\textsuperscript{+} determined with CHELPG from DLPNO-CCSD densities with Li ECPs on H atom point charges in the vicinity of the quantum region. The charges obtained in iteration 2 are the ones used for the calculation of excitation energies.}
\label{Tab:PC_Nmph_Li}}
{\input{Tables/PC_Nmph_Li.tex}
}
\end{table}

\begin{table}
\small
\centering
\ttabbox
{\caption{Cartesian coordinates of $D_{2d}$-{[CuCl\textsubscript{4}]\textsuperscript{2\textminus}}.}
\label{Tab:D2d_geometry}}
{\input{Tables/D2d_geometry.tex}
}
\end{table}
\begin{table}
\small
\centering
\ttabbox
{\caption{Cartesian coordinates of $D_{4h}$-{[CuCl\textsubscript{4}]\textsuperscript{2\textminus}}.}
\label{Tab:D4h_geometry}}
{\input{Tables/D4h_geometry.tex}
}
\end{table}
\begin{table}
\small
\centering
\ttabbox
{\caption{Cartesian coordinates of Nmph\textsuperscript{+}.}
\label{Tab:Nmph_geometry}}
{\input{Tables/Nmph_geometry.tex}
}
\end{table}

For the $D_{4h}$ crystal, a centrosymmetric unit cell is only possible if some atoms lie on the border of the cell. If all these atoms are included, the total supercell is charged, while when leaving only some of them away, the supercell might have a permanent dipole moment. Both situations are unfavorable. We solved this problem by scaling the charges of atoms lying on the border of the supercell by 1/2 for atoms lying on a face, by 1/4 for atoms lying on an edge, and by 1/8 for atoms lying on a corner. For the specific crystal investigated in this work, we managed to construct a centrosymmetric unit cell that had atoms only on faces, not on edges or corners. More information is provided in the supplementary material of our original publication.












\cleardoublepage
\addcontentsline{toc}{chapter}{Bibliography}  %Achtung: Platzierung entscheidet darüber welche Seitenzahl für das Literaturverzeichnis angegeben wird.
\bibliography{literature} 
\bibliographystyle{mydiss_unsorted}

\cleardoublepage
\addcontentsline{toc}{chapter}{Curriculum Vitae}
\KOMAoptions{twoside = false, BCOR=0mm}
\thispagestyle{empty}

\hrule
\vspace*{0.5cm}
{\LARGE\textsc{Curriculum Vitae}}
\vspace{1cm}
\hrule
\vspace{0.5cm}
{\large\textsc{Personal Data}}
\vspace{0.5cm}

\begin{tabular}{>{\raggedleft}m{0.23\textwidth}>{\raggedright\arraybackslash}m{0.77\textwidth}}
\textbf{Name:} & Lucas Lang \\
\textbf{Date of Birth:} & February 23, 1990 \\
\textbf{Place of Birth:} & Würzburg \\
\textbf{Email:} & lucas.lang@kofo.mpg.de
\end{tabular}

\vspace{0.5cm}
\hrule
\vspace{0.5cm}
{\large\textsc{Education}}
\vspace{0.5cm}

\begin{tabular}{>{\raggedleft}p{0.23\textwidth}>{\raggedright\arraybackslash}p{0.77\textwidth}}
since Jan 2018 & Continuation of Ph.D. studies at the Max-Planck-Institut für Kohlenforschung, Mülheim an der Ruhr. \\
& Supervisor: Prof. Dr. Frank Neese. \\
& \\
Nov 2015 -- Dec 2017 & Ph.D. studies at the Max Planck Institute for Chemical Energy Conversion, Mülheim an der Ruhr. \\
& Supervisor: Prof. Dr. Frank Neese. \\
& \\
Oct 2013 -- Sep 2015 & M.Sc. studies in chemistry at the Technical University of Munich. \\
& Title of the thesis: \textit{Implementation and evaluation of a new ACKS2 electronic linear response model.}\\
& Supervisor: Prof. Dr. Karsten Reuter. \\
& \\
Oct 2010 -- Aug 2013 & B.Sc. studies in chemistry at Ulm University. \\
& Title of the thesis: \textit{Präparation und Charakterisierung dünner MgO-Filme auf Mo(100).} \\
& Supervisor: Prof. Dr. Thorsten M. Bernhardt. \\
& \\
Jun 2009 & Abitur at Balthasar-Neumann-Gymnasium Marktheidenfeld.
\end{tabular}
\end{document}
